<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Virtual Qmail: cfsvq_dom.cc Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.3 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Compound&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Compound&nbsp;Members</a></div>
<h1>cfsvq_dom.cc</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment">Copyright (c) 2002,2003 Pawel Niewiadomski</span>
00003 <span class="comment">All rights reserved.</span>
00004 <span class="comment"></span>
00005 <span class="comment">Redistribution and use in source and binary forms, with or without</span>
00006 <span class="comment">modification, are permitted provided that the following conditions</span>
00007 <span class="comment">are met:</span>
00008 <span class="comment">1. Redistributions of source code must retain the above copyright</span>
00009 <span class="comment">   notice, this list of conditions and the following disclaimer.</span>
00010 <span class="comment">2. Redistributions in binary form must reproduce the above copyright</span>
00011 <span class="comment">   notice, this list of conditions and the following disclaimer in the</span>
00012 <span class="comment">   documentation and/or other materials provided with the distribution.</span>
00013 <span class="comment">3. All advertising materials mentioning features or use of this software</span>
00014 <span class="comment">   must display the following acknowledgement:</span>
00015 <span class="comment">   This product includes software developed by the Pawel Niewiadomski,</span>
00016 <span class="comment">   and other contributors.</span>
00017 <span class="comment">4. Neither the name of Pawel Niewiadomski nor the names of other contributors</span>
00018 <span class="comment">   may be used to endorse or promote products derived from this software</span>
00019 <span class="comment">   without specific prior written permission.</span>
00020 <span class="comment"></span>
00021 <span class="comment">THIS SOFTWARE IS PROVIDED BY PAWEL NIEWIADOMSKI AND CONTRIBUTORS ``AS IS'' AND</span>
00022 <span class="comment">ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
00023 <span class="comment">IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
00024 <span class="comment">ARE DISCLAIMED.  IN NO EVENT SHALL PAWEL NIEWIADOMSKI OR CONTRIBUTORS BE LIABLE</span>
00025 <span class="comment">FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
00026 <span class="comment">DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</span>
00027 <span class="comment">OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
00028 <span class="comment">HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
00029 <span class="comment">LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
00030 <span class="comment">OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
00031 <span class="comment">SUCH DAMAGE.</span>
00032 <span class="comment">*/</span>
00033 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00034 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00035 <span class="preprocessor">#include &lt;sys/wait.h&gt;</span>
00036 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
00037 <span class="preprocessor">#include &lt;sstream&gt;</span>
00038 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00039 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00040 <span class="preprocessor">#include &lt;cerrno&gt;</span>
00041 <span class="preprocessor">#include &lt;inttypes.h&gt;</span>
00042 <span class="preprocessor">#include &lt;algorithm&gt;</span>
00043 <span class="preprocessor">#include &lt;dirent.h&gt;</span>
00044 <span class="preprocessor">#include &lt;signal.h&gt;</span>
00045 <span class="preprocessor">#include &lt;iomanip&gt;</span>
00046 
00047 <span class="preprocessor">#include "pfstream.h"</span>
00048 <span class="preprocessor">#include "conf_home.h"</span>
00049 <span class="preprocessor">#include "vq_conf.h"</span>
00050 <span class="preprocessor">#include "cfsvq.h"</span>
00051 <span class="preprocessor">#include "lower.h"</span>
00052 <span class="preprocessor">#include "lock.h"</span>
00053 <span class="preprocessor">#include "dirs.h"</span>
00054 <span class="preprocessor">#include "split.h"</span>
00055 <span class="preprocessor">#include "util.h"</span>
00056 <span class="preprocessor">#include "auto/d_namlen.h"</span>
00057 <span class="preprocessor">#include "sys.h"</span>
00058 <span class="preprocessor">#include "qmail_progs.h"</span>
00059 
00060 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00061 <span class="keyword">using</span> <span class="keyword">namespace </span>posix;
00062 <span class="keyword">using</span> <span class="keyword">namespace </span>vq;
00063 
<a name="l00069"></a><a class="code" href="classcfsvq.html#a37">00069</a> uint8_t <a class="code" href="group__dom.html#a37">cfsvq::dom_alias_rm</a>( <span class="keyword">const</span> string &amp; a )
00070 {
00071     <span class="keywordtype">char</span> ret;
00072     string alias(lower(a));
00073     ret=<a class="code" href="classcfsvq.html#cfsvqb0">assign_ex</a>(alias);
00074     <span class="keywordflow">if</span>( ret ) <span class="keywordflow">return</span>(ret);
00075     <span class="keywordflow">return</span> <a class="code" href="classcfsvq.html#cfsvqb9">virt_rm</a>(alias);
00076 }
00077 
<a name="l00083"></a><a class="code" href="classcfsvq.html#a35">00083</a> uint8_t <a class="code" href="group__dom.html#a35">cfsvq::dom_rm</a>(<span class="keyword">const</span> string &amp;d)
00084 {
00085     <a class="code" href="classcfsvq.html#cfsvqb16">assert_auth</a>();
00086     string dom(lower(d));
00087     uint8_t ret;
00088     
00089     ret=<a class="code" href="classcfsvq.html#cfsvqb4">rcpt_rm</a>(dom);
00090     ret=<a class="code" href="classcfsvq.html#cfsvqb6">morercpt_rm</a>(dom);
00091     ret=<a class="code" href="classcfsvq.html#cfsvqb9">virt_rm</a>(dom);
00092     ret=<a class="code" href="classcfsvq.html#cfsvqb2">assign_rm</a>(dom);
00093 
00094     <span class="keywordflow">if</span>(<a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;dom_rm(dom)) ret = <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw7">err_auth</a>, <a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;err_report());
00095 
00096     string restart(conf_home+<span class="stringliteral">"/bin/qmail_run"</span>);
00097     <span class="keywordtype">char</span> prog[] = { qp_send_restart, <span class="charliteral">'\0'</span> };
00098     <span class="keywordtype">char</span> *<span class="keyword">const</span> args[] = {
00099             const_cast&lt;char *&gt;(restart.c_str()),
00100             prog,
00101             NULL
00102     };
00103     <span class="keywordtype">int</span> rr = <a class="code" href="classcfsvq.html#cfsvqb10">run</a>(args);
00104     <span class="keywordflow">if</span>( ! WIFEXITED(rr) || WEXITSTATUS(rr) ) ret = <a class="code" href="group__err.html#a16cvqw3">err_temp</a>;
00105 
00106     string dir(conf_home+<span class="stringliteral">"/domains/"</span>+split_dom(dom)+<span class="charliteral">'/'</span>+dom);
00107     <span class="keywordflow">if</span>(!rmdirrec(dir)) {
00108             ret = <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw10">err_wr</a>, dir);
00109     }
00110 
00111     <span class="keywordflow">return</span>(ret);
00112 }
00113 
<a name="l00119"></a><a class="code" href="classcfsvq.html#a9">00119</a> uint8_t <a class="code" href="group__dom.html#a9">cfsvq::dom_add</a>(<span class="keyword">const</span> string &amp;d)
00120 {
00121     <a class="code" href="classcfsvq.html#cfsvqb16">assert_auth</a>();
00122     string dom(lower(d));
00123     <span class="keywordflow">if</span>(!<a class="code" href="group__dom.html#a19">dom_val</a>(dom)) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw4">err_dom_inv</a>, dom);
00124 
00125     <span class="keywordflow">if</span>(<a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;dom_add(dom)) { 
00126             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw7">err_auth</a>, <a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;err_report()); 
00127     }
00128 
00129     string dom_add_dir(conf_home+<span class="stringliteral">"/domains/"</span>+split_dom(dom)+<span class="charliteral">'/'</span>+dom);
00130     <span class="keywordflow">if</span>(!mkdirhier(dom_add_dir.c_str(), 
00131         ac_vq_mode.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>(), ac_vq_uid.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>(), ac_vq_gid.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>())) {
00132             <a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;dom_rm(dom);
00133             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw20">err_mkdir</a>, dom);
00134     }
00135 
00136     <span class="comment">/* dot file with a call to deliver */</span>
00137     string <a class="code" href="group__udot.html#a10">dotfile</a>(dom_add_dir+<span class="stringliteral">"/.qmail-default"</span>);
00138     <span class="keywordflow">if</span>(!dumpstring( dotfile, (string)<span class="stringliteral">"|"</span>+conf_home+<span class="stringliteral">"/bin/deliver\n"</span>)
00139        || chown(dotfile.c_str(), ac_vq_uid.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>(), ac_vq_gid.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>())
00140        || chmod(dotfile.c_str(), ac_vq_fmode.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>()) ) {
00141             rmdirrec(dom_add_dir); 
00142             <a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;dom_rm(dom);
00143             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw10">err_wr</a>, dotfile);
00144     }
00145 
00146     <span class="keywordflow">if</span>( <a class="code" href="classcfsvq.html#cfsvqb8">virt_add</a>(dom,dom) ) {
00147             rmdirrec(dom_add_dir);
00148             <a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;dom_rm(dom);
00149             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a8">lastret</a>;
00150     }
00151         
00152     <span class="keywordflow">if</span>(<a class="code" href="classcfsvq.html#cfsvqb7">locals_rm</a>(dom)) {
00153             rmdirrec(dom_add_dir); 
00154             <a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;dom_rm(dom);
00155             <a class="code" href="classcfsvq.html#cfsvqb9">virt_rm</a>(dom);
00156             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a8">lastret</a>; 
00157     }
00158 
00159     <span class="keywordflow">switch</span>(<a class="code" href="classcfsvq.html#cfsvqb3">rcpt_add</a>(dom)) {
00160     <span class="keywordflow">case</span> <a class="code" href="group__err.html#a16cvqw2">err_no</a>: <span class="keywordflow">break</span>;
00161     <span class="keywordflow">case</span> <a class="code" href="group__err.html#a16cvqw18">err_over</a>:
00162             <span class="keywordflow">if</span>(<a class="code" href="classcfsvq.html#cfsvqb5">morercpt_add</a>(dom) == <a class="code" href="group__err.html#a16cvqw2">err_no</a>) <span class="keywordflow">break</span>;
00163     <span class="keywordflow">default</span>:
00164             <a class="code" href="group__err.html#a9">lastret_blkd</a>=<span class="keyword">true</span>;
00165             rmdirrec(dom_add_dir); 
00166             <a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;dom_rm(dom);
00167             <a class="code" href="classcfsvq.html#cfsvqb9">virt_rm</a>(dom);
00168             <a class="code" href="group__err.html#a9">lastret_blkd</a>=<span class="keyword">false</span>;
00169             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a8">lastret</a>; 
00170     }
00171     <span class="keywordflow">if</span>(<a class="code" href="classcfsvq.html#cfsvqb1">assign_add</a>(dom)) {
00172             <a class="code" href="group__err.html#a9">lastret_blkd</a>=<span class="keyword">true</span>;
00173             rmdirrec(dom_add_dir); 
00174             <a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;dom_rm(dom);
00175             <a class="code" href="classcfsvq.html#cfsvqb9">virt_rm</a>(dom);
00176             <a class="code" href="group__err.html#a9">lastret_blkd</a>=<span class="keyword">false</span>;
00177             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a8">lastret</a>;
00178     }
00179 
00180     string restart(conf_home+<span class="stringliteral">"/bin/qmail_run"</span>);
00181     <span class="keywordtype">char</span> prog[] = { qp_send_restart, <span class="charliteral">'\0'</span> };
00182     <span class="keywordtype">char</span> *<span class="keyword">const</span> args[] = {
00183             const_cast&lt;char *&gt;(restart.c_str()),
00184             prog,
00185             NULL
00186     };
00187     <span class="keywordtype">int</span> rr = <a class="code" href="classcfsvq.html#cfsvqb10">run</a>(args);
00188     <span class="keywordflow">if</span>( ! WIFEXITED(rr) || WEXITSTATUS(rr) ) {
00189             <a class="code" href="group__err.html#a9">lastret_blkd</a>=<span class="keyword">true</span>;
00190             rmdirrec(dom_add_dir); 
00191             <a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;dom_rm(dom);
00192             <a class="code" href="classcfsvq.html#cfsvqb9">virt_rm</a>(dom);
00193             <a class="code" href="group__err.html#a9">lastret_blkd</a>=<span class="keyword">false</span>;
00194             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a8">lastret</a>;
00195     }
00196 
00197     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw2">err_no</a>, <span class="stringliteral">""</span>);
00198 }
00199 
<a name="l00206"></a><a class="code" href="classcfsvq.html#a36">00206</a> uint8_t <a class="code" href="group__dom.html#a36">cfsvq::dom_alias_add</a>(<span class="keyword">const</span> string &amp;d, <span class="keyword">const</span> string &amp;a)
00207 {
00208     string dom(lower(d)), ali(lower(a));
00209     <span class="keywordflow">if</span>( <a class="code" href="classcfsvq.html#cfsvqb8">virt_add</a>(ali,dom) )
00210             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a8">lastret</a>;
00211     
00212     <span class="keywordflow">switch</span>( <a class="code" href="classcfsvq.html#cfsvqb3">rcpt_add</a>(ali) ) {
00213     <span class="keywordflow">case</span> <a class="code" href="group__err.html#a16cvqw2">err_no</a>: <span class="keywordflow">break</span>;
00214     <span class="keywordflow">case</span> <a class="code" href="group__err.html#a16cvqw18">err_over</a>:
00215             <span class="keywordflow">if</span>(<a class="code" href="classcfsvq.html#cfsvqb5">morercpt_add</a>(dom) == <a class="code" href="group__err.html#a16cvqw2">err_no</a>) <span class="keywordflow">break</span>;
00216     <span class="keywordflow">default</span>:
00217             <a class="code" href="group__err.html#a9">lastret_blkd</a> = <span class="keyword">true</span>;
00218             <a class="code" href="classcfsvq.html#cfsvqb9">virt_rm</a>(ali);
00219             <a class="code" href="group__err.html#a9">lastret_blkd</a> = <span class="keyword">false</span>;
00220             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a8">lastret</a>;
00221     }
00222 
00223     string restart(conf_home+<span class="stringliteral">"/bin/qmail_run"</span>);
00224     <span class="keywordtype">char</span> prog[] = { qp_send_restart, <span class="charliteral">'\0'</span> };
00225     <span class="keywordtype">char</span> *<span class="keyword">const</span> args[] = {
00226             const_cast&lt;char *&gt;(restart.c_str()),
00227             prog,
00228             NULL
00229     };
00230     <span class="keywordtype">int</span> rr = <a class="code" href="classcfsvq.html#cfsvqb10">run</a>(args);
00231     <span class="keywordflow">if</span>( ! WIFEXITED(rr) || WEXITSTATUS(rr) ) {
00232             <a class="code" href="group__err.html#a9">lastret_blkd</a> = <span class="keyword">true</span>;
00233             <a class="code" href="classcfsvq.html#cfsvqb9">virt_rm</a>(ali);
00234             <a class="code" href="group__err.html#a9">lastret_blkd</a> = <span class="keyword">false</span>;
00235             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw19">err_exec</a>, restart);
00236     }
00237     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw2">err_no</a>, <span class="stringliteral">""</span>);
00238 }
00239 
<a name="l00246"></a><a class="code" href="classcfsvq.html#a30">00246</a> uint8_t <a class="code" href="group__dom.html#a30">cfsvq::dom_ip_add</a>(<span class="keyword">const</span> string &amp;d, <span class="keyword">const</span> string &amp;i)
00247 {
00248     <a class="code" href="classcfsvq.html#cfsvqb16">assert_auth</a>();
00249     string dom(lower(d)), ip(lower(i));
00250     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(!<a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;dom_ip_add(dom,ip) ? <a class="code" href="group__err.html#a16cvqw2">err_no</a> : <a class="code" href="group__err.html#a16cvqw7">err_auth</a>, <a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;err_report());
00251 }
00252 
<a name="l00259"></a><a class="code" href="classcfsvq.html#a31">00259</a> uint8_t <a class="code" href="group__dom.html#a31">cfsvq::dom_ip_rm</a>(<span class="keyword">const</span> string &amp;d, <span class="keyword">const</span> string &amp;i)
00260 {
00261     <a class="code" href="classcfsvq.html#cfsvqb16">assert_auth</a>();
00262     string dom(lower(d)), ip(lower(i));
00263     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(!<a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;dom_ip_rm(dom,ip) ? <a class="code" href="group__err.html#a16cvqw2">err_no</a> : <a class="code" href="group__err.html#a16cvqw3">err_temp</a>, <span class="stringliteral">""</span>);
00264 }
00265 
<a name="l00271"></a><a class="code" href="classcfsvq.html#a32">00271</a> uint8_t <a class="code" href="group__dom.html#a32">cfsvq::dom_ip_rm_all</a>(<span class="keyword">const</span> string &amp;d)
00272 {
00273     <a class="code" href="classcfsvq.html#cfsvqb16">assert_auth</a>();
00274     string dom(lower(d));
00275     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(!<a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;dom_ip_rm_all(dom) ? <a class="code" href="group__err.html#a16cvqw2">err_no</a> : <a class="code" href="group__err.html#a16cvqw7">err_auth</a>, <a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;err_report());
00276 }
00277 
<a name="l00284"></a><a class="code" href="classcfsvq.html#a33">00284</a> uint8_t <a class="code" href="group__dom.html#a33">cfsvq::dom_ip_ls</a>(<span class="keyword">const</span> string &amp;d, vector&lt;string&gt; &amp;ips)
00285 {
00286     <a class="code" href="classcfsvq.html#cfsvqb16">assert_auth</a>();
00287     string dom(lower(d));
00288     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(!<a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;dom_ip_ls(dom,ips) ? <a class="code" href="group__err.html#a16cvqw2">err_no</a> : <a class="code" href="group__err.html#a16cvqw7">err_auth</a>, <a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;err_report());
00289 }
00290 
<a name="l00296"></a><a class="code" href="classcfsvq.html#a34">00296</a> uint8_t <a class="code" href="group__dom.html#a34">cfsvq::dom_ip_ls_dom</a>(vector&lt;string&gt; &amp;doms)
00297 {
00298     <a class="code" href="classcfsvq.html#cfsvqb16">assert_auth</a>();
00299     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(!<a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;dom_ip_ls_dom(doms) ? <a class="code" href="group__err.html#a16cvqw2">err_no</a> : <a class="code" href="group__err.html#a16cvqw7">err_auth</a>, <a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;err_report());
00300 }
00301 
<a name="l00306"></a><a class="code" href="classcfsvq.html#a38">00306</a> uint8_t <a class="code" href="group__dom.html#a38">cfsvq::dom_del_lock</a>( <span class="keyword">const</span> string &amp; dom ) {
00307     <span class="keyword">struct </span>stat st;
00308     <span class="keywordflow">if</span>(stat(dom.c_str(), &amp;st)) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw12">err_stat</a>, dom);
00309     <span class="keywordflow">if</span>(! S_ISDIR(st.st_mode)) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw13">err_notdir</a>, dom);
00310     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>( chmod(dom.c_str(), (st.st_mode &amp; 07777) | 01000) ? <a class="code" href="group__err.html#a16cvqw14">err_chmod</a> : <a class="code" href="group__err.html#a16cvqw2">err_no</a>, dom );
00311 }
00312 
<a name="l00317"></a><a class="code" href="classcfsvq.html#a39">00317</a> uint8_t <a class="code" href="group__dom.html#a39">cfsvq::dom_del_unlock</a>( <span class="keyword">const</span> string &amp; dom ) {
00318     <span class="keyword">struct </span>stat st;
00319     <span class="keywordflow">if</span>(stat(dom.c_str(), &amp;st)) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw12">err_stat</a>, dom);
00320     <span class="keywordflow">if</span>(! S_ISDIR(st.st_mode)) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw13">err_notdir</a>, dom);
00321     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>( chmod(dom.c_str(), (st.st_mode &amp; 07777) &amp; ~01000) ? <a class="code" href="group__err.html#a16cvqw14">err_chmod</a> : <a class="code" href="group__err.html#a16cvqw2">err_no</a>, dom );
00322 }
00323 
<a name="l00329"></a><a class="code" href="classcfsvq.html#a8">00329</a> string <a class="code" href="group__dom.html#a8">cfsvq::dompath</a>(<span class="keyword">const</span> string &amp;dom) {
00330     string ret;
00331     ret.reserve(conf_home.length()+10+2*dom.length());
00332     ret = conf_home;
00333     ret += <span class="stringliteral">"/domains/"</span>;
00334     ret += split_dom(dom);
00335     ret += dom;
00336     <span class="keywordflow">return</span> ret;
00337 }
00338 
00339 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Dec 25 13:37:10 2003 for Virtual Qmail by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.3 </small></address>
</body>
</html>
