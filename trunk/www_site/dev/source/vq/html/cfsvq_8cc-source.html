<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Virtual Qmail: cfsvq.cc Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.3 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Compound&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Compound&nbsp;Members</a></div>
<h1>cfsvq.cc</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment">Copyright (c) 2002,2003 Pawel Niewiadomski</span>
00003 <span class="comment">All rights reserved.</span>
00004 <span class="comment"></span>
00005 <span class="comment">Redistribution and use in source and binary forms, with or without</span>
00006 <span class="comment">modification, are permitted provided that the following conditions</span>
00007 <span class="comment">are met:</span>
00008 <span class="comment">1. Redistributions of source code must retain the above copyright</span>
00009 <span class="comment">   notice, this list of conditions and the following disclaimer.</span>
00010 <span class="comment">2. Redistributions in binary form must reproduce the above copyright</span>
00011 <span class="comment">   notice, this list of conditions and the following disclaimer in the</span>
00012 <span class="comment">   documentation and/or other materials provided with the distribution.</span>
00013 <span class="comment">3. All advertising materials mentioning features or use of this software</span>
00014 <span class="comment">   must display the following acknowledgement:</span>
00015 <span class="comment">   This product includes software developed by the Pawel Niewiadomski,</span>
00016 <span class="comment">   and other contributors.</span>
00017 <span class="comment">4. Neither the name of Pawel Niewiadomski nor the names of other contributors</span>
00018 <span class="comment">   may be used to endorse or promote products derived from this software</span>
00019 <span class="comment">   without specific prior written permission.</span>
00020 <span class="comment"></span>
00021 <span class="comment">THIS SOFTWARE IS PROVIDED BY PAWEL NIEWIADOMSKI AND CONTRIBUTORS ``AS IS'' AND</span>
00022 <span class="comment">ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
00023 <span class="comment">IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
00024 <span class="comment">ARE DISCLAIMED.  IN NO EVENT SHALL PAWEL NIEWIADOMSKI OR CONTRIBUTORS BE LIABLE</span>
00025 <span class="comment">FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
00026 <span class="comment">DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</span>
00027 <span class="comment">OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
00028 <span class="comment">HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
00029 <span class="comment">LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
00030 <span class="comment">OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
00031 <span class="comment">SUCH DAMAGE.</span>
00032 <span class="comment">*/</span>
00033 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00034 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00035 <span class="preprocessor">#include &lt;sys/wait.h&gt;</span>
00036 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
00037 <span class="preprocessor">#include &lt;sstream&gt;</span>
00038 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00039 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00040 <span class="preprocessor">#include &lt;cerrno&gt;</span>
00041 <span class="preprocessor">#include &lt;inttypes.h&gt;</span>
00042 <span class="preprocessor">#include &lt;algorithm&gt;</span>
00043 <span class="preprocessor">#include &lt;dirent.h&gt;</span>
00044 <span class="preprocessor">#include &lt;signal.h&gt;</span>
00045 <span class="preprocessor">#include &lt;iomanip&gt;</span>
00046 
00047 <span class="preprocessor">#include "pfstream.h"</span>
00048 <span class="preprocessor">#include "conf_home.h"</span>
00049 <span class="preprocessor">#include "vq_conf.h"</span>
00050 <span class="preprocessor">#include "cfsvq.h"</span>
00051 <span class="preprocessor">#include "lower.h"</span>
00052 <span class="preprocessor">#include "lock.h"</span>
00053 <span class="preprocessor">#include "dirs.h"</span>
00054 <span class="preprocessor">#include "split.h"</span>
00055 <span class="preprocessor">#include "util.h"</span>
00056 <span class="preprocessor">#include "auto/d_namlen.h"</span>
00057 <span class="preprocessor">#include "sys.h"</span>
00058 <span class="preprocessor">#include "qmail_files.h"</span>
00059 <span class="preprocessor">#include "uniq.h"</span>
00060 
00061 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00062 <span class="keyword">using</span> <span class="keyword">namespace </span>posix;
00063 <span class="keyword">using</span> <span class="keyword">namespace </span>vq;
00064 
<a name="l00065"></a><a class="code" href="classcfsvq.html#cfsvqt0">00065</a> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="classcfsvq.html#cfsvqt0">cfsvq::tmp_end</a>[] = <span class="stringliteral">".tmp"</span>; 
00066 
<a name="l00067"></a><a class="code" href="classcfsvq.html#cfsvqt1">00067</a> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="classcfsvq.html#cfsvqt1">cfsvq::ud_sup</a>[] = <span class="stringliteral">"FSMR"</span>; 
00068 
<a name="l00069"></a><a class="code" href="classcvq.html#cvqe2">00069</a> <a class="code" href="classcvq.html">cvq</a> * <a class="code" href="classcvq.html#cvqe2">cvq::alloc</a>( ) {
00070     <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classcfsvq.html">cfsvq</a>();
00071 }
00072 
00075 cfsvq::cfsvq() {
00076     umask(0);
00077 }
00078 
<a name="l00097"></a><a class="code" href="classcfsvq.html#a1">00097</a> uint8_t <a class="code" href="group__file.html#a0">cfsvq::file_add</a>(<span class="keyword">const</span> string &amp;fn, mode_t mode, 
00098         <span class="keyword">const</span> string &amp;eof_mark, <span class="keyword">const</span> string &amp;item_mark, 
00099         <span class="keywordtype">bool</span> item_whole, <span class="keyword">const</span> string &amp;item_add, uint8_t ex, string &amp;fntmp) {
00100 
00101     string fnlck(fn+<span class="stringliteral">".lock"</span>);
00102     opfstream l(fnlck.c_str());
00103     <span class="keywordflow">if</span>( ! l ) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw9">err_open</a>, fnlck);
00104 
00105     <span class="keywordflow">if</span>( lock_exnb(l.rdbuf()-&gt;fd()) ) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw15">err_lckd</a>, fnlck);
00106 
00107     pfstream in(fn.c_str(),ios::in);
00108     <span class="keywordtype">bool</span> enoent = <span class="keyword">false</span>;
00109     <span class="keywordflow">if</span>(!in) {
00110             <span class="keywordflow">if</span>( errno != ENOENT ) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw9">err_open</a>, fn);
00111             enoent = <span class="keyword">true</span>;
00112     }
00113 
00114     fntmp = fn+uniq();
00115     opfstream tmp(fntmp.c_str());
00116     <span class="keywordflow">if</span>(!tmp) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw10">err_wr</a>, fntmp);
00117 
00118     <span class="keywordflow">if</span>( ! enoent ) {
00119             string ln;
00120             <span class="keywordflow">while</span>(getline(in,ln) &amp;&amp; tmp.good()) {
00121                     <span class="keywordflow">if</span>(!eof_mark.empty() &amp;&amp; ln==eof_mark) <span class="keywordflow">break</span>;
00122                     <span class="keywordflow">if</span>( (!item_whole 
00123                         &amp;&amp; ln.substr(0,item_mark.length())==item_mark)
00124                         || (item_whole &amp;&amp; ln == item_mark) ) {
00125                             unlink(fntmp.c_str());
00126                             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(ex, fn);
00127                     }
00128                     tmp &lt;&lt; ln &lt;&lt; endl;
00129             }
00130             <span class="keywordflow">if</span>( in.bad() ) {
00131                     unlink(fntmp.c_str());
00132                     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw11">err_rd</a>, fn);
00133             }
00134     }
00135     tmp &lt;&lt; item_add &lt;&lt; endl;
00136     <span class="keywordflow">if</span>(!eof_mark.empty()) 
00137             tmp&lt;&lt;eof_mark&lt;&lt;endl;
00138 
00139     tmp.close();
00140     <span class="keywordflow">if</span>( ! tmp ) {
00141             unlink(fntmp.c_str());
00142             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw10">err_wr</a>, fntmp);
00143     }
00144 
00145     <span class="keywordflow">if</span>( ! enoent ) {
00146             <span class="keyword">struct </span>stat st;
00147             <span class="keywordflow">if</span>(!fstat(in.rdbuf()-&gt;fd(), &amp;st)) {
00148                     <span class="keywordflow">if</span>( chown(fntmp.c_str(), st.st_uid, st.st_gid) )
00149                             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw17">err_chown</a>, fntmp);
00150                     <span class="keywordflow">if</span>( chmod(fntmp.c_str(), st.st_mode &amp; 07777 ) )
00151                             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw14">err_chmod</a>, fntmp);
00152             } <span class="keywordflow">else</span> 
00153                     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw12">err_stat</a>, fn);
00154     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( chmod(fntmp.c_str(), ac_vq_fmode.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>()) )
00155             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw14">err_chmod</a>, fntmp);
00156     
00157     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw2">err_no</a>, <span class="stringliteral">""</span>);
00158 }
00159 
<a name="l00165"></a><a class="code" href="classcfsvq.html#cfsvqb10">00165</a> <span class="keywordtype">int</span> <a class="code" href="classcfsvq.html#cfsvqb10">cfsvq::run</a>(<span class="keywordtype">char</span> *<span class="keyword">const</span> args[]) {
00166     pid_t pid;
00167 
00168     <span class="keywordflow">switch</span>((pid=vfork())) {
00169     <span class="keywordflow">case</span> -1: 
00170             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw3">err_temp</a>,<span class="stringliteral">"fork failed"</span>);
00171     <span class="keywordflow">case</span> 0: 
00172             execv( *args, args );
00173             _exit(111);
00174     }
00175     <span class="keywordflow">while</span>( wait(&amp;pid) == -1 &amp;&amp; errno == EINTR );
00176     <span class="keywordflow">return</span> pid;
00177 }
00178 
<a name="l00185"></a><a class="code" href="classcfsvq.html#cfsvqb1">00185</a> uint8_t <a class="code" href="classcfsvq.html#cfsvqb1">cfsvq::assign_add</a>( <span class="keyword">const</span> string &amp;dom )
00186 {   
00187     ostringstream domln;
00188     domln &lt;&lt; <span class="charliteral">'+'</span>&lt;&lt; dom &lt;&lt; <span class="stringliteral">"-:"</span> &lt;&lt; ac_vq_user.<a class="code" href="classclnconf.html#clnconfa1">val_str</a>() &lt;&lt; <span class="charliteral">':'</span> 
00189         &lt;&lt; ac_vq_uid.<a class="code" href="classcintconf.html#cuidconfa2">val_str</a>() &lt;&lt; <span class="charliteral">':'</span> &lt;&lt; ac_vq_gid.<a class="code" href="classcintconf.html#cuidconfa2">val_str</a>() &lt;&lt; <span class="charliteral">':'</span>
00190         &lt;&lt; conf_home &lt;&lt; <span class="stringliteral">"/domains/"</span> &lt;&lt; split_dom(dom)
00191         &lt;&lt; <span class="charliteral">'/'</span> &lt;&lt; dom &lt;&lt; <span class="stringliteral">":-::"</span>;
00192     
00193     string ln(domln.str());
00194     string prog(conf_home+<span class="stringliteral">"/bin/qmail_assign_add"</span>);
00195     <span class="keywordtype">char</span> * <span class="keyword">const</span> args[] = {
00196             const_cast&lt;char *&gt;(prog.c_str()),
00197             const_cast&lt;char *&gt;(dom.c_str()),
00198             const_cast&lt;char *&gt;(ln.c_str()),
00199             NULL
00200     };
00201 
00202     <span class="keywordtype">int</span> ret = <a class="code" href="classcfsvq.html#cfsvqb10">run</a>(args);
00203     <span class="keywordflow">if</span>( WIFEXITED(ret) ) {
00204             <span class="keywordflow">switch</span>(WEXITSTATUS(ret)) {
00205             <span class="keywordflow">case</span> 0:
00206                     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw2">err_no</a>, <span class="stringliteral">""</span>);
00207             <span class="keywordflow">case</span> 1:
00208                     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw21">err_exists</a>, prog);
00209             }
00210     }
00211     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw19">err_exec</a>,prog);
00212 }
00213 
<a name="l00218"></a><a class="code" href="classcfsvq.html#cfsvqb0">00218</a> uint8_t <a class="code" href="classcfsvq.html#cfsvqb0">cfsvq::assign_ex</a>( <span class="keyword">const</span> string &amp;dom )
00219 {
00220     string prog(conf_home+<span class="stringliteral">"/bin/qmail_assign_ex"</span>);
00221     <span class="keywordtype">char</span> * <span class="keyword">const</span> args[] = {
00222             const_cast&lt;char *&gt;(prog.c_str()),
00223             const_cast&lt;char *&gt;(dom.c_str()),
00224             NULL
00225     };
00226 
00227     <span class="keywordtype">int</span> ret = <a class="code" href="classcfsvq.html#cfsvqb10">run</a>(args);
00228     <span class="keywordflow">if</span>( WIFEXITED(ret) ) {
00229             <span class="keywordflow">switch</span>(WEXITSTATUS(ret)) {
00230             <span class="keywordflow">case</span> 1:
00231                     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw2">err_no</a>,<span class="stringliteral">""</span>);
00232             <span class="keywordflow">case</span> 0:
00233                     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw21">err_exists</a>,prog);
00234             }
00235     }
00236     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw19">err_exec</a>, prog);
00237 }
<a name="l00244"></a><a class="code" href="classcfsvq.html#cfsvqb2">00244</a> uint8_t <a class="code" href="classcfsvq.html#cfsvqb2">cfsvq::assign_rm</a>( <span class="keyword">const</span> string &amp;dom )
00245 {   
00246     ostringstream domln;
00247     domln &lt;&lt; <span class="charliteral">'+'</span>&lt;&lt; dom &lt;&lt; <span class="stringliteral">"-:"</span> &lt;&lt; ac_vq_user.<a class="code" href="classclnconf.html#clnconfa1">val_str</a>() &lt;&lt; <span class="charliteral">':'</span> 
00248         &lt;&lt; ac_vq_uid.<a class="code" href="classcintconf.html#cuidconfa2">val_str</a>() &lt;&lt; <span class="charliteral">':'</span> &lt;&lt; ac_vq_gid.<a class="code" href="classcintconf.html#cuidconfa2">val_str</a>() &lt;&lt; <span class="charliteral">':'</span>
00249         &lt;&lt; conf_home &lt;&lt; <span class="stringliteral">"/domains/"</span> &lt;&lt; split_dom(dom)
00250         &lt;&lt; <span class="charliteral">'/'</span> &lt;&lt; dom &lt;&lt; <span class="stringliteral">":-::"</span>;
00251     
00252     string ln(domln.str());
00253     string prog(conf_home+<span class="stringliteral">"/bin/qmail_assign_rm"</span>);
00254     <span class="keywordtype">char</span> * <span class="keyword">const</span> args[] = {
00255             const_cast&lt;char *&gt;(prog.c_str()),
00256             const_cast&lt;char *&gt;(ln.c_str()),
00257             NULL
00258     };
00259 
00260     <span class="keywordtype">int</span> ret = <a class="code" href="classcfsvq.html#cfsvqb10">run</a>(args);
00261     <span class="keywordflow">if</span>( WIFEXITED(ret) ) {
00262             <span class="keywordflow">switch</span>(WEXITSTATUS(ret)) {
00263             <span class="keywordflow">case</span> 0: <span class="keywordflow">case</span> 1: <span class="keywordflow">case</span> 2:
00264                     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw2">err_no</a>, <span class="stringliteral">""</span>);
00265             }
00266     }
00267     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw19">err_exec</a>, prog);
00268 }
00269 
<a name="l00275"></a><a class="code" href="classcfsvq.html#cfsvqb3">00275</a> uint8_t <a class="code" href="classcfsvq.html#cfsvqb3">cfsvq::rcpt_add</a>(<span class="keyword">const</span> string &amp;dom)
00276 {
00277     string prog(conf_home+<span class="stringliteral">"/bin/qmail_rcpthosts_add"</span>);
00278     <span class="keywordtype">char</span> * <span class="keyword">const</span> args[] = {
00279             const_cast&lt;char *&gt;(prog.c_str()),
00280             const_cast&lt;char *&gt;(dom.c_str()),
00281             NULL
00282     };
00283 
00284     <span class="keywordtype">int</span> ret = <a class="code" href="classcfsvq.html#cfsvqb10">run</a>(args);
00285     <span class="keywordflow">if</span>( WIFEXITED(ret) ) {
00286             <span class="keywordflow">switch</span>(WEXITSTATUS(ret)) {
00287             <span class="keywordflow">case</span> 0: <span class="keywordflow">case</span> 1:
00288                     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw2">err_no</a>, <span class="stringliteral">""</span>);
00289             <span class="keywordflow">case</span> 2:
00290                     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw18">err_over</a>, prog);
00291             }
00292     }
00293     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw19">err_exec</a>, prog);
00294 }
00295 
<a name="l00300"></a><a class="code" href="classcfsvq.html#cfsvqb4">00300</a> uint8_t <a class="code" href="classcfsvq.html#cfsvqb4">cfsvq::rcpt_rm</a>(<span class="keyword">const</span> string &amp;dom)
00301 {
00302     <span class="keywordtype">char</span> file[] = { qf_rcpthosts, <span class="charliteral">'\0'</span> };
00303     string prog(conf_home+<span class="stringliteral">"/bin/qmail_file_rm"</span>);
00304     <span class="keywordtype">char</span> * <span class="keyword">const</span> args[] = {
00305             const_cast&lt;char *&gt;(prog.c_str()),
00306             file,
00307             const_cast&lt;char *&gt;(dom.c_str()),
00308             NULL
00309     };
00310 
00311     <span class="keywordtype">int</span> ret = <a class="code" href="classcfsvq.html#cfsvqb10">run</a>(args);
00312     <span class="keywordflow">if</span>( WIFEXITED(ret) ) {
00313             <span class="keywordflow">switch</span>(WEXITSTATUS(ret)) {
00314             <span class="keywordflow">case</span> 0: <span class="keywordflow">case</span> 1: <span class="keywordflow">case</span> 2:
00315                     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw2">err_no</a>, <span class="stringliteral">""</span>);
00316             }
00317     }
00318     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw19">err_exec</a>,prog);
00319 }
00320 
<a name="l00325"></a><a class="code" href="classcfsvq.html#cfsvqb7">00325</a> uint8_t <a class="code" href="classcfsvq.html#cfsvqb7">cfsvq::locals_rm</a>(<span class="keyword">const</span> string &amp;dom)
00326 {
00327     <span class="keywordtype">char</span> file[] = { qf_locals, <span class="charliteral">'\0'</span> };
00328     string prog(conf_home+<span class="stringliteral">"/bin/qmail_file_rm"</span>);
00329     <span class="keywordtype">char</span> * <span class="keyword">const</span> args[] = {
00330             const_cast&lt;char *&gt;(prog.c_str()),
00331             file,
00332             const_cast&lt;char *&gt;(dom.c_str()),
00333             NULL
00334     };
00335 
00336     <span class="keywordtype">int</span> ret = <a class="code" href="classcfsvq.html#cfsvqb10">run</a>(args);
00337     <span class="keywordflow">if</span>( WIFEXITED(ret) ) {
00338             <span class="keywordflow">switch</span>(WEXITSTATUS(ret)) {
00339             <span class="keywordflow">case</span> 0: <span class="keywordflow">case</span> 1: <span class="keywordflow">case</span> 2:
00340                     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw2">err_no</a>, <span class="stringliteral">""</span>);
00341             }
00342     }
00343     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw19">err_exec</a>, prog);
00344 }
00345 
<a name="l00354"></a><a class="code" href="classcfsvq.html#a2">00354</a> uint8_t <a class="code" href="group__file.html#a2">cfsvq::file_rm</a>( <span class="keyword">const</span> std::string &amp; fn, <span class="keyword">const</span> std::string &amp; item,
00355         std::string &amp; fntmp ) {
00356 
00357     fntmp = fn+uniq();
00358     string fnlck(fn+<span class="stringliteral">".lock"</span>);
00359 
00360     opfstream lock(fnlck.c_str());
00361     <span class="keywordflow">if</span>( ! lock ) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw9">err_open</a>, fnlck);
00362 
00363     <span class="keywordflow">if</span>( lock_exnb(lock.rdbuf()-&gt;fd()) ) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw15">err_lckd</a>, fnlck);
00364 
00365     ipfstream in(fn.c_str(),ios::in);
00366     <span class="keywordflow">if</span>(!in) {
00367             <span class="keywordflow">if</span>( errno == ENOENT ) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw2">err_no</a>, <span class="stringliteral">""</span>);
00368             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw9">err_open</a>, fn);
00369     }
00370     opfstream tmp(fntmp.c_str(),ios::trunc);
00371     <span class="keywordflow">if</span>(!tmp) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw9">err_open</a>, fntmp);
00372     
00373     string ln;
00374     <span class="keywordflow">while</span>( getline(in,ln) &amp;&amp; tmp.good() ) {
00375             <span class="keywordflow">if</span>(ln==item) <span class="keywordflow">continue</span>;
00376             tmp&lt;&lt;ln&lt;&lt;endl;
00377     }
00378     <span class="keywordflow">if</span>(in.bad()) {
00379             unlink(fntmp.c_str());
00380             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw11">err_rd</a>, fn);
00381     }
00382     tmp.close();
00383     <span class="keywordflow">if</span>(! tmp) {
00384             unlink(fntmp.c_str());
00385             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw10">err_wr</a>, fntmp);
00386     }
00387 
00388     <span class="keyword">struct </span>stat st;
00389     <span class="keywordflow">if</span>(!fstat(in.rdbuf()-&gt;fd(), &amp;st)) {
00390             <span class="keywordflow">if</span>( chown(fntmp.c_str(), st.st_uid, st.st_gid) )
00391                     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw17">err_chown</a>, fntmp);
00392             <span class="keywordflow">if</span>( chmod(fntmp.c_str(), st.st_mode &amp; 07777 ) )
00393                     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw14">err_chmod</a>, fntmp);
00394     } <span class="keywordflow">else</span> 
00395             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw12">err_stat</a>, fntmp);
00396     
00397     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw2">err_no</a>, <span class="stringliteral">""</span>);
00398 }
00399 
<a name="l00404"></a><a class="code" href="classcfsvq.html#cfsvqb8">00404</a> uint8_t <a class="code" href="classcfsvq.html#cfsvqb8">cfsvq::virt_add</a>(<span class="keyword">const</span> string &amp;dom,<span class="keyword">const</span> string &amp;al)
00405 {
00406     string ln(dom+<span class="charliteral">':'</span>+al);
00407     string prog(conf_home+<span class="stringliteral">"/bin/qmail_virtualdomains_add"</span>);
00408     <span class="keywordtype">char</span> * <span class="keyword">const</span> args[] = {
00409             const_cast&lt;char *&gt;(prog.c_str()),
00410             const_cast&lt;char *&gt;(dom.c_str()),
00411             const_cast&lt;char *&gt;(ln.c_str()),
00412             NULL
00413     };
00414 
00415     <span class="keywordtype">int</span> ret = <a class="code" href="classcfsvq.html#cfsvqb10">run</a>(args);
00416     <span class="keywordflow">if</span>( WIFEXITED(ret) ) {
00417             <span class="keywordflow">switch</span>(WEXITSTATUS(ret)) {
00418             <span class="keywordflow">case</span> 0:
00419                     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw2">err_no</a>, <span class="stringliteral">""</span>);
00420             <span class="keywordflow">case</span> 1:
00421                     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw21">err_exists</a>, prog);
00422             }
00423     }
00424     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw19">err_exec</a>, prog);
00425 }
00426 
<a name="l00433"></a><a class="code" href="classcfsvq.html#cfsvqb9">00433</a> uint8_t <a class="code" href="classcfsvq.html#cfsvqb9">cfsvq::virt_rm</a>(<span class="keyword">const</span> string &amp;ali)
00434 {
00435     string prog(conf_home+<span class="stringliteral">"/bin/qmail_virtualdomains_rm"</span>);
00436     <span class="keywordtype">char</span> * <span class="keyword">const</span> args[] = {
00437             const_cast&lt;char *&gt;(prog.c_str()),
00438             const_cast&lt;char *&gt;(ali.c_str()),
00439             NULL
00440     };
00441 
00442     <span class="keywordtype">int</span> ret = <a class="code" href="classcfsvq.html#cfsvqb10">run</a>(args);
00443     <span class="keywordflow">if</span>( WIFEXITED(ret) ) {
00444             <span class="keywordflow">switch</span>(WEXITSTATUS(ret)) {
00445             <span class="keywordflow">case</span> 0: <span class="keywordflow">case</span> 1: <span class="keywordflow">case</span> 2:
00446                     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw2">err_no</a>, <span class="stringliteral">""</span>);
00447             }
00448     }
00449     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw19">err_exec</a>, prog);
00450 }
00451 
<a name="l00456"></a><a class="code" href="classcfsvq.html#cfsvqb5">00456</a> uint8_t <a class="code" href="classcfsvq.html#cfsvqb5">cfsvq::morercpt_add</a>(<span class="keyword">const</span> string &amp;dom)
00457 {
00458     string prog(conf_home+<span class="stringliteral">"/bin/qmail_mrh_add"</span>);
00459     <span class="keywordtype">char</span> * <span class="keyword">const</span> args[] = {
00460             const_cast&lt;char *&gt;(prog.c_str()),
00461             const_cast&lt;char *&gt;(dom.c_str()),
00462             NULL
00463     };
00464 
00465     <span class="keywordtype">int</span> ret = <a class="code" href="classcfsvq.html#cfsvqb10">run</a>(args);
00466     <span class="keywordflow">if</span>( WIFEXITED(ret) ) {
00467             <span class="keywordflow">switch</span>(WEXITSTATUS(ret)) {
00468             <span class="keywordflow">case</span> 0: <span class="keywordflow">case</span> 1:
00469                     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw2">err_no</a>, <span class="stringliteral">""</span>);
00470             }
00471     }
00472     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw19">err_exec</a>, prog);
00473 }
00474 
<a name="l00484"></a><a class="code" href="classcfsvq.html#a0">00484</a> uint8_t <a class="code" href="group__file.html#a0">cfsvq::file_add</a>( <span class="keyword">const</span> string &amp; fn, <span class="keyword">const</span> string &amp;item,
00485         string &amp; fntmp, <span class="keywordtype">bool</span> beg_at ) {
00486 
00487     fntmp = fn+uniq();
00488     string fnlck(fn+<span class="stringliteral">".lock"</span>);
00489     opfstream lock(fnlck.c_str());
00490     <span class="keywordflow">if</span>( ! lock ) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw9">err_open</a>, fnlck);
00491 
00492     <span class="keywordflow">if</span>( lock_exnb(lock.rdbuf()-&gt;fd()) ) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw15">err_lckd</a>, fnlck);
00493 
00494     ipfstream in(fn.c_str());
00495     <span class="keywordtype">bool</span> enoent = <span class="keyword">false</span>;
00496     <span class="keywordflow">if</span>(!in) {
00497             <span class="keywordflow">if</span>( errno != ENOENT ) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw9">err_open</a>, fn);
00498             enoent = <span class="keyword">true</span>;
00499     }
00500 
00501     opfstream tmp(fntmp.c_str(),ios::trunc);
00502     <span class="keywordflow">if</span>(!tmp) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw9">err_open</a>, fntmp);
00503 
00504     <span class="keywordflow">if</span>( ! enoent ) {
00505             string ln;
00506             <span class="keywordflow">if</span>(beg_at) tmp&lt;&lt;item&lt;&lt;endl;
00507 
00508             <span class="keywordflow">while</span>( getline(in,ln) &amp;&amp; tmp.good() ) {
00509                     <span class="keywordflow">if</span>( item == ln ) <span class="keywordflow">continue</span>;
00510                     tmp&lt;&lt;ln&lt;&lt;endl;
00511             }
00512             <span class="keywordflow">if</span>( in.bad() ) {
00513                     unlink(fntmp.c_str());
00514                     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw11">err_rd</a>, fn);
00515             }
00516     }
00517     <span class="keywordflow">if</span>(!beg_at) tmp&lt;&lt;item&lt;&lt;endl;
00518     tmp.close();
00519     <span class="keywordflow">if</span>( tmp.bad() ) {
00520             unlink(fntmp.c_str());
00521             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw10">err_wr</a>, fntmp);
00522     }
00523 
00524     <span class="keywordflow">if</span>( ! enoent ) {
00525             <span class="comment">// try to preserve all of file's information, ignore errors</span>
00526             <span class="keyword">struct </span>stat st;
00527             <span class="keywordflow">if</span>(!fstat(in.rdbuf()-&gt;fd(), &amp;st)) {
00528                     <span class="keywordflow">if</span>( chown( fntmp.c_str(), st.st_uid, st.st_gid) )
00529                             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw17">err_chown</a>, fntmp);
00530                     <span class="keywordflow">if</span>( chmod( fntmp.c_str(), st.st_mode &amp; 07777 ) )
00531                             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw14">err_chmod</a>, fntmp);
00532             } <span class="keywordflow">else</span>
00533                     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw12">err_stat</a>, fn);
00534     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( chmod(fntmp.c_str(), ac_vq_fmode.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>()) )
00535             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw14">err_chmod</a>, fntmp);
00536     
00537     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw2">err_no</a>, <span class="stringliteral">""</span>);
00538 }
00539 
<a name="l00544"></a><a class="code" href="classcfsvq.html#cfsvqb6">00544</a> uint8_t <a class="code" href="classcfsvq.html#cfsvqb6">cfsvq::morercpt_rm</a>(<span class="keyword">const</span> string &amp;dom)
00545 {
00546     string prog(conf_home+<span class="stringliteral">"/bin/qmail_mrh_rm"</span>);
00547     <span class="keywordtype">char</span> * <span class="keyword">const</span> args[] = {
00548             const_cast&lt;char *&gt;(prog.c_str()),
00549             const_cast&lt;char *&gt;(dom.c_str()),
00550             NULL
00551     };
00552 
00553     <span class="keywordtype">int</span> ret = <a class="code" href="classcfsvq.html#cfsvqb10">run</a>(args);
00554     <span class="keywordflow">if</span>( WIFEXITED(ret) ) {
00555             <span class="keywordflow">switch</span>(WEXITSTATUS(ret)) {
00556             <span class="keywordflow">case</span> 0: <span class="keywordflow">case</span> 1: <span class="keywordflow">case</span> 2:
00557                     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw2">err_no</a>, <span class="stringliteral">""</span>);
00558             }
00559     }
00560     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw19">err_exec</a>, prog);
00561 }
00562 
<a name="l00568"></a><a class="code" href="classcfsvq.html#cfsvqb11">00568</a> uint8_t <a class="code" href="classcfsvq.html#cfsvqb11">cfsvq::maildirmake</a>(<span class="keyword">const</span> string &amp; d)
00569 {
00570     <span class="keywordflow">if</span>( mkdir(d.c_str(), ac_vq_mode.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>() )
00571         || chown(d.c_str(), ac_vq_uid.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>(), ac_vq_gid.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>())) <span class="keywordflow">return</span> 1;
00572     string dir = d+<span class="stringliteral">"/new"</span>; 
00573     <span class="keywordflow">if</span>( mkdir(dir.c_str(), ac_vq_mode.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>() ) 
00574         || chown(dir.c_str(), ac_vq_uid.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>(), ac_vq_gid.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>())) <span class="keywordflow">return</span> 1;
00575     dir = d+<span class="stringliteral">"/cur"</span>;
00576     <span class="keywordflow">if</span>( mkdir(dir.c_str(), ac_vq_mode.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>() ) 
00577         || chown(dir.c_str(), ac_vq_uid.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>(), ac_vq_gid.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>())) <span class="keywordflow">return</span> 1;
00578     dir = d+<span class="stringliteral">"/tmp"</span>;
00579     <span class="keywordflow">if</span>( mkdir(dir.c_str(), ac_vq_mode.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>() ) 
00580         || chown(dir.c_str(), ac_vq_uid.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>(), ac_vq_gid.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>())) <span class="keywordflow">return</span> 1;
00581     <span class="keywordflow">return</span> 0;
00582 }
00583 
<a name="l00588"></a><a class="code" href="classcfsvq.html#a1">00588</a> string <a class="code" href="group__qt.html#a1">cfsvq::qtfile</a>(<span class="keyword">const</span> string &amp;d, <span class="keyword">const</span> string &amp;u) {
00589     string dom(lower(d)), user(lower(u));
00590     string <a class="code" href="group__qt.html#a1">qtfile</a> = conf_home+<span class="stringliteral">"/domains/"</span>+split_dom(dom)+<span class="charliteral">'/'</span>+dom
00591             +<span class="charliteral">'/'</span>+split_user(user)+<span class="charliteral">'/'</span>+user+<span class="stringliteral">"/Maildir/.quota"</span>;
00592     <span class="keywordflow">return</span> qtfile;
00593 }
00594 
<a name="l00599"></a><a class="code" href="classcfsvq.html#a6">00599</a> string <a class="code" href="group__qt.html#a1">cfsvq::qtfile</a>(<span class="keyword">const</span> string &amp;d) {
00600     string dom(lower(d));
00601     string <a class="code" href="group__qt.html#a1">qtfile</a> = conf_home+<span class="stringliteral">"/domains/"</span>+split_dom(dom)+<span class="charliteral">'/'</span>+dom
00602             +<span class="stringliteral">"/.quota"</span>;
00603     <span class="keywordflow">return</span> qtfile;
00604 }
<a name="l00608"></a><a class="code" href="classcfsvq.html#a7">00608</a> string <a class="code" href="group__qt.html#a8">cfsvq::qtfile_def</a>(<span class="keyword">const</span> string &amp;d) {
00609     string dom(lower(d));
00610     string <a class="code" href="group__qt.html#a1">qtfile</a> = conf_home+<span class="stringliteral">"/domains/"</span>+split_dom(dom)+<span class="charliteral">'/'</span>+dom
00611             +<span class="stringliteral">"/.quota-default"</span>;
00612     <span class="keywordflow">return</span> qtfile;
00613 }
<a name="l00617"></a><a class="code" href="classcfsvq.html#a8">00617</a> string <a class="code" href="group__qt.html#a8">cfsvq::qtfile_def</a>() {
00618     <span class="keywordflow">return</span> conf_home+<span class="stringliteral">"/domains/.quota-default"</span>;
00619 }
00620 
<a name="l00626"></a><a class="code" href="classcfsvq.html#a0">00626</a> uint8_t <a class="code" href="group__qt.html#a0">cfsvq::qtf_cur_set</a>(<span class="keyword">const</span> string &amp;qtfile, int32_t c) {
00627     <a class="code" href="classcvq.html#cvqw0">quota_value</a> cq;
00628     pfstream qtf(qtfile.c_str(), ios::in | ios::out);
00629     <span class="keywordflow">if</span>(!qtf) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw9">err_open</a>, qtfile);
00630 
00631     qtf.read(reinterpret_cast&lt;char *&gt;(&amp;cq), <span class="keyword">sizeof</span>(cq));
00632     <span class="keywordflow">if</span> ( c &lt; 0 ) {
00633       <span class="keywordflow">if</span>( -c &gt; cq ) cq = 0;
00634       <span class="keywordflow">else</span> cq+=c;
00635     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( c &gt; 0 ) {
00636       <span class="keywordflow">if</span> ( cq &gt;= 0xffffffff/2 &amp;&amp; cq&lt;=c ) cq = 0xffffffff;
00637       <span class="keywordflow">else</span> cq += c;
00638     } <span class="keywordflow">else</span> <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw2">err_no</a>, <span class="stringliteral">""</span>);
00639 
00640     qtf.seekp(0);
00641     qtf.write(reinterpret_cast&lt;char *&gt;(&amp;cq),<span class="keyword">sizeof</span>(cq));
00642     qtf.flush();
00643     qtf.close();
00644     
00645     <span class="keywordflow">if</span>(!qtf) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw10">err_wr</a>, qtfile);
00646     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw2">err_no</a>, <span class="stringliteral">""</span>);
00647 }
00648 
<a name="l00655"></a><a class="code" href="classcfsvq.html#a0">00655</a> uint8_t <a class="code" href="group__qt__user.html#a0">cfsvq::qt_cur_set</a>(<span class="keyword">const</span> string&amp;d, <span class="keyword">const</span> string &amp;u, int32_t c) {
00656     <span class="keywordflow">return</span> <a class="code" href="group__qt.html#a0">qtf_cur_set</a>(<a class="code" href="group__qt.html#a1">qtfile</a>(d,u), c);
00657 }
00658 
<a name="l00664"></a><a class="code" href="classcfsvq.html#a0">00664</a> uint8_t <a class="code" href="group__qt__dom.html#a0">cfsvq::qt_dom_cur_set</a>(<span class="keyword">const</span> string &amp;d, int32_t c) {
00665     <span class="keywordflow">return</span> <a class="code" href="group__qt.html#a0">qtf_cur_set</a>(<a class="code" href="group__qt.html#a1">qtfile</a>(d), c);
00666 }
00667 
<a name="l00672"></a><a class="code" href="classcfsvq.html#a9">00672</a> uint8_t <a class="code" href="group__qt.html#a9">cfsvq::qtf_set</a>(<span class="keyword">const</span> string &amp;qtfile, quota_value c) {
00673     pfstream qtf(qtfile.c_str(), ios::in | ios::out );
00674     <a class="code" href="classcvq.html#cvqw0">quota_value</a> z = 0;
00675     <span class="keywordflow">if</span>(qtf) {
00676             qtf.read(reinterpret_cast&lt;char *&gt;(&amp;z),<span class="keyword">sizeof</span>(z));
00677             qtf.clear();
00678             qtf.seekp(0, ios::beg);
00679     } <span class="keywordflow">else</span> {
00680             qtf.clear();
00681             qtf.open(qtfile.c_str(), ios::out );
00682             <span class="keywordflow">if</span>(!qtf) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw9">err_open</a>, qtfile);
00683             
00684             <span class="keywordflow">if</span>(fchown(qtf.rdbuf()-&gt;fd(), ac_vq_uid.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>(), ac_vq_gid.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>() ) )
00685                     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw17">err_chown</a>, qtfile);
00686             <span class="keywordflow">if</span>(fchmod(qtf.rdbuf()-&gt;fd(), ac_vq_fmode.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>()) )
00687                     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw14">err_chmod</a>, qtfile);
00688     }           
00689     qtf.write(reinterpret_cast&lt;char *&gt;(&amp;z),<span class="keyword">sizeof</span>(z));
00690     qtf.write(reinterpret_cast&lt;char *&gt;(&amp;c),<span class="keyword">sizeof</span>(c));
00691     qtf.flush();
00692     qtf.close();
00693     <span class="keywordflow">if</span>(!qtf) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw10">err_wr</a>, qtfile);
00694     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw2">err_no</a>, <span class="stringliteral">""</span>);
00695 }
00696 
<a name="l00704"></a><a class="code" href="classcfsvq.html#a9">00704</a> uint8_t <a class="code" href="group__qt__user.html#a9">cfsvq::qt_set</a>(<span class="keyword">const</span> string &amp;d, <span class="keyword">const</span> string &amp;u, quota_value c) {
00705     <span class="keywordflow">return</span> <a class="code" href="group__qt.html#a9">qtf_set</a>(<a class="code" href="group__qt.html#a1">qtfile</a>(d,u), c);
00706 }
00707 
<a name="l00714"></a><a class="code" href="classcfsvq.html#a9">00714</a> uint8_t <a class="code" href="group__qt__dom.html#a9">cfsvq::qt_dom_set</a>(<span class="keyword">const</span> string &amp;d, quota_value c) {
00715     <span class="keywordflow">return</span> <a class="code" href="group__qt.html#a9">qtf_set</a>(<a class="code" href="group__qt.html#a1">qtfile</a>(d), c);
00716 }
00717 
<a name="l00723"></a><a class="code" href="classcfsvq.html#a10">00723</a> uint8_t <a class="code" href="group__qt.html#a9">cfsvq::qtf_set</a>(<span class="keyword">const</span> string &amp;qtfile, quota_value cm, quota_value cc) {
00724     opfstream qtf(qtfile.c_str());
00725     <span class="keywordflow">if</span>(!qtf) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw9">err_open</a>, qtfile);
00726     qtf.write(reinterpret_cast&lt;char *&gt;(&amp;cc),<span class="keyword">sizeof</span>(cc));
00727     qtf.write(reinterpret_cast&lt;char *&gt;(&amp;cm),<span class="keyword">sizeof</span>(cm));
00728     qtf.flush();
00729     qtf.close();
00730     <span class="keywordflow">if</span>(!qtf) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw10">err_wr</a>, qtfile);
00731     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw2">err_no</a>, <span class="stringliteral">""</span>);
00732 }
00733 
<a name="l00741"></a><a class="code" href="classcfsvq.html#a10">00741</a> uint8_t <a class="code" href="group__qt__user.html#a9">cfsvq::qt_set</a>(<span class="keyword">const</span> string &amp;d, <span class="keyword">const</span> string &amp;u, quota_value qm, quota_value qc) {
00742     <span class="keywordflow">return</span> <a class="code" href="group__qt.html#a9">qtf_set</a>(<a class="code" href="group__qt.html#a1">qtfile</a>(d,u), qm, qc);
00743 }
00744 
<a name="l00751"></a><a class="code" href="classcfsvq.html#a10">00751</a> uint8_t <a class="code" href="group__qt__dom.html#a9">cfsvq::qt_dom_set</a>(<span class="keyword">const</span> string &amp;d, quota_value qm, quota_value qc) {
00752     <span class="keywordflow">return</span> <a class="code" href="group__qt.html#a9">qtf_set</a>(<a class="code" href="group__qt.html#a1">qtfile</a>(d), qm, qc);
00753 }
00754 
<a name="l00761"></a><a class="code" href="classcfsvq.html#a12">00761</a> uint8_t <a class="code" href="group__qt.html#a12">cfsvq::qtf_get</a>(<span class="keyword">const</span> string &amp;qtfile, quota_value &amp; cm, quota_value &amp; cc) {
00762     ipfstream qtf(qtfile.c_str());
00763     <span class="keywordflow">if</span>(!qtf) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw9">err_open</a>, qtfile);
00764     qtf.read(reinterpret_cast&lt;char *&gt;(&amp;cc),<span class="keyword">sizeof</span>(cc));
00765     qtf.read(reinterpret_cast&lt;char *&gt;(&amp;cm),<span class="keyword">sizeof</span>(cm));
00766     qtf.close();
00767     <span class="keywordflow">if</span>(!qtf) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw10">err_wr</a>, qtfile);
00768     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw2">err_no</a>, <span class="stringliteral">""</span>);
00769 }
00770 
<a name="l00778"></a><a class="code" href="classcfsvq.html#a11">00778</a> uint8_t <a class="code" href="group__qt__user.html#a11">cfsvq::qt_get</a>(<span class="keyword">const</span> string &amp;d, <span class="keyword">const</span> string &amp;u, 
00779         quota_value &amp;qm, quota_value &amp; qc) {
00780     <span class="keywordflow">return</span> <a class="code" href="group__qt.html#a12">qtf_get</a>(<a class="code" href="group__qt.html#a1">qtfile</a>(d,u).c_str(), qm, qc);
00781 }
00782 
<a name="l00789"></a><a class="code" href="classcfsvq.html#a12">00789</a> uint8_t <a class="code" href="group__qt__dom.html#a12">cfsvq::qt_dom_get</a>(<span class="keyword">const</span> string&amp;d, quota_value &amp; qm, quota_value &amp; qc) {
00790     <span class="keywordflow">return</span> <a class="code" href="group__qt.html#a12">qtf_get</a>(<a class="code" href="group__qt.html#a1">qtfile</a>(d).c_str(), qm, qc);
00791 }
00792 
<a name="l00797"></a><a class="code" href="classcfsvq.html#a11">00797</a> uint8_t <a class="code" href="group__qt.html#a11">cfsvq::qtf_over</a>(<span class="keyword">const</span> string &amp;qtfile) {
00798     ipfstream qtf(qtfile.c_str());
00799     <span class="keywordflow">if</span>(!qtf) <span class="keywordflow">return</span> 0; <span class="comment">// no quota file</span>
00800     <a class="code" href="classcvq.html#cvqw0">quota_value</a> qc, qm;
00801     qtf.read(reinterpret_cast&lt;char *&gt;(&amp;qc),<span class="keyword">sizeof</span>(qc));
00802     qtf.read(reinterpret_cast&lt;char *&gt;(&amp;qm),<span class="keyword">sizeof</span>(qm));
00803     <span class="keywordflow">if</span>(!qtf || !qm) <span class="keywordflow">return</span> 0;
00804     <span class="keywordflow">return</span> qc &lt; qm ? 0 : 1;
00805 }
00806 
<a name="l00811"></a><a class="code" href="classcfsvq.html#a12">00811</a> uint8_t <a class="code" href="group__qt__user.html#a12">cfsvq::qt_over</a>(<span class="keyword">const</span> string &amp;d, <span class="keyword">const</span> string &amp;u) {
00812     <span class="keywordflow">return</span> <a class="code" href="group__qt.html#a11">qtf_over</a>(<a class="code" href="group__qt.html#a1">qtfile</a>(d,u));
00813 }
00814 
<a name="l00819"></a><a class="code" href="classcfsvq.html#a11">00819</a> uint8_t <a class="code" href="group__qt__dom.html#a11">cfsvq::qt_dom_over</a>(<span class="keyword">const</span> string &amp;d) {
00820     <span class="keywordflow">return</span> <a class="code" href="group__qt.html#a11">qtf_over</a>(<a class="code" href="group__qt.html#a1">qtfile</a>(d));
00821 }
00822 
<a name="l00826"></a><a class="code" href="classcfsvq.html#a13">00826</a> uint8_t <a class="code" href="group__qt__user.html#a13">cfsvq::qt_def_set</a>(<span class="keyword">const</span> string &amp;d, quota_value qm) {
00827     <span class="keywordflow">return</span> <a class="code" href="group__qt.html#a9">qtf_set</a>(<a class="code" href="group__qt.html#a8">qtfile_def</a>(d), qm);
00828 }
00829 
<a name="l00833"></a><a class="code" href="classcfsvq.html#a13">00833</a> uint8_t <a class="code" href="group__qt__dom.html#a13">cfsvq::qt_dom_def_set</a>(quota_value qm) {
00834     <span class="keywordflow">return</span> <a class="code" href="group__qt.html#a9">qtf_set</a>(<a class="code" href="group__qt.html#a8">qtfile_def</a>(), qm);
00835 }
00836 
<a name="l00840"></a><a class="code" href="classcfsvq.html#a14">00840</a> uint8_t <a class="code" href="group__qt__user.html#a14">cfsvq::qt_def_get</a>(<span class="keyword">const</span> string &amp;d, quota_value &amp; qm) {
00841     <a class="code" href="classcvq.html#cvqw0">quota_value</a> qc;
00842     <span class="keywordflow">return</span> <a class="code" href="group__qt.html#a12">qtf_get</a>(<a class="code" href="group__qt.html#a8">qtfile_def</a>(d), qm, qc);
00843 }
00844 
<a name="l00848"></a><a class="code" href="classcfsvq.html#a14">00848</a> uint8_t <a class="code" href="group__qt__dom.html#a14">cfsvq::qt_dom_def_get</a>(quota_value &amp; qm) {
00849     <a class="code" href="classcvq.html#cvqw0">quota_value</a> qc;
00850     <span class="keywordflow">return</span> <a class="code" href="group__qt.html#a12">qtf_get</a>(<a class="code" href="group__qt.html#a8">qtfile_def</a>(), qm, qc);
00851 }
00852 
<a name="l00856"></a><a class="code" href="classcfsvq.html#a15">00856</a> uint8_t <a class="code" href="group__qt__user.html#a15">cfsvq::qt_def_cp</a>(<span class="keyword">const</span> string &amp;d, <span class="keyword">const</span> string &amp;u) {
00857     uint8_t ret;
00858     <a class="code" href="classcvq.html#cvqw0">quota_value</a> qc, qm;
00859     ret = <a class="code" href="group__qt.html#a12">qtf_get</a>(<a class="code" href="group__qt.html#a8">qtfile_def</a>(d), qm, qc);
00860     <span class="keywordflow">if</span>( ret ) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(ret, <span class="stringliteral">""</span>);
00861     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__qt__user.html#a9">qt_set</a>(d,u,qm), <span class="stringliteral">""</span>);
00862 }
00863 
<a name="l00867"></a><a class="code" href="classcfsvq.html#a15">00867</a> uint8_t <a class="code" href="group__qt__dom.html#a15">cfsvq::qt_dom_def_cp</a>(<span class="keyword">const</span> string &amp;d) {
00868     uint8_t ret;
00869     <a class="code" href="classcvq.html#cvqw0">quota_value</a> qc, qm;
00870     ret = <a class="code" href="group__qt.html#a12">qtf_get</a>(<a class="code" href="group__qt.html#a8">qtfile_def</a>(), qm, qc);
00871     <span class="keywordflow">if</span>( ret ) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(ret, <span class="stringliteral">""</span>);
00872     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__qt__dom.html#a9">qt_dom_set</a>(d,qm), <span class="stringliteral">""</span>);
00873 }
00874 
<a name="l00878"></a><a class="code" href="classcfsvq.html#cfsvqb16">00878</a> <span class="keywordtype">void</span> <a class="code" href="classcfsvq.html#cfsvqb16">cfsvq::assert_auth</a>() {
00879     <span class="keywordflow">if</span>(!<a class="code" href="classcfsvq.html#cfsvqp0">auth</a>.get())
00880             <a class="code" href="classcfsvq.html#cfsvqp0">auth</a>.reset(<a class="code" href="classcauth.html#cdaemonauthe0">cauth::alloc</a>());
00881 }
00882 
<a name="l00890"></a><a class="code" href="classcfsvq.html#a11">00890</a> uint8_t <a class="code" href="group__udot.html#a11">cfsvq::udot_add</a>(<span class="keyword">const</span> string &amp;d, <span class="keyword">const</span> string &amp;u, <span class="keyword">const</span> string &amp;e,
00891         udot_info &amp; ui ) {
00892     <a class="code" href="classcfsvq.html#cfsvqb16">assert_auth</a>();
00893     string dom(lower(d)), user(lower(u)), ext(lower(e));
00894     string df(<a class="code" href="group__udot.html#a10">dotfile</a>(dom, user, ext)), dftmp;
00895     string ln(<a class="code" href="group__udot.html#a41">udot_ln</a>(ui));
00896     <span class="keywordflow">if</span>(ln.empty()) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw2">err_no</a>, <span class="stringliteral">""</span>);
00897 
00898     <span class="keywordflow">if</span>( <a class="code" href="group__file.html#a0">file_add</a>(df, ln, dftmp, ui.type == <a class="code" href="classcvq.html#cvqw35cvqw32">autoresp</a> || ui.type == <a class="code" href="classcvq.html#cvqw35cvqw31">sms</a>) )
00899             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a8">lastret</a>;
00900     
00901     <span class="keywordflow">if</span>(<a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;udot_add(dom,user,ext,ui)) {
00902             unlink(dftmp.c_str());
00903             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw7">err_auth</a>, <a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;err_report());
00904     }
00905     <span class="keywordflow">if</span>( rename(dftmp.c_str(), df.c_str()) ) {
00906             unlink(dftmp.c_str());
00907             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw16">err_ren</a>, dftmp);
00908     }
00909     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>( <a class="code" href="group__err.html#a16cvqw2">err_no</a>, <span class="stringliteral">""</span> );
00910 }
00911 
<a name="l00919"></a><a class="code" href="classcfsvq.html#a31">00919</a> uint8_t <a class="code" href="group__udot.html#a31">cfsvq::udot_rm</a>(<span class="keyword">const</span> string &amp;d, 
00920                 <span class="keyword">const</span> string &amp;user, <span class="keyword">const</span> string &amp;ext,
00921                 <span class="keyword">const</span> string &amp; id) {
00922     <a class="code" href="classcfsvq.html#cfsvqb16">assert_auth</a>();
00923     udot_info ui;
00924     ui.id = id;
00925     <span class="keywordflow">if</span>(<a class="code" href="group__udot.html#a35">udot_get</a>(d, ui)) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a8">lastret</a>;
00926 
00927     string dom(lower(d));
00928     string df(<a class="code" href="group__udot.html#a10">dotfile</a>(dom, lower(user), lower(ext)));
00929     string ln(<a class="code" href="group__udot.html#a41">udot_ln</a>(ui));
00930     <span class="keywordflow">if</span>(ln.empty()) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw2">err_no</a>, <span class="stringliteral">""</span>);
00931 
00932     <span class="comment">// is it portable?? may be on some systems it will block?</span>
00933     opfstream dout;
00934     string dftmp;
00935     <span class="keywordflow">if</span>( <a class="code" href="group__file.html#a3">tmp_crt</a>(df, dout, dftmp) != <a class="code" href="group__err.html#a16cvqw2">err_no</a> ) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a8">lastret</a>;
00936     
00937     ipfstream din(df.c_str());
00938     <span class="keywordflow">if</span>(din) {
00939             string cln;
00940             <span class="keywordflow">while</span>(getline(din, cln)) {
00941                     <span class="keywordflow">if</span>(cln!=ln &amp;&amp; !cln.empty()) {
00942                             dout&lt;&lt;cln&lt;&lt;endl;
00943                             <span class="keywordflow">if</span>(!dout) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw10">err_wr</a>, dftmp);
00944                     }
00945             }
00946             <span class="keywordflow">if</span>(din.bad()) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw11">err_rd</a>, df);
00947             din.clear();
00948     }
00949 
00950     dout.flush();
00951     <span class="keywordflow">if</span>(!dout) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw10">err_wr</a>, dftmp);
00952 
00953     <span class="keywordflow">if</span>(<a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;udot_rm(dom,id)) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw7">err_auth</a>, <a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;err_report());
00954     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(rename(dftmp.c_str(), df.c_str()) ? <a class="code" href="group__err.html#a16cvqw16">err_ren</a> : <a class="code" href="group__err.html#a16cvqw2">err_no</a>, dftmp);
00955 }
00956 
<a name="l00964"></a><a class="code" href="classcfsvq.html#a32">00964</a> uint8_t <a class="code" href="group__udot.html#a32">cfsvq::udot_ls</a>(<span class="keyword">const</span> string &amp;d, <span class="keyword">const</span> string &amp;u,
00965         <span class="keyword">const</span> string &amp;e, vector&lt;udot_info&gt; &amp; uideq) {
00966     <a class="code" href="classcfsvq.html#cfsvqb16">assert_auth</a>();
00967     string dom(lower(d)), user(lower(u));
00968     <span class="keywordflow">if</span>(<a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;udot_ls(dom,user,lower(e),uideq)) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw7">err_auth</a>, <a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;err_report());
00969     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw2">err_no</a>, <span class="stringliteral">""</span>);
00970 }
00971 
<a name="l00980"></a><a class="code" href="classcfsvq.html#a33">00980</a> uint8_t <a class="code" href="group__udot.html#a32">cfsvq::udot_ls</a>(<span class="keyword">const</span> string &amp;d, <span class="keyword">const</span> string &amp;u,
00981         <span class="keyword">const</span> string &amp;e, udot_type type, vector&lt;udot_info&gt; &amp; uideq) {
00982     <a class="code" href="classcfsvq.html#cfsvqb16">assert_auth</a>();
00983     string dom(lower(d)), user(lower(u));
00984     <span class="keywordflow">if</span>(<a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;udot_ls(dom,user,lower(e),type,uideq)) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw7">err_auth</a>, <a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;err_report());
00985     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw2">err_no</a>, <span class="stringliteral">""</span>);
00986 }
00987 
<a name="l00991"></a><a class="code" href="classcfsvq.html#a34">00991</a> uint8_t <a class="code" href="group__udot.html#a34">cfsvq::udot_rep</a>(<span class="keyword">const</span> string &amp;d, <span class="keyword">const</span> string &amp;u, 
00992         <span class="keyword">const</span> string &amp;e, <span class="keyword">const</span> udot_info &amp; uin) {
00993     <a class="code" href="classcfsvq.html#cfsvqb16">assert_auth</a>();
00994 
00995     udot_info uio;
00996     uio.id = uin.id;
00997     <span class="keywordflow">if</span>(<a class="code" href="group__udot.html#a35">udot_get</a>(d, uio)) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a8">lastret</a>;
00998 
00999     string dom(lower(d));
01000     string df(<a class="code" href="group__udot.html#a10">dotfile</a>(dom, lower(u), lower(e)));
01001     string lno(<a class="code" href="group__udot.html#a41">udot_ln</a>(uio)), lnn(<a class="code" href="group__udot.html#a41">udot_ln</a>(uin));
01002     <span class="keywordflow">if</span>(lno.empty()) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw2">err_no</a>, <span class="stringliteral">""</span>);
01003 
01004     <span class="comment">// is it portable?? may be on some systems it will block?</span>
01005     opfstream dout;
01006     string dftmp;
01007     <span class="keywordflow">if</span>( <a class="code" href="group__file.html#a3">tmp_crt</a>(df, dout, dftmp) != <a class="code" href="group__err.html#a16cvqw2">err_no</a> ) <span class="keywordflow">return</span>(<a class="code" href="group__err.html#a8">lastret</a>); 
01008     
01009     ipfstream din(df.c_str());
01010     <span class="keywordflow">if</span>(din) {
01011             string cln;
01012 
01013             <span class="keywordflow">if</span>( uin.type == <a class="code" href="classcvq.html#cvqw35cvqw32">autoresp</a> || uin.type == <a class="code" href="classcvq.html#cvqw35cvqw31">sms</a> )
01014                     dout&lt;&lt;lnn&lt;&lt;endl;
01015 
01016             <span class="keywordflow">while</span>(getline(din, cln)) {
01017                     <span class="keywordflow">if</span>(cln!=lno &amp;&amp; !cln.empty()) {
01018                             dout&lt;&lt;cln&lt;&lt;endl;
01019                             <span class="keywordflow">if</span>(!dout) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw10">err_wr</a>, dftmp);
01020                     }
01021             }
01022         
01023             <span class="keywordflow">if</span>( ! ( uin.type == <a class="code" href="classcvq.html#cvqw35cvqw32">autoresp</a> || uin.type == <a class="code" href="classcvq.html#cvqw35cvqw31">sms</a> ) )
01024                     dout&lt;&lt;lnn&lt;&lt;endl;
01025 
01026             <span class="keywordflow">if</span>(din.bad()) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw11">err_rd</a>, df);
01027             din.clear();
01028     } <span class="keywordflow">else</span> 
01029             dout&lt;&lt;lnn&lt;&lt;endl;
01030     dout.flush();
01031     <span class="keywordflow">if</span>(!dout) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw10">err_wr</a>, dftmp);
01032 
01033     <span class="keywordflow">if</span>(<a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;udot_rep(dom,uin)) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw7">err_auth</a>, <a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;err_report());
01034     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(rename(dftmp.c_str(), df.c_str()) ? <a class="code" href="group__err.html#a16cvqw16">err_ren</a> : <a class="code" href="group__err.html#a16cvqw2">err_no</a>, dftmp);
01035 }
01036 
<a name="l01040"></a><a class="code" href="classcfsvq.html#a35">01040</a> uint8_t <a class="code" href="group__udot.html#a35">cfsvq::udot_get</a>(<span class="keyword">const</span> string &amp;dom, udot_info &amp;ui) {
01041     <a class="code" href="classcfsvq.html#cfsvqb16">assert_auth</a>();
01042     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;udot_get(lower(dom), ui) ? <a class="code" href="group__err.html#a16cvqw7">err_auth</a> : <a class="code" href="group__err.html#a16cvqw2">err_no</a>, <a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;err_report());
01043 }
01044 
<a name="l01051"></a><a class="code" href="classcfsvq.html#a10">01051</a> string <a class="code" href="group__udot.html#a10">cfsvq::dotfile</a>(<span class="keyword">const</span> string &amp;d, <span class="keyword">const</span> string &amp;u, <span class="keyword">const</span> string &amp;e) {
01052     string dom(d), user(u), ext(e);
01053     string <a class="code" href="group__udot.html#a10">dotfile</a>;
01054     dotfile.reserve(2000);
01055     dotfile.append(conf_home);
01056     dotfile.append(<span class="stringliteral">"/domains/"</span>);
01057     dotfile.append(split_dom(dom));
01058     dotfile.append(<span class="stringliteral">"/"</span>, 1);
01059     dotfile.append(dom);
01060     dotfile.append(<span class="stringliteral">"/"</span>, 1);
01061     dotfile.append(split_user(user));
01062     dotfile.append(<span class="stringliteral">"/.qmail-"</span>);
01063     replace(user.begin(),user.end(), <span class="charliteral">'.'</span>, <span class="charliteral">':'</span>);
01064     dotfile.append(user);
01065     <span class="keywordflow">if</span>(!ext.empty()) {
01066             replace(ext.begin(),ext.end(), <span class="charliteral">'.'</span>, <span class="charliteral">':'</span>);
01067             dotfile += <span class="charliteral">'-'</span>+ext;
01068     }
01069     <span class="keywordflow">return</span> dotfile;
01070 }
01071 
<a name="l01075"></a><a class="code" href="classcfsvq.html#a36">01075</a> uint8_t <a class="code" href="group__udot.html#a36">cfsvq::udot_sup_is</a>(udot_type t) {
01076     <span class="keywordtype">unsigned</span> ud_supl = <span class="keyword">sizeof</span>(ud_supl);
01077     <span class="keywordflow">if</span>(!ud_supl) <span class="keywordflow">return</span> 0;
01078     ud_supl--;
01079     <span class="keywordflow">do</span> {
01080             <span class="keywordflow">if</span>(<a class="code" href="classcfsvq.html#cfsvqt1">ud_sup</a>[ud_supl] == t) <span class="keywordflow">return</span> 1;
01081     } <span class="keywordflow">while</span>(ud_supl--);
01082     <span class="keywordflow">return</span> 0;
01083 }
01084 
<a name="l01088"></a><a class="code" href="classcfsvq.html#a41">01088</a> string <a class="code" href="group__udot.html#a41">cfsvq::udot_ln</a>(<span class="keyword">const</span> udot_info &amp;ui) {
01089     string ret;
01090     string::size_type pos, pos1;
01091     string tmp, tmp1;
01092     <span class="keywordflow">switch</span>(ui.type) {
01093     <span class="keywordflow">case</span> <a class="code" href="classcvq.html#cvqw35cvqw29">redir</a>:
01094             ret.reserve(ui.val.length()+3);
01095             ret = <span class="charliteral">'&amp;'</span>;
01096             ret += ui.val;
01097             <span class="keywordflow">break</span>;
01098     <span class="keywordflow">case</span> <a class="code" href="classcvq.html#cvqw35cvqw32">autoresp</a>:
01099             ret = <span class="stringliteral">"|"</span>;
01100             ret += conf_home+<span class="stringliteral">"/bin/autoresp "</span>;
01101             tmp1 = hex_from(ui.val);
01102 
01103             pos = tmp1.find(<span class="charliteral">'\0'</span>);
01104             <span class="keywordflow">if</span>( pos == string::npos )
01105                     <span class="keywordflow">throw</span> logic_error(<span class="stringliteral">"udot_ln: there's no message!"</span>, __FILE__, __LINE__);
01106             
01107             tmp = tmp1.substr(0, pos);
01108             ret += tmp;
01109             
01110             pos1 = tmp1.find(<span class="charliteral">'\0'</span>, ++pos);
01111             tmp = tmp1.substr(pos, pos1 - pos);
01112             ret += <span class="charliteral">' '</span>;
01113             ret += to_hex((uint8_t *) tmp.data(), tmp.length());
01114             
01115             <span class="keywordflow">if</span>( pos1 != string::npos 
01116                 &amp;&amp; (pos1 = tmp1.find(<span class="charliteral">'\0'</span>, (pos=pos1+1))) != string::npos ) {
01117                     tmp = tmp1.substr(pos, pos1-pos);
01118                     <span class="keywordflow">if</span>( ! tmp.empty() ) {
01119                             ret+=<span class="charliteral">' '</span>;
01120                             ret+=to_hex((uint8_t *) tmp.data(), tmp.length());
01121                     }
01122             }
01123             <span class="keywordflow">break</span>;
01124     <span class="keywordflow">default</span>:
01125             ret = ui.val;
01126     }
01127     <span class="keywordflow">return</span> ret;
01128 }
01129 
<a name="l01137"></a><a class="code" href="classcfsvq.html#a37">01137</a> uint8_t <a class="code" href="group__udot.html#a37">cfsvq::udot_has</a>(<span class="keyword">const</span> string &amp;dom, <span class="keyword">const</span> string &amp;user, 
01138         <span class="keyword">const</span> string &amp;ext, udot_type type) {
01139     <a class="code" href="classcfsvq.html#cfsvqb16">assert_auth</a>();
01140     <span class="keywordflow">return</span> <a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;udot_has(dom, user, ext, type);
01141 }
01142 
<a name="l01146"></a><a class="code" href="classcfsvq.html#a38">01146</a> uint8_t <a class="code" href="group__udot.html#a38">cfsvq::udot_add_md_def</a>(<span class="keyword">const</span> string &amp;d, <span class="keyword">const</span> string &amp;u,
01147         <span class="keyword">const</span> string &amp;e) {
01148     udot_info ui;
01149     ui.type = <a class="code" href="classcvq.html#cvqw35cvqw30">maildir</a>;
01150     ui.val = <span class="stringliteral">"./"</span>+lower(u)+<span class="stringliteral">"/Maildir/"</span>;
01151     <span class="keywordflow">return</span> <a class="code" href="group__udot.html#a11">udot_add</a>(d, u, e, ui);
01152 }
01153 
<a name="l01157"></a><a class="code" href="classcfsvq.html#a3">01157</a> uint8_t <a class="code" href="group__file.html#a3">cfsvq::tmp_crt</a>(<span class="keyword">const</span> string &amp;fn, opfstream &amp; out, string &amp;fnout) {
01158     ostringstream pid;
01159     pid&lt;&lt;getpid();
01160     
01161     fnout = fn + <span class="charliteral">'.'</span> + pid.str() + <a class="code" href="classcfsvq.html#cfsvqt0">tmp_end</a>;
01162     <span class="keywordflow">if</span>(out.is_open()) out.close();
01163     out.open(fnout.c_str(), ios::trunc);
01164     <span class="keywordflow">if</span>(!out) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw9">err_open</a>, fnout);
01165 
01166     <span class="keywordflow">if</span>( fchown(out.rdbuf()-&gt;fd(), ac_vq_uid.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>(), ac_vq_gid.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>()) )
01167             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw17">err_chown</a>, fnout);
01168     <span class="keywordflow">if</span>( fchmod(out.rdbuf()-&gt;fd(), ac_vq_fmode.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>() ) )
01169             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw14">err_chmod</a>, fnout);
01170     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw2">err_no</a>, <span class="stringliteral">""</span>);
01171 }
01172 
<a name="l01180"></a><a class="code" href="classcfsvq.html#a39">01180</a> uint8_t <a class="code" href="group__udot.html#a31">cfsvq::udot_rm</a>(<span class="keyword">const</span> string &amp;d, <span class="keyword">const</span> string &amp;u,
01181         <span class="keyword">const</span> string &amp;e, udot_type type) {
01182     <a class="code" href="classcfsvq.html#cfsvqb16">assert_auth</a>();
01183     vector&lt;udot_info&gt; uis;
01184     vector&lt;udot_info&gt;::iterator uis_end, uis_cur;
01185     <span class="keywordflow">if</span>(<a class="code" href="group__udot.html#a32">udot_ls</a>(d, u, e, type, uis)) <span class="keywordflow">return</span>(<a class="code" href="group__err.html#a8">lastret</a>);
01186     uis_end = uis.end();
01187     
01188     string dom(lower(d));
01189     string df(<a class="code" href="group__udot.html#a10">dotfile</a>(dom, lower(u), lower(e)));
01190 
01191     <span class="keywordflow">for</span>( uis_cur=uis.begin(); uis_cur != uis_end; ++ uis_cur ) {
01192             uis_cur-&gt;val = <a class="code" href="group__udot.html#a41">udot_ln</a>(*uis_cur);
01193     }
01194 
01195     <span class="comment">// is it portable?? may be on some systems it will block?</span>
01196     opfstream dout;
01197     string dftmp;
01198     <span class="keywordflow">if</span>( <a class="code" href="group__file.html#a3">tmp_crt</a>(df, dout, dftmp) != <a class="code" href="group__err.html#a16cvqw2">err_no</a> ) <span class="keywordflow">return</span>(<a class="code" href="group__err.html#a8">lastret</a>);
01199     
01200     ipfstream din(df.c_str());
01201     <span class="keywordflow">if</span>(din) {
01202             string cln;
01203             <span class="keywordflow">while</span>(getline(din, cln)) {
01204                     <span class="keywordflow">if</span>( cln.empty() ) <span class="keywordflow">continue</span>;
01205                     <span class="keywordflow">for</span>( uis_cur = uis.begin(); uis_cur != uis_end; uis_cur ++ ) {
01206                             <span class="keywordflow">if</span>( cln == uis_cur-&gt;val ) <span class="keywordflow">break</span>;
01207                     }
01208                     <span class="keywordflow">if</span>( uis_cur == uis_end ) {
01209                             dout&lt;&lt;cln&lt;&lt;endl;
01210                             <span class="keywordflow">if</span>(!dout) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw10">err_wr</a>, dftmp);
01211                     }
01212             }
01213             <span class="keywordflow">if</span>(din.bad()) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw11">err_rd</a>, df);
01214             din.clear();
01215     }
01216 
01217     dout.flush();
01218     <span class="keywordflow">if</span>(!dout) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw10">err_wr</a>, dftmp);
01219     <span class="keywordflow">if</span>(<a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;udot_rm(dom,u,e,type)) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw7">err_auth</a>, <a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;err_report());
01220     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(rename(dftmp.c_str(), df.c_str()) ? <a class="code" href="group__err.html#a16cvqw16">err_ren</a> : <a class="code" href="group__err.html#a16cvqw2">err_no</a>, dftmp);
01221 }
01222 
<a name="l01231"></a><a class="code" href="classcfsvq.html#a40">01231</a> uint8_t <a class="code" href="group__udot.html#a40">cfsvq::udot_type_cnt</a>( <span class="keyword">const</span> string &amp;d, <span class="keyword">const</span> string &amp;u, <span class="keyword">const</span> string &amp;e,
01232         udot_type type, size_type &amp;cnt) {
01233     <a class="code" href="classcfsvq.html#cfsvqb16">assert_auth</a>();
01234     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>( <a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;udot_type_cnt(d,u,e,type,cnt) ? <a class="code" href="group__err.html#a16cvqw7">err_auth</a> : <a class="code" href="group__err.html#a16cvqw2">err_no</a>, <a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;err_report() );
01235 }
01236 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Dec 25 13:37:10 2003 for Virtual Qmail by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.3 </small></address>
</body>
</html>
