<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Virtual Qmail: user_auth.cc Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.3 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Compound&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Compound&nbsp;Members</a></div>
<h1>user_auth.cc</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment">Copyright (c) 2002,2003 Pawel Niewiadomski</span>
00003 <span class="comment">All rights reserved.</span>
00004 <span class="comment"></span>
00005 <span class="comment">Redistribution and use in source and binary forms, with or without</span>
00006 <span class="comment">modification, are permitted provided that the following conditions</span>
00007 <span class="comment">are met:</span>
00008 <span class="comment">1. Redistributions of source code must retain the above copyright</span>
00009 <span class="comment">   notice, this list of conditions and the following disclaimer.</span>
00010 <span class="comment">2. Redistributions in binary form must reproduce the above copyright</span>
00011 <span class="comment">   notice, this list of conditions and the following disclaimer in the</span>
00012 <span class="comment">   documentation and/or other materials provided with the distribution.</span>
00013 <span class="comment">3. All advertising materials mentioning features or use of this software</span>
00014 <span class="comment">   must display the following acknowledgement:</span>
00015 <span class="comment">   This product includes software developed by the Pawel Niewiadomski,</span>
00016 <span class="comment">   and other contributors.</span>
00017 <span class="comment">4. Neither the name of Pawel Niewiadomski nor the names of other contributors</span>
00018 <span class="comment">   may be used to endorse or promote products derived from this software</span>
00019 <span class="comment">   without specific prior written permission.</span>
00020 <span class="comment"></span>
00021 <span class="comment">THIS SOFTWARE IS PROVIDED BY PAWEL NIEWIADOMSKI AND CONTRIBUTORS ``AS IS'' AND</span>
00022 <span class="comment">ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
00023 <span class="comment">IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
00024 <span class="comment">ARE DISCLAIMED.  IN NO EVENT SHALL PAWEL NIEWIADOMSKI OR CONTRIBUTORS BE LIABLE</span>
00025 <span class="comment">FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
00026 <span class="comment">DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</span>
00027 <span class="comment">OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
00028 <span class="comment">HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
00029 <span class="comment">LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
00030 <span class="comment">OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
00031 <span class="comment">SUCH DAMAGE.</span>
00032 <span class="comment">*/</span>
00033 
00034 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00035 <span class="preprocessor">#include &lt;exception&gt;</span>
00036 <span class="preprocessor">#include &lt;iostream&gt;</span>
00037 <span class="preprocessor">#include &lt;cerrno&gt;</span>
00038 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00039 <span class="preprocessor">#include &lt;string&gt;</span>
00040 <span class="preprocessor">#include &lt;sstream&gt;</span>
00041 
00042 <span class="preprocessor">#include "cvq.h"</span>
00043 <span class="preprocessor">#include "getline.h"</span>
00044 <span class="preprocessor">#include "vq_conf.h"</span>
00045 <span class="preprocessor">#include "lower.h"</span>
00046 <span class="preprocessor">#include "hmac_md5.h"</span>
00047 <span class="preprocessor">#include "auto/lmd5.h"</span>
00048 <span class="preprocessor">#include "clogger.h"</span>
00049 <span class="preprocessor">#include "sig.h"</span>
00050 <span class="preprocessor">#include "sys.h"</span>
00051 
00052 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00053 <span class="keyword">using</span> <span class="keyword">namespace </span>vq;
00054 
00055 <span class="keywordtype">char</span> *me = NULL, **av;
00056 <span class="keywordtype">int</span> ac;
00057 <span class="keyword">const</span> <span class="keywordtype">char</span> *remip = NULL, *locip = NULL, *defdom = NULL;
00058 <span class="keywordtype">bool</span> quiet = <span class="keyword">false</span>;
00059 <a class="code" href="classcvq.html">cvq</a> *sys = NULL;
00060 string resp, pass;
00061 <span class="keyword">enum</span> { smtp, pop3 } contype;
00062 <a class="code" href="structcvq_1_1auth__info.html">cvq::auth_info</a> sysai;
00063 <a class="code" href="classclogger.html">clogger</a> *olog = NULL;
00064 
00065 <span class="comment">/*</span>
00066 <span class="comment"> *</span>
00067 <span class="comment"> */</span>
00068 <span class="keywordtype">char</span> read_auth_info() {
00069     <span class="keywordflow">if</span>( ! getline(3,sysai.<a class="code" href="structcvq_1_1auth__info.html#cvq_1_1auth__infoo0">user</a>,<span class="charliteral">'\0'</span>)
00070         || ! getline(3,pass,<span class="charliteral">'\0'</span>)
00071         || ! getline(3,resp,<span class="charliteral">'\0'</span>)) {
00072             olog-&gt;<a class="code" href="classclogger.html#cloggera6">write</a>( clogger::re_read, strerror(errno));
00073             <span class="keywordflow">return</span>(1);
00074     }
00075     sysai.<a class="code" href="structcvq_1_1auth__info.html#cvq_1_1auth__infoo0">user</a> = lower(sysai.<a class="code" href="structcvq_1_1auth__info.html#cvq_1_1auth__infoo0">user</a>);
00076     <span class="keywordflow">if</span>( ac_atchars.<a class="code" href="classclnconf.html#clnconfa1">val_str</a>().empty() ) {
00077             olog-&gt;<a class="code" href="classclogger.html#cloggera6">write</a>( clogger::re_int, <span class="stringliteral">"ac_atchars empty"</span>);
00078             <span class="keywordflow">return</span>(1);
00079     }
00080     string::size_type atpos = sysai.<a class="code" href="structcvq_1_1auth__info.html#cvq_1_1auth__infoo0">user</a>.find_last_of(ac_atchars.<a class="code" href="classclnconf.html#clnconfa1">val_str</a>());
00081     <span class="keywordflow">if</span>( atpos != sysai.<a class="code" href="structcvq_1_1auth__info.html#cvq_1_1auth__infoo0">user</a>.npos ) {
00082             sysai.<a class="code" href="structcvq_1_1auth__info.html#cvq_1_1auth__infoo2">dom</a> = sysai.<a class="code" href="structcvq_1_1auth__info.html#cvq_1_1auth__infoo0">user</a>.substr(atpos+1);
00083             sysai.<a class="code" href="structcvq_1_1auth__info.html#cvq_1_1auth__infoo0">user</a> = sysai.<a class="code" href="structcvq_1_1auth__info.html#cvq_1_1auth__infoo0">user</a>.substr(0,atpos);
00084     }
00085 
00086     <span class="keywordflow">if</span>( sysai.<a class="code" href="structcvq_1_1auth__info.html#cvq_1_1auth__infoo2">dom</a>.empty() ) sysai.<a class="code" href="structcvq_1_1auth__info.html#cvq_1_1auth__infoo2">dom</a> = defdom ? defdom : locip;
00087     
00088     <span class="keywordflow">if</span>( sysai.<a class="code" href="structcvq_1_1auth__info.html#cvq_1_1auth__infoo2">dom</a>.empty() || !sys-&gt;<a class="code" href="group__dom.html#a19">dom_val</a>(sysai.<a class="code" href="structcvq_1_1auth__info.html#cvq_1_1auth__infoo2">dom</a>) ) {
00089             olog-&gt;<a class="code" href="classclogger.html#cloggera6">write</a>(clogger::re_data, 
00090                 (string)<span class="stringliteral">"invalid domain name: "</span>+sysai.<a class="code" href="structcvq_1_1auth__info.html#cvq_1_1auth__infoo2">dom</a>);
00091             <span class="keywordflow">return</span> 1;
00092     }
00093     
00094     olog-&gt;<a class="code" href="classclogger.html#cloggera4">domain_set</a>(sysai.<a class="code" href="structcvq_1_1auth__info.html#cvq_1_1auth__infoo2">dom</a>);
00095 
00096     <span class="keywordflow">if</span>( sysai.<a class="code" href="structcvq_1_1auth__info.html#cvq_1_1auth__infoo0">user</a>.empty() || !sys-&gt;<a class="code" href="group__user.html#a10">user_val</a>(sysai.<a class="code" href="structcvq_1_1auth__info.html#cvq_1_1auth__infoo0">user</a>) ) {
00097             olog-&gt;<a class="code" href="classclogger.html#cloggera6">write</a>(clogger::re_data, 
00098                 (string)<span class="stringliteral">"invalid user name: "</span>+sysai.<a class="code" href="structcvq_1_1auth__info.html#cvq_1_1auth__infoo0">user</a> );
00099             <span class="keywordflow">return</span>(1);
00100     }
00101     
00102     olog-&gt;<a class="code" href="classclogger.html#cloggera5">login_set</a>(sysai.<a class="code" href="structcvq_1_1auth__info.html#cvq_1_1auth__infoo0">user</a>);
00103     
00104     <span class="keywordflow">if</span>( pass.empty() ) {
00105             olog-&gt;<a class="code" href="classclogger.html#cloggera6">write</a>(clogger::re_data, <span class="stringliteral">"empty password"</span>);
00106             <span class="keywordflow">return</span>(1);
00107     }
00108     <span class="keywordflow">return</span> 0;
00109 }
00110 
00111 <span class="comment">/*</span>
00112 <span class="comment"> *</span>
00113 <span class="comment"> */</span>
00114 <span class="keywordtype">char</span> read_env() {
00115     <span class="keyword">const</span> <span class="keywordtype">char</span> *tmp;
00116     <span class="keywordtype">int</span> itmp;
00117     <span class="keywordflow">while</span>((itmp=getopt(ac, av, <span class="stringliteral">"D:"</span>)) != -1) {
00118             <span class="keywordflow">switch</span>(itmp) {
00119             <span class="keywordflow">case</span> <span class="charliteral">'D'</span>:
00120                     defdom = optarg;
00121                     <span class="keywordflow">break</span>;
00122             }
00123     }
00124     ac -= optind;
00125     av += optind;
00126 
00127     remip = getenv(<span class="stringliteral">"TCPREMOTEIP"</span>);
00128     <span class="keywordflow">if</span>(!remip) remip = <span class="stringliteral">""</span>;
00129     
00130     locip = getenv(<span class="stringliteral">"TCPLOCALHOST"</span>);
00131     <span class="keywordflow">if</span>( !locip || *locip == <span class="charliteral">'\0'</span> ) {
00132             locip = getenv(<span class="stringliteral">"TCPLOCALIP"</span>);
00133             <span class="keywordflow">if</span>(!locip || *locip == <span class="charliteral">'\0'</span>) {
00134                     cerr&lt;&lt;me&lt;&lt;<span class="stringliteral">": TCPLOCALIP is not set"</span>&lt;&lt;endl;
00135                     <span class="keywordflow">return</span>(1);
00136             }
00137     }           
00138     <span class="keywordflow">if</span>( !(tmp=getenv(<span class="stringliteral">"TCPLOCALPORT"</span>)) ) {
00139             cerr&lt;&lt;me&lt;&lt;<span class="stringliteral">": TCPLOCALPORT is not set"</span>&lt;&lt;endl;
00140             <span class="keywordflow">return</span>(1);
00141     } <span class="keywordflow">else</span> {
00142             istringstream is;
00143             is.str(tmp);
00144             is &gt;&gt; itmp;
00145             <span class="keywordflow">if</span>( ! is || itmp&lt;0 || itmp&gt;0xffff ) {
00146                     cerr&lt;&lt;me&lt;&lt;<span class="stringliteral">": TCPLOCALPORT is not a valid port number"</span>&lt;&lt;endl;
00147                     <span class="keywordflow">return</span>(1);
00148             }
00149     }
00150     <span class="keywordflow">switch</span>(itmp) {
00151     <span class="keywordflow">default</span>:
00152     <span class="keywordflow">case</span> 995:
00153     <span class="keywordflow">case</span> 110:
00154             <span class="keywordflow">if</span>(ac&lt;1) {
00155                     cerr&lt;&lt;me&lt;&lt;<span class="stringliteral">": no command was given"</span>&lt;&lt;endl;
00156                     <span class="keywordflow">return</span>(1);
00157             }
00158             contype = pop3;
00159             olog-&gt;<a class="code" href="classclogger.html#cloggera3">service_set</a>(clogger::ser_pop3);
00160             <span class="keywordflow">break</span>;
00161     <span class="keywordflow">case</span> 80: <span class="comment">// HTTP</span>
00162     <span class="keywordflow">case</span> 443: <span class="comment">// HTTPS</span>
00163     <span class="keywordflow">case</span> 465: <span class="comment">// ESMTP+SSL</span>
00164     <span class="keywordflow">case</span> 25: <span class="comment">// ESMTP</span>
00165     <span class="keywordflow">case</span> 250: <span class="comment">// EMTP</span>
00166             contype = smtp;
00167 
00168             <span class="keywordflow">switch</span>(itmp) {
00169             <span class="keywordflow">case</span> 80:
00170                     olog-&gt;<a class="code" href="classclogger.html#cloggera3">service_set</a>(clogger::ser_http);
00171                     <span class="keywordflow">break</span>;
00172             <span class="keywordflow">case</span> 443:
00173                     olog-&gt;<a class="code" href="classclogger.html#cloggera3">service_set</a>(clogger::ser_https);
00174                     <span class="keywordflow">break</span>;
00175             <span class="keywordflow">case</span> 250:
00176                     olog-&gt;<a class="code" href="classclogger.html#cloggera3">service_set</a>(clogger::ser_emtp);
00177                     <span class="keywordflow">break</span>;
00178             <span class="keywordflow">default</span>:
00179                     olog-&gt;<a class="code" href="classclogger.html#cloggera3">service_set</a>(clogger::ser_smtp);
00180             }
00181             <span class="keywordflow">break</span>;
00182     }
00183     <span class="keywordflow">return</span> 0;
00184 }
00185 
00186 <span class="comment">/*</span>
00187 <span class="comment"> * return 0 if apop authorization is successful</span>
00188 <span class="comment"> */</span>
00189 <span class="keywordtype">char</span> auth_apop() {
00190     MD5_CTX ctx;
00191     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> digest[16];
00192     string hexdigest;
00193     MD5Init(&amp;ctx);
00194     MD5Update(&amp;ctx,(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)resp.data(),resp.length());
00195     MD5Update(&amp;ctx,(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)sysai.<a class="code" href="structcvq_1_1auth__info.html#cvq_1_1auth__infoo1">pass</a>.data(),sysai.<a class="code" href="structcvq_1_1auth__info.html#cvq_1_1auth__infoo1">pass</a>.length());
00196     MD5Final(digest,&amp;ctx);
00197     hexdigest = to_hex(digest,16);
00198     <span class="keywordflow">return</span> pass==hexdigest ? 0 : 1;
00199 }
00200 <span class="comment">/*</span>
00201 <span class="comment"> * return 0 if cram-md5 authorization is successful</span>
00202 <span class="comment"> */</span>
00203 <span class="keywordtype">char</span> auth_cram() {
00204     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> digest[16];
00205     string hexdigest;
00206     hmac_md5((<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)sysai.<a class="code" href="structcvq_1_1auth__info.html#cvq_1_1auth__infoo1">pass</a>.data(),
00207                     sysai.<a class="code" href="structcvq_1_1auth__info.html#cvq_1_1auth__infoo1">pass</a>.length(),(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)resp.data(),
00208                     resp.length(),digest);
00209     hexdigest = to_hex(digest,16);
00210     <span class="keywordflow">return</span> pass==hexdigest ? 0 : 1;
00211 }
00212 
00213 <span class="comment">/*</span>
00214 <span class="comment"> *</span>
00215 <span class="comment"> */</span>
00216 <span class="keywordtype">char</span> login_smtp() {
00217     olog-&gt;<a class="code" href="classclogger.html#cloggera6">write</a>( clogger::re_ok, <span class="stringliteral">""</span> );
00218     <span class="keywordflow">return</span>(0);
00219 }
00220 
00221 <span class="comment">/*</span>
00222 <span class="comment"> *</span>
00223 <span class="comment"> */</span>
00224 <span class="keywordtype">char</span> login_pop() {
00225     <span class="keywordflow">if</span>( setenv(<span class="stringliteral">"HOME"</span>, sysai.<a class="code" href="structcvq_1_1auth__info.html#cvq_1_1auth__infoo3">dir</a>.c_str(), 1) ) {
00226             <span class="keywordflow">return</span>(1);
00227     }
00228     <span class="keywordflow">if</span>( chdir(sysai.<a class="code" href="structcvq_1_1auth__info.html#cvq_1_1auth__infoo3">dir</a>.c_str()) ) {
00229             <span class="keywordflow">return</span>(1);
00230     }
00231     <span class="keywordflow">if</span>( setgid(ac_vq_gid.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>()) || setegid(getgid()) 
00232         || setuid(ac_vq_uid.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>()) || seteuid(getuid()) ) {
00233             <span class="keywordflow">return</span>(1);
00234     }
00235     olog-&gt;<a class="code" href="classclogger.html#cloggera6">write</a>(clogger::re_ok, <span class="stringliteral">""</span> );
00236     <span class="keywordflow">if</span>( olog ) <span class="keyword">delete</span> olog;
00237     execvp(*av,av);
00238     <span class="keywordflow">return</span>(1);
00239 } 
00240 
00241 <span class="comment">/*</span>
00242 <span class="comment"> *</span>
00243 <span class="comment"> */</span>
00244 <span class="keywordtype">char</span> proc_auth_info() {
00245     <span class="keywordflow">if</span>(contype==smtp) {
00246             <span class="keywordflow">if</span>( sysai.<a class="code" href="structcvq_1_1auth__info.html#cvq_1_1auth__infoo4">flags</a> &amp; <a class="code" href="classcvq.html#cvqw34cvqw24">cvq::smtp_blk</a> ) {
00247                     olog-&gt;<a class="code" href="classclogger.html#cloggera6">write</a>(clogger::re_blk, <span class="stringliteral">""</span> );
00248                     <span class="keywordflow">return</span>(1);
00249             }
00250             <span class="keywordflow">if</span>( (! resp.empty() &amp;&amp; ! auth_cram())
00251                 || pass==sysai.<a class="code" href="structcvq_1_1auth__info.html#cvq_1_1auth__infoo1">pass</a> ) {
00252                     <span class="keywordflow">return</span> login_smtp();
00253             }
00254     } <span class="keywordflow">else</span> {
00255             <span class="keywordflow">if</span>( sysai.<a class="code" href="structcvq_1_1auth__info.html#cvq_1_1auth__infoo4">flags</a> &amp; <a class="code" href="classcvq.html#cvqw34cvqw23">cvq::pop3_blk</a> ) {
00256                     olog-&gt;<a class="code" href="classclogger.html#cloggera6">write</a>(clogger::re_blk, <span class="stringliteral">""</span> );
00257                     <span class="keywordflow">return</span>(1);
00258             }
00259             <span class="keywordflow">if</span>( (! resp.empty() &amp;&amp; ! auth_apop())
00260                 || pass==sysai.<a class="code" href="structcvq_1_1auth__info.html#cvq_1_1auth__infoo1">pass</a> ) {
00261                     <span class="keywordflow">return</span> login_pop();
00262             }
00263     }
00264     olog-&gt;<a class="code" href="classclogger.html#cloggera6">write</a>( clogger::re_pass, pass );
00265     <span class="keywordflow">return</span>(1);
00266 }
00267 
00268 <span class="comment">/*</span>
00269 <span class="comment"> *</span>
00270 <span class="comment"> */</span>
00271 <span class="keywordtype">int</span> main(<span class="keywordtype">int</span> ac, <span class="keywordtype">char</span> **av)
00272 {
00273     me = *av;
00274     ::av = av;
00275     ::ac = ac;
00276     
00277     sig_pipeign();
00278 
00279     <span class="keywordflow">try</span> {
00280             sys = <a class="code" href="classcvq.html#cvqe2">cvq::alloc</a>();
00281             olog = <a class="code" href="classclogger.html#cloggere0">clogger::alloc</a>();
00282             
00283             <span class="keywordflow">if</span>(read_env()) <span class="keywordflow">return</span> 3;
00284             
00285             olog-&gt;<a class="code" href="classclogger.html#cloggera2">ip_set</a>(remip);
00286 
00287             <span class="keywordflow">if</span>(read_auth_info()) <span class="keywordflow">return</span> 2;
00288 
00289             <span class="keywordtype">char</span> ret;
00290             <span class="keywordflow">switch</span>( (ret=sys-&gt;<a class="code" href="group__user.html#a11">user_auth</a>(sysai)) ) {
00291             <span class="keywordflow">case</span> 0: <span class="keywordflow">break</span>;
00292             <span class="keywordflow">case</span> <a class="code" href="group__err.html#a16cvqw6">cvq::err_user_nf</a>:
00293                     olog-&gt;<a class="code" href="classclogger.html#cloggera6">write</a>( clogger::re_data, <span class="stringliteral">"no such user"</span> );
00294                     <span class="keywordflow">return</span>(1);
00295             <span class="keywordflow">default</span>:
00296                     olog-&gt;<a class="code" href="classclogger.html#cloggera6">write</a>( clogger::re_int, sys-&gt;<a class="code" href="group__dom.html#a23">err_report</a>());
00297                     <span class="keywordflow">return</span> 1;
00298             }
00299 
00300             <span class="keywordflow">return</span> proc_auth_info();
00301     } <span class="keywordflow">catch</span>( <span class="keyword">const</span> exception &amp; ) {
00302             <span class="keywordflow">return</span> 1;
00303     } <span class="keywordflow">catch</span>( ... ) {
00304             <span class="keywordflow">return</span>(1);
00305     }
00306     <span class="keywordflow">return</span>(0);
00307 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Dec 25 13:37:11 2003 for Virtual Qmail by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.3 </small></address>
</body>
</html>
