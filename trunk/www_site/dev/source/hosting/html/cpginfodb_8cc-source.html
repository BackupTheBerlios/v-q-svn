<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>vqwww: hosting: cpginfodb.cc Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.3 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Compound&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Compound&nbsp;Members</a></div>
<h1>cpginfodb.cc</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment">Copyright (c) 2003 Pawel Niewiadomski</span>
00003 <span class="comment">All rights reserved.</span>
00004 <span class="comment"></span>
00005 <span class="comment">Redistribution and use in source and binary forms, with or without</span>
00006 <span class="comment">modification, are permitted provided that the following conditions</span>
00007 <span class="comment">are met:</span>
00008 <span class="comment">1. Redistributions of source code must retain the above copyright</span>
00009 <span class="comment">   notice, this list of conditions and the following disclaimer.</span>
00010 <span class="comment">2. Redistributions in binary form must reproduce the above copyright</span>
00011 <span class="comment">   notice, this list of conditions and the following disclaimer in the</span>
00012 <span class="comment">   documentation and/or other materials provided with the distribution.</span>
00013 <span class="comment">3. All advertising materials mentioning features or use of this software</span>
00014 <span class="comment">   must display the following acknowledgement:</span>
00015 <span class="comment">   This product includes software developed by the Pawel Niewiadomski,</span>
00016 <span class="comment">   and other contributors.</span>
00017 <span class="comment">4. Neither the name of Pawel Niewiadomski nor the names of other contributors</span>
00018 <span class="comment">   may be used to endorse or promote products derived from this software</span>
00019 <span class="comment">   without specific prior written permission.</span>
00020 <span class="comment"></span>
00021 <span class="comment">THIS SOFTWARE IS PROVIDED BY PAWEL NIEWIADOMSKI AND CONTRIBUTORS ``AS IS'' AND</span>
00022 <span class="comment">ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
00023 <span class="comment">IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
00024 <span class="comment">ARE DISCLAIMED.  IN NO EVENT SHALL PAWEL NIEWIADOMSKI OR CONTRIBUTORS BE LIABLE</span>
00025 <span class="comment">FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
00026 <span class="comment">DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</span>
00027 <span class="comment">OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
00028 <span class="comment">HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
00029 <span class="comment">LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
00030 <span class="comment">OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
00031 <span class="comment">SUCH DAMAGE.</span>
00032 <span class="comment">*/</span>
00033 <span class="preprocessor">#include &lt;new&gt;</span>
00034 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00035 <span class="preprocessor">#include &lt;sys/wait.h&gt;</span>
00036 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00037 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00038 
00039 <span class="preprocessor">#include "cpginfodb.h"</span>
00040 <span class="preprocessor">#include "util.h"</span>
00041 <span class="preprocessor">#include "lower.h"</span>
00042 <span class="preprocessor">#include "hosting_conf.h"</span>
00043 
00044 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00045 <span class="keyword">using</span> <span class="keyword">namespace </span>hosting;
00046 
<a name="l00047"></a><a class="code" href="classcinfodb.html#cpginfodbe0">00047</a> <a class="code" href="classcinfodb.html">cinfodb</a> * <a class="code" href="classcinfodb.html#cpginfodbe0">cinfodb::alloc</a>() {
00048     <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classcpginfodb.html">cpginfodb</a>();
00049 }
00050 
00051 <span class="preprocessor">#define lreturn(x) do { uint8_t ret = x; \</span>
00052 <span class="preprocessor">        if(ret!=err_no) lastret = ret; return ret; } while(0)</span>
00053 <span class="preprocessor"></span>
00054 <span class="keywordtype">unsigned</span> cpginfodb::inst = 0; <span class="comment">// number of instances</span>
00055 auto_ptr&lt;pqxx::Connection&gt; cpginfodb::pg;
00056 
00060 <span class="keywordtype">void</span> cpginfodb::init() {
00061   lastret = <a class="code" href="group__err.html#a1cpginfodbw0">err_no</a>;
00062 }
00066 cpginfodb::cpginfodb() {
00067   init();
00068   <span class="keywordflow">if</span>( ! inst )
00069         pg.reset (<span class="keyword">new</span> pqxx::Connection(ac_pgsql.<a class="code" href="classclnconf.html#clnconfa1">val_str</a>().c_str()));
00070   ++inst;
00071 }
00075 cpginfodb::~cpginfodb() {
00076     <span class="keywordflow">if</span>(!inst) <span class="keywordflow">throw</span> runtime_error(<span class="stringliteral">"cpginfodb::~cpginfodb"</span>);
00077     --inst;
00078     <span class="keywordflow">if</span>( ! inst ) pg.reset(NULL);
00079 }
00080 
00084 uint8_t cpginfodb::ftp_ls(<span class="keyword">const</span> string &amp;d, vector&lt;ftp_info&gt; &amp;users) {
00085     string dom(d);
00086     str2tb(dom);
00087     users.clear();
00088 
00089     pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00090         <span class="stringliteral">"SELECT id,login,ftpsubdir FROM \""</span>+dom+<span class="stringliteral">"\" WHERE login!=''"</span>
00091         <span class="stringliteral">" AND login IS NOT NULL AND flags &amp; 20 = 0 ORDER BY login"</span>) );
00092     
00093     <span class="keywordtype">int</span> tup = res.size();
00094     <span class="keywordflow">if</span>(!tup) lreturn(err_no);
00095     users.reserve(tup);
00096     ftp_info fi;
00097     
00098     <span class="keyword">const</span> <span class="keywordtype">char</span> *ptr;
00099     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i=0; i &lt; tup; ++i ) {
00100             ptr = res[i][0].c_str();
00101             <span class="keywordflow">if</span>(!ptr) <span class="keywordflow">continue</span>;
00102             fi.id = ptr;
00103             ptr = res[i][1].c_str();
00104             <span class="keywordflow">if</span>(!ptr) <span class="keywordflow">continue</span>;
00105             fi.user = ptr; 
00106             fi.dir = (ptr=res[i][2].c_str()) ? ptr : <span class="stringliteral">""</span>;
00107             users.push_back(fi);
00108     }
00109     lreturn(err_no);
00110 }
00111 
<a name="l00115"></a><a class="code" href="classcpginfodb.html#cpginfodba6">00115</a> uint8_t <a class="code" href="classcpginfodb.html#cpginfodba6">cpginfodb::ftp_get</a>(<span class="keyword">const</span> string &amp;d, ftp_info &amp;info) {
00116     string dom(d);
00117     str2tb(dom);
00118 
00119     pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00120         <span class="stringliteral">"SELECT id,ftpsubdir FROM \""</span>+dom+<span class="stringliteral">"\" WHERE login="</span>
00121         +pqxx::Quote(info.user, <span class="keyword">false</span>)) );
00122     
00123     <span class="keyword">const</span> <span class="keywordtype">char</span> *ptr;
00124     <span class="keywordtype">int</span> tup = res.size();
00125 
00126     <span class="keywordflow">if</span>(!tup) lreturn(<a class="code" href="group__err.html#a1cpginfodbw0">err_no</a>);
00127 
00128     ptr = res[0][0].c_str();
00129     <span class="keywordflow">if</span>(!ptr || !*ptr) lreturn(<a class="code" href="group__err.html#a1cpginfodbw3">err_noent</a>);
00130     info.id = ptr;
00131     info.dir = (ptr=res[0][1].c_str()) ? ptr : <span class="stringliteral">""</span>;
00132     lreturn(<a class="code" href="group__err.html#a1cpginfodbw0">err_no</a>);
00133 }
00134 
00135 
00136 
<a name="l00140"></a><a class="code" href="classcpginfodb.html#cpginfodba2">00140</a> uint8_t <a class="code" href="classcpginfodb.html#cpginfodba2">cpginfodb::ftp_add</a>(<span class="keyword">const</span> string &amp;d, <span class="keyword">const</span> ftp_info &amp;fi) {
00141     string dom(d), domlow(lower(d));
00142     str2tb(dom);
00143 
00144     pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00145         <span class="stringliteral">"UPDATE \""</span>+dom+<span class="stringliteral">"\" SET ftpdir="</span>
00146         +pqxx::Quote(ac_ftp_base.<a class="code" href="classclnconf.html#clnconfa1">val_str</a>()+<span class="charliteral">'/'</span>+domlow+<span class="stringliteral">"/www/"</span>+domlow+<span class="charliteral">'/'</span>
00147                 +escape(fi.dir), <span class="keyword">false</span>)
00148         +<span class="stringliteral">",ftpsubdir="</span>+pqxx::Quote(<a class="code" href="classcpginfodb.html#cpginfodbb6">dir_clear</a>(fi.dir), <span class="keyword">false</span>)
00149         +<span class="stringliteral">" WHERE id="</span>+pqxx::Quote(fi.id, <span class="keyword">false</span>)) );
00150     
00151     <span class="keywordflow">if</span>( ! res.AffectedRows() ) lreturn(<a class="code" href="group__err.html#a1cpginfodbw3">err_noent</a>);
00152     lreturn(<a class="code" href="group__err.html#a1cpginfodbw0">err_no</a>);
00153 }
00154 
00158 uint8_t cpginfodb::ftp_rm(<span class="keyword">const</span> string &amp;d, <span class="keyword">const</span> string &amp;id) {
00159     string dom(d);
00160     str2tb(dom);
00161 
00162     pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00163         <span class="stringliteral">"UPDATE \""</span>+dom+<span class="stringliteral">"\" SET ftpdir=NULL,ftpsubdir=NULL"</span>
00164         <span class="stringliteral">" WHERE id="</span>+pqxx::Quote(id, <span class="keyword">false</span>)) );
00165     
00166     <span class="keywordflow">if</span>( ! res.AffectedRows() ) lreturn(err_noent);
00167     lreturn(err_no);
00168 }
00169 
00173 uint8_t cpginfodb::ftp_rep(<span class="keyword">const</span> string &amp;d, <span class="keyword">const</span> ftp_info &amp;fi) {
00174     <span class="keywordflow">return</span> <a class="code" href="classcpginfodb.html#cpginfodba2">ftp_add</a>(d, fi);
00175 }
00176 
00180 uint8_t cpginfodb::wwwali_ls(<span class="keyword">const</span> string &amp;dom, vector&lt;wwwali_dom_info&gt; &amp;doms) {
00181     doms.clear();
00182     pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00183         <span class="stringliteral">"SELECT dw.id,dw.name FROM domains as d,domains_all as dw WHERE "</span>
00184         <span class="stringliteral">"d.id=dw.domain_id AND d.domain="</span>+pqxx::Quote(lower(dom), <span class="keyword">false</span>)
00185         +<span class="stringliteral">" ORDER BY dw.name"</span>) );
00186 
00187     vector&lt;wwwali_dom_info&gt;::size_type cnt, i;
00188     wwwali_dom_info wadi;
00189     
00190     <span class="keyword">const</span> <span class="keywordtype">char</span> *ptr;
00191     <span class="keywordflow">if</span>( ! (cnt=res.size()) ) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a1cpginfodbw0">err_no</a>;
00192     
00193     doms.reserve(cnt);
00194     <span class="keywordflow">for</span>( i=0; i&lt;cnt; ++i ) {
00195             ptr = res[i][0].c_str();
00196             <span class="keywordflow">if</span>(!ptr) <span class="keywordflow">continue</span>;
00197             wadi.id = ptr;
00198             
00199             ptr = res[i][1].c_str();
00200             <span class="keywordflow">if</span>(!ptr || !*ptr) <span class="keywordflow">continue</span>;
00201             wadi.domain = ptr;
00202             
00203             doms.push_back(wadi);
00204     }
00205     lreturn(err_no);
00206 }
00207 
<a name="l00212"></a><a class="code" href="classcpginfodb.html#cpginfodba8">00212</a> uint8_t <a class="code" href="classcpginfodb.html#cpginfodba8">cpginfodb::wwwali_dom_ls</a>(<span class="keyword">const</span> string &amp;id, vector&lt;wwwali_info&gt; &amp; wais ) {
00213     wais.clear();
00214     
00215     pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00216         <span class="stringliteral">"SELECT id,prefix,dir FROM domains_prefixes WHERE domain_id="</span>
00217         +pqxx::Quote(id, <span class="keyword">false</span>)+<span class="stringliteral">" ORDER BY prefix"</span>) );
00218     
00219     vector&lt;wwwali_info&gt;::size_type i, cnt;
00220     wwwali_info wai;
00221     <span class="keyword">const</span> <span class="keywordtype">char</span> *ptr;
00222     
00223     <span class="keywordflow">if</span>( ! (cnt=res.size()) ) lreturn(<a class="code" href="group__err.html#a1cpginfodbw0">err_no</a>);
00224     
00225     <span class="keywordflow">for</span>( i=0; i&lt;cnt; i++ ) {
00226             ptr = res[i][0].c_str();
00227             <span class="keywordflow">if</span>(!ptr) <span class="keywordflow">continue</span>;
00228             wai.id = ptr;
00229 
00230             ptr = res[i][1].c_str();
00231             <span class="keywordflow">if</span>(!ptr || ! *ptr) <span class="keywordflow">continue</span>;
00232             wai.prefix = ptr;
00233 
00234             ptr = res[i][2].c_str();
00235             <span class="keywordflow">if</span>(!ptr || ! *ptr) <span class="keywordflow">continue</span>;
00236             wai.dir = ptr;
00237 
00238             wais.push_back(wai);
00239     }
00240     lreturn(<a class="code" href="group__err.html#a1cpginfodbw0">err_no</a>);
00241 }
00242 
00246 uint8_t cpginfodb::wwwali_rep(<span class="keyword">const</span> string &amp;domid, <span class="keyword">const</span> wwwali_info &amp; w) {
00247     wwwali_info waiold;
00248     waiold.id = w.id;
00249     <span class="keywordflow">if</span>(wwwali_get(domid, waiold)) lreturn(err_read);
00250 
00251     pqxx::Transaction tran(*pg);
00252 
00253     wwwali_info wai(w);
00254     wai.prefix = lower(wai.prefix);
00255     wai.dir = <a class="code" href="classcpginfodb.html#cpginfodbb6">dir_clear</a>(wai.dir);
00256 
00257     pqxx::Result res(tran.Exec(
00258         <span class="stringliteral">"UPDATE domains_prefixes SET prefix="</span>+pqxx::Quote(wai.prefix, <span class="keyword">false</span>)
00259         +<span class="stringliteral">",dir="</span>+pqxx::Quote(wai.dir, <span class="keyword">false</span>)+<span class="stringliteral">" WHERE id="</span>
00260         +pqxx::Quote(wai.id, <span class="keyword">false</span>)+<span class="stringliteral">" AND domain_id="</span>
00261         +pqxx::Quote(domid, <span class="keyword">false</span>)) );
00262 
00263     <span class="keywordflow">if</span>( ! res.AffectedRows() ) {
00264             lreturn(err_noent); <span class="comment">// transaction will be aborted</span>
00265     }
00266 
00267     <span class="comment">// calls function writing info about domains to file which is processed</span>
00268     <span class="comment">// to create dns configuration</span>
00269     tran.Exec(<span class="stringliteral">"SELECT domains_prefixes_dump()"</span>);
00270     
00271     <span class="keywordflow">if</span>(!wwwali_exe(tran, domid, wai)) {
00272             lreturn(err_write);
00273     }
00274 
00275     tran.Commit();
00276 
00277     pqxx::NonTransaction nt(*pg);
00278     <span class="keywordflow">if</span>( wai.prefix != waiold.prefix )
00279             wwwali_exe(nt, domid, waiold, <span class="charliteral">'r'</span>);
00280     lreturn(err_no);
00281 }
00282 
00286 uint8_t cpginfodb::wwwali_rm(<span class="keyword">const</span> string &amp;domid, <span class="keyword">const</span> string &amp;id) {
00287     pqxx::NonTransaction notrans(*pg);
00288     
00289     <span class="keywordflow">if</span>( ! wwwali_exe(notrans, domid, id, <span class="charliteral">'r'</span>) ) {
00290             lreturn(err_write);
00291     }
00292 
00293     pqxx::Result res(notrans.Exec(
00294         <span class="stringliteral">"DELETE FROM domains_prefixes WHERE id="</span>
00295         +pqxx::Quote(id, <span class="keyword">false</span>)+<span class="stringliteral">" AND domain_id="</span>+pqxx::Quote(domid, <span class="keyword">false</span>)) );
00296 
00297     <span class="keywordflow">if</span>( ! res.AffectedRows() ) lreturn(err_noent);
00298 
00299     <span class="comment">// calls function writing info about domains to file which is processed</span>
00300     <span class="comment">// to create dns configuration</span>
00301     notrans.Exec(<span class="stringliteral">"SELECT domains_prefixes_dump()"</span>);
00302     lreturn(err_no);
00303 }
00304 
00308 uint8_t cpginfodb::wwwali_add(<span class="keyword">const</span> string &amp;domid, wwwali_info &amp;wai) {
00309     wai.prefix = lower(wai.prefix);
00310     pqxx::Transaction trans(*pg);
00311     pqxx::Result res(trans.Exec(
00312         <span class="stringliteral">"SELECT nextval('domains_prefixes_id_seq')"</span>) );
00313     
00314     <span class="keywordflow">if</span>( res.size() != 1 ) lreturn(err_read);
00315     <span class="keyword">const</span> <span class="keywordtype">char</span> *ptr = res[0][0].c_str();
00316     <span class="keywordflow">if</span>(!ptr) lreturn(err_read);
00317     wai.id = ptr;
00318 
00319     res = trans.Exec(<span class="stringliteral">"INSERT INTO domains_prefixes (id,prefix,dir,domain_id)"</span>
00320         <span class="stringliteral">" VALUES("</span>+pqxx::Quote(wai.id, <span class="keyword">false</span>)+<span class="stringliteral">","</span>
00321         +pqxx::Quote(wai.prefix, <span class="keyword">false</span>)
00322         +<span class="stringliteral">","</span>+pqxx::Quote(<a class="code" href="classcpginfodb.html#cpginfodbb6">dir_clear</a>(wai.dir), <span class="keyword">false</span>)+<span class="stringliteral">","</span>
00323         +pqxx::Quote(domid, <span class="keyword">false</span>)+<span class="stringliteral">")"</span>);
00324 
00325     <span class="keywordflow">if</span>( res.AffectedRows() != 1 ) lreturn(err_write);
00326     
00327     <span class="comment">// calls function writing info about domains to file which is processed</span>
00328     <span class="comment">// to create dns configuration</span>
00329     trans.Exec(<span class="stringliteral">"SELECT domains_prefixes_dump()"</span>);
00330 
00331     <span class="keywordflow">if</span>( ! wwwali_exe(trans, domid, wai) ) {
00332             lreturn(err_write);
00333     }
00334 
00335     trans.Commit();
00336     lreturn(err_no);
00337 }
00338 
00342 <span class="keywordtype">bool</span> cpginfodb::wwwali_exe(pqxx::transaction_base &amp; trans,
00343         <span class="keyword">const</span> string &amp;domid, <span class="keyword">const</span> string &amp;id, <span class="keywordtype">char</span> act ) {
00344     wwwali_info wai;
00345     wai.id = id;
00346     <span class="keywordflow">if</span>(wwwali_get(trans, domid, wai)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00347     <span class="keywordflow">return</span> wwwali_exe(trans, domid, wai, act);
00348 }
00352 <span class="keywordtype">bool</span> cpginfodb::wwwali_exe(pqxx::transaction_base &amp; trans,
00353         <span class="keyword">const</span> string &amp;domid, <span class="keyword">const</span> wwwali_info &amp;wai, <span class="keywordtype">char</span> act ) {
00354     <span class="keywordtype">char</span> *av[5];
00355     <span class="keywordtype">int</span> r, wstat, pid;
00356     string domain, rdomain;
00357     <span class="keywordflow">if</span>( wwwali_dom_get(trans, domid, domain)
00358         || <a class="code" href="classcpginfodb.html#cpginfodbb4">wwwali_rdom_get</a>(trans, domid, rdomain) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00359     
00360     string alias(ac_ftp_base.<a class="code" href="classclnconf.html#clnconfa1">val_str</a>()+<span class="charliteral">'/'</span>+rdomain+<span class="stringliteral">"/www/"</span>+wai.prefix+<span class="charliteral">'.'</span>+domain);
00361     string dir(ac_ftp_base.<a class="code" href="classclnconf.html#clnconfa1">val_str</a>()+<span class="charliteral">'/'</span>+rdomain+<span class="stringliteral">"/www/"</span>+rdomain+<span class="charliteral">'/'</span>+wai.dir);
00362 
00363     string wwwali_exe(ac_wwwali_exe.<a class="code" href="classclnconf.html#clnconfa1">val_str</a>());
00364     av[0] = const_cast&lt;char*&gt;(wwwali_exe.c_str());
00365     av[1] = &amp;act;
00366     av[2] = (<span class="keywordtype">char</span> *)alias.c_str();
00367     av[3] = (<span class="keywordtype">char</span> *)dir.c_str();
00368     av[4] = NULL;
00369     <span class="keywordflow">switch</span>((pid=vfork())) {
00370     <span class="keywordflow">case</span> -1: <span class="keywordflow">return</span> <span class="keyword">false</span>;
00371     <span class="keywordflow">case</span> 0:
00372              close(0);
00373              execvp(*av, av);  
00374              _exit(1);
00375     }
00376  
00377     <span class="keywordflow">while</span>( (r=waitpid(pid, &amp;wstat, 0)) == -1 &amp;&amp; errno == EINTR );
00378     <span class="keywordflow">if</span>( r != pid ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00379     <span class="keywordflow">if</span>( WIFEXITED(wstat) &amp;&amp; ! WEXITSTATUS(wstat) ) <span class="keywordflow">return</span> <span class="keyword">true</span>;
00380     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00381 }
00382 
00386 uint8_t cpginfodb::wwwali_get( pqxx::transaction_base &amp; trans, 
00387         <span class="keyword">const</span> string &amp;domid, wwwali_info &amp; wai ) {
00388     pqxx::Result res(trans.Exec(
00389         <span class="stringliteral">"SELECT prefix,dir FROM domains_prefixes WHERE domain_id="</span>
00390         +pqxx::Quote(domid, <span class="keyword">false</span>)+<span class="stringliteral">" AND id="</span>+pqxx::Quote(wai.id, <span class="keyword">false</span>)) );
00391 
00392     <span class="keyword">const</span> <span class="keywordtype">char</span> *ptr;
00393     <span class="keywordflow">if</span>( ! res.size() ) lreturn(err_noent);
00394 
00395     ptr = res[0][0].c_str();
00396     <span class="keywordflow">if</span>(!ptr || ! *ptr) lreturn(err_noent);
00397     wai.prefix = ptr;
00398     
00399     ptr = res[0][1].c_str();
00400     <span class="keywordflow">if</span>(!ptr || ! *ptr) lreturn(err_noent);
00401     wai.dir = ptr;
00402     
00403     lreturn(err_no);
00404 }
00405 
00409 uint8_t cpginfodb::wwwali_get(<span class="keyword">const</span> string &amp;domid, wwwali_info &amp; wai ) {
00410     pqxx::NonTransaction nt(*pg);
00411     <span class="keywordflow">return</span> wwwali_get( nt, domid, wai );
00412 }
00413 
<a name="l00418"></a><a class="code" href="classcpginfodb.html#cpginfodba9">00418</a> uint8_t <a class="code" href="classcpginfodb.html#cpginfodba9">cpginfodb::wwwali_dom_ls_dir</a>(<span class="keyword">const</span> string &amp;id, <span class="keyword">const</span> string &amp;dir, 
00419         vector&lt;wwwali_info&gt; &amp; wais ) {
00420     string edir = dir;
00421     string::size_type slash, edirl=edir.length();
00422 
00423     <span class="keywordflow">for</span>(slash=0; slash&lt;edirl; ++slash)
00424             <span class="keywordflow">if</span>( edir[slash] != <span class="charliteral">'/'</span> ) <span class="keywordflow">break</span>;
00425     <span class="keywordflow">if</span>( slash ) edir = edir.substr(slash);
00426     edirl = edir.length();
00427     <span class="keywordflow">if</span>( edirl ) {
00428             <span class="keywordflow">while</span>( edirl &gt;= 1 &amp;&amp; edir[edirl-1] == <span class="charliteral">'/'</span> ) edirl--; 
00429             edir = edir.substr(0, edirl);
00430     }
00431     edir = pqxx::Quote(<a class="code" href="classcpginfodb.html#cpginfodbb6">dir_clear</a>(edir), <span class="keyword">false</span>);
00432 
00433     wais.clear();
00434     pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00435         <span class="stringliteral">"SELECT id,prefix,dir FROM domains_prefixes WHERE domain_id="</span>
00436         +pqxx::Quote(id, <span class="keyword">false</span>)+<span class="stringliteral">" AND (dir="</span>+edir+<span class="stringliteral">" OR dir='/' || "</span> + edir 
00437         +<span class="stringliteral">" OR dir='/' || "</span>+edir+<span class="stringliteral">" || '/' OR dir="</span>+edir+<span class="stringliteral">" || '/') "</span>
00438         <span class="stringliteral">"ORDER BY prefix"</span>) );
00439 
00440     vector&lt;wwwali_info&gt;::size_type i, cnt;
00441     wwwali_info wai;
00442     <span class="keyword">const</span> <span class="keywordtype">char</span> *ptr;
00443 
00444     <span class="keywordflow">if</span>( ! (cnt=res.size()) ) lreturn(<a class="code" href="group__err.html#a1cpginfodbw0">err_no</a>);
00445 
00446     <span class="keywordflow">for</span>( i=0; i&lt;cnt; i++ ) {
00447             ptr = res[i][0].c_str();
00448             <span class="keywordflow">if</span>(!ptr) <span class="keywordflow">continue</span>;
00449             wai.id = ptr;
00450 
00451             ptr = res[i][1].c_str();
00452             <span class="keywordflow">if</span>(!ptr || ! *ptr) <span class="keywordflow">continue</span>;
00453             wai.prefix = ptr;
00454 
00455             ptr = res[i][2].c_str();
00456             <span class="keywordflow">if</span>(!ptr || ! *ptr) <span class="keywordflow">continue</span>;
00457             wai.dir = ptr;
00458             
00459             wais.push_back(wai);
00460     }
00461 
00462     lreturn(<a class="code" href="group__err.html#a1cpginfodbw0">err_no</a>);
00463 }
00464 
00468 uint8_t cpginfodb::wwwali_dom_get( pqxx::transaction_base &amp; trans,
00469         <span class="keyword">const</span> string &amp;domid, string &amp;domain ) {
00470     pqxx::Result res(trans.Exec(
00471         <span class="stringliteral">"SELECT name FROM domains_all WHERE id="</span>+pqxx::Quote(domid, <span class="keyword">false</span>)) );
00472     
00473     <span class="keywordflow">if</span>( ! res.size() ) lreturn(err_noent);
00474 
00475     <span class="keyword">const</span> <span class="keywordtype">char</span> *ptr = res[0][0].c_str();
00476     <span class="keywordflow">if</span>(! ptr || ! *ptr) lreturn(err_noent);
00477     domain = ptr;
00478     lreturn(err_no);
00479 }
00480 
00484 uint8_t cpginfodb::wwwali_dom_get(<span class="keyword">const</span> string &amp;domid, string &amp;domain ) {
00485     pqxx::NonTransaction nt(*pg);
00486     <span class="keywordflow">return</span> wwwali_dom_get( nt, domid, domain );    
00487 }
00488 
00492 uint8_t cpginfodb::wwwali_dom_id_get(<span class="keyword">const</span> string &amp;domain, string &amp;id ) {
00493     pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00494         <span class="stringliteral">"SELECT id FROM domains_all WHERE name="</span>
00495         +pqxx::Quote(lower(domain), <span class="keyword">false</span>)) );
00496 
00497     <span class="keywordflow">if</span>( ! res.size() ) lreturn(err_noent);
00498 
00499     <span class="keyword">const</span> <span class="keywordtype">char</span> *ptr = res[0][0].c_str();
00500     <span class="keywordflow">if</span>(! ptr || ! *ptr) lreturn(err_noent);
00501     id = ptr;
00502     lreturn(err_no);
00503 }
00504 
<a name="l00510"></a><a class="code" href="classcpginfodb.html#cpginfodbb4">00510</a> uint8_t <a class="code" href="classcpginfodb.html#cpginfodbb4">cpginfodb::wwwali_rdom_get</a>( pqxx::transaction_base &amp;trans,
00511         <span class="keyword">const</span> string &amp;domid, string &amp;domain ) {
00512 
00513     pqxx::Result res(trans.Exec(
00514         <span class="stringliteral">"SELECT d.domain FROM domains as d,domains_all"</span>
00515         <span class="stringliteral">" as dw where dw.id="</span>+pqxx::Quote(domid, <span class="keyword">false</span>)
00516         +<span class="stringliteral">" and dw.domain_id=d.id"</span>) );
00517     
00518     <span class="keywordflow">if</span>( ! res.size() ) lreturn(<a class="code" href="group__err.html#a1cpginfodbw3">err_noent</a>);
00519     
00520     <span class="keyword">const</span> <span class="keywordtype">char</span> *ptr = res[0][0].c_str();
00521     <span class="keywordflow">if</span>(! ptr || ! *ptr) lreturn(<a class="code" href="group__err.html#a1cpginfodbw3">err_noent</a>);
00522     domain = ptr;
00523     lreturn(<a class="code" href="group__err.html#a1cpginfodbw0">err_no</a>);
00524 }
00525 
<a name="l00531"></a><a class="code" href="classcpginfodb.html#cpginfodba16">00531</a> uint8_t <a class="code" href="classcpginfodb.html#cpginfodbb4">cpginfodb::wwwali_rdom_get</a>( <span class="keyword">const</span> string &amp;domid, string &amp;domain ) {
00532     pqxx::NonTransaction nt(*pg);
00533     <span class="keywordflow">return</span> <a class="code" href="classcpginfodb.html#cpginfodbb4">wwwali_rdom_get</a>( nt, domid, domain );
00534 }
00535 
00539 uint8_t cpginfodb::user_ls(<span class="keyword">const</span> string &amp;d, vector&lt;user_info&gt; &amp;users) {
00540     string dom(d);
00541     str2tb(dom);
00542     users.clear();
00543 
00544     pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00545         <span class="stringliteral">"SELECT id,login,date_crt,date_exp FROM \""</span>
00546         +dom+<span class="stringliteral">"\" WHERE login!='' AND login IS NOT NULL"</span>
00547         <span class="stringliteral">" AND flags &amp; 20 = 0 ORDER BY login"</span>) );
00548 
00549     <span class="keywordtype">int</span> tup = res.size();
00550     <span class="keywordflow">if</span>(!tup) lreturn(err_no);
00551     
00552     users.reserve(tup);
00553     user_info fi;
00554     <span class="keyword">const</span> <span class="keywordtype">char</span> *ptr;
00555     
00556     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i=0; i &lt; tup; ++i ) {
00557             ptr = res[i][0].c_str();
00558             <span class="keywordflow">if</span>(!ptr) <span class="keywordflow">continue</span>;
00559             fi.id = ptr;
00560 
00561             ptr = res[i][1].c_str();
00562             <span class="keywordflow">if</span>(!ptr) <span class="keywordflow">continue</span>;
00563             fi.user = ptr; 
00564 
00565             fi.date_crt = (ptr=res[i][2].c_str()) ? ptr : <span class="stringliteral">""</span>;
00566             fi.date_exp = (ptr=res[i][3].c_str()) ? ptr : <span class="stringliteral">""</span>;
00567 
00568             users.push_back(fi);
00569     }
00570     lreturn(err_no);
00571 }
<a name="l00576"></a><a class="code" href="classcpginfodb.html#cpginfodba18">00576</a> uint8_t <a class="code" href="classcpginfodb.html#cpginfodba18">cpginfodb::ui_id_get</a>(<span class="keyword">const</span> string &amp;dom, <span class="keyword">const</span> string &amp;user, string &amp;id) {
00577     pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00578         <span class="stringliteral">"SELECT id FROM users_info WHERE login="</span>
00579         +pqxx::Quote(lower(user), <span class="keyword">false</span>)+<span class="stringliteral">" AND domain_id="</span>
00580         <span class="stringliteral">"(SELECT id FROM domains WHERE domain="</span>
00581         +pqxx::Quote(lower(dom), <span class="keyword">false</span>)+<span class="stringliteral">" LIMIT 1)"</span>) );
00582             
00583     <span class="keywordflow">if</span>( ! res.size() ) lreturn(<a class="code" href="group__err.html#a1cpginfodbw3">err_noent</a>);
00584 
00585     <span class="keyword">const</span> <span class="keywordtype">char</span> *tmp = res[0][0].c_str();
00586     id = ! tmp ? <span class="stringliteral">""</span> : tmp;
00587     lreturn(<a class="code" href="group__err.html#a1cpginfodbw0">err_no</a>);
00588 }
00589 
<a name="l00595"></a><a class="code" href="classcpginfodb.html#cpginfodbb6">00595</a> string <a class="code" href="classcpginfodb.html#cpginfodbb6">cpginfodb::dir_clear</a>( <span class="keyword">const</span> string &amp; dir ) {
00596     string dirclean;
00597     string::const_iterator dircur, dirend;
00598     <span class="keywordtype">char</span> state=0;
00599 
00600     dirclean.reserve(dir.length());
00601     <span class="keywordflow">for</span>( dircur=dir.begin(), dirend=dir.end(); dircur!=dirend; ++dircur ) {
00602             <span class="keywordflow">switch</span>(state) {
00603             <span class="keywordflow">case</span> 1:
00604                 <span class="keywordflow">if</span>(*dircur == <span class="charliteral">'/'</span>) <span class="keywordflow">break</span>;
00605                 state = 0;
00606                 dirclean += *dircur;
00607                 <span class="keywordflow">break</span>;
00608             <span class="keywordflow">case</span> 0:
00609                 <span class="keywordflow">if</span>(*dircur == <span class="charliteral">'/'</span>) state = 1;
00610                 dirclean += *dircur;
00611                 <span class="keywordflow">break</span>;
00612             }
00613     }
00614     <span class="keywordflow">return</span> dirclean; 
00615 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Dec 25 13:37:23 2003 for vqwww: hosting by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.3 </small></address>
</body>
</html>
