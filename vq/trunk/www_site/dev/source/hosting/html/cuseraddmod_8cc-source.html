<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>vqwww: hosting: cuseraddmod.cc Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.3 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Compound&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Compound&nbsp;Members</a></div>
<h1>cuseraddmod.cc</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment">Copyright (c) 2003 Pawel Niewiadomski</span>
00003 <span class="comment">All rights reserved.</span>
00004 <span class="comment"></span>
00005 <span class="comment">Redistribution and use in source and binary forms, with or without</span>
00006 <span class="comment">modification, are permitted provided that the following conditions</span>
00007 <span class="comment">are met:</span>
00008 <span class="comment">1. Redistributions of source code must retain the above copyright</span>
00009 <span class="comment">   notice, this list of conditions and the following disclaimer.</span>
00010 <span class="comment">2. Redistributions in binary form must reproduce the above copyright</span>
00011 <span class="comment">   notice, this list of conditions and the following disclaimer in the</span>
00012 <span class="comment">   documentation and/or other materials provided with the distribution.</span>
00013 <span class="comment">3. All advertising materials mentioning features or use of this software</span>
00014 <span class="comment">   must display the following acknowledgement:</span>
00015 <span class="comment">   This product includes software developed by the Pawel Niewiadomski,</span>
00016 <span class="comment">   and other contributors.</span>
00017 <span class="comment">4. Neither the name of Pawel Niewiadomski nor the names of other contributors</span>
00018 <span class="comment">   may be used to endorse or promote products derived from this software</span>
00019 <span class="comment">   without specific prior written permission.</span>
00020 <span class="comment"></span>
00021 <span class="comment">THIS SOFTWARE IS PROVIDED BY PAWEL NIEWIADOMSKI AND CONTRIBUTORS ``AS IS'' AND</span>
00022 <span class="comment">ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
00023 <span class="comment">IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
00024 <span class="comment">ARE DISCLAIMED.  IN NO EVENT SHALL PAWEL NIEWIADOMSKI OR CONTRIBUTORS BE LIABLE</span>
00025 <span class="comment">FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
00026 <span class="comment">DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</span>
00027 <span class="comment">OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
00028 <span class="comment">HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
00029 <span class="comment">LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
00030 <span class="comment">OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
00031 <span class="comment">SUCH DAMAGE.</span>
00032 <span class="comment">*/</span>
00033 <span class="preprocessor">#include &lt;inttypes.h&gt;</span>
00034 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00035 <span class="preprocessor">#include &lt;sys/wait.h&gt;</span>
00036 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00037 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00038 
00039 <span class="preprocessor">#include &lt;vqwww.h&gt;</span>
00040 <span class="preprocessor">#include &lt;cgi.h&gt;</span>
00041 <span class="preprocessor">#include &lt;html.h&gt;</span>
00042 <span class="preprocessor">#include &lt;vqwww_conf.h&gt;</span>
00043 
00044 <span class="preprocessor">#include "cuseraddmod.h"</span>
00045 <span class="preprocessor">#include "hosting_conf.h"</span>
00046 <span class="preprocessor">#include "cinfodb.h"</span>
00047 
00048 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00049 <span class="keyword">using</span> <span class="keyword">namespace </span>hosting;
00050 <span class="keyword">using</span> <span class="keyword">namespace </span>vqwww;
00051 
00052 <span class="keyword">const</span> <span class="keywordtype">char</span> cuseraddmod::_id[] = <span class="stringliteral">"useradd"</span>;
00053 <span class="keyword">const</span> <span class="keywordtype">char</span> cuseraddmod::_conf[] = <span class="stringliteral">"&lt;useradd/&gt;&lt;desc&gt;&lt;useradd/&gt;&lt;/desc&gt;"</span>;
00054 
00055 <span class="keyword">const</span> <span class="keywordtype">char</span> * cuseraddmod::conf() {
00056           <span class="keywordflow">return</span> ! (sessb.ai.flags &amp;cvq::admin) ? <span class="stringliteral">""</span> : _conf;
00057 }
00061 cuseraddmod::cuseraddmod( cenvironment &amp; env ) : cmod(env) {
00062   modinfo = sessb.ai.flags &amp; cvq::admin ? mi_conf : 0;
00063 }
00067 <span class="keywordtype">void</span> cuseraddmod::act() {
00068     out&lt;&lt; <span class="stringliteral">"&lt;mod&gt;&lt;useradd&gt;"</span>;
00069 
00070     string login;
00071     <span class="keywordflow">if</span>( env.cgi_rm_get() == cenvironment::rm_post ) {
00072             <span class="keywordtype">bool</span> ok=<span class="keyword">true</span>;
00073             string pass, pass1;
00074             string::size_type len;
00075             out&lt;&lt;<span class="stringliteral">"&lt;inv&gt;"</span>;
00076             out&lt;&lt;<span class="stringliteral">"&lt;login"</span>;
00077             <span class="keywordflow">if</span>( ! cgi_var(cgi, <span class="stringliteral">"login"</span>, login) || login.empty() ) {
00078                     ok = <span class="keyword">false</span>;
00079                     out&lt;&lt;<span class="stringliteral">" empty=\"1\" "</span>; 
00080             } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( (len=login.length()) &lt; ac_user_minl.val_int() ) {
00081                     ok = <span class="keyword">false</span>;
00082                     out&lt;&lt;<span class="stringliteral">" tooshort=\"1\" "</span>;
00083             } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( len &gt; ac_user_maxl.val_int() ) {
00084                     ok = <span class="keyword">false</span>;
00085                     out&lt;&lt;<span class="stringliteral">" toolong=\"1\" "</span>;
00086             } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( htmlbad(pass, ac_user_ok.val_str().c_str(), 
00087                 ac_html_br.val_str().at(0) ) ) {
00088                     ok = <span class="keyword">false</span>;
00089                     out&lt;&lt; <span class="stringliteral">" dirty=\"1\" "</span>;
00090             }
00091             out&lt;&lt;<span class="stringliteral">"/&gt;"</span>;
00092             out&lt;&lt;<span class="stringliteral">"&lt;pass"</span>;
00093             <span class="keywordflow">if</span>( ! cgi_var(cgi, <span class="stringliteral">"pass"</span>, pass) || pass.empty() ) {
00094                     ok = <span class="keyword">false</span>;
00095                     out&lt;&lt;<span class="stringliteral">" empty=\"1\" "</span>;
00096             } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( (len=pass.length()) &lt; ac_pass_minl.val_int() ) {
00097                     ok = <span class="keyword">false</span>;
00098                     out&lt;&lt;<span class="stringliteral">" tooshort=\"1\" "</span>;
00099             } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( len &gt; ac_pass_maxl.val_int() ) {
00100                     ok = <span class="keyword">false</span>;
00101                     out&lt;&lt;<span class="stringliteral">" toolong=\"1\" "</span>;
00102             } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( htmlbad(pass, ac_pass_ok.val_str().c_str(), 
00103                 ac_html_br.val_str().at(0) ) ) {
00104                     ok = <span class="keyword">false</span>;
00105                     out&lt;&lt; <span class="stringliteral">" dirty=\"1\" "</span>;
00106             }
00107             out&lt;&lt;<span class="stringliteral">"/&gt;"</span>;
00108             cgi_var(cgi, <span class="stringliteral">"pass1"</span>, pass1);
00109             <span class="keywordflow">if</span>( pass != pass1 ) {
00110                     ok = <span class="keyword">false</span>;
00111                     out&lt;&lt;<span class="stringliteral">"&lt;dontmatch/&gt;"</span>;
00112             }
00113             <span class="keywordflow">if</span>( ok ) {
00114                     uint8_t ret = vq.user_add(login, sessb.ai.dom, pass );
00115                     <span class="keywordflow">switch</span>(ret) {
00116                     <span class="keywordflow">case</span> cvq::err_user_inv:
00117                             out&lt;&lt;<span class="stringliteral">"&lt;inv/&gt;"</span>;
00118                             <span class="keywordflow">break</span>;
00119                     <span class="keywordflow">case</span> cvq::err_no: 
00120                             out&lt;&lt;<span class="stringliteral">"&lt;done/&gt;"</span>;
00121                             <span class="keywordflow">if</span>( ! ac_notify.<a class="code" href="classclnconf.html#clnconfa1">val_str</a>().empty() )
00122                                     notify_run(login);
00123                             login = pass = pass1 = <span class="stringliteral">""</span>;
00124                             <span class="keywordflow">break</span>;
00125                     <span class="keywordflow">default</span>:                            
00126                             out&lt;&lt;<span class="stringliteral">"&lt;cant/&gt;"</span>;
00127                             err&lt;&lt;<span class="stringliteral">"cuseraddmod: can't add user: "</span>&lt;&lt;vq.err_report()&lt;&lt;endl;
00128                     }
00129             }
00130             out&lt;&lt;<span class="stringliteral">"&lt;/inv&gt;"</span>;
00131     }
00132     out&lt;&lt; <span class="stringliteral">"&lt;login val=\""</span> &lt;&lt; login &lt;&lt; <span class="stringliteral">"\"/&gt;&lt;/useradd&gt;&lt;/mod&gt;"</span>;
00133 }
00134 <span class="comment">/**************************************************************************</span>
00135 <span class="comment"> *  </span>
00136 <span class="comment"> *  ***********************************************************************/</span>
00137 <span class="keywordtype">char</span> cuseraddmod::run() {
00138     <span class="keywordflow">if</span>( ! (sessb.ai.flags &amp; cvq::admin) ) <span class="keywordflow">return</span> notme;
00139     
00140     cgicc::const_form_iterator fi = cgi.getElement(<span class="stringliteral">"conf"</span>);
00141     <span class="keywordflow">if</span>( fi != env.cgi_end_get() ) {
00142             fi = cgi.getElement(<span class="stringliteral">"id"</span>);
00143             <span class="keywordflow">if</span>( fi != env.cgi_end_get() &amp;&amp; fi-&gt;getValue() == _id ) {
00144                     idb.reset(cinfodb::alloc());
00145 
00146                     act();
00147                     <span class="keywordflow">return</span> done;
00148             }
00149     }
00150     <span class="keywordflow">return</span> notme;
00151 }
00152 
00155 <span class="keywordtype">void</span> cuseraddmod::notify_run(<span class="keyword">const</span> string &amp;login) {
00156     string rcpt = sessb.ai.user+<span class="charliteral">'@'</span>+sessb.ai.dom;
00157     string ui_id;
00158     <span class="keywordflow">if</span>( idb-&gt;ui_id_get(sessb.ai.dom, sessb.ai.user, ui_id) ) <span class="keywordflow">return</span>;
00159    
00160     string notify(ac_notify.<a class="code" href="classclnconf.html#clnconfa1">val_str</a>());
00161     <span class="keywordtype">char</span> *av[] = { 
00162             const_cast&lt;char *&gt;(notify.c_str()), 
00163             (<span class="keywordtype">char</span> *)sessb.ai.dom.c_str(), 
00164             (<span class="keywordtype">char</span> *)login.c_str(), 
00165             (<span class="keywordtype">char</span> *)ui_id.c_str(), 
00166             (<span class="keywordtype">char</span> *)rcpt.c_str(), NULL };
00167 
00168     <span class="keywordtype">int</span> pid;
00169     <span class="keywordflow">switch</span>((pid=vfork())) {
00170     <span class="keywordflow">case</span> -1:
00171       err&lt;&lt;<span class="stringliteral">"cuseraddmod::notify_run: vfork: "</span>&lt;&lt;strerror(errno)&lt;&lt;endl;
00172       <span class="keywordflow">break</span>;
00173     <span class="keywordflow">case</span> 0:
00174       execvp( *av, av );
00175       err&lt;&lt;<span class="stringliteral">"cuseraddmod::notify_run: execvp: "</span>&lt;&lt; *av &lt;&lt;<span class="stringliteral">": "</span>&lt;&lt;strerror(errno)&lt;&lt;endl;
00176       _exit(1);
00177     }
00178     <span class="keywordflow">while</span>( wait(&amp;pid) == -1 &amp;&amp; EINTR == errno );
00179 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Dec 25 13:37:23 2003 for vqwww: hosting by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.3 </small></address>
</body>
</html>
