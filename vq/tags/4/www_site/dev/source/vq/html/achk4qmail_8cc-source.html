<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Virtual Qmail: achk4qmail.cc Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.3 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Compound&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Compound&nbsp;Members</a></div>
<h1>achk4qmail.cc</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment">Copyright (c) 2002 Pawel Niewiadomski</span>
00003 <span class="comment">All rights reserved.</span>
00004 <span class="comment"></span>
00005 <span class="comment">Redistribution and use in source and binary forms, with or without</span>
00006 <span class="comment">modification, are permitted provided that the following conditions</span>
00007 <span class="comment">are met:</span>
00008 <span class="comment">1. Redistributions of source code must retain the above copyright</span>
00009 <span class="comment">   notice, this list of conditions and the following disclaimer.</span>
00010 <span class="comment">2. Redistributions in binary form must reproduce the above copyright</span>
00011 <span class="comment">   notice, this list of conditions and the following disclaimer in the</span>
00012 <span class="comment">   documentation and/or other materials provided with the distribution.</span>
00013 <span class="comment">3. All advertising materials mentioning features or use of this software</span>
00014 <span class="comment">   must display the following acknowledgement:</span>
00015 <span class="comment">   This product includes software developed by the Pawel Niewiadomski,</span>
00016 <span class="comment">   and other contributors.</span>
00017 <span class="comment">4. Neither the name of Pawel Niewiadomski nor the names of other contributors</span>
00018 <span class="comment">   may be used to endorse or promote products derived from this software</span>
00019 <span class="comment">   without specific prior written permission.</span>
00020 <span class="comment"></span>
00021 <span class="comment">THIS SOFTWARE IS PROVIDED BY PAWEL NIEWIADOMSKI AND CONTRIBUTORS ``AS IS'' AND</span>
00022 <span class="comment">ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
00023 <span class="comment">IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
00024 <span class="comment">ARE DISCLAIMED.  IN NO EVENT SHALL PAWEL NIEWIADOMSKI OR CONTRIBUTORS BE LIABLE</span>
00025 <span class="comment">FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
00026 <span class="comment">DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</span>
00027 <span class="comment">OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
00028 <span class="comment">HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
00029 <span class="comment">LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
00030 <span class="comment">OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
00031 <span class="comment">SUCH DAMAGE.</span>
00032 <span class="comment">*/</span>
00033 
00034 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00035 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00036 <span class="preprocessor">#include &lt;sys/socket.h&gt;</span>
00037 <span class="preprocessor">#include &lt;sys/sem.h&gt;</span>
00038 <span class="preprocessor">#include &lt;sys/un.h&gt;</span>
00039 <span class="preprocessor">#include &lt;time.h&gt;</span>
00040 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00041 <span class="preprocessor">#include &lt;cerrno&gt;</span>
00042 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
00043 <span class="preprocessor">#include &lt;exception&gt;</span>
00044 <span class="preprocessor">#include &lt;stdexcept&gt;</span>
00045 <span class="preprocessor">#include &lt;iostream&gt;</span>
00046 <span class="preprocessor">#include &lt;algorithm&gt;</span>
00047 <span class="preprocessor">#include &lt;vector&gt;</span>
00048 <span class="preprocessor">#include &lt;sstream&gt;</span>
00049 
00050 <span class="preprocessor">#include "vq_conf.h"</span>
00051 <span class="preprocessor">#include "vq_init.h"</span>
00052 <span class="preprocessor">#include "sig.h"</span>
00053 <span class="preprocessor">#include "fd.h"</span>
00054 <span class="preprocessor">#include "fdstr.h"</span>
00055 <span class="comment">//#include "util.h"</span>
00056 <span class="preprocessor">#include "lock.h"</span>
00057 <span class="preprocessor">#include "sys.h"</span>
00058 
00059 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00060 
00061 <span class="comment">// socket</span>
00062 string fnlock = <span class="stringliteral">"achk_socket.lock"</span>;
00063 string dir = conf_qmail+<span class="stringliteral">"/control"</span>;
00064 string fn = <span class="stringliteral">"achk_socket"</span>;
00065 <span class="keywordtype">int</span> slock, sso, cso;
00066 <span class="comment">// child</span>
00067 <span class="keywordtype">bool</span> child_we, child_re;
00068 <span class="keywordtype">char</span> addr_type=0;
00069 string addr, user, dom, tb;
00070 <span class="comment">// VQ</span>
00071 <a class="code" href="classcvq.html">cvq</a> *vq = NULL;
00072 <a class="code" href="classcpoll.html">cpoll</a> fds;
00073 
00077 <span class="keywordtype">void</span> setup()
00078 {
00079     umask(0);
00080             
00081     <span class="keywordflow">if</span>(!sig_pipeign() || !sig_chld_nocldwait()) 
00082             <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"setup: can't set signals: "</span>+strerror(errno));
00083     <span class="keywordflow">if</span>(chdir(dir.c_str()))
00084             <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"setup: chdir: "</span>
00085                     +dir+<span class="stringliteral">": "</span>+strerror(errno));
00086     slock = open(fnlock.c_str(), O_RDONLY | O_NONBLOCK | O_CREAT, 0600 );
00087     <span class="keywordflow">if</span>(slock==-1)
00088             <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"setup: open: "</span>+fnlock+<span class="stringliteral">": "</span>+strerror(errno));
00089     <span class="keywordflow">if</span>(lock_exnb(slock)) {
00090             <span class="keywordflow">if</span>( errno == EWOULDBLOCK )
00091                     <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"setup: "</span>+fnlock+<span class="stringliteral">" is already locked"</span>);
00092             <span class="keywordflow">else</span> <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"setup: "</span>+fnlock+<span class="stringliteral">": lock: "</span>+strerror(errno));
00093     }
00094     <span class="keywordflow">if</span>(unlink(fn.c_str())==-1 &amp;&amp; errno != ENOENT )
00095             <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"setup: unlink: "</span>+fn+<span class="stringliteral">": "</span>+strerror(errno));
00096     <span class="keywordflow">if</span>( (sso=socket(AF_UNIX,SOCK_STREAM,0)) == -1 )
00097             <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"setup: socket: "</span>+strerror(errno));
00098 
00099     <span class="keyword">struct </span>sockaddr_un sun;
00100     sun.sun_family = AF_UNIX;
00101     strncpy(sun.sun_path, fn.c_str(), <span class="keyword">sizeof</span>(sun.sun_path)-1);
00102     <span class="keywordflow">if</span>(bind(sso, (<span class="keyword">struct</span> sockaddr*) &amp;sun, SUN_LEN(&amp;sun)))
00103             <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"setup: bind: "</span>+fn+<span class="stringliteral">": "</span>+strerror(errno));
00104     <span class="keywordflow">if</span>(chmod(fn.c_str(), 0600))
00105             <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"setup: chmod: "</span>+fn+<span class="stringliteral">": "</span>+strerror(errno));
00106     <span class="keywordflow">if</span>( listen(sso, 5) == -1 )
00107             <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"setup: listen: "</span>+strerror(errno));
00108 }
00109 
00113 <span class="keywordtype">void</span> ue() {
00114     uint8_t ret = vq-&gt;<a class="code" href="group__user.html#a12">user_ex</a>(dom, user);
00115     cout&lt;&lt;(<span class="keywordtype">int</span>)ret&lt;&lt;endl;
00116     <span class="keywordflow">if</span>( 1 == ret ) {
00117             <span class="keywordflow">if</span>(fdwrite(cso, &amp;<span class="stringliteral">"Z"</span>, 1) != 1
00118                || fdwrstr(cso,<span class="stringliteral">"553 no such mailbox; nie ma takiej skrzynki"</span>) == -1 ) child_we=<span class="keyword">true</span>;
00119             <span class="keywordflow">return</span>;
00120     }
00121     <span class="keywordflow">if</span>( 2 == ret) {
00122             <span class="keywordflow">if</span>( 1 != fdwrite(cso, &amp;<span class="stringliteral">"K"</span>, 1) ) child_we = <span class="keyword">true</span>;
00123             <span class="keywordflow">return</span>;
00124     }
00125             <span class="keywordflow">if</span>( 1 != fdwrite(cso, &amp;<span class="stringliteral">"K"</span>, 1) ) child_we = <span class="keyword">true</span>;
00126 }
00127 
00131 <span class="keywordtype">void</span> achk() {
00132     string::size_type atpos;
00133     <span class="keywordflow">if</span>( fdrdstr(cso, addr) != -1 ) {
00134             <span class="keywordflow">if</span>(<span class="charliteral">'M'</span> == addr_type 
00135                &amp;&amp; (addr.empty() || (1==addr.length() &amp;&amp; <span class="charliteral">'\0'</span>==addr[0])) ) {
00136                     <span class="keywordflow">if</span>(fdwrite(cso, &amp;<span class="stringliteral">"K"</span>,1) != 1) child_we=<span class="keyword">true</span>;
00137                     <span class="keywordflow">return</span>;
00138             }
00139             atpos = addr.find(<span class="charliteral">'@'</span>);
00140             <span class="keywordflow">if</span>( string::npos == atpos ) {
00141                     <span class="keywordflow">if</span>(fdwrite(cso, &amp;<span class="stringliteral">"Z"</span>, 1) != 1
00142                        || fdwrstr(cso,<span class="stringliteral">"553 sorry, I accept addresses only with @ sign; przykro mi, ale adres musi zawierac znak @"</span>) == -1 ) child_we=<span class="keyword">true</span>;
00143                     <span class="keywordflow">return</span>;
00144             }
00145             dom = addr.substr( atpos+1 );
00146             user = addr.substr( 0, atpos );
00147             <span class="keywordflow">if</span>(dom.empty() || user.empty()) {
00148                     <span class="keywordflow">if</span>(fdwrite(cso, &amp;<span class="stringliteral">"Z"</span>, 1) != 1
00149                        || fdwrstr(cso,<span class="stringliteral">"553 invalid e-mail address; nieprawidlowy adres e-mail"</span>) == -1 ) child_we=<span class="keyword">true</span>;
00150                     <span class="keywordflow">return</span>;
00151             }
00152             ue();
00153     } <span class="keywordflow">else</span> child_re = <span class="keyword">true</span>;
00154 }
00155 
00158 void (*cmd_proc( <span class="keywordtype">char</span> cmd )) () {
00159     addr_type = 0;
00160     <span class="keywordflow">switch</span>(cmd) {
00161     <span class="keywordflow">case</span> <span class="charliteral">'M'</span>:
00162             <span class="keywordflow">if</span>(!addr_type) addr_type = <span class="charliteral">'M'</span>;
00163     <span class="keywordflow">case</span> <span class="charliteral">'R'</span>:
00164             <span class="keywordflow">if</span>(!addr_type) addr_type = <span class="charliteral">'R'</span>;
00165             <span class="keywordflow">return</span> &amp;achk;
00166     <span class="keywordflow">default</span>:
00167         <span class="keywordflow">return</span> NULL;
00168     }
00169 }
00172 <span class="keywordtype">void</span> child()
00173 {
00174     <span class="keywordtype">char</span> cmd;
00175     void (*run)();
00176     
00177     child_we = child_re = <span class="keyword">false</span>;
00178     <span class="keywordflow">switch</span>( fdread(cso, &amp;cmd, 1) ) {
00179     <span class="keywordflow">case</span> 0: <span class="keywordflow">return</span>;
00180     <span class="keywordflow">case</span> -1: 
00181             child_re = <span class="keyword">true</span>;
00182             <span class="keywordflow">goto</span> child_end;
00183     }
00184     <span class="comment">// process cmd</span>
00185     <span class="keywordflow">if</span>( ! (run = cmd_proc(cmd)) ) {
00186             cerr &lt;&lt; <span class="stringliteral">"child: unknown command: "</span> &lt;&lt; (<span class="keywordtype">int</span>) cmd &lt;&lt; endl;
00187             <span class="keywordflow">return</span>;
00188     }
00189 child_end:
00190     <span class="keywordflow">if</span>( child_re ) {
00191             cerr &lt;&lt; <span class="stringliteral">"child: read error: "</span> &lt;&lt; strerror(errno) &lt;&lt; endl;
00192     }
00193     <span class="keywordflow">if</span>( child_we ) {
00194             cerr &lt;&lt; <span class="stringliteral">"child: write error: "</span> &lt;&lt; strerror(errno) &lt;&lt; endl;
00195     }
00196 }
00197 
00200 <span class="keywordtype">int</span> main()
00201 {
00202     <span class="keywordflow">try</span> {
00203 
00204     <span class="keyword">struct </span>sockaddr_un cun;
00205     socklen_t cunl;
00206             
00207     setup();
00208     vq_init(&amp;vq, &amp;auth);
00209     
00210     fds.<a class="code" href="classcpoll.html#cpolla2">add</a>(sso, POLLIN | POLLERR | POLLNVAL );
00211     <span class="keywordflow">for</span>( ;; ) {
00212             <span class="keywordflow">if</span>( fds.<a class="code" href="classcpoll.html#cpolla5">poll</a>(-1) &gt; 0 ) {
00213                     <span class="keywordflow">for</span>( i=1; i &lt; fds.<a class="code" href="classcpoll.html#cpollo1">cnt</a>; i++ ) {
00214                             <span class="keywordflow">if</span>( ! fds[i].revents ) <span class="keywordflow">continue</span>;
00215                             <span class="keywordflow">if</span>( fds[i].revents &amp; POLLNVAL
00216                                 || fds[i].revents &amp; POLLHUP 
00217                                 || fds[i].revents &amp; POLLERR ) {
00218                                     close(fds[i].fd);
00219                                     fds.<a class="code" href="classcpoll.html#cpolla3">rm</a>(fds[i].fd);
00220                                     <span class="keywordflow">continue</span>;
00221                             }
00222                             <span class="keywordflow">if</span>( fds[i].revents &amp; POLLIN ) {
00223                                     cso = fds[i].fd;
00224                                     child();
00225                             }
00226                     }
00227                     <span class="keywordflow">if</span>( fds.<a class="code" href="classcpoll.html#cpollo0">fds</a>[0].revents &amp; POLLIN ) {
00228                             cunl = <span class="keyword">sizeof</span>(cun);
00229                             <span class="keywordflow">if</span>( (fd_new=accept(sso, (<span class="keyword">struct</span> sockaddr *)&amp;cun, &amp;cunl)) != -1 ) {
00230                                     <span class="keywordflow">if</span>( setsockopt(fd_new, SOL_SOCKET, SO_SNDTIMEO, 
00231                                         &amp; stimeo, <span class="keyword">sizeof</span>(stimeo))
00232                                         || setsockopt(fd_new, SOL_SOCKET, SO_RCVTIMEO,
00233                                         &amp; stimeo, <span class="keyword">sizeof</span>(stimeo)) )
00234                                             cerr &lt;&lt; <span class="stringliteral">"setsockopt: "</span> &lt;&lt; strerror(errno) &lt;&lt; endl;
00235                                     fds.<a class="code" href="classcpoll.html#cpolla2">add</a>(fd_new, POLLIN | POLLERR | POLLNVAL | POLLHUP );
00236                             } <span class="keywordflow">else</span> cerr&lt;&lt; <span class="stringliteral">"accept: "</span> &lt;&lt; strerror(errno) &lt;&lt; endl;
00237                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( fds[0].revents ) {
00238                             cerr&lt;&lt;<span class="stringliteral">"socket problem: "</span>&lt;&lt; fds[0].revents &lt;&lt;<span class="stringliteral">": "</span>&lt;&lt;strerror(errno)&lt;&lt;endl;
00239                             <span class="keywordflow">return</span> 1;
00240                     }
00241             } <span class="keywordflow">else</span> cerr&lt;&lt; <span class="stringliteral">"poll: "</span> &lt;&lt; strerror(errno) &lt;&lt; endl;  
00242     }
00243 
00244     } <span class="keywordflow">catch</span>( <span class="keyword">const</span> exception &amp; e ) {
00245             cerr &lt;&lt; <span class="stringliteral">"exception: "</span> &lt;&lt; e.what() &lt;&lt; endl;
00246             <span class="keywordflow">return</span> 1;
00247     }
00248     <span class="keywordflow">return</span> 0;
00249 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Dec 25 13:37:09 2003 for Virtual Qmail by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.3 </small></address>
</body>
</html>
