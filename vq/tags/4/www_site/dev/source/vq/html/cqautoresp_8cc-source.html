<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Virtual Qmail: cqautoresp.cc Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.3 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Compound&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Compound&nbsp;Members</a></div>
<h1>cqautoresp.cc</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment">Copyright (c) 2003 Pawel Niewiadomski</span>
00003 <span class="comment">All rights reserved.</span>
00004 <span class="comment"></span>
00005 <span class="comment">Redistribution and use in source and binary forms, with or without</span>
00006 <span class="comment">modification, are permitted provided that the following conditions</span>
00007 <span class="comment">are met:</span>
00008 <span class="comment">1. Redistributions of source code must retain the above copyright</span>
00009 <span class="comment">   notice, this list of conditions and the following disclaimer.</span>
00010 <span class="comment">2. Redistributions in binary form must reproduce the above copyright</span>
00011 <span class="comment">   notice, this list of conditions and the following disclaimer in the</span>
00012 <span class="comment">   documentation and/or other materials provided with the distribution.</span>
00013 <span class="comment">3. All advertising materials mentioning features or use of this software</span>
00014 <span class="comment">   must display the following acknowledgement:</span>
00015 <span class="comment">   This product includes software developed by the Pawel Niewiadomski,</span>
00016 <span class="comment">   and other contributors.</span>
00017 <span class="comment">4. Neither the name of Pawel Niewiadomski nor the names of other contributors</span>
00018 <span class="comment">   may be used to endorse or promote products derived from this software</span>
00019 <span class="comment">   without specific prior written permission.</span>
00020 <span class="comment"></span>
00021 <span class="comment">THIS SOFTWARE IS PROVIDED BY PAWEL NIEWIADOMSKI AND CONTRIBUTORS ``AS IS'' AND</span>
00022 <span class="comment">ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
00023 <span class="comment">IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
00024 <span class="comment">ARE DISCLAIMED.  IN NO EVENT SHALL PAWEL NIEWIADOMSKI OR CONTRIBUTORS BE LIABLE</span>
00025 <span class="comment">FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
00026 <span class="comment">DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</span>
00027 <span class="comment">OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
00028 <span class="comment">HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
00029 <span class="comment">LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
00030 <span class="comment">OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
00031 <span class="comment">SUCH DAMAGE.</span>
00032 <span class="comment">*/</span>
00033 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
00034 <span class="preprocessor">#include &lt;sys/wait.h&gt;</span>
00035 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00036 <span class="preprocessor">#include &lt;new&gt;</span>
00037 <span class="preprocessor">#include &lt;sstream&gt;</span>
00038 <span class="preprocessor">#include &lt;algorithm&gt;</span>
00039 <span class="preprocessor">#include &lt;ctime&gt;</span>
00040 <span class="preprocessor">#include &lt;cstdio&gt;</span>
00041 <span class="preprocessor">#include &lt;cerrno&gt;</span>
00042 
00043 <span class="preprocessor">#include "sys.h"</span>
00044 <span class="preprocessor">#include "cqautoresp.h"</span>
00045 <span class="preprocessor">#include "vq_conf.h"</span>
00046 <span class="preprocessor">#include "pfstream.h"</span>
00047 
00048 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00049 <span class="keyword">using</span> <span class="keyword">namespace </span>posix;
00050 <span class="keyword">using</span> <span class="keyword">namespace </span>vq;
00051 
<a name="l00052"></a><a class="code" href="classcautoresp.html#cqautorespe0">00052</a> <a class="code" href="classcautoresp.html">cautoresp</a> * <a class="code" href="classcautoresp.html#cqautorespe0">cautoresp::alloc</a>() {
00053     <span class="keywordflow">return</span> <span class="keyword">new</span> cqautoresp();
00054 }
00055 
00059 cqautoresp::cqautoresp() {
00060     <span class="keywordflow">if</span>( !sig_pipeign() ) 
00061             <span class="keywordflow">throw</span> runtime_error(<span class="stringliteral">"can't ignore SIGPIPE"</span>);
00062     
00063     <span class="keywordflow">if</span>( regcomp(&amp;re_x_remark, <span class="stringliteral">".*automatic.*response.*"</span>, REG_ICASE | REG_NOSUB 
00064         | REG_EXTENDED ) )
00065             <span class="keywordflow">throw</span> regex_comp(<span class="stringliteral">"re_x_remark"</span>);
00066 }
00070 cqautoresp::~cqautoresp() {
00071     regfree(&amp;re_x_remark);
00072 }
00073 
00077 <span class="keywordtype">void</span> cqautoresp::msg_set( <span class="keyword">const</span> string &amp; m ) {
00078     msg = m;
00079 }
00080 
00084 <span class="keywordtype">void</span> cqautoresp::hdrs_add_set( <span class="keyword">const</span> map_hdr_val &amp; m ) {
00085     hdrs_add = m;
00086 }
00087 
00091 <span class="keywordtype">void</span> cqautoresp::msgWrite( ostream &amp; out ) {
00092     map_hdr_val::const_iterator iter, end;
00093     map_hdr_val::iterator rp;
00094     <span class="keywordflow">if</span>( (rp=hdrs_add.find(<span class="stringliteral">"return-path"</span>)) != hdrs_add.end() )
00095             hdrs_add.erase(rp);
00096 
00097     out&lt;&lt;<span class="stringliteral">"Return-Path: "</span>&lt;&lt;hdrs_add[<span class="stringliteral">"from"</span>]&lt;&lt;endl;
00098     <span class="keywordflow">for</span>( iter=hdrs_add.begin(), end=hdrs_add.end(); iter!=end; ++iter ) {
00099             out&lt;&lt;iter-&gt;first&lt;&lt;<span class="stringliteral">": "</span>&lt;&lt;iter-&gt;second&lt;&lt;endl;
00100     }
00101     out&lt;&lt;endl;
00102     out&lt;&lt;msg;
00103     out&lt;&lt;endl;
00104     out.flush();
00105 }
00106 
00110 <span class="keywordtype">void</span> cqautoresp::msgSend() {
00111     <span class="keywordtype">int</span> qip[2], pid;
00112     <span class="keywordtype">char</span> *args[] = { <span class="stringliteral">"qmail-inject"</span>, NULL };
00113     
00114     <span class="keywordflow">if</span>(pipe(qip)) <span class="keywordflow">throw</span> runtime_error(<span class="stringliteral">"pipe failed!"</span>);
00115     <span class="keywordflow">switch</span>((pid=fork())) {
00116     <span class="keywordflow">case</span> -1: <span class="keywordflow">throw</span> runtime_error(<span class="stringliteral">"fork failed!"</span>);
00117     <span class="keywordflow">case</span> 0:
00118             close(qip[1]);
00119             <span class="keywordflow">if</span>( dup2(qip[0], 0) != -1 ) {
00120                     execvp(*args, args);
00121             }
00122             _exit(111);
00123     }
00124 
00125     close(qip[0]);
00126     pfstream out(qip[1]);
00127     msgWrite(out);
00128     out.close();
00129     <span class="keywordflow">if</span>(out.bad()) 
00130             <span class="keywordflow">throw</span> runtime_error(<span class="stringliteral">"qmail-inject write problem"</span>);
00131     <span class="keywordflow">while</span>(wait(&amp;pid)==-1 &amp;&amp; errno==EINTR);
00132     <span class="keywordflow">if</span>( ! WIFEXITED(pid) || WEXITSTATUS(pid) ) 
00133             <span class="keywordflow">throw</span> runtime_error(<span class="stringliteral">"qmail-inject crashed or returned!=0"</span>);
00134 }
00135 
00139 <span class="keywordtype">void</span> cqautoresp::reply( <span class="keyword">const</span> map_hdr_val &amp; const_hdrs ) {
00140     <a class="code" href="classcautoresp.html#cqautorespw0">map_hdr_val</a> hdrs(const_hdrs);
00141     <span class="keyword">const</span> <span class="keywordtype">char</span> *tmp;
00142     <span class="keyword">const</span> <span class="keywordtype">char</span> md[] = <span class="stringliteral">"mailer-daemon"</span>;
00143     string host, rcpt, local, sender, new_rcpt;
00144 
00145     <span class="keywordflow">if</span>(!(tmp=getenv(<span class="stringliteral">"HOST"</span>))) <span class="keywordflow">throw</span> env_miss(<span class="stringliteral">"HOST"</span>);
00146     host = tmp;
00147     <span class="keywordflow">if</span>(!(tmp=getenv(<span class="stringliteral">"RECIPIENT"</span>))) <span class="keywordflow">throw</span> env_miss(<span class="stringliteral">"RECIPIENT"</span>);
00148     rcpt = tmp;
00149     <span class="keywordflow">if</span>(!(tmp=getenv(<span class="stringliteral">"LOCAL"</span>))) <span class="keywordflow">throw</span> env_miss(<span class="stringliteral">"LOCAL"</span>);
00150     local = tmp;
00151     <span class="keywordflow">if</span>(!(tmp=getenv(<span class="stringliteral">"SENDER"</span>))) <span class="keywordflow">throw</span> env_miss(<span class="stringliteral">"SENDER"</span>);
00152     sender = lower(tmp);
00153 
00154     <span class="comment">// don't reply on bounce messages</span>
00155     <span class="keywordflow">if</span>( sender.empty() || sender == <span class="stringliteral">"#@[]"</span> 
00156         || sender == <span class="stringliteral">"&lt;&gt;"</span> || sender == <span class="stringliteral">"&lt;#@[]&gt;"</span>
00157         || sender.substr(0,<span class="keyword">sizeof</span>(md)-1) == md ) <span class="keywordflow">return</span>;
00158 
00159     <span class="comment">// don't reply to messages from mailing lists</span>
00160     <span class="keywordflow">if</span>( hdrs.count(<span class="stringliteral">"list-id"</span>) || hdrs.count(<span class="stringliteral">"mailing-list"</span>)
00161         || hdrs.count(<span class="stringliteral">"x-mailing-list"</span>) || hdrs.count(<span class="stringliteral">"x-ml-name"</span>)
00162         || hdrs.count(<span class="stringliteral">"list-help"</span>) || hdrs.count(<span class="stringliteral">"list-unsubscribe"</span>)
00163         || hdrs.count(<span class="stringliteral">"list-subscribe"</span>) || hdrs.count(<span class="stringliteral">"list-post"</span>)
00164         || hdrs.count(<span class="stringliteral">"list-owner"</span>) || hdrs.count(<span class="stringliteral">"list-archive"</span>) ) <span class="keywordflow">return</span>;
00165     
00166     <span class="keywordflow">if</span>( hdrs.count(<span class="stringliteral">"precedence"</span>) ) {
00167             hdrs[<span class="stringliteral">"precedence"</span>] = lower(hdrs[<span class="stringliteral">"precedence"</span>]);
00168             <span class="keywordflow">if</span>( hdrs[<span class="stringliteral">"precedence"</span>] == <span class="stringliteral">"junk"</span> 
00169                 || hdrs[<span class="stringliteral">"precedence"</span>] == <span class="stringliteral">"bulk"</span>
00170                 || hdrs[<span class="stringliteral">"precedence"</span>] == <span class="stringliteral">"list"</span> ) <span class="keywordflow">return</span>;
00171     }
00172     
00173     <span class="comment">// try to get reply address, if it's this message recipient's address </span>
00174     <span class="comment">// don't reply</span>
00175     <span class="keywordflow">if</span>( (new_rcpt=hdrs[<span class="stringliteral">"reply-to"</span>]).empty() ) {
00176             <span class="keywordflow">if</span>( (new_rcpt=hdrs[<span class="stringliteral">"from"</span>]).empty() ) {
00177                     <span class="keywordflow">if</span>( (new_rcpt=hdrs[<span class="stringliteral">"sender"</span>]).empty() ) {
00178                             new_rcpt = sender;
00179                     }
00180             }
00181     } 
00182     <span class="keywordflow">if</span>(new_rcpt == rcpt) <span class="keywordflow">return</span>;
00183 
00184     <span class="comment">// autoresponder found on freshmeat checks this field so try to be</span>
00185     <span class="comment">// compatible</span>
00186     <span class="keywordflow">if</span>( ! regexec(&amp;re_x_remark, hdrs[<span class="stringliteral">"x-remark"</span>].c_str(), 0, NULL, 0) ) <span class="keywordflow">return</span>;
00187     hdrs_add[<span class="stringliteral">"x-remark"</span>] = <span class="stringliteral">"Automatic response generated by vq's autoresponder"</span>;
00188     
00189     <span class="comment">// subdir tells us where's user's directory</span>
00190     string dir(subdir(local,host));
00191 
00192     <span class="keywordflow">if</span>( histHas(dir+<span class="stringliteral">"/.autoresp.senders"</span>, sender) ) <span class="keywordflow">return</span>;
00193     <span class="keywordflow">if</span>( hdrs.count(<span class="stringliteral">"references"</span>) || hdrs.count(<span class="stringliteral">"in-reply-to"</span>) ) {
00194             <span class="keywordflow">if</span>( histIDMatches(dir+<span class="stringliteral">"/.autoresp.senders"</span>, hdrs[<span class="stringliteral">"in-reply-to"</span>], 
00195                     hdrs[<span class="stringliteral">"references"</span>]) ) <span class="keywordflow">return</span>;
00196     }
00197     
00198     <span class="comment">// create references field</span>
00199     hdrs_add[<span class="stringliteral">"references"</span>] = hdrs.count(<span class="stringliteral">"references"</span>) ? 
00200             hdrs[<span class="stringliteral">"message-id"</span>]+<span class="stringliteral">", "</span>+hdrs[<span class="stringliteral">"references"</span>] : hdrs[<span class="stringliteral">"message-id"</span>];
00201 
00202     <span class="comment">// set replied message id</span>
00203     hdrs_add[<span class="stringliteral">"in-reply-to"</span>] = hdrs[<span class="stringliteral">"message-id"</span>];
00204 
00205     <span class="comment">// title</span>
00206     <span class="keywordflow">if</span>(!hdrs_add.count(<span class="stringliteral">"subject"</span>))
00207             hdrs_add[<span class="stringliteral">"subject"</span>] = <span class="stringliteral">"Automatic response | Odpowiedz automatyczna"</span>;
00208 
00209     <span class="comment">// standard</span>
00210     <span class="keywordflow">if</span>(!hdrs_add.count(<span class="stringliteral">"from"</span>))
00211             hdrs_add[<span class="stringliteral">"from"</span>] = rcpt.find(host)==0 
00212                     &amp;&amp; rcpt.length() &gt; host.length()+7 
00213                     ? rcpt.substr(host.length()+1) : rcpt; 
00214 
00215     hdrs_add[<span class="stringliteral">"to"</span>] = new_rcpt;
00216     hdrs_add[<span class="stringliteral">"message-id"</span>] = (string)<span class="stringliteral">"&lt;"</span>+uniq()+<span class="stringliteral">".autoresp@"</span>+host+<span class="stringliteral">"&gt;"</span>;
00217     hdrs_add[<span class="stringliteral">"mime-version"</span>] = <span class="stringliteral">"1.0"</span>;
00218     hdrs_add[<span class="stringliteral">"content-type"</span>] = codepage.empty() ? <span class="stringliteral">"text/plain"</span> 
00219         : <span class="stringliteral">"text/plain; charset="</span>+codepage;
00220             
00221     msgSend();
00222 
00223     <span class="keywordflow">try</span> {
00224             <span class="keywordflow">if</span>( ! sender.empty() )
00225                     histAdd(dir+<span class="stringliteral">"/.autoresp.senders"</span>, sender);
00226             <span class="keywordflow">if</span>( hdrs_add.count(<span class="stringliteral">"message-id"</span>) )
00227                     histAdd(dir+<span class="stringliteral">"/.autoresp.msg.ids"</span>, hdrs_add[<span class="stringliteral">"message-id"</span>]);
00228     } <span class="keywordflow">catch</span>(...) {
00229     }
00230 }
00231 
00239 string cqautoresp::subdir(<span class="keyword">const</span> string &amp;local, <span class="keyword">const</span> string &amp;host) {
00240     string ret;
00241     string::value_type hyp;
00242     string::size_type hostl = host.length(), hyp2pos=string::npos;
00243 
00244     <span class="keywordflow">if</span>( ! hostl || local.length() &lt; hostl+2
00245         || local.find(host) != 0 ) {
00246             hostl = local.find(<span class="charliteral">'-'</span>);
00247             <span class="keywordflow">if</span>(hostl != string::npos) {
00248                     ++hostl;
00249                     hyp2pos = local.find(<span class="charliteral">'-'</span>, hostl+1);
00250             }
00251     } <span class="keywordflow">else</span> {
00252             hyp = local[hostl++];
00253             hyp2pos = local.find(hyp, hostl+1);
00254     }
00255     <span class="keywordflow">if</span>(hostl==string::npos) ret= local;
00256     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(hyp2pos == string::npos) ret = local.substr(hostl);
00257     <span class="keywordflow">else</span> ret = local.substr(hostl, hyp2pos-hostl);
00258     <span class="keywordflow">return</span> ret;
00259 }
00260 
00264 string cqautoresp::uniq() {
00265     ostringstream u;
00266     <span class="keyword">struct </span>timeval tv;
00267     gettimeofday(&amp;tv,NULL);
00268     u&lt;&lt;tv.tv_sec&lt;&lt;<span class="charliteral">'.'</span>&lt;&lt;tv.tv_usec&lt;&lt;<span class="charliteral">'.'</span>&lt;&lt;getpid();
00269     <span class="keywordflow">return</span> u.str();
00270 }
00271 
00281 <span class="keywordtype">bool</span> cqautoresp::histAdd(<span class="keyword">const</span> std::string &amp;fn, <span class="keyword">const</span> std::string &amp;_add) {
00282     <span class="keywordtype">bool</span> matches = <span class="keyword">false</span>;
00283     string add(_add);
00284     string fntmp = fn+uniq(), ln;
00285     istringstream time;
00286     string::size_type sep;
00287     opfstream tmp(fntmp.c_str());
00288     pfstream in(fn.c_str(), ios::in | ios::out);
00289     <span class="keyword">struct </span>timeval now, then, sub;
00290     
00291     <span class="keywordflow">if</span>(!tmp) <span class="keywordflow">throw</span> file_write(fntmp);
00292     <span class="keywordflow">if</span>(!in) <span class="keywordflow">throw</span> file_write(fn);
00293 
00294     <span class="keywordflow">if</span>(gettimeofday(&amp;now, NULL))
00295             <span class="keywordflow">throw</span> runtime_error(<span class="stringliteral">"gettimeofday failed!"</span>);
00296 
00297     replace(add.begin(), add.end(), <span class="charliteral">' '</span>, <span class="charliteral">'_'</span>);
00298     replace(add.begin(), add.end(), <span class="charliteral">'\n'</span>, <span class="charliteral">'_'</span>);
00299 
00300     <span class="comment">// line looks like this: item time</span>
00301     <span class="keywordflow">while</span>(getline(in, ln)) {
00302             sep = ln.find(<span class="charliteral">' '</span>);
00303             <span class="keywordflow">if</span>(sep == string::npos) <span class="keywordflow">continue</span>; <span class="comment">// ignore</span>
00304             time.str( ln.substr(sep+1) );
00305             then.tv_usec = 0;
00306             time&gt;&gt;then.tv_sec;
00307             <span class="keywordflow">if</span>( ! time ) <span class="keywordflow">continue</span>;
00308             timersub(&amp;now, &amp;then, &amp;sub);
00309             <span class="keywordflow">if</span>( sub.tv_sec &gt; ac_autoresp_ttl.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>() ) <span class="keywordflow">continue</span>;
00310             tmp&lt;&lt;ln&lt;&lt;endl;
00311             ln=ln.substr(0, sep);
00312             <span class="keywordflow">if</span>(ln == add) matches= <span class="keyword">true</span>;
00313     }
00314     <span class="keywordflow">if</span>( ! matches ) {
00315         tmp&lt;&lt;add&lt;&lt;<span class="charliteral">' '</span>&lt;&lt;now.tv_sec&lt;&lt;endl;
00316     }
00317     in.close();
00318     tmp.close();
00319 
00320     <span class="keywordflow">if</span>( in.bad() ) <span class="keywordflow">throw</span> file_read(fn);
00321     <span class="keywordflow">if</span>( tmp.bad() ) <span class="keywordflow">throw</span> file_write(fntmp);
00322 
00323     <span class="keywordflow">if</span>( rename(fntmp.c_str(), fn.c_str()) ) {
00324             unlink(fntmp.c_str());
00325             <span class="keywordflow">throw</span> file_write(fn);
00326     } 
00327     <span class="keywordflow">return</span> matches;
00328 }
00329 
00337 <span class="keywordtype">bool</span> cqautoresp::histHas(<span class="keyword">const</span> std::string &amp;fn, <span class="keyword">const</span> std::string &amp;_chk) {
00338     <span class="keywordtype">bool</span> matches = <span class="keyword">false</span>;
00339     string chk(_chk);
00340     string ln;
00341     istringstream time;
00342     string::size_type sep;
00343     ipfstream in(fn.c_str());
00344     <span class="keyword">struct </span>timeval now, then, sub;
00345     
00346     <span class="keywordflow">if</span>(!in) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00347     <span class="keywordflow">if</span>( gettimeofday(&amp;now, NULL) ) <span class="keywordflow">throw</span> runtime_error(<span class="stringliteral">"gettimeofday failed!"</span>);
00348 
00349     replace(chk.begin(), chk.end(), <span class="charliteral">' '</span>, <span class="charliteral">'_'</span>);
00350     replace(chk.begin(), chk.end(), <span class="charliteral">'\n'</span>, <span class="charliteral">'_'</span>);
00351 
00352     <span class="comment">// line looks like this: item time</span>
00353     <span class="keywordflow">while</span>(getline(in, ln)) {
00354             sep = ln.find(<span class="charliteral">' '</span>);
00355             <span class="keywordflow">if</span>(sep == string::npos) <span class="keywordflow">continue</span>; <span class="comment">// ignore</span>
00356             time.str( ln.substr(sep+1) );
00357             then.tv_usec = 0;
00358             time&gt;&gt;then.tv_sec;
00359             <span class="keywordflow">if</span>( ! time ) <span class="keywordflow">continue</span>;
00360             timersub(&amp;now, &amp;then, &amp;sub);
00361             <span class="keywordflow">if</span>( sub.tv_sec &gt; ac_autoresp_ttl.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>() ) <span class="keywordflow">continue</span>;
00362             ln=ln.substr(0, sep);
00363             <span class="keywordflow">if</span>(ln == chk) {
00364                     matches= <span class="keyword">true</span>;
00365                     <span class="keywordflow">break</span>;
00366             }
00367     }
00368     <span class="keywordflow">if</span>( in.bad() ) <span class="keywordflow">throw</span> file_read(fn);
00369     <span class="keywordflow">return</span> matches;
00370 }
00379 <span class="keywordtype">bool</span> cqautoresp::histIDMatches(<span class="keyword">const</span> std::string &amp;fn, 
00380         <span class="keyword">const</span> std::string &amp;_chk, <span class="keyword">const</span> std::string &amp;_chk1) {
00381     <span class="keywordtype">bool</span> matches = <span class="keyword">false</span>;
00382     string chk(_chk), chk1(_chk1);
00383     string ln;
00384     istringstream time;
00385     string::size_type sep;
00386     ipfstream in(fn.c_str());
00387     <span class="keyword">struct </span>timeval now, then, sub;
00388     
00389     <span class="keywordflow">if</span>(!in) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00390     <span class="keywordflow">if</span>(gettimeofday(&amp;now, NULL)) <span class="keywordflow">throw</span> runtime_error(<span class="stringliteral">"gettimeofday failed!"</span>);
00391 
00392     replace(chk.begin(), chk.end(), <span class="charliteral">' '</span>, <span class="charliteral">'_'</span>);
00393     replace(chk.begin(), chk.end(), <span class="charliteral">'\n'</span>, <span class="charliteral">'_'</span>);
00394 
00395     replace(chk1.begin(), chk1.end(), <span class="charliteral">' '</span>, <span class="charliteral">'_'</span>);
00396     replace(chk1.begin(), chk1.end(), <span class="charliteral">'\n'</span>, <span class="charliteral">'_'</span>);
00397 
00398     <span class="comment">// line looks like this: item time</span>
00399     <span class="keywordflow">while</span>(getline(in, ln)) {
00400             sep = ln.find(<span class="charliteral">' '</span>);
00401             <span class="keywordflow">if</span>(sep == string::npos) <span class="keywordflow">continue</span>; <span class="comment">// ignore</span>
00402             time.str( ln.substr(sep+1) );
00403             then.tv_usec = 0;
00404             time&gt;&gt;then.tv_sec;
00405             <span class="keywordflow">if</span>( ! time ) <span class="keywordflow">continue</span>;
00406             timersub(&amp;now, &amp;then, &amp;sub);
00407             <span class="keywordflow">if</span>( sub.tv_sec &gt; ac_autoresp_ttl.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>() ) <span class="keywordflow">continue</span>;
00408             ln=ln.substr(0, sep);
00409             <span class="keywordflow">if</span>( (! chk.empty() &amp;&amp; chk.find(ln) != string::npos)
00410                 || (!chk1.empty() &amp;&amp; chk1.find(ln) != string::npos) ) {
00411                     matches= <span class="keyword">true</span>;
00412                     <span class="keywordflow">break</span>;
00413             }
00414     }
00415     <span class="keywordflow">if</span>( in.bad() ) <span class="keywordflow">throw</span> file_read(fn);
00416     <span class="keywordflow">return</span> matches;
00417 }
00418 
00422 <span class="keywordtype">void</span> cqautoresp::codepage_set( <span class="keyword">const</span> string &amp; cp ) {
00423     codepage = cp;
00424 } 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Dec 25 13:37:10 2003 for Virtual Qmail by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.3 </small></address>
</body>
</html>
