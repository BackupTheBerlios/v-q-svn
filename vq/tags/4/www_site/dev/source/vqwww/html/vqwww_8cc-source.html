<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>vqwww: vqwww.cc Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.3 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Compound&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Compound&nbsp;Members</a></div>
<h1>vqwww.cc</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment">Copyright (c) 2002,2003 Pawel Niewiadomski</span>
00003 <span class="comment">All rights reserved.</span>
00004 <span class="comment"></span>
00005 <span class="comment">Redistribution and use in source and binary forms, with or without</span>
00006 <span class="comment">modification, are permitted provided that the following conditions</span>
00007 <span class="comment">are met:</span>
00008 <span class="comment">1. Redistributions of source code must retain the above copyright</span>
00009 <span class="comment">   notice, this list of conditions and the following disclaimer.</span>
00010 <span class="comment">2. Redistributions in binary form must reproduce the above copyright</span>
00011 <span class="comment">   notice, this list of conditions and the following disclaimer in the</span>
00012 <span class="comment">   documentation and/or other materials provided with the distribution.</span>
00013 <span class="comment">3. All advertising materials mentioning features or use of this software</span>
00014 <span class="comment">   must display the following acknowledgement:</span>
00015 <span class="comment">   This product includes software developed by the Pawel Niewiadomski,</span>
00016 <span class="comment">   and other contributors.</span>
00017 <span class="comment">4. Neither the name of Pawel Niewiadomski nor the names of other contributors</span>
00018 <span class="comment">   may be used to endorse or promote products derived from this software</span>
00019 <span class="comment">   without specific prior written permission.</span>
00020 <span class="comment"></span>
00021 <span class="comment">THIS SOFTWARE IS PROVIDED BY PAWEL NIEWIADOMSKI AND CONTRIBUTORS ``AS IS'' AND</span>
00022 <span class="comment">ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
00023 <span class="comment">IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
00024 <span class="comment">ARE DISCLAIMED.  IN NO EVENT SHALL PAWEL NIEWIADOMSKI OR CONTRIBUTORS BE LIABLE</span>
00025 <span class="comment">FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
00026 <span class="comment">DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</span>
00027 <span class="comment">OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
00028 <span class="comment">HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
00029 <span class="comment">LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
00030 <span class="comment">OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
00031 <span class="comment">SUCH DAMAGE.</span>
00032 <span class="comment">*/</span>
00033 
00034 <span class="preprocessor">#include &lt;dlfcn.h&gt;</span>
00035 <span class="preprocessor">#include &lt;iostream&gt;</span>
00036 <span class="preprocessor">#include &lt;memory&gt;</span>
00037 <span class="preprocessor">#include &lt;deque&gt;</span>
00038 <span class="preprocessor">#include &lt;ctime&gt;</span>
00039 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
00040 <span class="preprocessor">#include &lt;string&gt;</span>
00041 <span class="preprocessor">#include &lt;cerrno&gt;</span>
00042 <span class="preprocessor">#include &lt;stdexcept&gt;</span>
00043 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00044 <span class="preprocessor">#include &lt;sstream&gt;</span>
00045 <span class="preprocessor">#include &lt;fstream&gt;</span>
00046 <span class="preprocessor">#include &lt;new&gt;</span>
00047 
00048 <span class="preprocessor">#include &lt;cvq.h&gt;</span>
00049 
00050 <span class="preprocessor">#include "vqwww.h"</span>
00051 <span class="preprocessor">#include "sabmain.h"</span>
00052 <span class="preprocessor">#include "cconfmod.h"</span>
00053 <span class="preprocessor">#include "cpassmod.h"</span>
00054 <span class="preprocessor">#include "coutmod.h"</span>
00055 <span class="preprocessor">#include "credirmod.h"</span>
00056 <span class="preprocessor">#include "cautorespmod.h"</span>
00057 <span class="preprocessor">#include "cloghistmod.h"</span>
00058 <span class="preprocessor">#include "csess.h"</span>
00059 <span class="preprocessor">#include "cgi.h"</span>
00060 <span class="preprocessor">#include "conf_home.h"</span>
00061 <span class="preprocessor">#include "vqwww_conf.h"</span>
00062 <span class="preprocessor">#include "html.h"</span>
00063 
00064 <span class="preprocessor">#ifndef RTLD_NOW</span>
00065 <span class="preprocessor"></span><span class="preprocessor">    #define RTLD_NOW 0</span>
00066 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00067 <span class="preprocessor"></span>
00068 <span class="preprocessor">#ifndef RTLD_GLOBAL</span>
00069 <span class="preprocessor"></span><span class="preprocessor">    #define RTLD_GLOBAL 0</span>
00070 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00071 <span class="preprocessor"></span>
00072 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00073 <span class="keyword">using</span> <span class="keyword">namespace </span>cgicc;
00074 <span class="keyword">using</span> <span class="keyword">namespace </span>vqwww;
00075 
00079 cvqwww_dirs::cvqwww_dirs(<span class="keyword">const</span> std::string &amp;home)
00080         : conf(home+"/etc/vqwww"), 
00081         share(home+"/share/vqwww"),
00082         libexec(home+"/libexec/vqwww"), 
00083         include(home+"/include/vqwww") {
00084 }
00085 
00089 <span class="keyword">class </span>cvqwww : <span class="keyword">public</span> <a class="code" href="classcenvironment.html">cenvironment</a> {
00090         <span class="keyword">protected</span>:
00091                 <span class="keywordtype">void</span> mods_init();
00092                 <span class="keywordtype">void</span> mod_load( <span class="keyword">const</span> string &amp; file, <span class="keyword">const</span> string &amp; name );
00093                 <span class="keywordtype">void</span> menu_dump();
00094                 <span class="keywordtype">void</span> req_proc();
00095                 <span class="keywordtype">void</span> cks_dump();
00096                 <span class="keywordtype">void</span> sess_crt( <span class="keyword">const</span> cvq::auth_info &amp; );
00097                 <span class="keywordtype">bool</span> sess_get();
00098                 <span class="keywordtype">bool</span> log_do_it(<span class="keywordtype">bool</span> sto = <span class="keyword">false</span>);
00099                 <span class="keywordtype">void</span> lasttime_now();
00100                 <span class="keywordtype">bool</span> log_do();
00101                 <span class="keywordtype">void</span> setup();
00102                 <span class="keywordtype">void</span> locale_setup( <span class="keywordtype">bool</span> = <span class="keyword">false</span> );
00103                 <span class="keywordtype">void</span> locales_dump( ostream &amp; );
00104 
00105                 <span class="keywordtype">void</span> cgi_rm_set( request_method ); 
00106         <span class="keyword">public</span>:
00107                 cvqwww(<span class="keywordtype">int</span> ac, <span class="keyword">const</span> <span class="keywordtype">char</span> ** av, ostream &amp; out, ostream &amp; err,
00108                         xslt_args_type &amp; xat )
00109                         : <a class="code" href="classcenvironment.html">cenvironment</a>(ac, av, out, err, xat) {
00110 
00111                     logger-&gt;service_set(cgi_env_get().usingHTTPS() ? 
00112                         clogger::ser_https : clogger::ser_http );
00113                     logger-&gt;ip_set(cgi_env_get().getRemoteAddr());
00114                 }
00115 
00116                 <span class="keywordtype">void</span> run();
00117 };
00118 
00122 <span class="keywordtype">void</span> cvqwww::cgi_rm_set( request_method rm ) {
00123     cgi_rm = rm;    
00124 }
00125 
00131 <span class="keywordtype">void</span> cvqwww::mod_load( <span class="keyword">const</span> string &amp; file, <span class="keyword">const</span> string &amp; name) {
00132     <span class="comment">// real path</span>
00133     string rpath( file[0] == <span class="charliteral">'/'</span> ? file : dirs.<a class="code" href="classcvqwww__dirs.html#cvqwww__dirso2">libexec</a>+<span class="charliteral">'/'</span>+file);
00134     
00135     <span class="keywordtype">void</span> *dl = dlopen(rpath.c_str(), RTLD_NOW | RTLD_GLOBAL );
00136     <span class="keywordflow">if</span>( ! dl ) 
00137             <span class="keywordflow">throw</span> runtime_error(<span class="stringliteral">"mod_load: "</span>+rpath+<span class="stringliteral">": "</span>+dlerror());
00138     <a class="code" href="structmod__info.html">mod_info</a> *mi = (<a class="code" href="structmod__info.html">mod_info</a> *) dlsym(dl, name.c_str());
00139     <span class="keywordflow">if</span>( ! mi ) 
00140             <span class="keywordflow">throw</span> runtime_error(<span class="stringliteral">"mod_load: symbol: "</span>+name+<span class="stringliteral">": "</span>+dlerror());
00141     
00142     (*mi).mods_init(mods, *<span class="keyword">this</span>);
00143 }
00144 
00148 <span class="keywordtype">void</span> cvqwww::mods_init() {
00149     <span class="comment">// internal modules</span>
00150     mods.push_back( <span class="keyword">new</span> <a class="code" href="classcoutmod.html">coutmod</a>(*<span class="keyword">this</span>) );
00151     mods.push_back( <span class="keyword">new</span> <a class="code" href="classcconfmod.html">cconfmod</a>(*<span class="keyword">this</span>) );
00152     mods.push_back( <span class="keyword">new</span> <a class="code" href="classcpassmod.html">cpassmod</a>(*<span class="keyword">this</span>) );
00153     mods.push_back( <span class="keyword">new</span> <a class="code" href="classcredirmod.html">credirmod</a>(*<span class="keyword">this</span>) );
00154     mods.push_back( <span class="keyword">new</span> <a class="code" href="classcautorespmod.html">cautorespmod</a>(*<span class="keyword">this</span>) );
00155     mods.push_back( <span class="keyword">new</span> <a class="code" href="classcloghistmod.html">cloghistmod</a>(*<span class="keyword">this</span>) );
00156 
00157     <span class="comment">// external modules, dlopen them</span>
00158     string fnmods(dirs.<a class="code" href="classcvqwww__dirs.html#cvqwww__dirso0">conf</a>+<span class="stringliteral">"/mods"</span>);
00159     ifstream fmods( fnmods.c_str() );
00160     <span class="keywordflow">if</span>( fmods ) {
00161             string ln;
00162             string::size_type sep;
00163             <span class="keywordflow">while</span>( getline(fmods, ln) ) {
00164                     <span class="keywordflow">if</span>( ln[0] == <span class="charliteral">'#'</span> ) <span class="keywordflow">continue</span>;
00165                     sep = ln.find(<span class="charliteral">'|'</span>);
00166                     <span class="keywordflow">if</span>( sep != string::npos ) {
00167                             mod_load(ln.substr(0, sep), ln.substr(sep+1));
00168                     } <span class="keywordflow">else</span>
00169                             err&lt;&lt;*av&lt;&lt;<span class="stringliteral">": mods file include invalid line: "</span>
00170                                 &lt;&lt;ln&lt;&lt;<span class="stringliteral">"; ignoring"</span>&lt;&lt;endl;
00171             }
00172             <span class="keywordflow">if</span>( ! fmods.bad() ) 
00173                     <span class="keywordflow">return</span>;
00174     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( errno == ENOENT )
00175             <span class="keywordflow">return</span>;
00176 
00177     <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"error while reading mods file: "</span>+strerror(errno));
00178 } 
00182 <span class="keywordtype">void</span> cvqwww::menu_dump() {
00183     deque&lt; cmod * &gt;::size_type cnt = mods.size();
00184     <span class="keywordflow">if</span>( cnt -- ) {
00185         out &lt;&lt; <span class="stringliteral">"&lt;menu&gt;"</span>;
00186         <span class="keywordflow">do</span> {
00187                 <span class="keywordflow">if</span>( ! (mods[cnt]-&gt;modinfo &amp; cmod::mi_menu) ) <span class="keywordflow">continue</span>;
00188                 out &lt;&lt;<span class="stringliteral">"&lt;mod id=\""</span> &lt;&lt; mods[cnt]-&gt;id() &lt;&lt; <span class="stringliteral">"\"&gt;"</span>;
00189                 out &lt;&lt; mods[cnt]-&gt;menu();
00190                 out &lt;&lt; <span class="stringliteral">"&lt;/mod&gt;"</span>;
00191         } <span class="keywordflow">while</span>( cnt-- );
00192         out &lt;&lt; <span class="stringliteral">"&lt;/menu&gt;"</span>;
00193     }
00194 }
00198 <span class="keywordtype">void</span> cvqwww::req_proc() {
00199     deque&lt;cmod *&gt;::size_type mod_cur, mods_cnt = mods.size();
00200     <span class="keywordflow">if</span>(!mods_cnt) <span class="keywordflow">return</span>;
00201     <span class="keywordtype">char</span> res;
00202     <span class="keywordtype">bool</span> at; <span class="comment">// does some action was taken?</span>
00203     <span class="keywordflow">for</span>(;;) {
00204             at = <span class="keyword">false</span>;
00205             <span class="keywordflow">for</span>(mod_cur=0; mod_cur&lt;mods_cnt; ++mod_cur) {
00206                     <span class="keywordflow">try</span> {
00207                             mod_out.clear();
00208                             mod_out.str(<span class="stringliteral">""</span>);
00209                             res = mods[mod_cur]-&gt;run();
00210                     } <span class="keywordflow">catch</span>( <span class="keyword">const</span> std::exception &amp; e ) {
00211                             mod_out.str(<span class="stringliteral">""</span>);
00212                             out&lt;&lt;<span class="stringliteral">"&lt;exception&gt;"</span>&lt;&lt;e.what()&lt;&lt;<span class="stringliteral">"&lt;/exception&gt;"</span>;
00213                             err &lt;&lt; *av &lt;&lt; <span class="stringliteral">": exception cougth: "</span> &lt;&lt; e.what() &lt;&lt; endl;
00214                             <span class="keywordflow">return</span>;
00215                     } <span class="keywordflow">catch</span>( ... ) {
00216                             mod_out.str(<span class="stringliteral">""</span>);
00217                             out&lt;&lt;<span class="stringliteral">"&lt;exception unexpected=\"1\"/&gt;"</span>;
00218                             err &lt;&lt; *av &lt;&lt; <span class="stringliteral">": unknown exception"</span> &lt;&lt; endl;
00219                             <span class="keywordflow">return</span>;
00220                     }
00221 
00222                     out&lt;&lt;mod_out.str();
00223                     <span class="keywordflow">if</span>(out.bad() || mod_out.bad()) 
00224                             <span class="keywordflow">throw</span> runtime_error(<span class="stringliteral">"can't copy module's output"</span>);
00225                     mod_out.str(<span class="stringliteral">""</span>);
00226 
00227                     <span class="keywordflow">switch</span>(res) {
00228                     <span class="keywordflow">case</span> <a class="code" href="classcmod.html#credirmodw8credirmodw3">cmod::done</a>:
00229                             <span class="keywordflow">return</span>;
00230                     <span class="keywordflow">case</span> <a class="code" href="classcmod.html#credirmodw8credirmodw1">cmod::loopaf</a>:
00231                             at= <span class="keyword">true</span>;
00232                             <span class="keywordflow">break</span>;
00233                     <span class="keywordflow">case</span> <a class="code" href="classcmod.html#credirmodw8credirmodw0">cmod::loopa</a>:
00234                             <span class="keywordflow">goto</span> req_proc_le;
00235                     <span class="keywordflow">case</span> <a class="code" href="classcmod.html#credirmodw8credirmodw4">cmod::sessclose</a>:
00236                             sess-&gt;rm();
00237                             out&lt;&lt;<span class="stringliteral">"&lt;redirme/&gt;"</span>;
00238                             <span class="keywordflow">return</span>;
00239                     }
00240             }
00241             <span class="keywordflow">if</span>(!at) <span class="keywordflow">break</span>;
00242 req_proc_le:
00243             <span class="keywordflow">continue</span>;
00244     }
00245 }
00246 
00250 <span class="keywordtype">void</span> cvqwww::cks_dump() {
00251     cookies_map::const_iterator cur = cgi_cks_set.begin(), end=cgi_cks_set.end();
00252     <span class="keywordflow">for</span>( ; cur!=end; ++cur ) {
00253             out &lt;&lt; <span class="stringliteral">"&lt;cookie&gt;"</span>;
00254             cur-&gt;second.render(out);
00255             out &lt;&lt; <span class="stringliteral">"&lt;/cookie&gt;"</span>;
00256     }
00257 }
00258 
00262 <span class="keywordtype">void</span> cvqwww::sess_crt( <span class="keyword">const</span> cvq::auth_info &amp; ai ) {
00263     string sid;
00264     <span class="keywordflow">if</span>( !sess-&gt;create(sid) )
00265             <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"can't create session: "</span>+sess-&gt;errmsg());
00266 
00267     <span class="keywordflow">if</span>( !sess-&gt;setval(<span class="stringliteral">"cip"</span>, cgi_env_get().getRemoteAddr())
00268         || ! sess-&gt;setval(<span class="stringliteral">"user"</span>, ai.user)
00269         || ! sess-&gt;setval(<span class="stringliteral">"domain"</span>, ai.dom)
00270         || ! sess-&gt;setval(<span class="stringliteral">"flags"</span>, (<span class="keywordtype">char</span>*) &amp;ai.flags, <span class="keyword">sizeof</span>(ai.flags))
00271         || ! sess-&gt;setval(<span class="stringliteral">"dir"</span>, ai.dir) )
00272             <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"can't set session's variable: "</span>+sess-&gt;errmsg());
00273 
00274     HTTPCookie ck_sid;
00275     ck_sid.setName(<span class="stringliteral">"SID"</span>); 
00276     ck_sid.setValue(sid);
00277     cgi_cks_set[ck_sid.getName()] = ck_sid;
00278 }            
00279 
00284 <span class="keywordtype">bool</span> cvqwww::sess_get() {
00285     <span class="keywordflow">if</span>( ! sess-&gt;getval(<span class="stringliteral">"user"</span>, sessb.<a class="code" href="structcsess__basic.html#csess__basico0">ai</a>.user)
00286        || ! sess-&gt;getval(<span class="stringliteral">"domain"</span>, sessb.<a class="code" href="structcsess__basic.html#csess__basico0">ai</a>.dom)
00287        || ! sess-&gt;getval(<span class="stringliteral">"flags"</span>, (<span class="keywordtype">char</span>*) &amp;sessb.<a class="code" href="structcsess__basic.html#csess__basico0">ai</a>.flags, <span class="keyword">sizeof</span>(sessb.<a class="code" href="structcsess__basic.html#csess__basico0">ai</a>.flags))
00288        || ! sess-&gt;getval(<span class="stringliteral">"dir"</span>, sessb.<a class="code" href="structcsess__basic.html#csess__basico0">ai</a>.dir) ) {
00289             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00290     }
00291     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00292 }
00293 
00297 <span class="keywordtype">void</span> cvqwww::locales_dump( ostream &amp; os ) {
00298     <span class="keyword">const</span> <a class="code" href="classcmapconf.html#cmapconfw0">cmapconf::map_type</a> &amp; locales = ac_locales.<a class="code" href="classcmapconf.html#cmapconfa1">val_map</a>();
00299     
00300     cmapconf::map_type::const_iterator beg, end;
00301     <span class="keywordflow">for</span>( beg = locales.begin(), end = locales.end(); beg != end; ++beg ) {
00302             os&lt;&lt;<span class="stringliteral">"&lt;locale code=\""</span>&lt;&lt; beg-&gt;first 
00303                 &lt;&lt; <span class="stringliteral">"\" name=\""</span> &lt;&lt; beg-&gt;second &lt;&lt; <span class="stringliteral">"\""</span>;
00304             <span class="keywordflow">if</span>( beg-&gt;first == locale )
00305                     os &lt;&lt; <span class="stringliteral">" sel=\"1\" "</span>;
00306             os&lt;&lt;<span class="stringliteral">"/&gt;"</span>;
00307     }
00308 }
00309 
00313 <span class="keywordtype">bool</span> cvqwww::log_do_it(<span class="keywordtype">bool</span> sto) {
00314     string email, pass;
00315     ostringstream os;
00316 
00317     os&lt;&lt;<span class="stringliteral">"&lt;log&gt;"</span>;
00318 
00319     <span class="keywordflow">if</span>(sto) os&lt;&lt;<span class="stringliteral">"&lt;sto/&gt;"</span>;
00320 
00321     <span class="keywordflow">if</span>( cgi_rm_get() == rm_post &amp;&amp; cgi-&gt;getElement(<span class="stringliteral">"login"</span>) != cgi_end_get() ) {
00322             cvq::auth_info ai;
00323             <span class="keywordtype">bool</span> ok = <span class="keyword">true</span>;
00324 
00325             locale_setup(<span class="keyword">true</span>);
00326 
00327             os&lt;&lt;<span class="stringliteral">"&lt;inv&gt;&lt;email "</span>;
00328             <span class="keywordflow">if</span>(cgi_var(cgi.get(),<span class="stringliteral">"email"</span>, email) &amp;&amp; ! email.empty()) {
00329                     string::size_type atpos;
00330                     <span class="keywordflow">if</span>(htmlbad(email, ac_user_ok.<a class="code" href="classclnconf.html#clnconfa1">val_str</a>().c_str(), 
00331                         ac_html_br.<a class="code" href="classclnconf.html#clnconfa1">val_str</a>().at(0))) {
00332                             ok = <span class="keyword">false</span>;
00333                             os&lt;&lt;<span class="stringliteral">" dirty=\"1\" "</span>;
00334                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>((atpos=email.find(<span class="charliteral">'@'</span>)) == string::npos) {
00335                             ok = <span class="keyword">false</span>;
00336                             os&lt;&lt;<span class="stringliteral">" syntax=\"1\" "</span>;
00337                     } <span class="keywordflow">else</span> {
00338                             ai.user = email.substr(0, atpos );
00339                             ai.dom = email.substr( atpos+1 );
00340                             logger-&gt;domain_set(ai.dom);
00341                             logger-&gt;login_set(ai.user);
00342                     }
00343             } <span class="keywordflow">else</span> { 
00344                     ok=<span class="keyword">false</span>; 
00345                     os &lt;&lt; <span class="stringliteral">" empty=\"1\" "</span>; 
00346             }
00347             
00348             os&lt;&lt;<span class="stringliteral">"/&gt;&lt;pass "</span>;
00349 
00350             <span class="keywordflow">if</span>(cgi_var(cgi.get(),<span class="stringliteral">"pass"</span>, pass) &amp;&amp; ! pass.empty() ) {
00351                     <span class="keywordflow">if</span>(htmlbad(pass, ac_pass_ok.<a class="code" href="classclnconf.html#clnconfa1">val_str</a>().c_str(), 
00352                         ac_html_br.<a class="code" href="classclnconf.html#clnconfa1">val_str</a>().at(0))) {
00353                             ok = <span class="keyword">false</span>;
00354                             os&lt;&lt;<span class="stringliteral">" dirty = \"1\" "</span>;
00355                             logger-&gt;write(clogger::re_data, <span class="stringliteral">"dirty password: "</span>+pass);
00356                     }
00357             } <span class="keywordflow">else</span> { 
00358                     ok = <span class="keyword">false</span>; 
00359                     os&lt;&lt;<span class="stringliteral">" empty = \"1\" "</span>;
00360                     logger-&gt;write(clogger::re_data, <span class="stringliteral">"empty password"</span>);
00361             }
00362             
00363             os&lt;&lt;<span class="stringliteral">"/&gt;"</span>;
00364             
00365             <span class="comment">// if ok do authorization</span>
00366             <span class="keywordflow">if</span>( ok ) {
00367                     <span class="keywordflow">switch</span>(vq-&gt;user_auth(ai) ) {
00368                     <span class="keywordflow">case</span> cvq::err_no:
00369                             <span class="keywordflow">if</span>( pass == ai.pass ) {
00370                                     sess_crt( ai ); <span class="comment">// this will throw exception on error</span>
00371                                     logger-&gt;write(clogger::re_ok, <span class="stringliteral">""</span>);
00372                                     <span class="keywordflow">return</span> sess_get();
00373                             } <span class="keywordflow">else</span> 
00374                                     logger-&gt;write(clogger::re_pass, pass);
00375                             <span class="keywordflow">break</span>;
00376                     <span class="keywordflow">case</span> cvq::err_user_nf:
00377                             logger-&gt;write(clogger::re_data, <span class="stringliteral">"no such user"</span>);
00378                             <span class="keywordflow">break</span>;
00379                     <span class="keywordflow">default</span>:
00380                             logger-&gt;write(clogger::re_int, vq-&gt;err_report());
00381                     }
00382                     os &lt;&lt; <span class="stringliteral">"&lt;auth/&gt;"</span>;
00383             }
00384             os&lt;&lt;<span class="stringliteral">"&lt;/inv&gt;"</span>;
00385     }
00386     
00387     out &lt;&lt; os.str()
00388         &lt;&lt; <span class="stringliteral">"&lt;email val=\""</span> &lt;&lt; email &lt;&lt; <span class="stringliteral">"\"/&gt;"</span>;
00389     
00390     locales_dump(out);
00391 
00392     out &lt;&lt;<span class="stringliteral">"&lt;/log&gt;"</span>;
00393     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00394 }
00395 
00399 <span class="keywordtype">void</span> cvqwww::lasttime_now() {
00400     <span class="keyword">struct </span>timeval now;
00401     <span class="keywordflow">if</span>(! gettimeofday(&amp;now, NULL)) {
00402             <span class="keywordflow">if</span>( ! sess-&gt;setval(<span class="stringliteral">"lasttime"</span>, now) )
00403                     <span class="keywordflow">throw</span> runtime_error(<span class="stringliteral">"can't set lasttime"</span>);
00404     } <span class="keywordflow">else</span> 
00405             <span class="keywordflow">throw</span> runtime_error(<span class="stringliteral">"gettimeofday != 0"</span>);
00406 }
00407 
00413 <span class="keywordtype">bool</span> cvqwww::log_do() {
00414     HTTPCookie ck_sid;
00415 
00416     <span class="comment">// if session doesn't exist. create it. </span>
00417     <span class="keywordflow">if</span>( ! cgi_ck(cgi_cks_get(), <span class="stringliteral">"SID"</span>, ck_sid)
00418        || ! sess-&gt;open(ck_sid.getValue())
00419        || ! sess-&gt;getval(<span class="stringliteral">"cip"</span>, sessb.<a class="code" href="structcsess__basic.html#csess__basico1">cip</a>) 
00420        || sessb.<a class="code" href="structcsess__basic.html#csess__basico1">cip</a> != cgi_env_get().getRemoteAddr() ) {
00421             <span class="keywordflow">return</span> log_do_it();
00422     }
00423     
00424     <span class="keyword">struct </span>timeval lasttime;
00425     <span class="keywordflow">if</span>( sess-&gt;getval(<span class="stringliteral">"lasttime"</span>, lasttime) ) {
00426             <span class="keyword">struct </span>timeval sub, now;
00427             <span class="keywordflow">if</span>(gettimeofday(&amp;now, NULL))
00428                     <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"gettimeofday: "</span>+strerror(errno));
00429 
00430             timersub(&amp;now, &amp;lasttime, &amp;sub);
00431             <span class="keywordflow">if</span>(sub.tv_sec&gt;ac_sess_timeout.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>()) {
00432                     <span class="keywordflow">return</span> log_do_it(<span class="keyword">true</span>);
00433             }
00434 
00435             <span class="keywordflow">if</span>( ! sess_get() ) 
00436                     <span class="keywordflow">return</span> log_do_it(<span class="keyword">true</span>);
00437 
00438             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00439     }
00440     <span class="keywordflow">return</span> log_do_it();
00441 }
00442 
00446 <span class="keywordtype">void</span> cvqwww::locale_setup( <span class="keywordtype">bool</span> login ) {
00447     HTTPCookie ck_loc;
00448     <span class="keywordflow">if</span>( login ) {
00449             <span class="keywordflow">if</span>( ! cgi_var(cgi.get(), <span class="stringliteral">"locale"</span>, locale) )
00450                     login = <span class="keyword">false</span>;
00451             <span class="keywordflow">if</span>( locale.empty() )
00452                     login = <span class="keyword">false</span>;
00453     }
00454     
00455     <span class="keywordflow">if</span>( ! login &amp;&amp; cgi_ck(cgi_cks_get(), <span class="stringliteral">"locale"</span>, ck_loc) ) {
00456             locale = ck_loc.getValue();
00457     }
00458 
00459     <span class="keywordflow">if</span>( ! locale.empty() ) {
00460             ck_loc.setName(<span class="stringliteral">"locale"</span>);
00461             ck_loc.setValue(locale);
00462             ck_loc.setMaxAge(60*60*24*7); <span class="comment">// week</span>
00463 
00464             cgi_cks_set[ck_loc.getName()] = ck_loc;
00465     } <span class="keywordflow">else</span>
00466             locale = <span class="stringliteral">"pl_PL"</span>;
00467 
00468     xslt_args[<span class="stringliteral">"LOCALE"</span>] = locale;
00469 }
00470 
00474 <span class="keywordtype">void</span> cvqwww::setup() {
00475     cgi_rm_set( stringsAreEqual(cgi_env_get().getRequestMethod(), <span class="stringliteral">"post"</span>) 
00476         ? rm_post : rm_get );
00477 
00478     locale_setup();
00479 
00480     <span class="comment">// setup all variables needed for xslt processing </span>
00481     xslt_args[<span class="stringliteral">"REQUEST_URI"</span>] = cgi_env_get().getScriptName();
00482     xslt_args[<span class="stringliteral">"SERVER_NAME"</span>] = cgi_env_get().getServerName();
00483     <span class="keywordflow">if</span>( cgi_env_get().usingHTTPS() )
00484             xslt_args[<span class="stringliteral">"HTTPS"</span>] = <span class="stringliteral">"on"</span>;
00485 }
00486 
00490 <span class="keywordtype">void</span> cvqwww::run() {
00491     <span class="comment">// setup some data</span>
00492     setup();
00493 
00494     out&lt;&lt;<span class="stringliteral">"&lt;vqwww&gt;"</span>;
00495     <span class="keywordflow">if</span>( log_do() ) {
00496             lasttime_now();
00497 
00498             mods_init();
00499             menu_dump();
00500 
00501             req_proc();
00502     } 
00503    
00504     cks_dump();
00505     out&lt;&lt;<span class="stringliteral">"&lt;/vqwww&gt;"</span>;
00506 }
00507 
00511 <span class="keywordtype">void</span> start( <span class="keywordtype">int</span> ac, <span class="keywordtype">char</span> **av, ostream &amp;out, ostream &amp;err, 
00512         xslt_args_type &amp; xat ) {
00513     cvqwww vqwww(ac, (<span class="keyword">const</span> <span class="keywordtype">char</span> **)av, out, err, xat);
00514     vqwww.run();
00515 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Dec 25 13:37:28 2003 for vqwww by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.3 </small></address>
</body>
</html>
