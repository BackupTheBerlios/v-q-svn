<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>vqwww: cloghistmod.cc Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.3 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Compound&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Compound&nbsp;Members</a></div>
<h1>cloghistmod.cc</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment">Copyright (c) 2003 Pawel Niewiadomski</span>
00003 <span class="comment">All rights reserved.</span>
00004 <span class="comment"></span>
00005 <span class="comment">Redistribution and use in source and binary forms, with or without</span>
00006 <span class="comment">modification, are permitted provided that the following conditions</span>
00007 <span class="comment">are met:</span>
00008 <span class="comment">1. Redistributions of source code must retain the above copyright</span>
00009 <span class="comment">   notice, this list of conditions and the following disclaimer.</span>
00010 <span class="comment">2. Redistributions in binary form must reproduce the above copyright</span>
00011 <span class="comment">   notice, this list of conditions and the following disclaimer in the</span>
00012 <span class="comment">   documentation and/or other materials provided with the distribution.</span>
00013 <span class="comment">3. All advertising materials mentioning features or use of this software</span>
00014 <span class="comment">   must display the following acknowledgement:</span>
00015 <span class="comment">   This product includes software developed by the Pawel Niewiadomski,</span>
00016 <span class="comment">   and other contributors.</span>
00017 <span class="comment">4. Neither the name of Pawel Niewiadomski nor the names of other contributors</span>
00018 <span class="comment">   may be used to endorse or promote products derived from this software</span>
00019 <span class="comment">   without specific prior written permission.</span>
00020 <span class="comment"></span>
00021 <span class="comment">THIS SOFTWARE IS PROVIDED BY PAWEL NIEWIADOMSKI AND CONTRIBUTORS ``AS IS'' AND</span>
00022 <span class="comment">ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
00023 <span class="comment">IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
00024 <span class="comment">ARE DISCLAIMED.  IN NO EVENT SHALL PAWEL NIEWIADOMSKI OR CONTRIBUTORS BE LIABLE</span>
00025 <span class="comment">FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
00026 <span class="comment">DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</span>
00027 <span class="comment">OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
00028 <span class="comment">HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
00029 <span class="comment">LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
00030 <span class="comment">OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
00031 <span class="comment">SUCH DAMAGE.</span>
00032 <span class="comment">*/</span>
00033 <span class="preprocessor">#include &lt;memory&gt;</span>
00034 <span class="preprocessor">#include &lt;sstream&gt;</span>
00035 
00036 <span class="preprocessor">#include "cloghistmod.h"</span>
00037 <span class="preprocessor">#include "vqwww.h"</span>
00038 <span class="preprocessor">#include "cgi.h"</span>
00039 <span class="preprocessor">#include "vqwww_conf.h"</span>
00040 <span class="preprocessor">#include "html.h"</span>
00041 
00042 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00043 <span class="keyword">using</span> <span class="keyword">namespace </span>vqwww;
00044 <span class="keyword">using</span> <span class="keyword">namespace </span>cgicc;
00045 
00046 <span class="keyword">const</span> <span class="keywordtype">char</span> cloghistmod::_id[] = <span class="stringliteral">"loghist"</span>;
00047 <span class="keyword">const</span> <span class="keywordtype">char</span> cloghistmod::_menu[] = <span class="stringliteral">"&lt;loghist/&gt;"</span>;
00048 
<a name="l00054"></a><a class="code" href="classcloghistmod.html#cloghistmodb1">00054</a> <span class="keywordtype">void</span> <a class="code" href="classcloghistmod.html#cloghistmodb1">cloghistmod::range_get</a>( clogger::size_type &amp; start, clogger::size_type &amp; cnt ) {
00055     const_form_iterator get_start(cgi.getElement(<span class="stringliteral">"start"</span>));
00056     const_form_iterator get_cnt(cgi.getElement(<span class="stringliteral">"cnt"</span>));
00057     istringstream in;
00058     clogger::size_type tmp;
00059     
00060     <span class="keywordflow">if</span>( get_start != <a class="code" href="classcmod.html#credirmodp1">env</a>.<a class="code" href="group__cgi.html#a3">cgi_end_get</a>() ) {
00061             in.str(get_start-&gt;getValue());
00062             in&gt;&gt;tmp;
00063             <span class="keywordflow">if</span>( ! in.bad() &amp;&amp; ! in.fail() &amp;&amp; tmp &gt; 0 ) 
00064                     start = tmp;
00065     }
00066     <span class="keywordflow">if</span>( get_cnt != <a class="code" href="classcmod.html#credirmodp1">env</a>.<a class="code" href="group__cgi.html#a3">cgi_end_get</a>() ) {
00067             in.clear();
00068             in.str(get_cnt-&gt;getValue());
00069             in&gt;&gt;tmp;
00070             <span class="keywordflow">if</span>( ! in.bad() &amp;&amp; ! in.fail() &amp;&amp; tmp &gt; 0 ) 
00071                     cnt = tmp;
00072     }
00073 }
00074 
<a name="l00080"></a><a class="code" href="classcloghistmod.html#cloghistmodb2">00080</a> <span class="keywordtype">void</span> <a class="code" href="classcloghistmod.html#cloghistmodb2">cloghistmod::navi_dump</a>( clogger::size_type cnt, 
00081         clogger::size_type sh_start, clogger::size_type sh_cnt ) {
00082 
00083     clogger::size_type page=sh_start/sh_cnt, page_end = cnt/sh_cnt+(cnt%sh_cnt ? 1 : 0);
00084     clogger::size_type start=page-(page%10), end=page_end &lt; start+10 ? page_end : start+10;
00085     
00086     ostringstream navi;
00087     <span class="keywordtype">bool</span> show = <span class="keyword">false</span>;
00088     
00089     navi&lt;&lt;<span class="stringliteral">"&lt;navi cnt=\""</span>&lt;&lt; sh_cnt &lt;&lt;<span class="stringliteral">"\"&gt;"</span>;
00090     <span class="keywordflow">if</span>( cnt &gt; sh_cnt ) {
00091             show = <span class="keyword">true</span>;
00092             navi&lt;&lt;<span class="stringliteral">"&lt;start/&gt;"</span>;
00093             navi&lt;&lt;<span class="stringliteral">"&lt;end start=\""</span>&lt;&lt; (sh_cnt == 1 ? cnt-1 : cnt-(cnt%sh_cnt ? cnt%sh_cnt : sh_cnt)) &lt;&lt;<span class="stringliteral">"\"/&gt;"</span>;
00094     }
00095     <span class="keywordflow">if</span>( start &gt; 0 ) {
00096             navi&lt;&lt;<span class="stringliteral">"&lt;prev start=\""</span> &lt;&lt; (start-1)*sh_cnt &lt;&lt;<span class="stringliteral">"\"/&gt;"</span>;
00097             show = <span class="keyword">true</span>;
00098     }
00099     
00100     <span class="keywordflow">if</span>( end &gt; 0 &amp;&amp; page_end &gt; end ) {
00101             navi&lt;&lt;<span class="stringliteral">"&lt;next start=\""</span> &lt;&lt; (end &gt; 0 ? end*sh_cnt : 0) &lt;&lt;<span class="stringliteral">"\"/&gt;"</span>;
00102             show = <span class="keyword">true</span>;
00103     }
00104 
00105     <span class="keywordflow">for</span>( ; start&lt;end &amp;&amp; end&gt;1; ++start ) {
00106             navi&lt;&lt;<span class="stringliteral">"&lt;page"</span>;
00107             <span class="keywordflow">if</span>( start==page ) navi&lt;&lt;<span class="stringliteral">" cur=\"1\" "</span>;
00108             navi&lt;&lt;<span class="stringliteral">" start=\""</span>&lt;&lt; start*sh_cnt &lt;&lt;<span class="stringliteral">"\""</span>
00109                 &lt;&lt;<span class="stringliteral">" num=\""</span>&lt;&lt; start+1 &lt;&lt; <span class="stringliteral">"\"/&gt;"</span>;
00110     }
00111     navi&lt;&lt;<span class="stringliteral">"&lt;/navi&gt;"</span>;
00112 
00113     <span class="keywordflow">if</span>( show ) out&lt;&lt;navi.str();
00114 }
00115 
00119 <span class="keywordtype">void</span> cloghistmod::act( clogger * log ) {
00120     out&lt;&lt; <span class="stringliteral">"&lt;mod&gt;&lt;loghist&gt;"</span>;
00121     <span class="keyword">typedef</span> vector&lt;clogger::entry_type&gt; hist_type;
00122     hist_type hist;
00123 
00124     log-&gt;domain_set(sessb.<a class="code" href="structcsess__basic.html#csess__basico0">ai</a>.dom);
00125     log-&gt;login_set(sessb.<a class="code" href="structcsess__basic.html#csess__basico0">ai</a>.user);
00126 
00127     clogger::size_type cnt;
00128 
00129     <span class="keywordflow">if</span>( log-&gt;dom_log_cnt_log(cnt) == clogger::err_no ) {
00130             clogger::size_type sh_start = 0, sh_cnt = 20;
00131             <a class="code" href="classcloghistmod.html#cloghistmodb1">range_get</a>(sh_start, sh_cnt);
00132 
00133             <a class="code" href="classcloghistmod.html#cloghistmodb2">navi_dump</a>(cnt, sh_start, sh_cnt);
00134     
00135             hist_type::const_iterator beg, end;
00136             <span class="keywordflow">switch</span>( log-&gt;dom_log_read_log(hist, sh_start, sh_cnt) ) {
00137             <span class="keywordflow">case</span> clogger::err_no:
00138                     <span class="keywordflow">for</span>( beg=hist.begin(), end=hist.end(); beg!=end; ++beg ) {
00139                             out&lt;&lt;<span class="stringliteral">"&lt;login&gt;"</span>
00140                                 &lt;&lt;<span class="stringliteral">"&lt;time&gt;"</span>&lt;&lt;beg-&gt;time&lt;&lt;<span class="stringliteral">"&lt;/time&gt;"</span>
00141                                 &lt;&lt;<span class="stringliteral">"&lt;ser&gt;"</span>&lt;&lt;static_cast&lt;int&gt;(beg-&gt;ser)&lt;&lt;<span class="stringliteral">"&lt;/ser&gt;"</span>
00142                                 &lt;&lt;<span class="stringliteral">"&lt;msg&gt;"</span>&lt;&lt;beg-&gt;msg&lt;&lt;<span class="stringliteral">"&lt;/msg&gt;"</span>
00143                                 &lt;&lt;<span class="stringliteral">"&lt;ip&gt;"</span>&lt;&lt;beg-&gt;ip&lt;&lt;<span class="stringliteral">"&lt;/ip&gt;"</span>
00144                                 &lt;&lt;<span class="stringliteral">"&lt;res&gt;"</span>&lt;&lt;static_cast&lt;int&gt;(beg-&gt;res)&lt;&lt;<span class="stringliteral">"&lt;/res&gt;"</span>
00145                                 &lt;&lt;<span class="stringliteral">"&lt;/login&gt;"</span>;
00146                     }
00147                     <span class="keywordflow">break</span>;
00148             <span class="keywordflow">case</span> clogger::err_empty:
00149                     out&lt;&lt;<span class="stringliteral">"&lt;empty/&gt;"</span>;
00150                     <span class="keywordflow">break</span>;
00151             <span class="keywordflow">default</span>:
00152                     out&lt;&lt;<span class="stringliteral">"&lt;getcant/&gt;"</span>;
00153                     err&lt;&lt;__FILE__&lt;&lt;<span class="stringliteral">": "</span>&lt;&lt;__LINE__&lt;&lt;<span class="stringliteral">": "</span>&lt;&lt;log-&gt;err_report()&lt;&lt;endl;
00154             }
00155     } <span class="keywordflow">else</span> {
00156             out&lt;&lt;<span class="stringliteral">"&lt;getcant/&gt;"</span>;
00157             err&lt;&lt;__FILE__&lt;&lt;<span class="stringliteral">": "</span>&lt;&lt;__LINE__&lt;&lt;<span class="stringliteral">": "</span>&lt;&lt;log-&gt;err_report()&lt;&lt;endl;
00158     }
00159     
00160     out&lt;&lt; <span class="stringliteral">"&lt;/loghist&gt;&lt;/mod&gt;"</span>;
00161 }
00162 <span class="comment">/**************************************************************************</span>
00163 <span class="comment"> *  </span>
00164 <span class="comment"> *  ***********************************************************************/</span>
<a name="l00165"></a><a class="code" href="classcloghistmod.html#cloghistmoda5">00165</a> <span class="keywordtype">char</span> <a class="code" href="classcloghistmod.html#cloghistmoda5">cloghistmod::run</a>() {
00166     const_form_iterator <a class="code" href="classcloghistmod.html#cloghistmoda1">id</a> = cgi.getElement(<span class="stringliteral">"id"</span>);
00167     <span class="keywordflow">if</span>( id != <a class="code" href="classcmod.html#credirmodp1">env</a>.<a class="code" href="group__cgi.html#a3">cgi_end_get</a>() &amp;&amp; id-&gt;getValue() == _id ) {
00168             act(&amp;<a class="code" href="classcmod.html#credirmodp1">env</a>.<a class="code" href="classcenvironment.html#cvqwwwa16">logger_get</a>());
00169             <span class="keywordflow">return</span> <a class="code" href="classcmod.html#credirmodw8credirmodw3">done</a>;
00170     }
00171     <span class="keywordflow">return</span> <a class="code" href="classcmod.html#credirmodw8credirmodw2">notme</a>;
00172 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Dec 25 13:37:27 2003 for vqwww by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.3 </small></address>
</body>
</html>
