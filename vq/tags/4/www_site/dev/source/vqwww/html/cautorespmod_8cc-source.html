<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>vqwww: cautorespmod.cc Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.3 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Compound&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Compound&nbsp;Members</a></div>
<h1>cautorespmod.cc</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment">Copyright (c) 2002,2003 Pawel Niewiadomski</span>
00003 <span class="comment">All rights reserved.</span>
00004 <span class="comment"></span>
00005 <span class="comment">Redistribution and use in source and binary forms, with or without</span>
00006 <span class="comment">modification, are permitted provided that the following conditions</span>
00007 <span class="comment">are met:</span>
00008 <span class="comment">1. Redistributions of source code must retain the above copyright</span>
00009 <span class="comment">   notice, this list of conditions and the following disclaimer.</span>
00010 <span class="comment">2. Redistributions in binary form must reproduce the above copyright</span>
00011 <span class="comment">   notice, this list of conditions and the following disclaimer in the</span>
00012 <span class="comment">   documentation and/or other materials provided with the distribution.</span>
00013 <span class="comment">3. All advertising materials mentioning features or use of this software</span>
00014 <span class="comment">   must display the following acknowledgement:</span>
00015 <span class="comment">   This product includes software developed by the Pawel Niewiadomski,</span>
00016 <span class="comment">   and other contributors.</span>
00017 <span class="comment">4. Neither the name of Pawel Niewiadomski nor the names of other contributors</span>
00018 <span class="comment">   may be used to endorse or promote products derived from this software</span>
00019 <span class="comment">   without specific prior written permission.</span>
00020 <span class="comment"></span>
00021 <span class="comment">THIS SOFTWARE IS PROVIDED BY PAWEL NIEWIADOMSKI AND CONTRIBUTORS ``AS IS'' AND</span>
00022 <span class="comment">ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
00023 <span class="comment">IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
00024 <span class="comment">ARE DISCLAIMED.  IN NO EVENT SHALL PAWEL NIEWIADOMSKI OR CONTRIBUTORS BE LIABLE</span>
00025 <span class="comment">FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
00026 <span class="comment">DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</span>
00027 <span class="comment">OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
00028 <span class="comment">HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
00029 <span class="comment">LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
00030 <span class="comment">OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
00031 <span class="comment">SUCH DAMAGE.</span>
00032 <span class="comment">*/</span>
00033 
00034 <span class="preprocessor">#include &lt;new&gt;</span>
00035 <span class="preprocessor">#include &lt;vector&gt;</span>
00036 <span class="preprocessor">#include &lt;sstream&gt;</span>
00037 <span class="preprocessor">#include &lt;algorithm&gt;</span>
00038 <span class="preprocessor">#include &lt;functional&gt;</span>
00039 <span class="preprocessor">#include &lt;cctype&gt;</span>
00040 <span class="preprocessor">#include &lt;cerrno&gt;</span>
00041 
00042 <span class="preprocessor">#include &lt;iconv.h&gt;</span>
00043 
00044 <span class="preprocessor">#include &lt;sys.h&gt;</span>
00045 
00046 <span class="preprocessor">#include "cautorespmod.h"</span>
00047 <span class="preprocessor">#include "vqwww_conf.h"</span>
00048 <span class="preprocessor">#include "vqwww.h"</span>
00049 <span class="preprocessor">#include "cgi.h"</span>
00050 <span class="preprocessor">#include "html.h"</span>
00051 
00052 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00053 <span class="keyword">using</span> <span class="keyword">namespace </span>vqwww;
00054 <span class="keyword">using</span> <span class="keyword">namespace </span>cgicc;
00055 
00056 <span class="keyword">const</span> <span class="keywordtype">char</span> cautorespmod::_id[] = <span class="stringliteral">"autoresp"</span>;
00057 <span class="keyword">const</span> <span class="keywordtype">char</span> cautorespmod::_conf[] = <span class="stringliteral">"&lt;autoresp/&gt;&lt;desc&gt;&lt;autoresp/&gt;&lt;/desc&gt;"</span>;
00058 
<a name="l00059"></a><a class="code" href="classcautorespmod.html#cautorespmodb1">00059</a> <span class="keywordtype">void</span> <a class="code" href="classcautorespmod.html#cautorespmodb1">cautorespmod::change</a>(string &amp;autoresp, vector&lt;cvq::udot_info&gt; &amp;uis ) {
00060     <span class="keywordtype">bool</span> chgcant = <span class="keyword">false</span>;
00061     <span class="keywordflow">if</span>( autoresp.empty() ) {
00062             <span class="keywordflow">if</span>( vq.udot_has(sessb.<a class="code" href="structcsess__basic.html#csess__basico0">ai</a>.dom, sessb.<a class="code" href="structcsess__basic.html#csess__basico0">ai</a>.user, <span class="stringliteral">""</span>, 
00063                         cvq::maildir) == cvq::err_noent
00064                  &amp;&amp; vq.udot_has(sessb.<a class="code" href="structcsess__basic.html#csess__basico0">ai</a>.dom, sessb.<a class="code" href="structcsess__basic.html#csess__basico0">ai</a>.user, <span class="stringliteral">""</span>, 
00065                         cvq::redir) == cvq::err_noent ) {
00066                     <span class="keywordflow">switch</span>( vq.udot_add_md_def(sessb.<a class="code" href="structcsess__basic.html#csess__basico0">ai</a>.dom, sessb.<a class="code" href="structcsess__basic.html#csess__basico0">ai</a>.user, <span class="stringliteral">""</span>) ) {
00067                     <span class="keywordflow">case</span> cvq::err_exists:
00068                     <span class="keywordflow">case</span> cvq::err_no: <span class="keywordflow">break</span>;
00069                     <span class="keywordflow">default</span>: 
00070                             err&lt;&lt;<span class="stringliteral">"cautorespmod::udot_add_md_def: "</span>&lt;&lt;vq.err_report()&lt;&lt;endl;
00071                             chgcant = <span class="keyword">true</span>;
00072                     }
00073             }
00074             <span class="keywordflow">if</span>(!chgcant) {
00075                     <span class="keywordflow">if</span>( vq.udot_rm(sessb.<a class="code" href="structcsess__basic.html#csess__basico0">ai</a>.dom, sessb.<a class="code" href="structcsess__basic.html#csess__basico0">ai</a>.user, 
00076                          <span class="stringliteral">""</span>, cvq::autoresp) ) {
00077                             err&lt;&lt;<span class="stringliteral">"cautorespmod::udot_rm: "</span>&lt;&lt;vq.err_report()&lt;&lt;endl;
00078                     } <span class="keywordflow">else</span> uis.clear();
00079             }
00080     } <span class="keywordflow">else</span> {
00081             cvq::udot_info ui;
00082             cmapconf::map_type::const_iterator liter;
00083             liter = ac_codepages.<a class="code" href="classcmapconf.html#cmapconfa1">val_map</a>().find(<a class="code" href="classcmod.html#credirmodp1">env</a>.<a class="code" href="classcenvironment.html#cvqwwwa17">locale_get</a>());
00084 
00085             ui.val = liter != ac_codepages.<a class="code" href="classcmapconf.html#cmapconfa1">val_map</a>().end() ? liter-&gt;second : <span class="stringliteral">"UTF-8"</span>;
00086             ui.val += <span class="charliteral">'\0'</span>+<a class="code" href="classcautorespmod.html#cautorespmodb2">convert</a>(ui.val, <span class="stringliteral">"UTF-8"</span>, autoresp);
00087 
00088             ui.val = to_hex( 
00089                 reinterpret_cast&lt;const unsigned char *&gt;(ui.val.data()), 
00090                 ui.val.length());
00091             
00092             <span class="keywordflow">if</span>(!uis.size()) {
00093                     <span class="keywordflow">if</span>( vq.udot_has(sessb.<a class="code" href="structcsess__basic.html#csess__basico0">ai</a>.dom, sessb.<a class="code" href="structcsess__basic.html#csess__basico0">ai</a>.user, <span class="stringliteral">""</span>, 
00094                                 cvq::maildir) == cvq::err_noent
00095                          &amp;&amp; vq.udot_has(sessb.<a class="code" href="structcsess__basic.html#csess__basico0">ai</a>.dom, sessb.<a class="code" href="structcsess__basic.html#csess__basico0">ai</a>.user, <span class="stringliteral">""</span>, 
00096                                 cvq::redir) == cvq::err_noent ) {
00097                             <span class="keywordflow">switch</span>( vq.udot_add_md_def(sessb.<a class="code" href="structcsess__basic.html#csess__basico0">ai</a>.dom, sessb.<a class="code" href="structcsess__basic.html#csess__basico0">ai</a>.user, <span class="stringliteral">""</span>) ) {
00098                             <span class="keywordflow">case</span> cvq::err_exists:
00099                             <span class="keywordflow">case</span> cvq::err_no: <span class="keywordflow">break</span>;
00100                             <span class="keywordflow">default</span>: 
00101                                     err&lt;&lt;<span class="stringliteral">"cautorespmod::udot_add_md_def: "</span>&lt;&lt;vq.err_report()&lt;&lt;endl;
00102                                     chgcant = <span class="keyword">true</span>;
00103                             }
00104                     }
00105                     <span class="keywordflow">if</span>( ! chgcant ) {
00106                             ui.type = cvq::autoresp;
00107                             <span class="keywordflow">if</span>(vq.udot_add(sessb.<a class="code" href="structcsess__basic.html#csess__basico0">ai</a>.dom, sessb.<a class="code" href="structcsess__basic.html#csess__basico0">ai</a>.user, <span class="stringliteral">""</span>, ui)) {
00108                                     err&lt;&lt;<span class="stringliteral">"cautorespmod::udot_add: "</span>&lt;&lt;vq.err_report()&lt;&lt;endl;
00109                                     chgcant = <span class="keyword">true</span>;
00110                             } <span class="keywordflow">else</span> {
00111                                     uis.push_back(ui);
00112                             }
00113                     }
00114             } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(autoresp != uis[0].val) {
00115                     ui.id = uis[0].id;
00116                     ui.type = uis[0].type;
00117                     <span class="keywordflow">if</span>(vq.udot_rep(sessb.<a class="code" href="structcsess__basic.html#csess__basico0">ai</a>.dom, sessb.<a class="code" href="structcsess__basic.html#csess__basico0">ai</a>.user, <span class="stringliteral">""</span>, ui)) {
00118                             err&lt;&lt;<span class="stringliteral">"cautorespmod::udot_rep: "</span>&lt;&lt;vq.err_report()&lt;&lt;endl;
00119                             chgcant = <span class="keyword">true</span>;
00120                     } <span class="keywordflow">else</span> {
00121                             uis[0].val = ui.val;
00122                     }
00123             }
00124     }
00125     <span class="keywordflow">if</span>( chgcant ) out&lt;&lt;<span class="stringliteral">"&lt;chgcant/&gt;"</span>;
00126 }
00127 
00128 <span class="comment">/***************************************************************************</span>
00129 <span class="comment"> *  </span>
00130 <span class="comment"> * *************************************************************************/</span>
00131 <span class="keywordtype">void</span> cautorespmod::act() {
00132     vector&lt;cvq::udot_info&gt; uis;
00133     out&lt;&lt; <span class="stringliteral">"&lt;mod&gt;&lt;autoresp&gt;"</span>;
00134     <span class="keywordflow">if</span>(! vq.udot_ls(sessb.<a class="code" href="structcsess__basic.html#csess__basico0">ai</a>.dom, sessb.<a class="code" href="structcsess__basic.html#csess__basico0">ai</a>.user, <span class="stringliteral">""</span>, cvq::autoresp, uis ) ) {
00135             <span class="keywordflow">if</span>( <a class="code" href="classcmod.html#credirmodp1">env</a>.<a class="code" href="group__cgi.html#a6">cgi_rm_get</a>() == cenvironment::rm_post ) {
00136                     <span class="keywordtype">bool</span> ok = <span class="keyword">true</span>;
00137                     string autoresp;
00138                     
00139                     <span class="comment">// we get list of items</span>
00140                     cgi_var(cgi, <span class="stringliteral">"autoresp"</span>, autoresp);
00141                     autoresp = html_spec_dec(autoresp);
00142 
00143                     <span class="keywordflow">if</span>( ok ) {
00144                             <span class="keywordflow">try</span> {
00145                                     <a class="code" href="classcautorespmod.html#cautorespmodb1">change</a>(autoresp, uis);
00146                             } <span class="keywordflow">catch</span>( <span class="keyword">const</span> exception &amp; e ) {
00147                                     err&lt;&lt;e.what()&lt;&lt;endl;
00148                                     out&lt;&lt;<span class="stringliteral">"&lt;chgcant/&gt;"</span>;
00149                             }
00150                     }
00151             }
00152             out&lt;&lt;<span class="stringliteral">"&lt;autoresp&gt;"</span>;
00153             <span class="keywordflow">if</span>( uis.size() ) {
00154                     string ar(hex_from(uis[0].val));
00155                     string::size_type zero = ar.find(<span class="charliteral">'\0'</span>);
00156                     <span class="keywordflow">if</span>(ar.length() &gt; zero+1)
00157                             out&lt;&lt;html_spec_enc(
00158                                 <a class="code" href="classcautorespmod.html#cautorespmodb2">convert</a>(<span class="stringliteral">"UTF-8"</span>, ar.substr(0, zero), 
00159                                     ar.substr(zero+1, ar.find(<span class="charliteral">'\0'</span>, zero+1))) )
00160                                 &lt;&lt;endl; 
00161             }
00162             out&lt;&lt; <span class="stringliteral">"&lt;/autoresp&gt;"</span>;
00163     } <span class="keywordflow">else</span> out&lt;&lt; <span class="stringliteral">"&lt;getcant/&gt;"</span>;
00164     out&lt;&lt; <span class="stringliteral">"&lt;/autoresp&gt;&lt;/mod&gt;"</span>;
00165 }
00166 <span class="comment">/**************************************************************************</span>
00167 <span class="comment"> *      </span>
00168 <span class="comment"> ************************************************************************/</span>
<a name="l00169"></a><a class="code" href="classcautorespmod.html#cautorespmoda5">00169</a> <span class="keywordtype">char</span> <a class="code" href="classcautorespmod.html#cautorespmoda5">cautorespmod::run</a>() {
00170     const_form_iterator fi = cgi.getElement(<span class="stringliteral">"conf"</span>);
00171     <span class="keywordflow">if</span>( fi != <a class="code" href="classcmod.html#credirmodp1">env</a>.<a class="code" href="group__cgi.html#a3">cgi_end_get</a>() ) {
00172             fi = cgi.getElement(<span class="stringliteral">"id"</span>);
00173             <span class="keywordflow">if</span>( fi != <a class="code" href="classcmod.html#credirmodp1">env</a>.<a class="code" href="group__cgi.html#a3">cgi_end_get</a>() &amp;&amp; fi-&gt;getValue() == _id ) {
00174                     <span class="keywordflow">if</span>( vq.udot_sup_is(cvq::autoresp) 
00175                         &amp;&amp; vq.udot_sup_is(cvq::maildir) ) {
00176                             act();
00177                             <span class="keywordflow">return</span> <a class="code" href="classcmod.html#credirmodw8credirmodw3">done</a>;
00178                     }
00179             }
00180     }
00181     <span class="keywordflow">return</span> <a class="code" href="classcmod.html#credirmodw8credirmodw2">notme</a>;
00182 }
00183 
<a name="l00189"></a><a class="code" href="classcautorespmod.html#cautorespmodb2">00189</a> std::string <a class="code" href="classcautorespmod.html#cautorespmodb2">cautorespmod::convert</a>( <span class="keyword">const</span> string &amp; to, <span class="keyword">const</span> string &amp; from, 
00190         <span class="keyword">const</span> string &amp; msg) {
00191     <span class="keywordflow">if</span>( msg.empty() ) <span class="keywordflow">return</span> <span class="stringliteral">""</span>;
00192                 
00193     iconv_t ic = iconv_open(to.c_str(), from.c_str());
00194     <span class="keywordflow">if</span>( (iconv_t) -1 == ic ) 
00195             <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"cautoresp::convert("</span>
00196                 +to+<span class="stringliteral">","</span>+from+<span class="stringliteral">"): iconv_open: "</span>+strerror(errno));
00197     
00198     size_t in_len, buf_len = msg.length()*2, out_len;
00199     ICONV_IN_TYPE *in;
00200     <span class="keywordtype">char</span> *buf = <span class="keyword">new</span> <span class="keywordtype">char</span>[buf_len], *out;
00201     <span class="keywordflow">for</span>( ;; ) {
00202             in_len = msg.length();
00203             in = (ICONV_IN_TYPE *)msg.data();
00204             out = buf;
00205             out_len = buf_len;
00206 
00207             <span class="keywordflow">if</span>( (size_t)-1 == iconv(ic, &amp;in, &amp;in_len, &amp;out, &amp;out_len) ) {
00208                     <span class="keywordflow">if</span>( errno == E2BIG ) {
00209                             buf_len *= 2;
00210                             <span class="keyword">delete</span> [] buf;
00211                             buf = <span class="keyword">new</span> <span class="keywordtype">char</span>[ buf_len ];
00212                             <span class="keywordflow">continue</span>;
00213                     } <span class="keywordflow">else</span> {
00214                             iconv_close(ic);
00215                             <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"cautoresp::convert("</span>
00216                                 +to+<span class="stringliteral">","</span>+from+<span class="stringliteral">"): iconv: "</span>+strerror(errno));
00217                     }
00218             }
00219             string ret(buf, out-buf);
00220             <span class="keyword">delete</span> [] buf;
00221             iconv_close(ic);
00222             <span class="keywordflow">return</span> ret;
00223     }
00224 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Dec 25 13:37:27 2003 for vqwww by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.3 </small></address>
</body>
</html>
