<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Virtual Qmail: cfsvq_user.cc Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.3 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Compound&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Compound&nbsp;Members</a></div>
<h1>cfsvq_user.cc</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment">Copyright (c) 2002,2003 Pawel Niewiadomski</span>
00003 <span class="comment">All rights reserved.</span>
00004 <span class="comment"></span>
00005 <span class="comment">Redistribution and use in source and binary forms, with or without</span>
00006 <span class="comment">modification, are permitted provided that the following conditions</span>
00007 <span class="comment">are met:</span>
00008 <span class="comment">1. Redistributions of source code must retain the above copyright</span>
00009 <span class="comment">   notice, this list of conditions and the following disclaimer.</span>
00010 <span class="comment">2. Redistributions in binary form must reproduce the above copyright</span>
00011 <span class="comment">   notice, this list of conditions and the following disclaimer in the</span>
00012 <span class="comment">   documentation and/or other materials provided with the distribution.</span>
00013 <span class="comment">3. All advertising materials mentioning features or use of this software</span>
00014 <span class="comment">   must display the following acknowledgement:</span>
00015 <span class="comment">   This product includes software developed by the Pawel Niewiadomski,</span>
00016 <span class="comment">   and other contributors.</span>
00017 <span class="comment">4. Neither the name of Pawel Niewiadomski nor the names of other contributors</span>
00018 <span class="comment">   may be used to endorse or promote products derived from this software</span>
00019 <span class="comment">   without specific prior written permission.</span>
00020 <span class="comment"></span>
00021 <span class="comment">THIS SOFTWARE IS PROVIDED BY PAWEL NIEWIADOMSKI AND CONTRIBUTORS ``AS IS'' AND</span>
00022 <span class="comment">ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
00023 <span class="comment">IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
00024 <span class="comment">ARE DISCLAIMED.  IN NO EVENT SHALL PAWEL NIEWIADOMSKI OR CONTRIBUTORS BE LIABLE</span>
00025 <span class="comment">FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
00026 <span class="comment">DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</span>
00027 <span class="comment">OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
00028 <span class="comment">HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
00029 <span class="comment">LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
00030 <span class="comment">OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
00031 <span class="comment">SUCH DAMAGE.</span>
00032 <span class="comment">*/</span>
00033 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00034 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00035 <span class="preprocessor">#include &lt;sys/wait.h&gt;</span>
00036 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
00037 <span class="preprocessor">#include &lt;sstream&gt;</span>
00038 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00039 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00040 <span class="preprocessor">#include &lt;cerrno&gt;</span>
00041 <span class="preprocessor">#include &lt;inttypes.h&gt;</span>
00042 <span class="preprocessor">#include &lt;algorithm&gt;</span>
00043 <span class="preprocessor">#include &lt;dirent.h&gt;</span>
00044 <span class="preprocessor">#include &lt;signal.h&gt;</span>
00045 <span class="preprocessor">#include &lt;iomanip&gt;</span>
00046 
00047 <span class="preprocessor">#include "pfstream.h"</span>
00048 <span class="preprocessor">#include "conf_home.h"</span>
00049 <span class="preprocessor">#include "vq_conf.h"</span>
00050 <span class="preprocessor">#include "cfsvq.h"</span>
00051 <span class="preprocessor">#include "lower.h"</span>
00052 <span class="preprocessor">#include "lock.h"</span>
00053 <span class="preprocessor">#include "dirs.h"</span>
00054 <span class="preprocessor">#include "split.h"</span>
00055 <span class="preprocessor">#include "util.h"</span>
00056 <span class="preprocessor">#include "auto/d_namlen.h"</span>
00057 <span class="preprocessor">#include "sys.h"</span>
00058 
00059 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00060 <span class="keyword">using</span> <span class="keyword">namespace </span>posix;
00061 <span class="keyword">using</span> <span class="keyword">namespace </span>vq;
00062 
<a name="l00070"></a><a class="code" href="classcfsvq.html#a6">00070</a> uint8_t <a class="code" href="group__user.html#a6">cfsvq::user_add</a>( <span class="keyword">const</span> string &amp; u, <span class="keyword">const</span> string &amp;d, <span class="keyword">const</span> string &amp; p, 
00071                 uint8_t flags )
00072 {
00073     <a class="code" href="classcfsvq.html#cfsvqb16">assert_auth</a>();
00074     string user(lower(u)), dom(lower(d));
00075 
00076     string domdir(conf_home+<span class="stringliteral">"/domains/"</span>+split_dom(dom)+<span class="charliteral">'/'</span>+dom+<span class="charliteral">'/'</span>);
00077     string spuser(split_user(user));
00078     string user_add_dir(domdir + spuser + <span class="charliteral">'/'</span>+ u);
00079 
00080     <span class="comment">/* check wheter domain has default quota for users */</span>
00081     <a class="code" href="classcvq.html#cvqw0">quota_value</a> qm=0;
00082     <span class="keywordtype">char</span> ret;
00083     <span class="keywordflow">switch</span>((ret=<a class="code" href="group__qt__user.html#a14">qt_def_get</a>(dom, qm))) {
00084     <span class="keywordflow">case</span> <a class="code" href="group__err.html#a16cvqw2">err_no</a>: <span class="keywordflow">break</span>;
00085     <span class="keywordflow">case</span> <a class="code" href="group__err.html#a16cvqw9">err_open</a>: <span class="keywordflow">if</span>(<a class="code" href="group__dom.html#a20">err_sys</a>() == ENOENT) <span class="keywordflow">break</span>;
00086     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a8">lastret</a>;
00087     }
00088 
00089     <span class="keywordflow">if</span>(!mkdirhier(user_add_dir.c_str(), ac_vq_mode.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>(),
00090                 ac_vq_uid.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>(), ac_vq_gid.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>())) 
00091             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw20">err_mkdir</a>, user_add_dir);
00092     
00093     <span class="keywordflow">if</span>(<a class="code" href="classcfsvq.html#cfsvqb11">maildirmake</a>(user_add_dir+<span class="stringliteral">"/Maildir"</span>)) {
00094             rmdirrec(user_add_dir);
00095             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw20">err_mkdir</a>, user_add_dir+<span class="stringliteral">"/Maildir"</span>);
00096     }
00097     <span class="keywordflow">if</span>( qm &amp;&amp; (ret=<a class="code" href="group__qt__user.html#a9">qt_set</a>(dom, user, qm)) != <a class="code" href="group__err.html#a16cvqw2">err_no</a> ) {
00098             rmdirrec(user_add_dir);
00099             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a8">lastret</a>;
00100     }
00101     <span class="keywordflow">if</span>( <a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;user_add(u,d,p,flags) ) {
00102             rmdirrec(user_add_dir);
00103             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw7">err_auth</a>, <a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;err_report());
00104     }
00105     string dotuser = <a class="code" href="group__udot.html#a10">dotfile</a>(dom, user, <span class="stringliteral">""</span>);
00106     <span class="keywordflow">if</span>( ! dumpstring(dotuser, (string)<span class="stringliteral">"./"</span>+user+<span class="stringliteral">"/Maildir/\n"</span> )
00107        || chown(dotuser.c_str(), ac_vq_uid.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>(), ac_vq_gid.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>())
00108        || chmod(dotuser.c_str(), ac_vq_fmode.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>()) ) {
00109             <a class="code" href="group__err.html#a9">lastret_blkd</a> = <span class="keyword">true</span>;
00110             <a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;user_rm(user,dom);
00111             rmdirrec(user_add_dir);
00112             <a class="code" href="group__err.html#a9">lastret_blkd</a> = <span class="keyword">false</span>;
00113             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw10">err_wr</a>, dotuser);
00114     }
00115     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw2">err_no</a>, <span class="stringliteral">""</span>);
00116 }
00117 
<a name="l00124"></a><a class="code" href="classcfsvq.html#a18">00124</a> uint8_t <a class="code" href="group__user.html#a18">cfsvq::user_rm</a>(<span class="keyword">const</span> string &amp;u,<span class="keyword">const</span> string &amp;d)
00125 {
00126     <a class="code" href="classcfsvq.html#cfsvqb16">assert_auth</a>();
00127 
00128     string user(lower(u)), dom(lower(d));
00129     <span class="keywordflow">if</span>( <a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;user_rm(u,d) ) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw7">err_auth</a>, <a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;err_report());
00130 
00131     string dir = conf_home+<span class="stringliteral">"/domains/"</span>+split_dom(dom)+<span class="charliteral">'/'</span>+dom+<span class="charliteral">'/'</span>
00132             +split_user(user) + <span class="charliteral">'/'</span>;
00133     
00134     ostringstream dir_mv;
00135     <span class="keyword">struct </span>timeval time_mv;
00136     gettimeofday(&amp;time_mv, NULL);
00137     dir_mv&lt;&lt;conf_home&lt;&lt;<span class="stringliteral">"/deleted/@"</span>&lt;&lt;time_mv.tv_sec
00138             &lt;&lt;<span class="charliteral">'.'</span>&lt;&lt;time_mv.tv_usec&lt;&lt;<span class="charliteral">'.'</span>&lt;&lt;user&lt;&lt;<span class="charliteral">'@'</span>&lt;&lt;dom;
00139 
00140     <span class="keywordflow">if</span>(rename((dir+user).c_str(), dir_mv.str().c_str())) 
00141             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw16">err_ren</a>, dir+user);
00142     
00143     replace(user.begin(),user.end(),<span class="charliteral">'.'</span>,<span class="charliteral">':'</span>);
00144     DIR *dotdir = opendir(dir.c_str());
00145     <span class="keywordflow">if</span>( dotdir ) {
00146             <span class="keyword">struct </span>dirent *de;
00147             <span class="keywordtype">char</span> * name;
00148             string::size_type userl = user.length(); <span class="comment">// +6 = .qmail-</span>
00149             <span class="keywordflow">while</span>( (de=readdir(dotdir)) ) {
00150                     name = de-&gt;d_name;
00151                     <span class="keywordflow">if</span>( _D_EXACT_NAMLEN(de) &lt; 7
00152                       || _D_EXACT_NAMLEN(de)-7 &lt; userl 
00153                       || *(name++) != <span class="charliteral">'.'</span> || *(name++) != <span class="charliteral">'q'</span> 
00154                       || *(name++) != <span class="charliteral">'m'</span>
00155                       || *(name++) != <span class="charliteral">'a'</span> || *(name++) != <span class="charliteral">'i'</span>
00156                       || *(name++) != <span class="charliteral">'l'</span> || *(name++) != <span class="charliteral">'-'</span> ) <span class="keywordflow">continue</span>;
00157                     <span class="keywordflow">if</span>( name == user 
00158                         || ( name[userl] == <span class="charliteral">'-'</span>
00159                            &amp;&amp; strncmp(name+userl,user.c_str(),userl) ) )
00160                             unlink((dir+de-&gt;d_name).c_str());
00161             }
00162             closedir(dotdir);
00163     } <span class="keywordflow">else</span> <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw11">err_rd</a>, dir);
00164     
00165     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw2">err_no</a>, <span class="stringliteral">""</span>);
00166 }
00167 
<a name="l00175"></a><a class="code" href="classcfsvq.html#a17">00175</a> uint8_t <a class="code" href="group__user.html#a17">cfsvq::user_pass</a>(<span class="keyword">const</span> string &amp;u,<span class="keyword">const</span> string &amp;d,<span class="keyword">const</span> string &amp;p)
00176 {
00177     <a class="code" href="classcfsvq.html#cfsvqb16">assert_auth</a>();
00178     string user(lower(u)), dom(lower(d));
00179     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;user_pass(user,dom,p) ? <a class="code" href="group__err.html#a16cvqw7">err_auth</a> : <a class="code" href="group__err.html#a16cvqw2">err_no</a>, <a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;err_report());
00180 }
<a name="l00186"></a><a class="code" href="classcfsvq.html#a19">00186</a> uint8_t <a class="code" href="group__user.html#a19">cfsvq::user_auth</a>(auth_info &amp; ai)
00187 {
00188     <a class="code" href="classcfsvq.html#cfsvqb16">assert_auth</a>();
00189     <span class="keywordflow">if</span>( ai.user.empty() )
00190             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw5">err_user_inv</a>, <span class="stringliteral">"it's empty"</span>);
00191             
00192     <span class="keywordflow">if</span>( ai.dom.empty() ) 
00193             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw4">err_dom_inv</a>, <span class="stringliteral">"it's empty"</span>);
00194     
00195     ai.user=lower(ai.user);
00196     ai.dom=lower(ai.dom);
00197     <span class="keywordflow">switch</span>( <a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;user_auth(ai) ) {
00198     <span class="keywordflow">case</span> <a class="code" href="group__err.html#a16cvqw2">err_no</a>: 
00199             ai.dir = conf_home+<span class="stringliteral">"/domains/"</span>+split_dom(ai.dom)+<span class="charliteral">'/'</span>+ai.dom+<span class="charliteral">'/'</span>
00200                     +split_user(ai.user)+<span class="charliteral">'/'</span>+ai.user;
00201             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw2">err_no</a>, <span class="stringliteral">""</span>);
00202     <span class="keywordflow">case</span> <a class="code" href="group__err.html#a16cvqw6">err_user_nf</a>: 
00203             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw6">err_user_nf</a>, ai.user+<span class="stringliteral">"@"</span>+ai.dom);
00204     }
00205     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a13">lr</a>(<a class="code" href="group__err.html#a16cvqw7">err_auth</a>, <a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;err_report());
00206 }
00207 
<a name="l00214"></a><a class="code" href="classcfsvq.html#a20">00214</a> uint8_t <a class="code" href="group__user.html#a20">cfsvq::user_ex</a>( <span class="keyword">const</span> string &amp;dom, <span class="keyword">const</span> string &amp;user ) {
00215     <a class="code" href="classcfsvq.html#cfsvqb16">assert_auth</a>();
00216     <span class="keywordflow">return</span> <a class="code" href="classcfsvq.html#cfsvqp0">auth</a>-&gt;user_ex(dom, user);
00217 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Dec 25 13:37:10 2003 for Virtual Qmail by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.3 </small></address>
</body>
</html>
