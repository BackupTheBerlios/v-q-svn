<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>vqwww: cfilesess.cc Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.3 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Compound&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Compound&nbsp;Members</a></div>
<h1>cfilesess.cc</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment">Copyright (c) 2002 Pawel Niewiadomski</span>
00003 <span class="comment">All rights reserved.</span>
00004 <span class="comment"></span>
00005 <span class="comment">Redistribution and use in source and binary forms, with or without</span>
00006 <span class="comment">modification, are permitted provided that the following conditions</span>
00007 <span class="comment">are met:</span>
00008 <span class="comment">1. Redistributions of source code must retain the above copyright</span>
00009 <span class="comment">   notice, this list of conditions and the following disclaimer.</span>
00010 <span class="comment">2. Redistributions in binary form must reproduce the above copyright</span>
00011 <span class="comment">   notice, this list of conditions and the following disclaimer in the</span>
00012 <span class="comment">   documentation and/or other materials provided with the distribution.</span>
00013 <span class="comment">3. All advertising materials mentioning features or use of this software</span>
00014 <span class="comment">   must display the following acknowledgement:</span>
00015 <span class="comment">   This product includes software developed by the Pawel Niewiadomski,</span>
00016 <span class="comment">   and other contributors.</span>
00017 <span class="comment">4. Neither the name of Pawel Niewiadomski nor the names of other contributors</span>
00018 <span class="comment">   may be used to endorse or promote products derived from this software</span>
00019 <span class="comment">   without specific prior written permission.</span>
00020 <span class="comment"></span>
00021 <span class="comment">THIS SOFTWARE IS PROVIDED BY PAWEL NIEWIADOMSKI AND CONTRIBUTORS ``AS IS'' AND</span>
00022 <span class="comment">ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
00023 <span class="comment">IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
00024 <span class="comment">ARE DISCLAIMED.  IN NO EVENT SHALL PAWEL NIEWIADOMSKI OR CONTRIBUTORS BE LIABLE</span>
00025 <span class="comment">FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
00026 <span class="comment">DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</span>
00027 <span class="comment">OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
00028 <span class="comment">HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
00029 <span class="comment">LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
00030 <span class="comment">OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
00031 <span class="comment">SUCH DAMAGE.</span>
00032 <span class="comment">*/</span>
00033 <span class="preprocessor">#include &lt;string&gt;</span>
00034 <span class="preprocessor">#include &lt;cerrno&gt;</span>
00035 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00036 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00037 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00038 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
00039 <span class="preprocessor">#include &lt;fstream&gt;</span>
00040 <span class="preprocessor">#include &lt;dirent.h&gt;</span>
00041 <span class="preprocessor">#include &lt;sstream&gt;</span>
00042 <span class="preprocessor">#include &lt;stdexcept&gt;</span>
00043 
00044 <span class="preprocessor">#include "cfilesess.h"</span>
00045 <span class="preprocessor">#include "util.h"</span>
00046 <span class="preprocessor">#include "dirs.h"</span>
00047 <span class="preprocessor">#include "split.h"</span>
00048 <span class="preprocessor">#include "vqwww_conf.h"</span>
00049 <span class="preprocessor">#include "auto/lmd5.h"</span>
00050 
00051 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00052 <span class="keyword">using</span> <span class="keyword">namespace </span>vqwww;
00053 
<a name="l00057"></a><a class="code" href="classcfilesess.html#cfilesessa0">00057</a> <a class="code" href="classcfilesess.html#cfilesessa0">cfilesess::cfilesess</a>( <span class="keyword">const</span> string &amp; d ) : base(d)
00058 {
00059 }
00060 
<a name="l00065"></a><a class="code" href="classcfilesess.html#cfilesessa3">00065</a> <span class="keywordtype">bool</span> <a class="code" href="classcfilesess.html#cfilesessa3">cfilesess::valid</a>( <span class="keyword">const</span> string &amp; id )
00066 {
00067         <span class="keyword">struct </span>stat st;
00068         <span class="keywordflow">if</span>( ! stat(<a class="code" href="classcfilesess.html#cfilesessb1">sessfn</a>(id).c_str(), &amp; st) ) {
00069                 <span class="keywordflow">return</span> S_ISDIR(st.st_mode) ? <span class="keyword">true</span> : <span class="keyword">false</span>;
00070         }
00071         err = strerror(errno);
00072         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00073 }
<a name="l00079"></a><a class="code" href="classcfilesess.html#cfilesessz7_0">00079</a> string <a class="code" href="classcfilesess.html#cfilesessz7_0">cfilesess::tohex</a>( <span class="keyword">const</span> string &amp; n )
00080 {
00081         <span class="keywordflow">return</span> <a class="code" href="classcfilesess.html#cfilesessz7_0">tohex</a>(n.data(), n.length());
00082 }
00083 
<a name="l00090"></a><a class="code" href="classcfilesess.html#cfilesessz7_1">00090</a> string <a class="code" href="classcfilesess.html#cfilesessz7_0">cfilesess::tohex</a>( <span class="keyword">const</span> <span class="keywordtype">char</span> *ptr, <span class="keywordtype">unsigned</span> len )
00091 {
00092         <span class="keyword">const</span> <span class="keywordtype">char</span> lut[] = <span class="stringliteral">"0123456789abcdef"</span>;
00093         string ret;
00094         <span class="keywordflow">for</span>( <span class="keywordtype">unsigned</span> i=0; i &lt; len; i++ ) {
00095                 ret += lut[ (ptr[i] &amp; 0xf0) &gt;&gt; 4 ];
00096                 ret += lut[ ptr[i] &amp; 0xf ];
00097         }
00098         <span class="keywordflow">return</span> ret;
00099 }
00100 
<a name="l00107"></a><a class="code" href="classcfilesess.html#cfilesessa6">00107</a> <span class="keywordtype">bool</span> <a class="code" href="classcfilesess.html#cfilesessa4">cfilesess::setval</a>( <span class="keyword">const</span> string &amp; n, <span class="keyword">const</span> string &amp; v )
00108 {
00109         <span class="keywordflow">if</span>( id == <span class="stringliteral">""</span> ) 
00110                 <span class="keywordflow">throw</span> logic_error( <span class="stringliteral">"cfilesess: session hasn't been opened"</span> );
00111 
00112         string fn(id+<span class="charliteral">'/'</span>+<a class="code" href="classcfilesess.html#cfilesessz7_0">tohex</a>(n));
00113         ofstream o( fn.c_str(), ios::trunc );
00114         <span class="keywordflow">if</span>( ! o || chmod(fn.c_str(), ac_sess_fmode.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>())) {
00115                 err = strerror(errno);
00116                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00117         }
00118         o &lt;&lt; v;
00119         o.close();
00120         <span class="keywordflow">if</span>( ! o ) {
00121                 err = strerror(errno);
00122                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00123         }
00124         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00125 }
00126 
<a name="l00133"></a><a class="code" href="classcfilesess.html#cfilesessa10">00133</a> <span class="keywordtype">bool</span> <a class="code" href="classcfilesess.html#cfilesessa5">cfilesess::getval</a>( <span class="keyword">const</span> string &amp; n, string &amp; v )
00134 {
00135     <span class="keywordflow">if</span>( id.empty() ) <span class="keywordflow">throw</span> logic_error( <span class="stringliteral">"session hasn't been opened"</span>);
00136     v = <span class="stringliteral">""</span>;
00137     ifstream i( (id+<span class="charliteral">'/'</span>+<a class="code" href="classcfilesess.html#cfilesessz7_0">tohex</a>(n)).c_str() );
00138     <span class="keywordflow">if</span>( ! i ) {
00139             err = strerror(errno);
00140             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00141     }
00142     ostringstream str;
00143     str &lt;&lt; i.rdbuf();
00144     <span class="keywordflow">if</span>( i.bad() || i.fail() || str.bad() || str.fail() ) {
00145             err = strerror(errno);
00146             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00147     }
00148     i.close();
00149     <span class="keywordflow">if</span>( i.bad() || i.fail() ) {
00150             err = strerror(errno);
00151             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00152     }
00153     v = str.str();
00154     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00155 }
<a name="l00159"></a><a class="code" href="classcfilesess.html#cfilesessa11">00159</a> <span class="keywordtype">bool</span> <a class="code" href="classcfilesess.html#cfilesessa4">cfilesess::setval</a>( <span class="keyword">const</span> string &amp; n, <span class="keywordtype">bool</span> v ) 
00160 {
00161         string t = id+<span class="charliteral">'/'</span>+<a class="code" href="classcfilesess.html#cfilesessz7_0">tohex</a>(n);
00162         ofstream o( t.c_str(), ios::trunc );
00163         o.close();
00164         <span class="keywordflow">if</span>(! o || chmod(t.c_str(), ac_sess_fmode.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>()) ) {
00165                 err = strerror(errno);
00166                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00167         }
00168         <span class="keywordflow">if</span>(chmod( t.c_str(), S_IRUSR | S_IWUSR | (v ? S_IXUSR : 0) )) {
00169                 err = strerror(errno);
00170                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00171         }
00172         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00173 }
00174 
<a name="l00178"></a><a class="code" href="classcfilesess.html#cfilesessa12">00178</a> <span class="keywordtype">bool</span> <a class="code" href="classcfilesess.html#cfilesessa5">cfilesess::getval</a>( <span class="keyword">const</span> string &amp;n, <span class="keywordtype">bool</span> &amp; v ) 
00179 {
00180         <span class="keyword">struct </span>stat st;
00181         <span class="keywordflow">if</span>( ! stat((id+<span class="charliteral">'/'</span>+<a class="code" href="classcfilesess.html#cfilesessz7_0">tohex</a>(n)).c_str(), &amp; st) ) {
00182                 v = st.st_mode &amp; S_IXUSR ? 1 : 0;
00183                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
00184         }
00185         err = strerror(errno);
00186         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00187 }
00188 
<a name="l00193"></a><a class="code" href="classcfilesess.html#cfilesessa13">00193</a> <span class="keywordtype">bool</span> <a class="code" href="classcfilesess.html#cfilesessa13">cfilesess::rmval</a>( <span class="keyword">const</span> string &amp; n )
00194 {
00195         <span class="keywordflow">if</span>( unlink( (id+<span class="charliteral">'/'</span>+<a class="code" href="classcfilesess.html#cfilesessz7_0">tohex</a>(n)).c_str() ) ) {
00196                 err = strerror(errno);
00197                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00198         }
00199         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00200 }
00201 
<a name="l00205"></a><a class="code" href="classcfilesess.html#cfilesessa15">00205</a> <span class="keywordtype">bool</span> <a class="code" href="classcfilesess.html#cfilesessa15">cfilesess::rm</a>()
00206 {
00207         <span class="keywordflow">try</span> {
00208                 rmdirrec(id);
00209         } <span class="keywordflow">catch</span>( <span class="keyword">const</span> runtime_error &amp; e ) {
00210                 err = e.what();
00211                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00212         }
00213         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00214 }
00215 
<a name="l00221"></a><a class="code" href="classcfilesess.html#cfilesessa16">00221</a> <span class="keywordtype">bool</span> <a class="code" href="classcfilesess.html#cfilesessa16">cfilesess::open</a>( <span class="keyword">const</span> string &amp; id )
00222 {
00223         <span class="keyword">struct </span>stat st;
00224         string tmp = <a class="code" href="classcfilesess.html#cfilesessb1">sessfn</a>(id);
00225         <span class="keywordflow">if</span>( stat( tmp.c_str(), &amp;st) == -1 ) {
00226                 err = strerror(errno);
00227                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00228         }
00229         <span class="keywordflow">if</span>( ! S_ISDIR(st.st_mode) ) {
00230                 err =<span class="stringliteral">"no such session"</span>;
00231                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00232         }
00233         this-&gt;id =  tmp;
00234         sid = id;
00235         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00236 }
00237 
<a name="l00243"></a><a class="code" href="classcfilesess.html#cfilesessa17">00243</a> <span class="keywordtype">bool</span> <a class="code" href="classcfilesess.html#cfilesessa17">cfilesess::create</a>( string &amp; id )
00244 {
00245         id = <a class="code" href="classcfilesess.html#cfilesessb0">crtid</a>();
00246         string tid = base+<span class="charliteral">'/'</span>+split(id, 2, <span class="stringliteral">"/"</span>, ac_fs_split.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>())+id;
00247         <span class="keywordflow">if</span>( ! mkdirhier( tid.c_str(), 0700 ) ) {
00248                 id = <a class="code" href="classcfilesess.html#cfilesessb0">crtid</a>();
00249                 tid = base+<span class="charliteral">'/'</span>+split(id, 2, <span class="stringliteral">"/"</span>, ac_fs_split.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>())+id;
00250                 <span class="keywordflow">if</span>(!mkdirhier(tid.c_str(), 0700)) {
00251                         err = strerror(errno);
00252                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00253                 }
00254         }
00255         this-&gt;id = tid;
00256         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00257 }
<a name="l00262"></a><a class="code" href="classcfilesess.html#cfilesessb0">00262</a> string <a class="code" href="classcfilesess.html#cfilesessb0">cfilesess::crtid</a>()
00263 {
00264         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> dig[16];
00265         <span class="keyword">struct </span>timeval tp;
00266         gettimeofday( &amp; tp, NULL );
00267         ostringstream o;
00268         o &lt;&lt; tp.tv_usec &lt;&lt; getpid() &lt;&lt; tp.tv_sec;
00269         MD5_CTX con;
00270         MD5Init( &amp; con );
00271         MD5Update( &amp; con, (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) o.str().c_str(), o.str().length() );
00272         MD5Final (dig, &amp;con);
00273         <span class="keywordflow">return</span> <a class="code" href="classcfilesess.html#cfilesessz7_0">tohex</a>((<span class="keywordtype">char</span> *) dig, <span class="keyword">sizeof</span>(dig));
00274 }
00275 
<a name="l00279"></a><a class="code" href="classcfilesess.html#cfilesessa18">00279</a> <span class="keyword">const</span> <span class="keywordtype">char</span> * <a class="code" href="classcfilesess.html#cfilesessa18">cfilesess::errmsg</a>()
00280 {
00281         <span class="keywordflow">return</span> err.c_str();
00282 }
00283 
<a name="l00287"></a><a class="code" href="classcfilesess.html#cfilesessa4">00287</a> <span class="keywordtype">bool</span> <a class="code" href="classcfilesess.html#cfilesessa4">cfilesess::setval</a>(<span class="keyword">const</span> string &amp;name, <span class="keyword">const</span> <span class="keyword">struct</span> timeval &amp;t) {
00288         <span class="keyword">struct </span>timeval ts[2];
00289         string fn = id+<span class="charliteral">'/'</span>+<a class="code" href="classcfilesess.html#cfilesessz7_0">tohex</a>(name);
00290         ts[0] = t;
00291         ts[1] = t;
00292         <span class="keywordflow">if</span>(utimes(fn.c_str(), (<span class="keyword">struct </span>timeval *) &amp;ts)) {
00293                 <span class="keywordflow">if</span>( errno == ENOENT ) {
00294                         ofstream o(fn.c_str(), ios::trunc );
00295                         o.close();
00296                         <span class="keywordflow">if</span>( o.bad() || chmod(fn.c_str(), ac_sess_fmode.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>())) {
00297                                 err = fn+<span class="stringliteral">": "</span>+strerror(errno);
00298                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00299                         }
00300                         <span class="keywordflow">if</span>( ! utimes(fn.c_str(), (<span class="keyword">struct </span>timeval *) &amp;ts) )
00301                                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
00302                 }
00303                 err = fn+<span class="stringliteral">": "</span>+strerror(errno);
00304                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00305         }
00306         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00307 }
00308 
<a name="l00312"></a><a class="code" href="classcfilesess.html#cfilesessa5">00312</a> <span class="keywordtype">bool</span> <a class="code" href="classcfilesess.html#cfilesessa5">cfilesess::getval</a>(<span class="keyword">const</span> string &amp;name, <span class="keyword">struct</span> timeval &amp;t) {
00313         <span class="keyword">struct </span>stat st;
00314         string fn=id+<span class="charliteral">'/'</span>+<a class="code" href="classcfilesess.html#cfilesessz7_0">tohex</a>(name);
00315         <span class="keywordflow">if</span>( stat(fn.c_str(), &amp;st) ) {
00316                 err = fn+<span class="stringliteral">": "</span>+strerror(errno);
00317                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00318         }
00319 <span class="preprocessor">#ifndef __linux__        </span>
00320 <span class="preprocessor"></span>        TIMESPEC_TO_TIMEVAL(&amp;t, &amp;st.st_mtimespec);
00321 <span class="preprocessor">#else</span>
00322 <span class="preprocessor"></span>        t.tv_sec = st.st_mtime;
00323         t.tv_usec = 0;
00324 <span class="preprocessor">#endif</span>
00325 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <span class="keyword">true</span>;
00326 }
00327 
<a name="l00331"></a><a class="code" href="classcfilesess.html#cfilesessa7">00331</a> <span class="keywordtype">bool</span> <a class="code" href="classcfilesess.html#cfilesessa4">cfilesess::setval</a>(<span class="keyword">const</span> string &amp;n, <span class="keyword">const</span> <span class="keywordtype">char</span> *ptr, <span class="keywordtype">unsigned</span> len ) {
00332         <span class="keywordflow">if</span>( id == <span class="stringliteral">""</span> ) <span class="keywordflow">throw</span> logic_error( <span class="stringliteral">"cfilesess: session hasn't been opened"</span> );
00333         string fn(id+<span class="charliteral">'/'</span>+<a class="code" href="classcfilesess.html#cfilesessz7_0">tohex</a>(n));
00334         ofstream o( fn.c_str(), ios::trunc );
00335         <span class="keywordflow">if</span>( ! o || chmod(fn.c_str(), ac_sess_fmode.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>())) {
00336                 err = strerror(errno);
00337                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00338         }
00339         o.write(reinterpret_cast&lt;char *&gt;(&amp;len), <span class="keyword">sizeof</span>(len));
00340         o.write(ptr,len);
00341         o.close();
00342         <span class="keywordflow">if</span>( ! o ) {
00343                 err = strerror(errno);
00344                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00345         }
00346         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00347 }
00348 
<a name="l00352"></a><a class="code" href="classcfilesess.html#cfilesessa8">00352</a> <span class="keywordtype">bool</span> <a class="code" href="classcfilesess.html#cfilesessa5">cfilesess::getval</a>( <span class="keyword">const</span> string &amp;n, <span class="keywordtype">char</span> *ptr, <span class="keywordtype">unsigned</span> len ) {
00353     <span class="keywordflow">if</span>( id.empty() ) <span class="keywordflow">throw</span> logic_error( <span class="stringliteral">"session hasn't been opened"</span>);
00354     ifstream i( (id+<span class="charliteral">'/'</span>+<a class="code" href="classcfilesess.html#cfilesessz7_0">tohex</a>(n)).c_str() );
00355     <span class="keywordflow">if</span>( ! i ) {
00356             err = strerror(errno);
00357             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00358     }
00359     <span class="keywordtype">unsigned</span> slen;
00360     i.read(reinterpret_cast&lt;char *&gt;(&amp;slen), <span class="keyword">sizeof</span>(slen));
00361     <span class="keywordflow">if</span>( slen != len ) {
00362             err = <span class="stringliteral">"saved length and specified differs"</span>;
00363             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00364     }
00365     i.read(ptr, slen);
00366     <span class="keywordflow">if</span>( ! i ) {
00367             err = strerror(errno);
00368             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00369     }
00370     i.close();
00371     <span class="keywordflow">if</span>( i.bad() || i.fail() ) {
00372             err = strerror(errno);
00373             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00374     }
00375     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00376 }
00377 
<a name="l00384"></a><a class="code" href="classcfilesess.html#cfilesessa9">00384</a> <span class="keywordtype">bool</span> <a class="code" href="classcfilesess.html#cfilesessa5">cfilesess::getval</a>(<span class="keyword">const</span> string &amp;n, <span class="keywordtype">char</span> **ptr, <span class="keywordtype">unsigned</span> &amp; len) {
00385     <span class="keywordflow">if</span>( id.empty() ) <span class="keywordflow">throw</span> logic_error( <span class="stringliteral">"session hasn't been opened"</span>);
00386     ifstream i( (id+<span class="charliteral">'/'</span>+<a class="code" href="classcfilesess.html#cfilesessz7_0">tohex</a>(n)).c_str() );
00387     <span class="keywordflow">if</span>( ! i ) {
00388             err = strerror(errno);
00389             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00390     }
00391     i.read(reinterpret_cast&lt;char *&gt;(&amp;len), <span class="keyword">sizeof</span>(len));
00392     *ptr = <span class="keyword">new</span> <span class="keywordtype">char</span>[len];
00393     i.read(*ptr, len);
00394     <span class="keywordflow">if</span>( ! i ) {
00395             err = strerror(errno);
00396             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00397     }
00398     i.close();
00399     <span class="keywordflow">if</span>( i.bad() || i.fail() ) {
00400             err = strerror(errno);
00401             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00402     }
00403     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00404 }
<a name="l00409"></a><a class="code" href="classcfilesess.html#cfilesessb1">00409</a> string <a class="code" href="classcfilesess.html#cfilesessb1">cfilesess::sessfn</a>( <span class="keyword">const</span> string &amp; id ) {
00410     <span class="keywordflow">return</span> base + <span class="charliteral">'/'</span> + split(id, 2, <span class="stringliteral">"/"</span>, ac_fs_split.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>()) + id;
00411 }
00412 
<a name="l00416"></a><a class="code" href="classcsess.html#csesse0">00416</a> <a class="code" href="classcsess.html">csess</a>* <a class="code" href="classcsess.html#csesse0">csess::alloc</a>() {
00417     <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classcfilesess.html">cfilesess</a>(ac_fs.<a class="code" href="classclnconf.html#clnconfa1">val_str</a>());
00418 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Dec 25 13:37:27 2003 for vqwww by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.3 </small></address>
</body>
</html>
