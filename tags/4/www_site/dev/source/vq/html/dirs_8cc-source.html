<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Virtual Qmail: dirs.cc Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.3 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Compound&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Compound&nbsp;Members</a></div>
<h1>dirs.cc</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment">Copyright (c) 2002 Pawel Niewiadomski</span>
00003 <span class="comment">All rights reserved.</span>
00004 <span class="comment"></span>
00005 <span class="comment">Redistribution and use in source and binary forms, with or without</span>
00006 <span class="comment">modification, are permitted provided that the following conditions</span>
00007 <span class="comment">are met:</span>
00008 <span class="comment">1. Redistributions of source code must retain the above copyright</span>
00009 <span class="comment">   notice, this list of conditions and the following disclaimer.</span>
00010 <span class="comment">2. Redistributions in binary form must reproduce the above copyright</span>
00011 <span class="comment">   notice, this list of conditions and the following disclaimer in the</span>
00012 <span class="comment">   documentation and/or other materials provided with the distribution.</span>
00013 <span class="comment">3. All advertising materials mentioning features or use of this software</span>
00014 <span class="comment">   must display the following acknowledgement:</span>
00015 <span class="comment">   This product includes software developed by the Pawel Niewiadomski,</span>
00016 <span class="comment">   and other contributors.</span>
00017 <span class="comment">4. Neither the name of Pawel Niewiadomski nor the names of other contributors</span>
00018 <span class="comment">   may be used to endorse or promote products derived from this software</span>
00019 <span class="comment">   without specific prior written permission.</span>
00020 <span class="comment"></span>
00021 <span class="comment">THIS SOFTWARE IS PROVIDED BY PAWEL NIEWIADOMSKI AND CONTRIBUTORS ``AS IS'' AND</span>
00022 <span class="comment">ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
00023 <span class="comment">IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
00024 <span class="comment">ARE DISCLAIMED.  IN NO EVENT SHALL PAWEL NIEWIADOMSKI OR CONTRIBUTORS BE LIABLE</span>
00025 <span class="comment">FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
00026 <span class="comment">DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</span>
00027 <span class="comment">OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
00028 <span class="comment">HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
00029 <span class="comment">LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
00030 <span class="comment">OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
00031 <span class="comment">SUCH DAMAGE.</span>
00032 <span class="comment">*/</span>
00033 
00034 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00035 <span class="preprocessor">#include &lt;string&gt;</span>
00036 <span class="preprocessor">#include &lt;cerrno&gt;</span>
00037 <span class="preprocessor">#include &lt;dirent.h&gt;</span>
00038 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00039 
00040 <span class="preprocessor">#ifdef DIRSTEST</span>
00041 <span class="preprocessor"></span><span class="preprocessor">#include &lt;iostream&gt;</span>
00042 <span class="preprocessor">#endif</span>
00043 <span class="preprocessor"></span>
00044 <span class="preprocessor">#include "dirs.h"</span>
00045 
00046 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00047 
00052 <span class="keywordtype">bool</span> mkdirhier(<span class="keyword">const</span> <span class="keywordtype">char</span> *path, mode_t m)
00053 {
00054     <span class="keywordflow">if</span>( mkdir(path,m) ) {
00055             <span class="keywordflow">if</span>( errno != ENOENT ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00056             string pre, sub, p(path);
00057             string::size_type pos, beg;
00058             <span class="keywordflow">for</span>( beg=0; (pos=p.find(<span class="charliteral">'/'</span>,beg)) != string::npos; beg = pos+1 ) {
00059                     sub = p.substr(beg, pos-beg);
00060                     <span class="keywordflow">if</span>( sub == <span class="stringliteral">".."</span> ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00061                     <span class="keywordflow">if</span>( sub == <span class="stringliteral">"."</span> ) <span class="keywordflow">continue</span>;
00062                     pre += sub + <span class="charliteral">'/'</span>;
00063                     <span class="keywordflow">if</span>( sub == <span class="stringliteral">""</span> ) <span class="keywordflow">continue</span>;
00064                     <span class="keywordflow">if</span>( mkdir( pre.c_str(), m ) &amp;&amp; errno != EEXIST ) {
00065                             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00066                     }
00067             }
00068             pre += p.substr(beg);
00069             <span class="keywordflow">if</span>( mkdir(pre.c_str(), m) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00070             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00071     }
00072     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00073 }
00074 
00079 <span class="keywordtype">bool</span> mkdirhier(<span class="keyword">const</span> <span class="keywordtype">char</span> *path, mode_t m, <span class="keywordtype">int</span> uid, <span class="keywordtype">int</span> gid)
00080 {
00081     <span class="keywordflow">if</span>( mkdir(path,m) ) {
00082             <span class="keywordflow">if</span>( errno != ENOENT ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00083             string pre, sub, p(path);
00084             string::size_type pos, beg;
00085             <span class="keywordflow">for</span>( beg=0; (pos=p.find(<span class="charliteral">'/'</span>,beg)) != string::npos; beg = pos+1 ) {
00086                     sub = p.substr(beg, pos-beg);
00087                     <span class="keywordflow">if</span>( sub == <span class="stringliteral">".."</span> ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00088                     <span class="keywordflow">if</span>( sub == <span class="stringliteral">"."</span> ) <span class="keywordflow">continue</span>;
00089                     pre += sub + <span class="charliteral">'/'</span>;
00090                     <span class="keywordflow">if</span>( sub == <span class="stringliteral">""</span> ) <span class="keywordflow">continue</span>;
00091                     <span class="keywordflow">if</span>( mkdir( pre.c_str(), m ) ) { 
00092                             <span class="keywordflow">if</span>( errno != EEXIST ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00093                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( chown(pre.c_str(), uid, gid) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00094             }
00095             pre += p.substr(beg);
00096             <span class="keywordflow">if</span>( mkdir(pre.c_str(), m)
00097                 || chown(pre.c_str(), uid, gid)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00098             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00099     }
00100     <span class="keywordflow">if</span>( chown(path, uid, gid) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00101     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00102 }
00103 
00108 <span class="keywordtype">bool</span> rmdirrec( <span class="keyword">const</span> string &amp; n )
00109 {
00110         <span class="keywordflow">if</span>( n.empty() ) <span class="keywordflow">return</span> <span class="keyword">true</span>;
00111         DIR *cd = opendir(<span class="stringliteral">"."</span>);
00112         <span class="keywordflow">if</span>( ! cd ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00113 
00114         <span class="keywordflow">if</span>( chdir(n.c_str()) ) {
00115                 <span class="keywordflow">if</span>( fchdir(dirfd(cd)) ) 
00116                         <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"rmdirrec: can't go back to: "</span> 
00117                                 + n + <span class="stringliteral">": "</span> + strerror(errno));
00118                 closedir(cd);
00119                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00120         }
00121         DIR *d = opendir(<span class="stringliteral">"."</span>);
00122         <span class="keywordflow">if</span>( ! d ) {
00123                 <span class="keywordflow">if</span>( fchdir(dirfd(cd)) )
00124                         <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"rmdirrec: can't go back to: "</span>
00125                                 + n + <span class="stringliteral">": "</span> + strerror(errno) );
00126                 closedir(cd);
00127                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00128         }
00129         <span class="keyword">struct </span>dirent *de;
00130         <span class="keyword">struct </span>stat st;
00131         <span class="keywordflow">while</span>( (de=readdir(d)) ) {
00132                 <span class="keywordflow">if</span>( de-&gt;d_name[0] == <span class="charliteral">'.'</span> &amp;&amp; ( de-&gt;d_name[1] == <span class="charliteral">'\0'</span> 
00133                     || (de-&gt;d_name[1] == <span class="charliteral">'.'</span> &amp;&amp; de-&gt;d_name[2] == <span class="charliteral">'\0'</span> )) )
00134                         <span class="keywordflow">continue</span>;
00135                         
00136                 <span class="keywordflow">if</span>( ::unlink(de-&gt;d_name) ) {
00137                         <span class="keywordflow">if</span>( stat(de-&gt;d_name, &amp; st) ) {
00138                                 closedir(d);
00139                                 <span class="keywordflow">if</span>( fchdir(dirfd(cd)) )
00140                                         <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"rmdirrec: can't go back to: "</span>
00141                                                 + n + <span class="stringliteral">": "</span> + strerror(errno) );
00142                                 closedir(cd);
00143                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00144                         }
00145                         <span class="keywordflow">if</span>( S_ISDIR(st.st_mode) ) {
00146                                 <span class="keywordflow">if</span>( ! rmdirrec(de-&gt;d_name) ) {
00147                                         closedir(d);
00148                                         <span class="keywordflow">if</span>( fchdir(dirfd(cd)) )
00149                                                 <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"rmdirrec: can't go back to: "</span>
00150                                                         + n + <span class="stringliteral">": "</span> + strerror(errno) );
00151                                         closedir(cd);
00152                                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00153                                 }
00154                         } <span class="keywordflow">else</span> {
00155                                 closedir(d);
00156                                 <span class="keywordflow">if</span>( fchdir(dirfd(cd)) )
00157                                         <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"rmdirrec: can't go back to: "</span>
00158                                                 + n + <span class="stringliteral">": "</span> + strerror(errno) );
00159                                 closedir(cd);
00160                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00161                         }
00162                 }
00163         }
00164         closedir(d);
00165         <span class="keywordflow">if</span>( fchdir(dirfd(cd)) ) 
00166                 <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"rmdirrec: can't go back to: "</span>
00167                         + n + <span class="stringliteral">": "</span> + strerror(errno) );
00168         closedir(cd);
00169         <span class="keywordflow">return</span> rmdir(n.c_str()) ? <span class="keyword">false</span> : <span class="keyword">true</span>;
00170 }
00171 
00172 <span class="preprocessor">#ifdef DIRSTEST</span>
00173 <span class="preprocessor"></span><span class="preprocessor">#include &lt;string&gt;</span>
00174 <span class="preprocessor">#include &lt;cerrno&gt;</span>
00175 <span class="keywordtype">int</span> main()
00176 {
00177     <span class="keywordtype">char</span> *d[] = { <span class="stringliteral">"tets/xcg/fdgv/./cvb//bcv"</span>, <span class="stringliteral">"./sdf/srt"</span> };
00178     cout &lt;&lt; d[0] &lt;&lt; <span class="charliteral">' '</span> &lt;&lt; (<span class="keywordtype">int</span>)mkdirhier(d[0],0700) &lt;&lt; endl;
00179     cout &lt;&lt; d[0] &lt;&lt; <span class="charliteral">' '</span> &lt;&lt; (<span class="keywordtype">int</span>)rmdirrec(d[0]) &lt;&lt; <span class="charliteral">':'</span>&lt;&lt; strerror(errno) &lt;&lt;endl;
00180     cout &lt;&lt; d[0] &lt;&lt; <span class="charliteral">' '</span> &lt;&lt; (<span class="keywordtype">int</span>)rmdirrec(<span class="stringliteral">"tets"</span>) &lt;&lt; <span class="charliteral">':'</span>&lt;&lt; strerror(errno) &lt;&lt;endl;
00181     cout &lt;&lt; d[1] &lt;&lt; <span class="charliteral">' '</span> &lt;&lt; (<span class="keywordtype">int</span>)mkdirhier(d[1],0700) &lt;&lt; endl;
00182     cout &lt;&lt; d[1] &lt;&lt; <span class="charliteral">' '</span> &lt;&lt; (<span class="keywordtype">int</span>)rmdirrec(d[1]) &lt;&lt; <span class="charliteral">':'</span> &lt;&lt; strerror(errno) &lt;&lt; endl;
00183     cout &lt;&lt; d[1] &lt;&lt; <span class="charliteral">' '</span> &lt;&lt; (<span class="keywordtype">int</span>)rmdirrec(<span class="stringliteral">"sdf"</span>) &lt;&lt; <span class="charliteral">':'</span> &lt;&lt; strerror(errno) &lt;&lt; endl;
00184     <span class="keywordflow">return</span> 0;
00185 }
00186 <span class="preprocessor">#endif</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Dec 25 13:37:10 2003 for Virtual Qmail by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.3 </small></address>
</body>
</html>
