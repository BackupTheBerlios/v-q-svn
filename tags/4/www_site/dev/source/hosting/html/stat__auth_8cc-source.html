<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>vqwww: hosting: stat_auth.cc Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.3 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Compound&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Compound&nbsp;Members</a></div>
<h1>stat_auth.cc</h1><div class="fragment"><pre>00001 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
00002 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00003 <span class="preprocessor">#include &lt;fstream&gt;</span>
00004 <span class="preprocessor">#include &lt;iostream&gt;</span>
00005 <span class="preprocessor">#include &lt;exception&gt;</span>
00006 <span class="preprocessor">#include &lt;stdexcept&gt;</span>
00007 
00008 <span class="preprocessor">#include &lt;csess.h&gt;</span>
00009 <span class="preprocessor">#include &lt;cgicc/Cgicc.h&gt;</span>
00010 
00011 <span class="keyword">using</span> <span class="keyword">namespace </span>cgicc;
00012 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00013 
00015 Cgicc *cgi=NULL;
00017 const_form_iterator cgie;
00019 <span class="keyword">const</span> CgiEnvironment *ce=NULL;
00021 csess *sess = NULL;
00022 
00023 <span class="keywordtype">int</span> conf_sess_timeout_i = 20*60;
00027 <span class="keywordtype">bool</span> cgi_var( Cgicc *cgi, <span class="keyword">const</span> string &amp;name, string &amp;val ) {
00028     const_form_iterator fi = cgi-&gt;getElement(name);
00029     <span class="keywordflow">if</span>( fi != cgi-&gt;getElements().end() ) {
00030             val = fi-&gt;getValue();
00031             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00032     }
00033     val = <span class="stringliteral">""</span>;
00034     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00035 }
00036 
00040 <span class="keywordtype">void</span> denied() {
00041     cout&lt;&lt;<span class="stringliteral">"Location: /log/denied.html"</span>&lt;&lt;endl
00042         &lt;&lt;<span class="stringliteral">"Content-Type: text/html"</span>&lt;&lt;endl&lt;&lt;endl;
00043     exit(0);
00044 }
00045 
00049 <span class="keywordtype">void</span> empty() {
00050     cout&lt;&lt;<span class="stringliteral">"Location: /log/empty.html"</span>&lt;&lt;endl
00051         &lt;&lt;<span class="stringliteral">"Content-Type: text/html"</span>&lt;&lt;endl&lt;&lt;endl;
00052     exit(0);
00053 }
00057 <span class="keywordtype">bool</span> dom_allow(<span class="keyword">const</span> string &amp;doms, <span class="keyword">const</span> string &amp; dom) {
00058     string::size_type pos, domsl = doms.length(), doml = dom.length();
00059     string::size_type beg = 0;
00060     <span class="keywordflow">if</span>( doml &gt; domsl ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00061     <span class="keywordflow">for</span>( ; (pos = doms.find(dom, beg)) != string::npos; beg += (pos-beg)+doml ) {
00062         <span class="keywordflow">if</span>( pos+doml &gt; domsl ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00063         <span class="keywordflow">if</span>( ! pos ) {
00064                 <span class="keywordflow">if</span>( doml == domsl ) <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">// match</span>
00065                 <span class="keywordflow">if</span>( doms[pos+doml] == <span class="charliteral">','</span> ) <span class="keywordflow">return</span> <span class="keyword">true</span>;
00066         } <span class="keywordflow">else</span> {
00067                 <span class="keywordflow">if</span>( doms[pos-1] == <span class="charliteral">','</span> ) {
00068                         <span class="keywordflow">if</span>( pos+doml == domsl ) <span class="keywordflow">return</span> <span class="keyword">true</span>;
00069                         <span class="keywordflow">if</span>( pos+doml &lt;= domsl &amp;&amp; doms[pos+doml] == <span class="charliteral">','</span> ) 
00070                                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
00071                 }
00072         }
00073     }
00074     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00075 }
00079 <span class="keywordtype">int</span> main(<span class="keywordtype">int</span> , <span class="keywordtype">char</span> **av) {
00080     <span class="keywordflow">try</span> {
00081             string cip; <span class="comment">// client ip</span>
00082             string uri, sid, domains, domain;
00083             string::size_type uril;
00084             <span class="keyword">struct </span>timeval lasttime, now, tvsub;
00085             
00086             sess = csess::alloc();
00087             cgi = <span class="keyword">new</span> Cgicc();
00088             cgie = cgi-&gt;getElements().end();
00089             ce = &amp;cgi-&gt;getEnvironment();
00090             
00091             <span class="keywordflow">if</span>( ! cgi_var(cgi, <span class="stringliteral">"file"</span>, uri) || ! cgi_var(cgi, <span class="stringliteral">"sid"</span>, sid) 
00092                 || ! cgi_var(cgi, <span class="stringliteral">"domain"</span>, domain) || domain.empty()
00093                 || uri.empty() || sid.empty() ) {
00094                     denied();
00095             }
00096             <span class="keywordflow">if</span>( (uril=uri.length()) &gt; 2 ) {
00097                     <span class="keywordflow">if</span>( ( uri[0] == <span class="charliteral">'.'</span> &amp;&amp; uri[1] == <span class="charliteral">'.'</span> &amp;&amp; uri[2] == <span class="charliteral">'/'</span> )
00098                        || ( uri[uril-1] == <span class="charliteral">'/'</span> &amp;&amp; uri[uril-2] == <span class="charliteral">'.'</span> &amp;&amp; uri[uril-3] == <span class="charliteral">'.'</span>)
00099                        || ( uri[uril-1] == <span class="charliteral">'.'</span> &amp;&amp; uri[uril-2] == <span class="charliteral">'.'</span> ) 
00100                        || uri.find(<span class="stringliteral">"/../"</span>) != string::npos ) {
00101                             denied();
00102                     }
00103             }
00104             
00105             <span class="keywordflow">if</span>( ! sess-&gt;open(sid) ) {
00106                     denied();
00107             }
00108             <span class="comment">// check if specified session is valid</span>
00109             <span class="keywordflow">if</span>( ! sess-&gt;getval(<span class="stringliteral">"cip"</span>, cip) || cip != ce-&gt;getRemoteAddr() ) {
00110                     denied();
00111             }
00112             <span class="keywordflow">if</span>( gettimeofday( &amp;now, NULL ) ) <span class="keywordflow">throw</span> runtime_error(<span class="stringliteral">"gettimeofday failed!"</span>);
00113             <span class="keywordflow">if</span>( sess-&gt;getval(<span class="stringliteral">"lasttime"</span>, lasttime) ) {
00114                     timersub(&amp;now, &amp;lasttime, &amp;tvsub);
00115                     <span class="keywordflow">if</span>( tvsub.tv_sec &gt; conf_sess_timeout_i ) {
00116                             denied();
00117                     }
00118             } <span class="keywordflow">else</span> {
00119                     denied();
00120             }
00121             <span class="keywordflow">if</span>( ! sess-&gt;getval(<span class="stringliteral">"stat_domains"</span>, domains) 
00122                 || ! dom_allow(domains, domain) ) {
00123                     denied();
00124             }
00125 
00126             ifstream in(uri.c_str());
00127             <span class="keywordflow">if</span>( ! in ) {
00128                     empty();
00129             }
00130             <span class="keywordflow">if</span>( uri[uri.length()-1] == <span class="charliteral">'g'</span> ) 
00131                     cout&lt;&lt;<span class="stringliteral">"Content-Type: application/png\n\n"</span>;
00132             <span class="keywordflow">else</span> 
00133                     cout&lt;&lt;<span class="stringliteral">"Content-Type: text/html\n\n"</span>;
00134             cout&lt;&lt;in.rdbuf();
00135     } <span class="keywordflow">catch</span>( <span class="keyword">const</span> exception &amp; e ) {
00136             cerr&lt;&lt;*av&lt;&lt;<span class="stringliteral">": exception: "</span>&lt;&lt;e.what()&lt;&lt;endl;
00137             <span class="keywordflow">return</span> 1;
00138     }
00139     <span class="keywordflow">return</span> 0;
00140 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Dec 25 13:37:23 2003 for vqwww: hosting by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.3 </small></address>
</body>
</html>
