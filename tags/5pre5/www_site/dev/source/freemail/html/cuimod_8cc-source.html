<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>vqwww: freemail: cuimod.cc Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.3 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Compound&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Compound&nbsp;Members</a></div>
<h1>cuimod.cc</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment">Copyright (c) 2003 Pawel Niewiadomski</span>
00003 <span class="comment">All rights reserved.</span>
00004 <span class="comment"></span>
00005 <span class="comment">Redistribution and use in source and binary forms, with or without</span>
00006 <span class="comment">modification, are permitted provided that the following conditions</span>
00007 <span class="comment">are met:</span>
00008 <span class="comment">1. Redistributions of source code must retain the above copyright</span>
00009 <span class="comment">   notice, this list of conditions and the following disclaimer.</span>
00010 <span class="comment">2. Redistributions in binary form must reproduce the above copyright</span>
00011 <span class="comment">   notice, this list of conditions and the following disclaimer in the</span>
00012 <span class="comment">   documentation and/or other materials provided with the distribution.</span>
00013 <span class="comment">3. All advertising materials mentioning features or use of this software</span>
00014 <span class="comment">   must display the following acknowledgement:</span>
00015 <span class="comment">   This product includes software developed by the Pawel Niewiadomski,</span>
00016 <span class="comment">   and other contributors.</span>
00017 <span class="comment">4. Neither the name of Pawel Niewiadomski nor the names of other contributors</span>
00018 <span class="comment">   may be used to endorse or promote products derived from this software</span>
00019 <span class="comment">   without specific prior written permission.</span>
00020 <span class="comment"></span>
00021 <span class="comment">THIS SOFTWARE IS PROVIDED BY PAWEL NIEWIADOMSKI AND CONTRIBUTORS ``AS IS'' AND</span>
00022 <span class="comment">ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
00023 <span class="comment">IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
00024 <span class="comment">ARE DISCLAIMED.  IN NO EVENT SHALL PAWEL NIEWIADOMSKI OR CONTRIBUTORS BE LIABLE</span>
00025 <span class="comment">FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
00026 <span class="comment">DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</span>
00027 <span class="comment">OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
00028 <span class="comment">HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
00029 <span class="comment">LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
00030 <span class="comment">OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
00031 <span class="comment">SUCH DAMAGE.</span>
00032 <span class="comment">*/</span>
00033 <span class="preprocessor">#include &lt;sstream&gt;</span>
00034 <span class="preprocessor">#include &lt;cgicc/Cgicc.h&gt;</span>
00035 <span class="preprocessor">#include &lt;vqwww.h&gt;</span>
00036 <span class="preprocessor">#include &lt;html.h&gt;</span>
00037 <span class="preprocessor">#include &lt;cgi.h&gt;</span>
00038 <span class="preprocessor">#include &lt;valid.h&gt;</span>
00039 
00040 <span class="preprocessor">#include "cuimod.h"</span>
00041 <span class="preprocessor">#include "freemail_conf.h"</span>
00042 
00043 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00044 <span class="keyword">using</span> <span class="keyword">namespace </span>cgicc;
00045 <span class="keyword">using</span> <span class="keyword">namespace </span>freemail;
00046 <span class="keyword">using</span> <span class="keyword">namespace </span>valid;
00047 
00048 <span class="keyword">const</span> <span class="keywordtype">char</span> cuimod::_id[] = <span class="stringliteral">"ui"</span>;
00049 <span class="keyword">const</span> <span class="keywordtype">char</span> cuimod::_conf[] = <span class="stringliteral">"&lt;ui/&gt;&lt;desc&gt;&lt;ui/&gt;&lt;/desc&gt;"</span>;
00050 
00054 cuimod::cuimod( cenvironment &amp; env ) : cmod(env) {
00055     modinfo = mi_conf;
00056 }
00057 
00061 <span class="keywordtype">void</span> cuimod::form2ints() {
00062     ostringstream int_name;
00063     string inter;
00064     vector&lt;cdbdaemon::int_info&gt;::size_type i, cnt;
00065     vector&lt;cdbdaemon::int_info&gt;::const_iterator icur, iend = ints.end();
00066     ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo11">ints_id</a>.clear();
00067     <span class="keywordflow">for</span>( i=1, cnt=ints.size(); i&lt;=cnt; ++i ) {
00068             int_name.str(<span class="stringliteral">""</span>);
00069             int_name&lt;&lt;i;
00070             cgi_var(cgi, <span class="stringliteral">"int"</span>+int_name.str(), inter);
00071             <span class="keywordflow">if</span>( ! inter.empty() ) {
00072                     <span class="keywordflow">for</span>( icur=ints.begin(); icur!=iend; ++icur ) {
00073                             <span class="keywordflow">if</span>( icur-&gt;id == inter ) <span class="keywordflow">break</span>;
00074                     }
00075                     <span class="keywordflow">if</span>( icur != iend ) {
00076                             ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo11">ints_id</a>.push_back(inter);
00077                     }
00078             }
00079     }
00080 }
00081 
00085 <span class="keywordtype">void</span> cuimod::ints2form() {
00086     vector&lt;cdbdaemon::int_info&gt;::const_iterator beg=ints.begin(), end=ints.end();
00087     vector&lt;string&gt;::const_iterator icur, iend = ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo11">ints_id</a>.end();
00088     out&lt;&lt;<span class="stringliteral">"&lt;ints&gt;"</span>;
00089     <span class="keywordflow">for</span>( ; beg!=end; ++beg ) {
00090             out&lt;&lt;<span class="stringliteral">"&lt;int id=\""</span> &lt;&lt; beg-&gt;id &lt;&lt;<span class="stringliteral">"\" name=\""</span> &lt;&lt; beg-&gt;name &lt;&lt;<span class="stringliteral">"\""</span>;
00091             <span class="keywordflow">for</span>( icur=ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo11">ints_id</a>.begin(); icur!=iend; ++icur ) {
00092                     <span class="keywordflow">if</span>( *icur == beg-&gt;id ) { 
00093                             out&lt;&lt;<span class="stringliteral">" sel=\"1\" "</span>;
00094                             <span class="keywordflow">break</span>;
00095                     }
00096             }
00097             out&lt;&lt;<span class="stringliteral">"/&gt;"</span>;
00098     }
00099     out&lt;&lt;<span class="stringliteral">"&lt;/ints&gt;"</span>;
00100 }
00101 
00104 <span class="keywordtype">void</span> cuimod::post_act() {
00105 <span class="preprocessor">#define ok_not(x) do { \</span>
00106 <span class="preprocessor">        out&lt;&lt;x; \</span>
00107 <span class="preprocessor">        ok = false; \</span>
00108 <span class="preprocessor">} while(0)</span>
00109 <span class="preprocessor"></span>    <span class="keywordtype">bool</span> ok = <span class="keyword">true</span>;
00110     string::size_type len;
00111     
00112     out&lt;&lt;<span class="stringliteral">"&lt;inv&gt;"</span>;
00113     <span class="comment">// country</span>
00114     out&lt;&lt;<span class="stringliteral">"&lt;country "</span>;
00115     len = ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo3">country</a>.length();
00116     <span class="keywordflow">if</span>(len &lt;= ac_cntry_minl.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>()) ok_not(<span class="stringliteral">"sh=\"1\" "</span>);
00117     out&lt;&lt;<span class="stringliteral">"/&gt;"</span>;
00118     <span class="comment">// city</span>
00119     out&lt;&lt;<span class="stringliteral">"&lt;city "</span>;
00120     len = ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo4">city</a>.length();
00121     <span class="keywordflow">if</span>(len &lt;= ac_city_minl.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>()) ok_not(<span class="stringliteral">"sh=\"1\" "</span>);
00122     out&lt;&lt;<span class="stringliteral">"/&gt;"</span>;
00123     <span class="comment">// birthday</span>
00124     out&lt;&lt;<span class="stringliteral">"&lt;birthday "</span>;
00125     string t;
00126     <span class="keywordflow">if</span>( ! (t=date_valid(ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo5">birthday</a>)).empty() ) ok_not(<span class="stringliteral">"inv=\"1\" "</span>);
00127     out&lt;&lt;<span class="stringliteral">"/&gt;"</span>;
00128   
00129     out&lt;&lt;<span class="stringliteral">"&lt;ints "</span>;
00130     <span class="keywordflow">if</span>( ! ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo11">ints_id</a>.size() ) ok_not(<span class="stringliteral">"no=\"1\" "</span>);
00131     out&lt;&lt;<span class="stringliteral">"/&gt;"</span>;
00132     out&lt;&lt;<span class="stringliteral">"&lt;/inv&gt;"</span>;
00133 
00134     <span class="keywordflow">if</span>( ok ) {
00135             <span class="keywordflow">if</span>( idb-&gt;ui_chg(ui) != <a class="code" href="group__err.html#a1cdbdaemonw21">cdbdaemon::err_no</a> ) {
00136                     err&lt;&lt; *env.av_get() &lt;&lt; <span class="stringliteral">": idb-&gt;ui_chg: "</span>&lt;&lt; idb-&gt;err() &lt;&lt; endl;
00137                     out&lt;&lt;<span class="stringliteral">"&lt;chgcant/&gt;"</span>;
00138             }
00139     }
00140 
00141 <span class="preprocessor">#undef ok_not</span>
00142 <span class="preprocessor"></span>}
00143 
00147 <span class="keywordtype">void</span> cuimod::act() {
00148     out&lt;&lt;<span class="stringliteral">"&lt;mod&gt;&lt;ui&gt;"</span>;
00149     dominfo.<a class="code" href="structcdbdaemon_1_1domain__info.html#cdbdaemon_1_1domain__infoo1">name</a> = sessb.ai.dom;
00150     <span class="keywordflow">if</span>( idb-&gt;domain_get_by_name(dominfo) != <a class="code" href="group__err.html#a1cdbdaemonw21">cdbdaemon::err_no</a> ) {
00151             out&lt;&lt; <span class="stringliteral">"&lt;getcant/&gt;"</span>;
00152             err&lt;&lt; *env.av_get() &lt;&lt; <span class="stringliteral">": can't get domain info: "</span> &lt;&lt; idb-&gt;err() &lt;&lt; endl;
00153             <span class="keywordflow">goto</span> cuimod_act_end;
00154     }
00155 
00156     ui_org.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo1">login</a> = sessb.ai.user;
00157     ui_org.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo2">dom_id</a> = dominfo.<a class="code" href="structcdbdaemon_1_1domain__info.html#cdbdaemon_1_1domain__infoo0">id</a>;
00158     <span class="keywordflow">if</span>( idb-&gt;ui_get_by_name(ui_org) != <a class="code" href="group__err.html#a1cdbdaemonw21">cdbdaemon::err_no</a> ) {
00159             out&lt;&lt; <span class="stringliteral">"&lt;getcant/&gt;"</span>;
00160             err&lt;&lt; *env.av_get() &lt;&lt; <span class="stringliteral">": can't get user info: "</span> &lt;&lt; idb-&gt;err() &lt;&lt; endl;
00161             <span class="keywordflow">goto</span> cuimod_act_end;
00162     }
00163 
00164     idb-&gt;locale_set(ui_org.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo10">locale</a>);
00165     <span class="keywordflow">if</span>( idb-&gt;edu_ls(edu_levs) != <a class="code" href="group__err.html#a1cdbdaemonw21">cdbdaemon::err_no</a>
00166         || idb-&gt;work_ls(works) != <a class="code" href="group__err.html#a1cdbdaemonw21">cdbdaemon::err_no</a>
00167         || idb-&gt;int_ls(ints) != <a class="code" href="group__err.html#a1cdbdaemonw21">cdbdaemon::err_no</a>
00168         || idb-&gt;area_ls(areas) != <a class="code" href="group__err.html#a1cdbdaemonw21">cdbdaemon::err_no</a>
00169         || idb-&gt;sex_ls(sexes) != <a class="code" href="group__err.html#a1cdbdaemonw21">cdbdaemon::err_no</a> ) {
00170             out&lt;&lt; <span class="stringliteral">"&lt;getcant/&gt;"</span>;
00171             err&lt;&lt; *env.av_get() &lt;&lt; <span class="stringliteral">": can't get info: "</span> &lt;&lt; idb-&gt;err() &lt;&lt; endl;
00172             <span class="keywordflow">goto</span> cuimod_act_end;
00173     }
00174     ui = ui_org;
00175     <span class="keywordflow">if</span>( env.cgi_rm_get() == cenvironment::rm_post ) {
00176             <span class="comment">// real action </span>
00177             cgi_var(cgi, <span class="stringliteral">"country"</span>, ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo3">country</a>);
00178             cgi_var(cgi, <span class="stringliteral">"area"</span>, ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo6">area_id</a>);
00179             cgi_var(cgi, <span class="stringliteral">"city"</span>, ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo4">city</a>);
00180             cgi_var(cgi, <span class="stringliteral">"sex"</span>, ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo9">sex_id</a>);
00181             cgi_var(cgi, <span class="stringliteral">"edu"</span>, ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo8">edu_id</a>);
00182             cgi_var(cgi, <span class="stringliteral">"work"</span>, ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo7">work_id</a>);
00183             cgi_var(cgi, <span class="stringliteral">"birthday"</span>, ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo5">birthday</a>);
00184 <span class="preprocessor">#define spec_dec(x) x = html_spec_dec(x)</span>
00185 <span class="preprocessor"></span>            spec_dec(ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo3">country</a>);
00186             spec_dec(ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo4">city</a>);
00187             spec_dec(ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo5">birthday</a>);
00188 <span class="preprocessor">#undef spec_dec</span>
00189 <span class="preprocessor"></span>            form2ints();
00190 
00191             post_act();
00192     }
00193 
00194     out&lt;&lt;<span class="stringliteral">"&lt;edu&gt;"</span>;
00195     <span class="keywordflow">for</span>( vector&lt;cdbdaemon::edu_info&gt;::const_iterator beg = edu_levs.begin(), 
00196                     end=edu_levs.end(); beg!=end; ++beg ) {
00197             out&lt;&lt;<span class="stringliteral">"&lt;lev id=\""</span> &lt;&lt; beg-&gt;id &lt;&lt;<span class="stringliteral">"\" name=\""</span> &lt;&lt; beg-&gt;name &lt;&lt;<span class="stringliteral">"\""</span>;
00198             <span class="keywordflow">if</span>( ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo8">edu_id</a> == beg-&gt;id ) out&lt;&lt;<span class="stringliteral">" sel=\"1\" "</span>;
00199             out&lt;&lt;<span class="stringliteral">"/&gt;"</span>;
00200     }
00201 
00202     out&lt;&lt;<span class="stringliteral">"&lt;/edu&gt;"</span>;
00203     out&lt;&lt;<span class="stringliteral">"&lt;works&gt;"</span>;
00204 
00205     <span class="keywordflow">for</span>( vector&lt;cdbdaemon::work_info&gt;::const_iterator beg = works.begin(), 
00206                     end=works.end(); beg!=end; ++beg ) {
00207             out&lt;&lt;<span class="stringliteral">"&lt;work id=\""</span> &lt;&lt; beg-&gt;id &lt;&lt;<span class="stringliteral">"\" name=\""</span> &lt;&lt; beg-&gt;name &lt;&lt;<span class="stringliteral">"\""</span>;
00208             <span class="keywordflow">if</span>( ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo7">work_id</a> == beg-&gt;id ) out&lt;&lt;<span class="stringliteral">" sel=\"1\" "</span>;
00209             out&lt;&lt;<span class="stringliteral">"/&gt;"</span>;
00210     }
00211     out&lt;&lt;<span class="stringliteral">"&lt;/works&gt;"</span>;
00212     ints2form();
00213     out&lt;&lt;<span class="stringliteral">"&lt;areas&gt;"</span>;
00214     <span class="keywordflow">for</span>( vector&lt;cdbdaemon::area_info&gt;::const_iterator beg=areas.begin(),
00215                     end=areas.end(); beg!=end; ++beg ) {
00216             out&lt;&lt;<span class="stringliteral">"&lt;area id=\""</span>&lt;&lt; beg-&gt;id &lt;&lt;<span class="stringliteral">"\" name=\""</span>&lt;&lt; beg-&gt;name &lt;&lt;<span class="stringliteral">"\""</span>;
00217             <span class="keywordflow">if</span>( ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo6">area_id</a> == beg-&gt;id ) out&lt;&lt;<span class="stringliteral">" sel=\"1\" "</span>;
00218             out&lt;&lt;<span class="stringliteral">"/&gt;"</span>;
00219     }
00220     out&lt;&lt;<span class="stringliteral">"&lt;/areas&gt;"</span>;
00221     out&lt;&lt;<span class="stringliteral">"&lt;sexes&gt;"</span>;
00222 
00223     <span class="keywordflow">for</span>( vector&lt;cdbdaemon::sex_info&gt;::const_iterator beg=sexes.begin(),
00224                     end=sexes.end(); beg!=end; ++beg ) {
00225             out&lt;&lt;<span class="stringliteral">"&lt;sex id=\""</span> &lt;&lt; beg-&gt;id &lt;&lt;<span class="stringliteral">"\" name=\""</span>&lt;&lt; beg-&gt;name &lt;&lt;<span class="stringliteral">"\""</span>;
00226             <span class="keywordflow">if</span>( ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo9">sex_id</a> == beg-&gt;id ) out&lt;&lt;<span class="stringliteral">" sel=\"1\" "</span>;
00227             out&lt;&lt;<span class="stringliteral">"/&gt;"</span>;
00228     }
00229     out&lt;&lt;<span class="stringliteral">"&lt;/sexes&gt;"</span>;
00230 
00231     out&lt;&lt;<span class="stringliteral">"&lt;country val=\""</span> &lt;&lt; html_spec_enc(ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo3">country</a>) &lt;&lt; <span class="stringliteral">"\" minl=\""</span>&lt;&lt; ac_cntry_minl.<a class="code" href="classcintconf.html#cuidconfa2">val_str</a>()&lt;&lt;<span class="stringliteral">"\"/&gt;"</span>;
00232     out&lt;&lt;<span class="stringliteral">"&lt;city val=\""</span> &lt;&lt; html_spec_enc(ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo4">city</a>) &lt;&lt; <span class="stringliteral">"\" minl=\""</span>&lt;&lt; ac_city_minl.<a class="code" href="classcintconf.html#cuidconfa2">val_str</a>() &lt;&lt;<span class="stringliteral">"\"/&gt;"</span>;
00233     out&lt;&lt;<span class="stringliteral">"&lt;birthday val=\""</span> &lt;&lt; html_spec_enc(ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo5">birthday</a>) &lt;&lt; <span class="stringliteral">"\"/&gt;"</span>;
00234 
00235 cuimod_act_end:
00236     out&lt;&lt;<span class="stringliteral">"&lt;/ui&gt;&lt;/mod&gt;"</span>;
00237 }
00238 
00242 <span class="keywordtype">char</span> cuimod::run() {
00243     const_form_iterator fi = cgi.getElement(<span class="stringliteral">"conf"</span>);
00244     <span class="keywordflow">if</span>( fi != env.cgi_end_get() ) {
00245             fi = cgi.getElement(<span class="stringliteral">"id"</span>);
00246             <span class="keywordflow">if</span>( fi != env.cgi_end_get() &amp;&amp; fi-&gt;getValue() == _id ) {
00247                     idb.reset(<span class="keyword">new</span> <a class="code" href="classcdbdaemon.html">cdbdaemon</a>());
00248 
00249                     act();
00250                     <span class="keywordflow">return</span> done;
00251             }
00252     }
00253     <span class="keywordflow">return</span> notme;
00254 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Dec 25 13:37:18 2003 for vqwww: freemail by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.3 </small></address>
</body>
</html>
