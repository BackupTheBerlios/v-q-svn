<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>vqwww: freemail: vqsignup1d.cc Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.3 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Compound&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Compound&nbsp;Members</a></div>
<h1>vqsignup1d.cc</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment">Copyright (c) 2002,2003 Pawel Niewiadomski</span>
00003 <span class="comment">All rights reserved.</span>
00004 <span class="comment"></span>
00005 <span class="comment">Redistribution and use in source and binary forms, with or without</span>
00006 <span class="comment">modification, are permitted provided that the following conditions</span>
00007 <span class="comment">are met:</span>
00008 <span class="comment">1. Redistributions of source code must retain the above copyright</span>
00009 <span class="comment">   notice, this list of conditions and the following disclaimer.</span>
00010 <span class="comment">2. Redistributions in binary form must reproduce the above copyright</span>
00011 <span class="comment">   notice, this list of conditions and the following disclaimer in the</span>
00012 <span class="comment">   documentation and/or other materials provided with the distribution.</span>
00013 <span class="comment">3. All advertising materials mentioning features or use of this software</span>
00014 <span class="comment">   must display the following acknowledgement:</span>
00015 <span class="comment">   This product includes software developed by the Pawel Niewiadomski,</span>
00016 <span class="comment">   and other contributors.</span>
00017 <span class="comment">4. Neither the name of Pawel Niewiadomski nor the names of other contributors</span>
00018 <span class="comment">   may be used to endorse or promote products derived from this software</span>
00019 <span class="comment">   without specific prior written permission.</span>
00020 <span class="comment"></span>
00021 <span class="comment">THIS SOFTWARE IS PROVIDED BY PAWEL NIEWIADOMSKI AND CONTRIBUTORS ``AS IS'' AND</span>
00022 <span class="comment">ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
00023 <span class="comment">IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
00024 <span class="comment">ARE DISCLAIMED.  IN NO EVENT SHALL PAWEL NIEWIADOMSKI OR CONTRIBUTORS BE LIABLE</span>
00025 <span class="comment">FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
00026 <span class="comment">DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</span>
00027 <span class="comment">OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
00028 <span class="comment">HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
00029 <span class="comment">LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
00030 <span class="comment">OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
00031 <span class="comment">SUCH DAMAGE.</span>
00032 <span class="comment">*/</span>
00033 
00034 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00035 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00036 <span class="preprocessor">#include &lt;sys/socket.h&gt;</span>
00037 <span class="preprocessor">#include &lt;sys/un.h&gt;</span>
00038 <span class="preprocessor">#include &lt;ctime&gt;</span>
00039 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00040 <span class="preprocessor">#include &lt;cerrno&gt;</span>
00041 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
00042 <span class="preprocessor">#include &lt;exception&gt;</span>
00043 <span class="preprocessor">#include &lt;stdexcept&gt;</span>
00044 <span class="preprocessor">#include &lt;iostream&gt;</span>
00045 <span class="preprocessor">#include &lt;algorithm&gt;</span>
00046 <span class="preprocessor">#include &lt;vector&gt;</span>
00047 
00048 <span class="preprocessor">#define HAVE_NAMESPACE_STD 1</span>
00049 <span class="preprocessor"></span><span class="preprocessor">#include &lt;pqxx/all.h&gt;</span>
00050 
00051 <span class="preprocessor">#include &lt;sig.h&gt;</span>
00052 <span class="preprocessor">#include &lt;fd.h&gt;</span>
00053 <span class="preprocessor">#include &lt;fdstr.h&gt;</span>
00054 <span class="preprocessor">#include &lt;util.h&gt;</span>
00055 <span class="preprocessor">#include &lt;lock.h&gt;</span>
00056 <span class="preprocessor">#include &lt;sys.h&gt;</span>
00057 
00058 <span class="preprocessor">#include "cdbdaemon.h"</span>
00059 <span class="preprocessor">#include "conf_home.h"</span>
00060 <span class="preprocessor">#include "freemail_conf.h"</span>
00061 <span class="preprocessor">#include "daemon.h"</span>
00062 
00063 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00064 <span class="keyword">using</span> <span class="keyword">namespace </span>freemail;
00065 
00066 <span class="comment">// socket</span>
00067 <span class="keywordtype">int</span> slock;
00068 <span class="comment">// pgsql</span>
00069 pqxx::Connection *pg = NULL;
00070 <span class="comment">// child</span>
00071 <span class="keywordtype">char</span> msg_type=0;
00072 string id, localeinfo, login, dom_id, country, city, birthday, area_id, work_id;
00073 string edu_id, sex_id, re_que, re_ans, domain;
00074 vector&lt;string&gt; ints;
00075 vector&lt;string&gt;::size_type ints_cnt;
00076 
00080 <span class="keywordtype">void</span> setup()
00081 {
00082     umask(0);
00083     <span class="keywordflow">if</span>(!sig_pipeign() || !sig_chld_nocldwait() ) 
00084             <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"setup: can't set signals: "</span>+strerror(errno));
00085     <span class="keywordflow">if</span>(chdir((conf_home+<span class="stringliteral">"/var/run/vqsignup1d"</span>).c_str()))
00086             <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"setup: chdir: "</span>
00087                     +conf_home+<span class="stringliteral">"/var/run: "</span>+strerror(errno));
00088     slock = open(<span class="stringliteral">"vqsignup1d.lock"</span>, O_RDONLY | O_NONBLOCK | O_CREAT, 0666 );
00089     <span class="keywordflow">if</span>(slock==-1)
00090             <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"setup: open: vqsignup1d.lock: "</span>+strerror(errno));
00091     <span class="keywordflow">if</span>(lock_exnb(slock)) {
00092             <span class="keywordflow">if</span>( errno == EWOULDBLOCK )
00093                     <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"setup: vqsignup1d.lock is already locked"</span>);
00094             <span class="keywordflow">else</span> <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"setup: vqsignup1d.lock: lock: "</span>+strerror(errno));
00095     }
00096     <span class="keywordflow">if</span>(unlink(<span class="stringliteral">"vqsignup1d.sock"</span>)==-1 &amp;&amp; errno != ENOENT )
00097             <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"setup: unlink: vqsignup1d.sock: "</span>+strerror(errno));
00098     <span class="keywordflow">if</span>( (sso=socket(AF_UNIX,SOCK_STREAM,0)) == -1 )
00099             <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"setup: socket: "</span>+strerror(errno));
00100     <span class="keyword">struct </span>sockaddr_un sun;
00101     sun.sun_family = AF_UNIX;
00102     strcpy(sun.sun_path, <span class="stringliteral">"vqsignup1d.sock"</span>);
00103     <span class="keywordflow">if</span>(bind(sso, (<span class="keyword">struct</span> sockaddr*) &amp;sun, SUN_LEN(&amp;sun)))
00104             <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"setup: bind: vqsignup1d.sock: "</span>+strerror(errno));
00105     <span class="keywordflow">if</span>( chmod(sun.sun_path, 0600) )
00106             <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"setup: chmod: vasignup1d.sock: "</span>+strerror(errno));
00107     <span class="keywordflow">if</span>( !(pg = <span class="keyword">new</span> pqxx::Connection(ac_pgsql.<a class="code" href="classclnconf.html#clnconfa1">val_str</a>().c_str())) ) 
00108             <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"setup: no memory"</span>); 
00109     <span class="keywordflow">if</span>( listen(sso, 5) == -1 )
00110             <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"setup: listen: "</span>+strerror(errno));
00111 }
00112 
00116 <span class="keywordtype">void</span> send2strings( <span class="keyword">const</span> pqxx::Result::Tuple &amp; tup ) {
00117     <span class="keyword">const</span> <span class="keywordtype">char</span> *ptr;
00118     string::size_type ptrl;
00119     ptr = tup[0].c_str();
00120     <span class="keywordflow">if</span>(!ptr) ptr = <span class="stringliteral">""</span>;
00121     ptrl = strlen(ptr);
00122     <span class="keywordflow">if</span>( fdwrite(cso, &amp;ptrl, <span class="keyword">sizeof</span>(ptrl)) == -1
00123         || fdwrite(cso, ptr, ptrl) == -1 ) 
00124             <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00125                 
00126     ptr = tup[1].c_str();
00127     <span class="keywordflow">if</span>(!ptr) ptr = <span class="stringliteral">""</span>;
00128     ptrl = strlen(ptr);
00129     <span class="keywordflow">if</span>( fdwrite(cso, &amp;ptrl, <span class="keyword">sizeof</span>(ptrl)) == -1
00130         || fdwrite(cso, ptr, ptrl) == -1 ) 
00131             <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00132 }
00133 
00137 <span class="keywordtype">void</span> cmd_edu_ls() {
00138     <span class="keywordflow">if</span>( fdrdstr(cso, localeinfo) != -1 ) {
00139             pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00140                 <span class="stringliteral">"SELECT id,name FROM users_info_edu WHERE locale="</span>
00141                  +pqxx::Quote(localeinfo, <span class="keyword">false</span>)+<span class="stringliteral">" ORDER BY name"</span>));
00142 
00143             vector&lt;cdbdaemon::edu_info&gt;::size_type i, cnt = res.size();
00144             <span class="keywordflow">if</span>( cnt ) {
00145                     <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"F"</span>, 1) != 1 
00146                         || fdwrite(cso, &amp;cnt, <span class="keyword">sizeof</span>(cnt)) != <span class="keyword">sizeof</span>(cnt) )
00147                             <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00148         
00149                     <span class="keywordflow">for</span>( i=0; i &lt; cnt; ++i ) {
00150                             send2strings(res[i]);
00151                     }
00152                     <span class="keywordflow">return</span>;
00153             } <span class="keywordflow">else</span> {
00154                     <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"Z"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00155                     <span class="keywordflow">return</span>;
00156             }
00157  
00158             <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"E"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00159     } <span class="keywordflow">else</span> 
00160          <span class="keywordflow">throw</span> <a class="code" href="classrd__error.html">rd_error</a>();
00161 }
00162 
00166 <span class="keywordtype">void</span> cmd_work_ls() {
00167     <span class="keywordflow">if</span>( fdrdstr(cso, localeinfo) != -1 ) {
00168             pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00169                 <span class="stringliteral">"SELECT id,name FROM users_info_work WHERE locale="</span>
00170                 +pqxx::Quote(localeinfo, <span class="keyword">false</span>)+<span class="stringliteral">" ORDER BY name"</span>));
00171 
00172             vector&lt;cdbdaemon::edu_info&gt;::size_type i, cnt = res.size();
00173             <span class="keywordflow">if</span>( cnt ) {
00174                     <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"F"</span>, 1) != 1 
00175                         || fdwrite(cso, &amp;cnt, <span class="keyword">sizeof</span>(cnt)) != <span class="keyword">sizeof</span>(cnt) )
00176                             <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00177                     
00178                     <span class="keywordflow">for</span>( i=0; i &lt; cnt; ++i ) {
00179                             send2strings(res[i]);
00180                     }
00181                     <span class="keywordflow">return</span>;
00182             } <span class="keywordflow">else</span> {
00183                     <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"Z"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00184                     <span class="keywordflow">return</span>;
00185             }
00186  
00187             <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"E"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00188     } <span class="keywordflow">else</span> 
00189             <span class="keywordflow">throw</span> <a class="code" href="classrd__error.html">rd_error</a>();
00190 }
00191 
00195 <span class="keywordtype">void</span> cmd_int_ls() {
00196     <span class="keywordflow">if</span>( fdrdstr(cso, localeinfo) != -1 ) {
00197             pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00198                 <span class="stringliteral">"SELECT id,name FROM users_info_interests WHERE locale="</span>
00199                 +pqxx::Quote(localeinfo, <span class="keyword">false</span>)+<span class="stringliteral">" ORDER BY name"</span>));
00200 
00201             vector&lt;cdbdaemon::edu_info&gt;::size_type i, cnt = res.size();
00202             <span class="keywordflow">if</span>( cnt ) {
00203                     <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"F"</span>, 1) != 1 
00204                         || fdwrite(cso, &amp;cnt, <span class="keyword">sizeof</span>(cnt)) != <span class="keyword">sizeof</span>(cnt) )
00205                             <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00206 
00207                     <span class="keywordflow">for</span>( i=0; i &lt; cnt; ++i ) {
00208                             send2strings(res[i]);
00209                     }
00210                     <span class="keywordflow">return</span>;
00211             } <span class="keywordflow">else</span> {
00212                     <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"Z"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00213                     <span class="keywordflow">return</span>;
00214             }
00215  
00216             <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"E"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00217     } <span class="keywordflow">else</span> 
00218             <span class="keywordflow">throw</span> <a class="code" href="classrd__error.html">rd_error</a>();
00219 }
00220 
00224 <span class="keywordtype">void</span> cmd_area_ls() {
00225     <span class="keywordflow">if</span>( fdrdstr(cso, localeinfo) != -1 ) {
00226             pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00227                 <span class="stringliteral">"SELECT id,name FROM users_info_areas WHERE locale="</span>
00228                 +pqxx::Quote(localeinfo, <span class="keyword">false</span>)+<span class="stringliteral">" ORDER BY name"</span>) );
00229             
00230             vector&lt;cdbdaemon::edu_info&gt;::size_type i, cnt = res.size();
00231             <span class="keywordflow">if</span>( cnt ) {
00232                     <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"F"</span>, 1) != 1 
00233                         || fdwrite(cso, &amp;cnt, <span class="keyword">sizeof</span>(cnt)) != <span class="keyword">sizeof</span>(cnt) )
00234                             <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00235 
00236                     <span class="keywordflow">for</span>( i=0; i &lt; cnt; ++i ) {
00237                             send2strings(res[i]);
00238                     }
00239                     <span class="keywordflow">return</span>;
00240             } <span class="keywordflow">else</span> {
00241                     <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"Z"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00242                     <span class="keywordflow">return</span>;
00243             }
00244  
00245             <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"E"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00246     } <span class="keywordflow">else</span> 
00247             <span class="keywordflow">throw</span> <a class="code" href="classrd__error.html">rd_error</a>();
00248 }
00249 
00253 <span class="keywordtype">void</span> cmd_sex_ls() {
00254         <span class="keywordflow">if</span>( fdrdstr(cso, localeinfo) != -1 ) {
00255                 pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00256                     <span class="stringliteral">"SELECT id,name FROM users_info_sexes WHERE locale="</span>
00257                     +pqxx::Quote(localeinfo, <span class="keyword">false</span>)+<span class="stringliteral">" ORDER BY name"</span>) );
00258 
00259                 vector&lt;cdbdaemon::sex_info&gt;::size_type i, cnt = res.size();
00260                 
00261                 <span class="keywordflow">if</span>( cnt ) {
00262                         <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"F"</span>, 1) != 1 
00263                             || fdwrite(cso, &amp;cnt, <span class="keyword">sizeof</span>(cnt)) != <span class="keyword">sizeof</span>(cnt) )
00264                                 <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00265 
00266                         <span class="keywordflow">for</span>( i=0; i &lt; cnt; ++i ) {
00267                                 send2strings(res[i]);
00268                         }
00269                         <span class="keywordflow">return</span>;
00270                 } <span class="keywordflow">else</span> {
00271                         <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"Z"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00272                         <span class="keywordflow">return</span>;
00273                 }
00274                 
00275                 <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"E"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00276     } <span class="keywordflow">else</span> 
00277             <span class="keywordflow">throw</span> <a class="code" href="classrd__error.html">rd_error</a>();
00278 }
00279 
00283 <span class="keywordtype">void</span> cmd_dom_ls() {
00284     <span class="keywordflow">if</span>( fdrdstr(cso, localeinfo) != -1 ) {
00285             pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00286                 <span class="stringliteral">"SELECT id,name FROM domains ORDER BY name"</span>) );
00287             
00288             vector&lt;cdbdaemon::domain_info&gt;::size_type i, cnt = res.size();
00289             
00290             <span class="keywordflow">if</span>( cnt ) {
00291                     <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"F"</span>, 1) != 1 
00292                         || fdwrite(cso, &amp;cnt, <span class="keyword">sizeof</span>(cnt)) != <span class="keyword">sizeof</span>(cnt) )
00293                             <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00294 
00295                     <span class="keywordflow">for</span>( i=0; i &lt; cnt; ++i ) {
00296                             send2strings(res[i]);
00297                     }
00298                     <span class="keywordflow">return</span>;
00299             } <span class="keywordflow">else</span> {
00300                     <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"Z"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00301                     <span class="keywordflow">return</span>;
00302             }
00303  
00304            <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"E"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00305     } <span class="keywordflow">else</span> <span class="keywordflow">throw</span> <a class="code" href="classrd__error.html">rd_error</a>();
00306 }
00307 
00311 <span class="keywordtype">void</span> cmd_ui_rm() {
00312     <span class="keywordflow">if</span>( fdrdstr(cso, id) != -1 ) {
00313             pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00314                 <span class="stringliteral">"DELETE FROM users_info WHERE id="</span>
00315                 +pqxx::Quote(id, <span class="keyword">false</span>)) );
00316             
00317             <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"K"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00318     } <span class="keywordflow">else</span> <span class="keywordflow">throw</span> <a class="code" href="classrd__error.html">rd_error</a>();
00319 }
00320 
00324 <span class="keywordtype">void</span> cmd_dom_get() {
00325     <span class="keywordflow">if</span>( fdrdstr(cso, id) != -1 ) {
00326             pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00327                 <span class="stringliteral">"SELECT name FROM domains WHERE id="</span>
00328                 +pqxx::Quote(id, <span class="keyword">false</span>)+<span class="stringliteral">" LIMIT 1"</span>) );
00329             
00330             <span class="keywordflow">if</span>( ! res.size() ) {
00331                     <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"Z"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00332                     <span class="keywordflow">return</span>;
00333             }
00334             
00335             <span class="keyword">const</span> <span class="keywordtype">char</span> *did = res[0][0].c_str();
00336             <span class="keywordflow">if</span>(!did) did = <span class="stringliteral">""</span>;
00337             <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"F"</span>, 1) != 1 
00338                 || fdwrstr(cso, did) == -1 ) 
00339                     <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00340             <span class="keywordflow">return</span>;
00341      } <span class="keywordflow">else</span> <span class="keywordflow">throw</span> <a class="code" href="classrd__error.html">rd_error</a>();
00342 }
00343 
00347 <span class="keywordtype">void</span> cmd_dom_get_by_name() {
00348     <span class="keywordflow">if</span>( fdrdstr(cso, id) != -1 ) {
00349             pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00350                 <span class="stringliteral">"SELECT id FROM domains WHERE name="</span>
00351                 +pqxx::Quote(id, <span class="keyword">false</span>)+<span class="stringliteral">" LIMIT 1"</span>) );
00352 
00353             <span class="keywordflow">if</span>( ! res.size() ) {
00354                     <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"Z"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00355                     <span class="keywordflow">return</span>;
00356             }
00357             
00358             <span class="keyword">const</span> <span class="keywordtype">char</span> *did = res[0][0].c_str();
00359             <span class="keywordflow">if</span>(!did) did = <span class="stringliteral">""</span>;
00360             <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"F"</span>, 1) != 1
00361                 || fdwrstr(cso, did) == -1 )
00362                     <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00363             <span class="keywordflow">return</span>;
00364     } <span class="keywordflow">else</span> <span class="keywordflow">throw</span> <a class="code" href="classrd__error.html">rd_error</a>();
00365 }
00366 
00370 <span class="keywordtype">void</span> cmd_ui_add() {
00371     <span class="keywordflow">if</span>( fdrdstr(cso, localeinfo) != -1 
00372         &amp;&amp; fdrdstr(cso, login) != -1
00373         &amp;&amp; fdrdstr(cso, dom_id) != -1
00374         &amp;&amp; fdrdstr(cso, country) != -1
00375         &amp;&amp; fdrdstr(cso, city) != -1
00376         &amp;&amp; fdrdstr(cso, birthday) != -1
00377         &amp;&amp; fdrdstr(cso, area_id) != -1
00378         &amp;&amp; fdrdstr(cso, work_id) != -1
00379         &amp;&amp; fdrdstr(cso, edu_id) != -1
00380         &amp;&amp; fdrdstr(cso, sex_id) != -1
00381         &amp;&amp; fdrdstr(cso, re_que) != -1 
00382         &amp;&amp; fdrdstr(cso, re_ans) != -1 
00383         &amp;&amp; fdread(cso, &amp;ints_cnt, <span class="keyword">sizeof</span>(ints_cnt)) == <span class="keyword">sizeof</span>(ints_cnt) ) {
00384             ints.clear();
00385             <span class="keywordflow">if</span>( ints_cnt -- ) {
00386                     string inter;
00387                     <span class="keywordflow">do</span> {
00388                             <span class="keywordflow">if</span>( fdrdstr(cso, inter) == -1 ) <span class="keywordflow">throw</span> <a class="code" href="classrd__error.html">rd_error</a>();
00389                             ints.push_back(inter);
00390                     } <span class="keywordflow">while</span>( ints_cnt -- );
00391             }
00392 
00393             pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00394                 <span class="stringliteral">"SELECT NEXTVAL('users_info_id_seq')"</span>) );
00395             
00396             <span class="keywordflow">if</span>( res.size() == 1 &amp;&amp; ! res[0][0].is_null() ) {
00397                     pqxx::Transaction tran(*pg);
00398                     string uid(res[0][0].c_str());
00399                     
00400                     <span class="comment">// first query call some procedure returning data, that's why we compare it to PGRES_TUPLES_OK</span>
00401                     <span class="keywordflow">if</span>( tran.Exec(<span class="stringliteral">"INSERT INTO users_info "</span>
00402                         <span class="stringliteral">"(id,login,domain_id,country,city,"</span>
00403                         <span class="stringliteral">"birthday,re_question,re_answer,locale) VALUES("</span>
00404                             +pqxx::Quote(uid, <span class="keyword">false</span>)+<span class="stringliteral">","</span>
00405                             +pqxx::Quote(login, <span class="keyword">false</span>)+<span class="stringliteral">","</span>
00406                             +pqxx::Quote(dom_id, <span class="keyword">false</span>)+<span class="stringliteral">","</span>
00407                             +pqxx::Quote(country, <span class="keyword">false</span>)+<span class="stringliteral">","</span>
00408                             +pqxx::Quote(city, <span class="keyword">false</span>)+<span class="stringliteral">","</span>
00409                             +pqxx::Quote(birthday, <span class="keyword">false</span>)+<span class="stringliteral">","</span>
00410                             +pqxx::Quote(re_que, <span class="keyword">false</span>)+<span class="stringliteral">","</span>
00411                             +pqxx::Quote(re_ans, <span class="keyword">false</span>)+<span class="stringliteral">","</span>
00412                             +pqxx::Quote(localeinfo, <span class="keyword">false</span>)+<span class="stringliteral">")"</span>).AffectedRows() != 1
00413                         || tran.Exec(<span class="stringliteral">"INSERT INTO users_info_map_area "</span>
00414                             <span class="stringliteral">"(user_id,val_id) VALUES("</span>
00415                             +pqxx::Quote(uid, <span class="keyword">false</span>)+<span class="stringliteral">","</span>
00416                             +pqxx::Quote(area_id, <span class="keyword">false</span>)+<span class="stringliteral">")"</span>).AffectedRows() != 1
00417                         || tran.Exec(<span class="stringliteral">"INSERT INTO users_info_map_work "</span>
00418                             <span class="stringliteral">"(user_id,val_id) VALUES("</span>
00419                             +pqxx::Quote(uid, <span class="keyword">false</span>)+<span class="stringliteral">","</span>
00420                             +pqxx::Quote(work_id, <span class="keyword">false</span>)+<span class="stringliteral">")"</span>).AffectedRows() != 1
00421                         || tran.Exec(<span class="stringliteral">"INSERT INTO users_info_map_edu "</span>
00422                             <span class="stringliteral">"(user_id,val_id) VALUES("</span>
00423                             +pqxx::Quote(uid, <span class="keyword">false</span>)+<span class="stringliteral">","</span>
00424                             +pqxx::Quote(edu_id, <span class="keyword">false</span>)+<span class="stringliteral">")"</span>).AffectedRows() != 1
00425                         || tran.Exec(<span class="stringliteral">"INSERT INTO users_info_map_sex "</span>
00426                             <span class="stringliteral">"(user_id,val_id) VALUES("</span>
00427                             +pqxx::Quote(uid, <span class="keyword">false</span>)+<span class="stringliteral">","</span>
00428                             +pqxx::Quote(sex_id, <span class="keyword">false</span>)+<span class="stringliteral">")"</span>).AffectedRows() != 1 ) {
00429 
00430                             <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"E"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00431                             <span class="keywordflow">return</span>;
00432                     }
00433 
00434                     ints_cnt = ints.size();
00435                     
00436                     <span class="keywordflow">if</span>( ints_cnt-- ) {
00437                             <span class="keywordflow">do</span> {
00438                                     <span class="keywordflow">if</span>( tran.Exec(<span class="stringliteral">"INSERT INTO users_info_map_ints "</span>
00439                                         <span class="stringliteral">"(user_id,val_id) VALUES("</span>
00440                                         +pqxx::Quote(uid, <span class="keyword">false</span>)+<span class="stringliteral">","</span>
00441                                         +pqxx::Quote(ints[ints_cnt], <span class="keyword">false</span>)
00442                                         +<span class="stringliteral">")"</span>).AffectedRows() != 1 ) {
00443                                             <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"E"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00444                                             <span class="keywordflow">return</span>;
00445                                     }
00446                             } <span class="keywordflow">while</span>( ints_cnt -- );
00447                     }
00448 
00449                     tran.Commit();
00450                     
00451                     <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"F"</span>, 1) != 1
00452                         || fdwrstr(cso, uid) == -1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00453                     <span class="keywordflow">return</span>;
00454             }
00455 
00456             <span class="keywordflow">if</span>( fdwrite( cso, &amp;<span class="stringliteral">"E"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00457     } <span class="keywordflow">else</span> <span class="keywordflow">throw</span> <a class="code" href="classrd__error.html">rd_error</a>();
00458 }
00459 
00463 <span class="keywordtype">void</span> cmd_ui_chg() {
00464     <span class="keywordflow">if</span>( fdrdstr(cso, localeinfo) != -1 
00465         &amp;&amp; fdrdstr(cso, id) != -1
00466         &amp;&amp; fdrdstr(cso, country) != -1
00467         &amp;&amp; fdrdstr(cso, city) != -1
00468         &amp;&amp; fdrdstr(cso, birthday) != -1
00469         &amp;&amp; fdrdstr(cso, area_id) != -1
00470         &amp;&amp; fdrdstr(cso, work_id) != -1
00471         &amp;&amp; fdrdstr(cso, edu_id) != -1
00472         &amp;&amp; fdrdstr(cso, sex_id) != -1
00473         &amp;&amp; fdrdstr(cso, re_que) != -1 
00474         &amp;&amp; fdrdstr(cso, re_ans) != -1 
00475         &amp;&amp; fdread(cso, &amp;ints_cnt, <span class="keyword">sizeof</span>(ints_cnt)) == <span class="keyword">sizeof</span>(ints_cnt) ) {
00476             ints.clear();
00477 
00478             <span class="keywordflow">if</span>( ints_cnt -- ) {
00479                     string inter;
00480                     <span class="keywordflow">do</span> {
00481                             <span class="keywordflow">if</span>( fdrdstr(cso, inter) == -1 ) <span class="keywordflow">throw</span> <a class="code" href="classrd__error.html">rd_error</a>();
00482                             ints.push_back(inter);
00483                     } <span class="keywordflow">while</span>( ints_cnt -- );
00484             }
00485 
00486             pqxx::Transaction tran(*pg);
00487 
00488             <span class="keywordflow">if</span>( tran.Exec(<span class="stringliteral">"UPDATE users_info SET country="</span>
00489                     +pqxx::Quote(country, <span class="keyword">false</span>)
00490                     +<span class="stringliteral">",city="</span>+pqxx::Quote(city, <span class="keyword">false</span>)
00491                     +<span class="stringliteral">",birthday="</span>+pqxx::Quote(birthday, <span class="keyword">false</span>)
00492                     +<span class="stringliteral">",re_question="</span>+pqxx::Quote(re_que, <span class="keyword">false</span>)
00493                     +<span class="stringliteral">",re_answer="</span>+pqxx::Quote(re_ans, <span class="keyword">false</span>)
00494                     +<span class="stringliteral">",locale="</span>+pqxx::Quote(localeinfo, <span class="keyword">false</span>)
00495                     +<span class="stringliteral">" WHERE id="</span>+pqxx::Quote(id, <span class="keyword">false</span>)).AffectedRows() != 1
00496                 || tran.Exec(<span class="stringliteral">"UPDATE users_info_map_area SET val_id="</span>
00497                     +pqxx::Quote(area_id, <span class="keyword">false</span>)
00498                     +<span class="stringliteral">" WHERE user_id="</span>+pqxx::Quote(id, <span class="keyword">false</span>)).AffectedRows() != 1
00499                 || tran.Exec(<span class="stringliteral">"UPDATE users_info_map_work SET val_id="</span>
00500                     +pqxx::Quote(work_id, <span class="keyword">false</span>)
00501                     +<span class="stringliteral">" WHERE user_id="</span>+pqxx::Quote(id, <span class="keyword">false</span>)).AffectedRows() != 1
00502                 || tran.Exec(<span class="stringliteral">"UPDATE users_info_map_edu SET val_id="</span>
00503                     +pqxx::Quote(edu_id, <span class="keyword">false</span>)
00504                     +<span class="stringliteral">" WHERE user_id="</span>+pqxx::Quote(id, <span class="keyword">false</span>)).AffectedRows() != 1
00505                 || tran.Exec(<span class="stringliteral">"UPDATE users_info_map_sex SET val_id="</span>
00506                     +pqxx::Quote(sex_id, <span class="keyword">false</span>)
00507                     +<span class="stringliteral">" WHERE user_id="</span>+pqxx::Quote(id, <span class="keyword">false</span>)).AffectedRows() != 1 ) {
00508                     <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"E"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00509                     <span class="keywordflow">return</span>;
00510             }
00511 
00512             tran.Exec(<span class="stringliteral">"DELETE FROM users_info_map_ints WHERE user_id="</span>
00513                 +pqxx::Quote(id, <span class="keyword">false</span>));
00514             
00515             ints_cnt = ints.size();
00516             <span class="keywordflow">if</span>( ints_cnt-- ) {
00517                     <span class="keywordflow">do</span> {
00518                             <span class="keywordflow">if</span>( tran.Exec(<span class="stringliteral">"INSERT INTO users_info_map_ints"</span>
00519                                 <span class="stringliteral">" (user_id,val_id) VALUES("</span>
00520                                 +pqxx::Quote(id, <span class="keyword">false</span>)+<span class="stringliteral">","</span>
00521                                 +pqxx::Quote(ints[ints_cnt], <span class="keyword">false</span>)
00522                                 +<span class="stringliteral">")"</span>).AffectedRows() != 1 ) {
00523                                     <span class="keywordflow">if</span>(fdwrite(cso, &amp;<span class="stringliteral">"E"</span>, 1) != 1) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00524                                     <span class="keywordflow">return</span>;
00525                             }
00526                     } <span class="keywordflow">while</span>( ints_cnt -- );
00527             }
00528 
00529             tran.Commit();
00530 
00531             <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"K"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00532     } <span class="keywordflow">else</span> <span class="keywordflow">throw</span> <a class="code" href="classrd__error.html">rd_error</a>();
00533 }
00534 
00538 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt;
00539     uint8_t ui_elem_get( <span class="keyword">const</span> pqxx::Result &amp; res, <span class="keyword">const</span> string &amp; loc,
00540         T &amp; info ) {
00541 
00542     <span class="keywordtype">int</span> tups;
00543     <span class="keywordflow">if</span>( ! (tups=res.size()) ) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a1cdbdaemonw22">cdbdaemon::err_empty</a>;
00544     <span class="keywordflow">if</span>( tups &gt; 2 ) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a1cdbdaemonw24">cdbdaemon::err_read</a>;
00545 
00546     <span class="keywordtype">int</span> fidx = 0;
00547     string locale;
00548     <span class="keyword">const</span> <span class="keywordtype">char</span> *tmp;
00549 
00550     tmp = res[0][fidx++].c_str();
00551     <span class="keywordflow">if</span>(!tmp) tmp = <span class="stringliteral">""</span>;
00552     info.id = tmp;
00553         
00554     tmp = res[0][fidx++].c_str();
00555     <span class="keywordflow">if</span>(!tmp) tmp = <span class="stringliteral">""</span>;
00556     info.name = tmp;
00557 
00558     tmp = res[0][fidx++].c_str();
00559     <span class="keywordflow">if</span>(!tmp) tmp = <span class="stringliteral">""</span>;
00560     locale = tmp;
00561         
00562     <span class="keywordflow">if</span>( tups == 1 || loc == locale ) {
00563             <span class="keywordflow">return</span> <a class="code" href="group__err.html#a1cdbdaemonw21">cdbdaemon::err_no</a>;
00564     }
00565         
00566     fidx = 0;
00567     tmp = res[1][fidx++].c_str();
00568     <span class="keywordflow">if</span>(!tmp) tmp = <span class="stringliteral">""</span>;
00569     info.id = tmp;
00570 
00571     tmp = res[1][fidx++].c_str();
00572     <span class="keywordflow">if</span>(!tmp) tmp = <span class="stringliteral">""</span>;
00573     info.name = tmp;
00574 
00575     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a1cdbdaemonw21">cdbdaemon::err_no</a>;
00576 }
00577 
00581 uint8_t ui_work_get(<span class="keyword">const</span> string &amp;uid, <span class="keyword">const</span> string &amp;loc, <a class="code" href="structcdbdaemon_1_1work__info.html">cdbdaemon::work_info</a> &amp; info ) {
00582     pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00583         <span class="stringliteral">"SELECT id,name,locale FROM users_info_work"</span>
00584         <span class="stringliteral">" WHERE (code=(SELECT code FROM users_info_work WHERE id="</span>
00585         <span class="stringliteral">"(SELECT val_id FROM users_info_map_work WHERE user_id="</span>
00586         +pqxx::Quote(uid, <span class="keyword">false</span>)+<span class="stringliteral">")) AND locale="</span>+pqxx::Quote(loc, <span class="keyword">false</span>)
00587         +<span class="stringliteral">") OR code=(SELECT code FROM users_info_map_work WHERE id="</span>
00588         <span class="stringliteral">"(SELECT val_id FROM users_info_map_work WHERE user_id="</span>
00589         +pqxx::Quote(uid, <span class="keyword">false</span>)+<span class="stringliteral">"))"</span>) );
00590 
00591     <span class="keywordflow">return</span> ui_elem_get&lt;cdbdaemon::work_info&gt;(res, loc, info);
00592 }
00593 
00597 uint8_t ui_area_get(<span class="keyword">const</span> string &amp;uid, <span class="keyword">const</span> string &amp;loc, <a class="code" href="structcdbdaemon_1_1area__info.html">cdbdaemon::area_info</a> &amp; info ) {
00598     pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00599         <span class="stringliteral">"SELECT id,name,locale FROM users_info_areas "</span>
00600         <span class="stringliteral">"WHERE (code=(SELECT code FROM users_info_areas WHERE id="</span>
00601         <span class="stringliteral">"(SELECT val_id FROM users_info_map_area WHERE user_id="</span>
00602         +pqxx::Quote(uid, <span class="keyword">false</span>)+<span class="stringliteral">")) AND locale="</span>+pqxx::Quote(loc, <span class="keyword">false</span>)+<span class="stringliteral">") "</span>
00603         <span class="stringliteral">"OR code=(SELECT code FROM users_info_map_area WHERE id="</span>
00604         <span class="stringliteral">"(SELECT val_id FROM users_info_map_area WHERE user_id="</span>
00605         +pqxx::Quote(uid, <span class="keyword">false</span>)+<span class="stringliteral">"))"</span>));
00606     
00607     <span class="keywordflow">return</span> ui_elem_get&lt;cdbdaemon::area_info&gt;(res, loc, info);
00608 }
00609 
00613 uint8_t ui_sex_get(<span class="keyword">const</span> string &amp;uid, <span class="keyword">const</span> string &amp;loc, <a class="code" href="structcdbdaemon_1_1sex__info.html">cdbdaemon::sex_info</a> &amp; info ) {
00614     pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00615         <span class="stringliteral">"SELECT id,name,locale FROM users_info_sexes "</span>
00616         <span class="stringliteral">"WHERE (code=(SELECT code FROM users_info_sexes WHERE id="</span>
00617         <span class="stringliteral">"(SELECT val_id FROM users_info_map_sex WHERE user_id="</span>
00618         +pqxx::Quote(uid, <span class="keyword">false</span>)+<span class="stringliteral">")) AND locale="</span>+pqxx::Quote(loc, <span class="keyword">false</span>)+<span class="stringliteral">") "</span>
00619         <span class="stringliteral">"OR code=(SELECT code FROM users_info_map_sex WHERE id="</span>
00620         <span class="stringliteral">"(SELECT val_id FROM users_info_map_sex WHERE user_id="</span>
00621         +pqxx::Quote(uid, <span class="keyword">false</span>)+<span class="stringliteral">"))"</span>) );
00622     
00623     <span class="keywordflow">return</span> ui_elem_get&lt;cdbdaemon::sex_info&gt;(res, loc, info);
00624 }
00625 
00629 uint8_t ui_edu_get(<span class="keyword">const</span> string &amp;uid, <span class="keyword">const</span> string &amp;loc, <a class="code" href="structcdbdaemon_1_1edu__info.html">cdbdaemon::edu_info</a> &amp; info ) {
00630     pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00631         <span class="stringliteral">"SELECT id,name,locale FROM users_info_edu "</span>
00632         <span class="stringliteral">"WHERE (code=(SELECT code FROM users_info_edu WHERE id="</span>
00633         <span class="stringliteral">"(SELECT val_id FROM users_info_map_edu WHERE user_id="</span>
00634         +pqxx::Quote(uid, <span class="keyword">false</span>)+<span class="stringliteral">")) AND locale="</span>+pqxx::Quote(loc, <span class="keyword">false</span>)+<span class="stringliteral">") "</span>
00635         <span class="stringliteral">"OR code=(SELECT code FROM users_info_map_edu WHERE id="</span>
00636         <span class="stringliteral">"(SELECT val_id FROM users_info_map_edu WHERE user_id="</span>
00637         +pqxx::Quote(uid, <span class="keyword">false</span>)+<span class="stringliteral">"))"</span>) );
00638 
00639    <span class="keywordflow">return</span> ui_elem_get&lt;cdbdaemon::edu_info&gt;(res, loc, info);
00640 }
00641 
00645 uint8_t ui_ints_get(<span class="keyword">const</span> string &amp;uid, vector&lt;cdbdaemon::int_info&gt; &amp; infos ) {
00646     infos.clear();
00647 
00648     pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00649         <span class="stringliteral">"SELECT ui.id,ui.name FROM users_info_map_ints AS umi,"</span>
00650         <span class="stringliteral">"users_info_interests AS ui WHERE umi.user_id="</span>+pqxx::Quote(uid, <span class="keyword">false</span>)+
00651         <span class="stringliteral">" AND umi.val_id=ui.id"</span>) );
00652 
00653     <span class="keyword">const</span> <span class="keywordtype">char</span> *tmp;
00654     <span class="keywordtype">int</span> tups;
00655     <a class="code" href="structcdbdaemon_1_1int__info.html">cdbdaemon::int_info</a> inter;
00656 
00657     <span class="keywordflow">if</span>( (tups=res.size()) == 0 ) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a1cdbdaemonw22">cdbdaemon::err_empty</a>;
00658     tups--;
00659     <span class="keywordflow">do</span> {
00660             tmp = res[tups][0].c_str();
00661             <span class="keywordflow">if</span>(!tmp) tmp = <span class="stringliteral">""</span>;
00662             inter.<a class="code" href="structcdbdaemon_1_1int__info.html#cdbdaemon_1_1int__infoo0">id</a> = tmp;
00663 
00664             tmp = res[tups][1].c_str();
00665             <span class="keywordflow">if</span>(!tmp) tmp = <span class="stringliteral">""</span>;
00666             inter.<a class="code" href="structcdbdaemon_1_1int__info.html#cdbdaemon_1_1int__infoo1">name</a> = tmp;
00667 
00668             infos.push_back(inter);
00669     } <span class="keywordflow">while</span>( tups -- );
00670     
00671     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a1cdbdaemonw21">cdbdaemon::err_no</a>;
00672 }
00673 
00677 <span class="keywordtype">void</span> cmd_ui_get_by_name() {
00678     <span class="keywordflow">if</span>( fdrdstr(cso, localeinfo) == -1 
00679         || fdrdstr(cso, login) == -1
00680         || fdrdstr(cso, dom_id) == -1 )
00681             <span class="keywordflow">throw</span> <a class="code" href="classrd__error.html">rd_error</a>();
00682     
00683     pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00684         <span class="stringliteral">"SELECT ui.id,ui.country,ui.city,ui.birthday,"</span>
00685         <span class="stringliteral">"ui.re_question,ui.re_answer,ui.locale,uw.id,uw.name,us.id,us.name,"</span>
00686         <span class="stringliteral">"ue.id,ue.name,ua.id,ua.name"</span>
00687         <span class="stringliteral">" FROM users_info as ui,users_info_work as uw,users_info_edu as ue,"</span>
00688         <span class="stringliteral">"users_info_areas as ua,users_info_sexes as us,"</span>
00689         <span class="stringliteral">"users_info_map_edu as ume,users_info_map_work as umw,"</span>
00690         <span class="stringliteral">"users_info_map_area as uma,users_info_map_sex as ums where"</span>
00691         <span class="stringliteral">" ui.login="</span>+pqxx::Quote(login, <span class="keyword">false</span>)+<span class="stringliteral">" and ui.domain_id="</span>
00692         +pqxx::Quote(dom_id, <span class="keyword">false</span>)+<span class="stringliteral">" AND ui.id=umw.user_id and umw.val_id=uw.id and "</span>
00693         <span class="stringliteral">"ui.id=ume.user_id and ume.val_id=ue.id and ui.id=ums.user_id"</span>
00694         <span class="stringliteral">" and ums.val_id=us.id and ui.id=uma.user_id and uma.val_id=ua.id"</span>) );
00695 
00696     <span class="keywordflow">if</span>( res.size() != 1 ) {
00697             <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"Z"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00698             <span class="keywordflow">return</span>;
00699     }
00700             
00701     <span class="keyword">const</span> <span class="keywordtype">char</span> *tmp;
00702     <span class="keywordtype">int</span> fidx = 0;
00703     <a class="code" href="structcdbdaemon_1_1ui__full.html">cdbdaemon::ui_full</a> ui;
00704     vector&lt;cdbdaemon::int_info&gt;::size_type icnt;
00705 
00706     tmp = res[0][fidx++].c_str();
00707     <span class="keywordflow">if</span>(!tmp) tmp = <span class="stringliteral">""</span>;
00708     ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo0">id</a> = tmp;
00709 
00710     tmp = res[0][fidx++].c_str(); 
00711     <span class="keywordflow">if</span>(!tmp) tmp = <span class="stringliteral">""</span>;
00712     ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo3">country</a> = tmp;
00713 
00714     tmp = res[0][fidx++].c_str(); 
00715     <span class="keywordflow">if</span>(!tmp) tmp = <span class="stringliteral">""</span>;
00716     ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo4">city</a> = tmp;
00717             
00718     tmp = res[0][fidx++].c_str(); 
00719     <span class="keywordflow">if</span>(!tmp) tmp = <span class="stringliteral">""</span>;
00720     ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo5">birthday</a> = tmp;
00721 
00722     tmp = res[0][fidx++].c_str(); 
00723     <span class="keywordflow">if</span>(!tmp) tmp = <span class="stringliteral">""</span>;
00724     ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo12">re_que</a> = tmp;
00725 
00726     tmp = res[0][fidx++].c_str(); 
00727     <span class="keywordflow">if</span>(!tmp) tmp = <span class="stringliteral">""</span>;
00728     ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo13">re_ans</a> = tmp;
00729 
00730     tmp = res[0][fidx++].c_str(); 
00731     <span class="keywordflow">if</span>(!tmp) tmp = <span class="stringliteral">""</span>;
00732     ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo10">locale</a> = tmp;
00733 
00734     tmp = res[0][fidx++].c_str(); 
00735     <span class="keywordflow">if</span>(!tmp) tmp = <span class="stringliteral">""</span>;
00736     ui.work.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo0">id</a> = tmp;
00737 
00738     tmp = res[0][fidx++].c_str(); 
00739     <span class="keywordflow">if</span>(!tmp) tmp = <span class="stringliteral">""</span>;
00740     ui.work.name = tmp;
00741 
00742     tmp = res[0][fidx++].c_str(); 
00743     <span class="keywordflow">if</span>(!tmp) tmp = <span class="stringliteral">""</span>;
00744     ui.sex.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo0">id</a> = tmp;
00745 
00746     tmp = res[0][fidx++].c_str(); 
00747     <span class="keywordflow">if</span>(!tmp) tmp = <span class="stringliteral">""</span>;
00748     ui.sex.name = tmp;
00749 
00750     tmp = res[0][fidx++].c_str(); 
00751     <span class="keywordflow">if</span>(!tmp) tmp = <span class="stringliteral">""</span>;
00752     ui.edu.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo0">id</a> = tmp;
00753 
00754     tmp = res[0][fidx++].c_str(); 
00755     <span class="keywordflow">if</span>(!tmp) tmp = <span class="stringliteral">""</span>;
00756     ui.edu.name = tmp;
00757 
00758     tmp = res[0][fidx++].c_str(); 
00759     <span class="keywordflow">if</span>(!tmp) tmp = <span class="stringliteral">""</span>;
00760     ui.area.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo0">id</a> = tmp;
00761 
00762     tmp = res[0][fidx++].c_str(); 
00763     <span class="keywordflow">if</span>(!tmp) tmp = <span class="stringliteral">""</span>;
00764     ui.area.name = tmp;
00765 
00766     <span class="keywordflow">switch</span>( ui_ints_get(ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo0">id</a>, ui.ints) ) {
00767     <span class="keywordflow">case</span> <a class="code" href="group__err.html#a1cdbdaemonw21">cdbdaemon::err_no</a>:
00768     <span class="keywordflow">case</span> <a class="code" href="group__err.html#a1cdbdaemonw22">cdbdaemon::err_empty</a>:
00769             <span class="keywordflow">break</span>;
00770     <span class="keywordflow">default</span>:
00771             <span class="keywordflow">if</span>( fdwrite( cso, &amp;<span class="stringliteral">"E"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00772             <span class="keywordflow">return</span>;
00773     }
00774 
00775     icnt = ui.ints.size();
00776 
00777     <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"F"</span>, 1) != 1
00778         || fdwrstr(cso, ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo0">id</a>) == -1 
00779         || fdwrstr(cso, ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo3">country</a>) == -1 
00780         || fdwrstr(cso, ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo4">city</a>) == -1
00781         || fdwrstr(cso, ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo5">birthday</a>) == -1 
00782         || fdwrstr(cso, ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo12">re_que</a>) == -1 
00783         || fdwrstr(cso, ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo13">re_ans</a>) == -1
00784         || fdwrstr(cso, ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo10">locale</a>) == -1
00785         || fdwrstr(cso, ui.area.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo0">id</a>) == -1
00786         || fdwrstr(cso, ui.area.name) == -1
00787         || fdwrstr(cso, ui.work.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo0">id</a>) == -1
00788         || fdwrstr(cso, ui.work.name) == -1
00789         || fdwrstr(cso, ui.edu.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo0">id</a>) == -1
00790         || fdwrstr(cso, ui.edu.name) == -1
00791         || fdwrstr(cso, ui.sex.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo0">id</a>) == -1
00792         || fdwrstr(cso, ui.sex.name) == -1
00793         || fdwrite(cso, &amp; icnt, <span class="keyword">sizeof</span>(icnt)) != <span class="keyword">sizeof</span>(icnt) )
00794             <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00795             
00796     <span class="keywordflow">if</span>( icnt -- ) {
00797             <span class="keywordflow">do</span> {
00798                     <span class="keywordflow">if</span>( fdwrstr(cso, ui.ints[icnt].<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo0">id</a>) == -1 
00799                         || fdwrstr(cso, ui.ints[icnt].name) == -1 )
00800                                 <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00801             } <span class="keywordflow">while</span>( icnt-- );
00802     }
00803 }
00804 
00808 uint8_t ui_ints_ids_get(<span class="keyword">const</span> string &amp;uid, vector&lt;string&gt; &amp; infos ) {
00809     infos.clear();
00810 
00811     pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00812         <span class="stringliteral">"SELECT umi.val_id FROM users_info_map_ints AS umi WHERE umi.user_id="</span>
00813         +pqxx::Quote(uid, <span class="keyword">false</span>)) );
00814     
00815     <span class="keyword">const</span> <span class="keywordtype">char</span> *tmp;
00816     <span class="keywordtype">int</span> tups;
00817     string inter;
00818     
00819     <span class="keywordflow">if</span>( (tups=res.size()) == 0 ) <span class="keywordflow">return</span> <a class="code" href="group__err.html#a1cdbdaemonw22">cdbdaemon::err_empty</a>;
00820     tups--;
00821     
00822     <span class="keywordflow">do</span> {
00823             tmp = res[tups][0].c_str();
00824             <span class="keywordflow">if</span>(!tmp) tmp = <span class="stringliteral">""</span>;
00825             inter = tmp;
00826             infos.push_back(inter);
00827     } <span class="keywordflow">while</span>( tups -- );
00828     <span class="keywordflow">return</span> <a class="code" href="group__err.html#a1cdbdaemonw21">cdbdaemon::err_no</a>;
00829 }
00830 
00834 <span class="keywordtype">void</span> cmd_ui_get_by_name1() {
00835     <span class="keywordflow">if</span>( fdrdstr(cso, localeinfo) == -1 
00836         || fdrdstr(cso, login) == -1
00837         || fdrdstr(cso, dom_id) == -1 )
00838             <span class="keywordflow">throw</span> <a class="code" href="classrd__error.html">rd_error</a>();
00839     
00840     pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00841         <span class="stringliteral">"SELECT ui.id,ui.country,ui.city,ui.birthday,"</span>
00842         <span class="stringliteral">"ui.re_question,ui.re_answer,ui.locale,umw.val_id,ums.val_id,"</span>
00843         <span class="stringliteral">"ume.val_id,uma.val_id FROM users_info as ui,"</span>
00844         <span class="stringliteral">"users_info_map_edu as ume,users_info_map_work as umw,"</span>
00845         <span class="stringliteral">"users_info_map_area as uma,users_info_map_sex as ums where"</span>
00846         <span class="stringliteral">" ui.login="</span>+pqxx::Quote(login, <span class="keyword">false</span>)+<span class="stringliteral">" AND ui.domain_id="</span>
00847         +pqxx::Quote(dom_id, <span class="keyword">false</span>)+<span class="stringliteral">" AND ui.id=umw.user_id AND "</span>
00848         <span class="stringliteral">"ui.id=ume.user_id and ui.id=ums.user_id"</span>
00849         <span class="stringliteral">" and ui.id=uma.user_id"</span>) );
00850     
00851     <span class="keywordflow">if</span>( res.size() != 1 ) {
00852             <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"Z"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00853             <span class="keywordflow">return</span>;
00854     }
00855      
00856     <span class="keyword">const</span> <span class="keywordtype">char</span> *tmp;
00857     <span class="keywordtype">int</span> fidx = 0;
00858     <a class="code" href="structcdbdaemon_1_1user__info.html">cdbdaemon::user_info</a> ui;
00859     vector&lt;cdbdaemon::int_info&gt;::size_type icnt;
00860 
00861     tmp = res[0][fidx++].c_str(); 
00862     <span class="keywordflow">if</span>(!tmp) tmp = <span class="stringliteral">""</span>;
00863     ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo0">id</a> = tmp;
00864     
00865     tmp = res[0][fidx++].c_str(); 
00866     <span class="keywordflow">if</span>(!tmp) tmp = <span class="stringliteral">""</span>;
00867     ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo3">country</a> = tmp;
00868     
00869     tmp = res[0][fidx++].c_str(); 
00870     <span class="keywordflow">if</span>(!tmp) tmp = <span class="stringliteral">""</span>;
00871     ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo4">city</a> = tmp;
00872     
00873     tmp = res[0][fidx++].c_str(); 
00874     <span class="keywordflow">if</span>(!tmp) tmp = <span class="stringliteral">""</span>;
00875     ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo5">birthday</a> = tmp;
00876     
00877     tmp = res[0][fidx++].c_str(); 
00878     <span class="keywordflow">if</span>(!tmp) tmp = <span class="stringliteral">""</span>;
00879     ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo12">re_que</a> = tmp;
00880     
00881     tmp = res[0][fidx++].c_str(); 
00882     <span class="keywordflow">if</span>(!tmp) tmp = <span class="stringliteral">""</span>;
00883     ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo13">re_ans</a> = tmp;
00884 
00885     tmp = res[0][fidx++].c_str(); 
00886     <span class="keywordflow">if</span>(!tmp) tmp = <span class="stringliteral">""</span>;
00887     ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo10">locale</a> = tmp;
00888 
00889     tmp = res[0][fidx++].c_str(); 
00890     <span class="keywordflow">if</span>(!tmp) tmp = <span class="stringliteral">""</span>;
00891     ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo7">work_id</a> = tmp;
00892 
00893     tmp = res[0][fidx++].c_str(); 
00894     <span class="keywordflow">if</span>(!tmp) tmp = <span class="stringliteral">""</span>;
00895     ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo9">sex_id</a> = tmp;
00896 
00897     tmp = res[0][fidx++].c_str(); 
00898     <span class="keywordflow">if</span>(!tmp) tmp = <span class="stringliteral">""</span>;
00899     ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo8">edu_id</a> = tmp;
00900 
00901     tmp = res[0][fidx++].c_str(); 
00902     <span class="keywordflow">if</span>(!tmp) tmp = <span class="stringliteral">""</span>;
00903     ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo6">area_id</a> = tmp;
00904 
00905     <span class="keywordflow">switch</span>( ui_ints_ids_get(ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo0">id</a>, ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo11">ints_id</a>) ) {
00906     <span class="keywordflow">case</span> <a class="code" href="group__err.html#a1cdbdaemonw21">cdbdaemon::err_no</a>:
00907     <span class="keywordflow">case</span> <a class="code" href="group__err.html#a1cdbdaemonw22">cdbdaemon::err_empty</a>:
00908             <span class="keywordflow">break</span>;
00909     <span class="keywordflow">default</span>:
00910             <span class="keywordflow">if</span>( fdwrite( cso, &amp;<span class="stringliteral">"E"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00911             <span class="keywordflow">return</span>;
00912     }
00913 
00914     icnt = ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo11">ints_id</a>.size();
00915 
00916     <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"F"</span>, 1) != 1
00917         || fdwrstr(cso, ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo0">id</a>) == -1 
00918         || fdwrstr(cso, ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo3">country</a>) == -1 
00919         || fdwrstr(cso, ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo4">city</a>) == -1
00920         || fdwrstr(cso, ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo5">birthday</a>) == -1 
00921         || fdwrstr(cso, ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo12">re_que</a>) == -1 
00922         || fdwrstr(cso, ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo13">re_ans</a>) == -1
00923         || fdwrstr(cso, ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo10">locale</a>) == -1
00924         || fdwrstr(cso, ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo6">area_id</a>) == -1
00925         || fdwrstr(cso, ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo7">work_id</a>) == -1
00926         || fdwrstr(cso, ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo8">edu_id</a>) == -1
00927         || fdwrstr(cso, ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo9">sex_id</a>) == -1
00928         || fdwrite(cso, &amp; icnt, <span class="keyword">sizeof</span>(icnt)) != <span class="keyword">sizeof</span>(icnt) )
00929             <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00930             
00931     <span class="keywordflow">if</span>( icnt -- ) {
00932             <span class="keywordflow">do</span> {
00933                     <span class="keywordflow">if</span>( fdwrstr(cso, ui.<a class="code" href="structcdbdaemon_1_1user__info.html#cdbdaemon_1_1user__infoo11">ints_id</a>[icnt]) == -1 )
00934                             <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00935             } <span class="keywordflow">while</span>( icnt-- );
00936     }
00937 }
00938 
00939 
00943 <span class="keywordtype">void</span> cmd_ui_cmp_by_name() {
00944     <span class="keywordflow">if</span>( fdrdstr(cso, localeinfo) == -1 
00945         || fdrdstr(cso, login) == -1
00946         || fdrdstr(cso, dom_id) == -1
00947         || fdrdstr(cso, country) == -1
00948         || fdrdstr(cso, city) == -1
00949         || fdrdstr(cso, birthday) == -1
00950         || fdrdstr(cso, area_id) == -1
00951         || fdrdstr(cso, work_id) == -1
00952         || fdrdstr(cso, edu_id) == -1
00953         || fdrdstr(cso, sex_id) == -1
00954         || fdrdstr(cso, re_ans) == -1 )
00955             <span class="keywordflow">throw</span> <a class="code" href="classrd__error.html">rd_error</a>();
00956     
00957     pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00958         <span class="stringliteral">"SELECT 1 FROM users_info as ui,"</span>
00959         <span class="stringliteral">"users_info_map_area as uma,"</span>
00960         <span class="stringliteral">"users_info_map_work as umw,"</span>
00961         <span class="stringliteral">"users_info_map_edu as ume,"</span>
00962         <span class="stringliteral">"users_info_map_sex as ums"</span>
00963         <span class="stringliteral">" WHERE ui.login="</span>+pqxx::Quote(login, <span class="keyword">false</span>)
00964         +<span class="stringliteral">" AND ui.domain_id="</span>+pqxx::Quote(dom_id, <span class="keyword">false</span>)
00965         +<span class="stringliteral">" AND ui.country_up=UPPER("</span>+pqxx::Quote(country, <span class="keyword">false</span>)+<span class="stringliteral">")"</span>
00966         +<span class="stringliteral">" AND ui.city_up=UPPER("</span>+pqxx::Quote(city, <span class="keyword">false</span>)+<span class="stringliteral">")"</span>
00967          <span class="stringliteral">" AND birthday="</span>+pqxx::Quote(birthday, <span class="keyword">false</span>)
00968         +<span class="stringliteral">" AND re_answer=UPPER("</span>+pqxx::Quote(re_ans, <span class="keyword">false</span>)+<span class="stringliteral">")"</span>
00969         <span class="stringliteral">" AND uma.user_id=ui.id AND uma.val_id="</span>+pqxx::Quote(area_id, <span class="keyword">false</span>)
00970         +<span class="stringliteral">" AND umw.user_id=ui.id AND umw.val_id="</span>+pqxx::Quote(work_id, <span class="keyword">false</span>)
00971         +<span class="stringliteral">" AND ume.user_id=ui.id AND ume.val_id="</span>+pqxx::Quote(edu_id, <span class="keyword">false</span>)
00972         +<span class="stringliteral">" AND ums.user_id=ui.id AND ums.val_id="</span>+pqxx::Quote(sex_id, <span class="keyword">false</span>) ) );
00973 
00974     <span class="keywordtype">char</span> resp; 
00975     <span class="keywordflow">if</span>( res.size() == 1 ) resp = <span class="charliteral">'K'</span>;
00976     <span class="keywordflow">else</span> resp = <span class="charliteral">'Z'</span>;
00977 
00978     <span class="keywordflow">if</span>( fdwrite(cso, &amp;resp, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00979 }
00983 <span class="keywordtype">void</span> cmd_user_pass_get() {
00984     <span class="keywordflow">if</span>( fdrdstr(cso, domain) == -1 
00985         || fdrdstr(cso, login) == -1 )
00986             <span class="keywordflow">throw</span> <a class="code" href="classrd__error.html">rd_error</a>();
00987     
00988     str2tb(domain);
00989     pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00990         <span class="stringliteral">"SELECT pass FROM \""</span>+domain+<span class="stringliteral">"\" WHERE login="</span>
00991         +pqxx::Quote(login, <span class="keyword">false</span>)) );
00992 
00993     <span class="keywordflow">if</span>( ! res.size() ) {
00994             <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"Z"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00995             <span class="keywordflow">return</span>;
00996     }
00997 
00998     <span class="keyword">const</span> <span class="keywordtype">char</span> *tmp = res[0][0].c_str();
00999     <span class="keywordflow">if</span>(!tmp) tmp = <span class="stringliteral">""</span>;
01000     <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"F"</span>, 1) != 1
01001         || fdwrstr(cso, tmp) == -1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
01002 }
01003 
01007 <span class="keywordtype">void</span> cmd_ui_re_que_get_by_name() {
01008     <span class="keywordflow">if</span>( fdrdstr(cso, dom_id) == -1 
01009         || fdrdstr(cso, login) == -1 ) 
01010             <span class="keywordflow">throw</span> <a class="code" href="classrd__error.html">rd_error</a>();
01011 
01012     str2tb(domain);
01013     pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
01014         <span class="stringliteral">"SELECT re_question FROM users_info WHERE "</span>
01015         <span class="stringliteral">"login="</span>+pqxx::Quote(login, <span class="keyword">false</span>)
01016         +<span class="stringliteral">" AND domain_id="</span>+pqxx::Quote(dom_id, <span class="keyword">false</span>)) );
01017 
01018     <span class="keywordflow">if</span>( ! res.size() ) {
01019             <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"Z"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
01020             <span class="keywordflow">return</span>;
01021     }
01022     
01023     <span class="keyword">const</span> <span class="keywordtype">char</span> *tmp = res[0][0].c_str();
01024     <span class="keywordflow">if</span>(!tmp) tmp = <span class="stringliteral">""</span>;
01025     <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"F"</span>, 1) != 1
01026         || fdwrstr(cso, tmp) == -1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
01027 }
01028 
01031 void (*cmd_proc( <span class="keywordtype">char</span> cmd )) () {
01032     <span class="keywordflow">switch</span>(cmd) {
01033     <span class="keywordflow">case</span> <a class="code" href="classcdbdaemon.html#cdbdaemonw25cdbdaemonw0">cdbdaemon::cmd_edu_ls</a>:
01034         <span class="keywordflow">return</span> &amp;cmd_edu_ls;
01035     <span class="keywordflow">case</span> <a class="code" href="classcdbdaemon.html#cdbdaemonw25cdbdaemonw1">cdbdaemon::cmd_work_ls</a>:
01036         <span class="keywordflow">return</span> &amp;cmd_work_ls;
01037     <span class="keywordflow">case</span> <a class="code" href="classcdbdaemon.html#cdbdaemonw25cdbdaemonw2">cdbdaemon::cmd_int_ls</a>:
01038         <span class="keywordflow">return</span> &amp;cmd_int_ls;
01039     <span class="keywordflow">case</span> <a class="code" href="classcdbdaemon.html#cdbdaemonw25cdbdaemonw3">cdbdaemon::cmd_area_ls</a>:
01040         <span class="keywordflow">return</span> &amp;cmd_area_ls;
01041     <span class="keywordflow">case</span> <a class="code" href="classcdbdaemon.html#cdbdaemonw25cdbdaemonw4">cdbdaemon::cmd_sex_ls</a>:
01042         <span class="keywordflow">return</span> &amp;cmd_sex_ls;
01043     <span class="keywordflow">case</span> <a class="code" href="classcdbdaemon.html#cdbdaemonw25cdbdaemonw5">cdbdaemon::cmd_dom_ls</a>:
01044         <span class="keywordflow">return</span> &amp;cmd_dom_ls;
01045     <span class="keywordflow">case</span> <a class="code" href="classcdbdaemon.html#cdbdaemonw25cdbdaemonw7">cdbdaemon::cmd_ui_rm</a>:
01046         <span class="keywordflow">return</span> &amp;cmd_ui_rm;
01047     <span class="keywordflow">case</span> <a class="code" href="classcdbdaemon.html#cdbdaemonw25cdbdaemonw6">cdbdaemon::cmd_ui_add</a>:
01048         <span class="keywordflow">return</span> &amp;cmd_ui_add;
01049     <span class="keywordflow">case</span> <a class="code" href="classcdbdaemon.html#cdbdaemonw25cdbdaemonw8">cdbdaemon::cmd_dom_get</a>:
01050         <span class="keywordflow">return</span> &amp;cmd_dom_get;
01051     <span class="keywordflow">case</span> <a class="code" href="classcdbdaemon.html#cdbdaemonw25cdbdaemonw9">cdbdaemon::cmd_dom_get_by_name</a>:
01052         <span class="keywordflow">return</span> &amp;cmd_dom_get_by_name;
01053     <span class="keywordflow">case</span> <a class="code" href="classcdbdaemon.html#cdbdaemonw25cdbdaemonw10">cdbdaemon::cmd_ui_get_by_name</a>:
01054         <span class="keywordflow">return</span> &amp;cmd_ui_get_by_name;
01055     <span class="keywordflow">case</span> cdbdaemon::cmd_ui_get_by_name1:
01056         <span class="keywordflow">return</span> &amp;cmd_ui_get_by_name1;
01057     <span class="keywordflow">case</span> cdbdaemon::cmd_ui_cmp_by_name:
01058         <span class="keywordflow">return</span> &amp;cmd_ui_cmp_by_name;
01059     <span class="keywordflow">case</span> cdbdaemon::cmd_user_pass_get:
01060         <span class="keywordflow">return</span> &amp;cmd_user_pass_get;
01061     <span class="keywordflow">case</span> cdbdaemon::cmd_ui_re_que_get_by_name:
01062         <span class="keywordflow">return</span> &amp;cmd_ui_re_que_get_by_name;
01063     <span class="keywordflow">case</span> cdbdaemon::cmd_ui_chg:
01064         <span class="keywordflow">return</span> &amp;cmd_ui_chg;
01065     <span class="keywordflow">default</span>:
01066         <span class="keywordflow">return</span> NULL;
01067     }
01068 }
01071 <span class="keywordtype">char</span> child(<span class="keywordtype">int</span> fd)
01072 {
01073     <span class="keywordtype">char</span> cmd;
01074     void (*run)();
01075 
01076     cso = fd;
01077     
01078     <span class="keywordflow">switch</span>( fdread(cso, &amp;cmd, 1) ) {
01079     <span class="keywordflow">case</span> 0: <span class="keywordflow">return</span> 1;
01080     <span class="keywordflow">case</span> -1: 
01081             cerr&lt;&lt;<span class="stringliteral">"child: read error: "</span>&lt;&lt;strerror(errno)&lt;&lt;endl;
01082             <span class="keywordflow">return</span> 2;
01083     }
01084     <span class="comment">// process cmd</span>
01085     <span class="keywordflow">if</span>( ! (run = cmd_proc(cmd)) ) {
01086             cerr &lt;&lt; <span class="stringliteral">"child: unknown command: "</span> &lt;&lt; (<span class="keywordtype">int</span>) cmd &lt;&lt; endl;
01087             <span class="keywordflow">return</span> 2;
01088     }
01089     
01090     <span class="keywordflow">try</span> {
01091             (*run)();
01092             <span class="keywordflow">return</span> 0;
01093     } <span class="keywordflow">catch</span>( <span class="keyword">const</span> <a class="code" href="classrd__error.html">rd_error</a> &amp; e ) {
01094             cerr&lt;&lt;<span class="stringliteral">"child: exception: "</span>&lt;&lt;e.what()&lt;&lt;endl;
01095     } <span class="keywordflow">catch</span>( <span class="keyword">const</span> <a class="code" href="classwr__error.html">wr_error</a> &amp; e ) {
01096             cerr&lt;&lt;<span class="stringliteral">"child: exception: "</span>&lt;&lt;e.what()&lt;&lt;endl;
01097     } <span class="keywordflow">catch</span>( <span class="keyword">const</span> exception &amp; e ) {
01098             cerr&lt;&lt;<span class="stringliteral">"child: exception: "</span>&lt;&lt;e.what()&lt;&lt;endl;
01099             <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"E"</span>, 1) != 1 ) cerr&lt;&lt;<span class="stringliteral">"child: write error: "</span>&lt;&lt;strerror(errno)&lt;&lt;endl;
01100     }
01101     
01102     <span class="keywordflow">return</span> 2;
01103 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Dec 25 13:37:19 2003 for vqwww: freemail by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.3 </small></address>
</body>
</html>
