<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Virtual Qmail: hmac_md5.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.3 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Compound&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Compound&nbsp;Members</a></div>
<h1>hmac_md5.c</h1><div class="fragment"><pre>00001 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00002 <span class="preprocessor">#include &lt;string.h&gt;</span>
00003 <span class="preprocessor">#include "auto/lmd5.h"</span>
00004 
00005 <span class="comment">/*</span>
00006 <span class="comment">** Function: hmac_md5</span>
00007 <span class="comment">*/</span>
00008 
00009 <span class="keywordtype">void</span> hmac_md5(
00010     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*  text,                <span class="comment">/* pointer to data stream */</span>
00011     <span class="keywordtype">int</span>             text_len,            <span class="comment">/* length of data stream */</span>
00012     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*  key,                 <span class="comment">/* pointer to authentication key */</span>
00013     <span class="keywordtype">int</span>             key_len,             <span class="comment">/* length of authentication key */</span>
00014     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>   *digest              <span class="comment">/* caller digest to be filled in */</span>
00015 )
00016 {
00017         MD5_CTX context;
00018         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> k_ipad[65];    <span class="comment">/* inner padding -</span>
00019 <span class="comment">                                      * key XORd with ipad</span>
00020 <span class="comment">                                      */</span>
00021         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> k_opad[65];    <span class="comment">/* outer padding -</span>
00022 <span class="comment">                                      * key XORd with opad</span>
00023 <span class="comment">                                      */</span>
00024         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> tk[16];
00025         <span class="keywordtype">int</span> i;
00026         <span class="comment">/* if key is longer than 64 bytes reset it to key=MD5(key) */</span>
00027         <span class="keywordflow">if</span> (key_len &gt; 64) {
00028 
00029                 MD5_CTX      tctx;
00030 
00031                 MD5Init(&amp;tctx);
00032                 MD5Update(&amp;tctx, key, key_len);
00033                 MD5Final(tk, &amp;tctx);
00034 
00035                 key = tk;
00036                 key_len = 16;
00037         }
00038 
00039         <span class="comment">/*</span>
00040 <span class="comment">         * the HMAC_MD5 transform looks like:</span>
00041 <span class="comment">         *</span>
00042 <span class="comment">         * MD5(K XOR opad, MD5(K XOR ipad, text))</span>
00043 <span class="comment">         *</span>
00044 <span class="comment">         * where K is an n byte key</span>
00045 <span class="comment">         * ipad is the byte 0x36 repeated 64 times</span>
00046 <span class="comment">         * opad is the byte 0x5c repeated 64 times</span>
00047 <span class="comment">         * and text is the data being protected</span>
00048 <span class="comment">         */</span>
00049 
00050         <span class="comment">/* start out by storing key in pads */</span>
00051         bzero( k_ipad, <span class="keyword">sizeof</span> k_ipad);
00052         bzero( k_opad, <span class="keyword">sizeof</span> k_opad);
00053         bcopy( key, k_ipad, key_len);
00054         bcopy( key, k_opad, key_len);
00055 
00056         <span class="comment">/* XOR key with ipad and opad values */</span>
00057         <span class="keywordflow">for</span> (i=0; i&lt;64; i++) {
00058                 k_ipad[i] ^= 0x36;
00059                 k_opad[i] ^= 0x5c;
00060         }
00061         <span class="comment">/*</span>
00062 <span class="comment">         * perform inner MD5</span>
00063 <span class="comment">         */</span>
00064         MD5Init(&amp;context);                   <span class="comment">/* init context for 1st pass */</span>
00065         MD5Update(&amp;context, k_ipad, 64);      <span class="comment">/* start with inner pad */</span>
00066         MD5Update(&amp;context, text, text_len); <span class="comment">/* then text of datagram */</span>
00067         MD5Final(digest, &amp;context);          <span class="comment">/* finish up 1st pass */</span>
00068         <span class="comment">/*</span>
00069 <span class="comment">         * perform outer MD5</span>
00070 <span class="comment">         */</span>
00071         MD5Init(&amp;context);                   <span class="comment">/* init context for 2nd</span>
00072 <span class="comment">                                              * pass */</span>
00073         MD5Update(&amp;context, k_opad, 64);     <span class="comment">/* start with outer pad */</span>
00074         MD5Update(&amp;context, digest, 16);     <span class="comment">/* then results of 1st</span>
00075 <span class="comment">                                              * hash */</span>
00076         MD5Final(digest, &amp;context);          <span class="comment">/* finish up 2nd pass */</span>
00077 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Dec 25 13:37:10 2003 for Virtual Qmail by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.3 </small></address>
</body>
</html>
