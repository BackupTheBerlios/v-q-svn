<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>vqwww: cpassmod.cc Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.3 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Compound&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Compound&nbsp;Members</a></div>
<h1>cpassmod.cc</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment">Copyright (c) 2002,2003 Pawel Niewiadomski</span>
00003 <span class="comment">All rights reserved.</span>
00004 <span class="comment"></span>
00005 <span class="comment">Redistribution and use in source and binary forms, with or without</span>
00006 <span class="comment">modification, are permitted provided that the following conditions</span>
00007 <span class="comment">are met:</span>
00008 <span class="comment">1. Redistributions of source code must retain the above copyright</span>
00009 <span class="comment">   notice, this list of conditions and the following disclaimer.</span>
00010 <span class="comment">2. Redistributions in binary form must reproduce the above copyright</span>
00011 <span class="comment">   notice, this list of conditions and the following disclaimer in the</span>
00012 <span class="comment">   documentation and/or other materials provided with the distribution.</span>
00013 <span class="comment">3. All advertising materials mentioning features or use of this software</span>
00014 <span class="comment">   must display the following acknowledgement:</span>
00015 <span class="comment">   This product includes software developed by the Pawel Niewiadomski,</span>
00016 <span class="comment">   and other contributors.</span>
00017 <span class="comment">4. Neither the name of Pawel Niewiadomski nor the names of other contributors</span>
00018 <span class="comment">   may be used to endorse or promote products derived from this software</span>
00019 <span class="comment">   without specific prior written permission.</span>
00020 <span class="comment"></span>
00021 <span class="comment">THIS SOFTWARE IS PROVIDED BY PAWEL NIEWIADOMSKI AND CONTRIBUTORS ``AS IS'' AND</span>
00022 <span class="comment">ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
00023 <span class="comment">IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
00024 <span class="comment">ARE DISCLAIMED.  IN NO EVENT SHALL PAWEL NIEWIADOMSKI OR CONTRIBUTORS BE LIABLE</span>
00025 <span class="comment">FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
00026 <span class="comment">DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</span>
00027 <span class="comment">OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
00028 <span class="comment">HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
00029 <span class="comment">LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
00030 <span class="comment">OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
00031 <span class="comment">SUCH DAMAGE.</span>
00032 <span class="comment">*/</span>
00033 
00034 <span class="preprocessor">#include "cpassmod.h"</span>
00035 <span class="preprocessor">#include "vqwww.h"</span>
00036 <span class="preprocessor">#include "cgi.h"</span>
00037 <span class="preprocessor">#include "vqwww_conf.h"</span>
00038 <span class="preprocessor">#include "html.h"</span>
00039 
00040 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00041 <span class="keyword">using</span> <span class="keyword">namespace </span>vqwww;
00042 <span class="keyword">using</span> <span class="keyword">namespace </span>cgicc;
00043 
<a name="l00044"></a><a class="code" href="classcpassmod.html#cpassmodt0">00044</a> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="classcpassmod.html#cpassmodt0">cpassmod::_id</a>[] = <span class="stringliteral">"pass"</span>;
<a name="l00045"></a><a class="code" href="classcpassmod.html#cpassmodt1">00045</a> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="classcpassmod.html#cpassmodt1">cpassmod::_conf</a>[] = <span class="stringliteral">"&lt;pass/&gt;&lt;desc&gt;&lt;pass/&gt;&lt;/desc&gt;"</span>;
00046 
00047 <span class="keywordtype">void</span> cpassmod::act() {
00048     out&lt;&lt; <span class="stringliteral">"&lt;mod&gt;&lt;pass&gt;"</span>;
00049     <span class="keywordflow">if</span>( <a class="code" href="classcmod.html#credirmodp1">env</a>.<a class="code" href="group__cgi.html#a6">cgi_rm_get</a>() == cenvironment::rm_post ) {
00050             <span class="keywordtype">bool</span> ok= <span class="keyword">true</span>;
00051             string cpass, npass, rpass;
00052             string::size_type len;
00053             out&lt;&lt;<span class="stringliteral">"&lt;inv&gt;"</span>;
00054             out&lt;&lt;<span class="stringliteral">"&lt;cpass"</span>;
00055             <span class="keywordflow">if</span>( ! cgi_var(&amp;<a class="code" href="classcmod.html#credirmodp1">env</a>.<a class="code" href="group__cgi.html#a0">cgi_get</a>(), <span class="stringliteral">"cpass"</span>, cpass) || cpass.empty() ) {
00056                     ok = <span class="keyword">false</span>;
00057                     out&lt;&lt;<span class="stringliteral">" empty=\"1\" "</span>; 
00058             }
00059             out&lt;&lt;<span class="stringliteral">"/&gt;"</span>;
00060             out&lt;&lt;<span class="stringliteral">"&lt;npass"</span>;
00061             <span class="keywordflow">if</span>( ! cgi_var(&amp;<a class="code" href="classcmod.html#credirmodp1">env</a>.<a class="code" href="group__cgi.html#a0">cgi_get</a>(), <span class="stringliteral">"npass"</span>, npass) || npass.empty() ) {
00062                     ok = <span class="keyword">false</span>;
00063                     out&lt;&lt;<span class="stringliteral">" empty=\"1\" "</span>;
00064             } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( (len=npass.length()) &lt; ac_pass_minl.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>() ) {
00065                     ok = <span class="keyword">false</span>;
00066                     out&lt;&lt;<span class="stringliteral">" tooshort=\"1\" "</span>;
00067             } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( len &gt; ac_pass_maxl.<a class="code" href="classcintconf.html#cintconfa2">val_int</a>() ) {
00068                     ok = <span class="keyword">false</span>;
00069                     out&lt;&lt;<span class="stringliteral">" toolong=\"1\" "</span>;
00070             } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( htmlbad(npass, ac_pass_ok.<a class="code" href="classclnconf.html#clnconfa1">val_str</a>().c_str(), 
00071                     ac_html_br.<a class="code" href="classclnconf.html#clnconfa1">val_str</a>().at(0) ) ) {
00072                     ok = <span class="keyword">false</span>;
00073                     out&lt;&lt; <span class="stringliteral">" dirty=\"1\" "</span>;
00074             }
00075             out&lt;&lt;<span class="stringliteral">"/&gt;"</span>;
00076             cgi_var(&amp;<a class="code" href="classcmod.html#credirmodp1">env</a>.<a class="code" href="group__cgi.html#a0">cgi_get</a>(), <span class="stringliteral">"rpass"</span>, rpass);
00077             <span class="keywordflow">if</span>( rpass != npass ) {
00078                     ok = <span class="keyword">false</span>;
00079                     out&lt;&lt;<span class="stringliteral">"&lt;dontmatch/&gt;"</span>;
00080             }
00081             <span class="keywordflow">if</span>( ok ) {
00082                     cvq::auth_info ai;
00083                     ai.dom = <a class="code" href="classcmod.html#credirmodp1">env</a>.<a class="code" href="group__sess.html#a1">sessb_get</a>().<a class="code" href="structcsess__basic.html#csess__basico0">ai</a>.dom;
00084                     ai.user = <a class="code" href="classcmod.html#credirmodp1">env</a>.<a class="code" href="group__sess.html#a1">sessb_get</a>().<a class="code" href="structcsess__basic.html#csess__basico0">ai</a>.user;
00085                     
00086                     <span class="keywordflow">if</span>( ! <a class="code" href="classcmod.html#credirmodp1">env</a>.<a class="code" href="classcenvironment.html#cvqwwwa6">vq_get</a>().user_auth(ai) ) {
00087                             <span class="keywordflow">if</span>( ai.pass != cpass ) {
00088                                     out&lt;&lt;<span class="stringliteral">"&lt;oldbad/&gt;"</span>;
00089                             } <span class="keywordflow">else</span> {
00090                                     <span class="keywordflow">if</span>( ! <a class="code" href="classcmod.html#credirmodp1">env</a>.<a class="code" href="classcenvironment.html#cvqwwwa6">vq_get</a>().user_pass(
00091                                                 <a class="code" href="classcmod.html#credirmodp1">env</a>.<a class="code" href="group__sess.html#a1">sessb_get</a>().<a class="code" href="structcsess__basic.html#csess__basico0">ai</a>.user, 
00092                                                 <a class="code" href="classcmod.html#credirmodp1">env</a>.<a class="code" href="group__sess.html#a1">sessb_get</a>().<a class="code" href="structcsess__basic.html#csess__basico0">ai</a>.dom, npass ) ) {
00093                                             out&lt;&lt;<span class="stringliteral">"&lt;done/&gt;"</span>;
00094                                     } <span class="keywordflow">else</span> {
00095                                             out&lt;&lt;<span class="stringliteral">"&lt;chgcant/&gt;"</span>;
00096                                             err&lt;&lt;<span class="stringliteral">"cpassmod: can't set password: "</span>
00097                                                 &lt;&lt;<a class="code" href="classcmod.html#credirmodp1">env</a>.<a class="code" href="classcenvironment.html#cvqwwwa6">vq_get</a>().err_report()&lt;&lt;endl;
00098                                     }
00099                             }
00100                     } <span class="keywordflow">else</span> {
00101                             out&lt;&lt;<span class="stringliteral">"&lt;getcant/&gt;"</span>;
00102                             err&lt;&lt;<span class="stringliteral">"cpassmod: can't get password: "</span>
00103                                 &lt;&lt;<a class="code" href="classcmod.html#credirmodp1">env</a>.<a class="code" href="classcenvironment.html#cvqwwwa6">vq_get</a>().err_report()&lt;&lt;endl;
00104                     }
00105             }
00106             out&lt;&lt;<span class="stringliteral">"&lt;/inv&gt;"</span>;
00107     }
00108     out&lt;&lt; <span class="stringliteral">"&lt;/pass&gt;&lt;/mod&gt;"</span>;
00109 }
00110 <span class="comment">/**************************************************************************</span>
00111 <span class="comment"> *  </span>
00112 <span class="comment"> *  ***********************************************************************/</span>
<a name="l00113"></a><a class="code" href="classcpassmod.html#cpassmoda3">00113</a> <span class="keywordtype">char</span> <a class="code" href="classcpassmod.html#cpassmoda3">cpassmod::run</a>() {
00114     const_form_iterator fi = <a class="code" href="classcmod.html#credirmodp1">env</a>.<a class="code" href="group__cgi.html#a0">cgi_get</a>().getElement(<span class="stringliteral">"conf"</span>);
00115     <span class="keywordflow">if</span>( fi != <a class="code" href="classcmod.html#credirmodp1">env</a>.<a class="code" href="group__cgi.html#a3">cgi_end_get</a>() ) {
00116             fi = <a class="code" href="classcmod.html#credirmodp1">env</a>.<a class="code" href="group__cgi.html#a0">cgi_get</a>().getElement(<span class="stringliteral">"id"</span>);
00117             <span class="keywordflow">if</span>( fi != <a class="code" href="classcmod.html#credirmodp1">env</a>.<a class="code" href="group__cgi.html#a3">cgi_end_get</a>() &amp;&amp; fi-&gt;getValue() == <a class="code" href="classcpassmod.html#cpassmodt0">_id</a> ) {
00118                     act();
00119                     <span class="keywordflow">return</span> <a class="code" href="classcmod.html#credirmodw8credirmodw3">done</a>;
00120             }
00121     }
00122     <span class="keywordflow">return</span> <a class="code" href="classcmod.html#credirmodw8credirmodw2">notme</a>;
00123 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Dec 25 13:37:27 2003 for vqwww by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.3 </small></address>
</body>
</html>
