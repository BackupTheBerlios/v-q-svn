<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Virtual Qmail: pgsqlauthd.cc Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.3 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Compound&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Compound&nbsp;Members</a></div>
<h1>pgsqlauthd.cc</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment">Copyright (c) 2002,2003 Pawel Niewiadomski</span>
00003 <span class="comment">All rights reserved.</span>
00004 <span class="comment"></span>
00005 <span class="comment">Redistribution and use in source and binary forms, with or without</span>
00006 <span class="comment">modification, are permitted provided that the following conditions</span>
00007 <span class="comment">are met:</span>
00008 <span class="comment">1. Redistributions of source code must retain the above copyright</span>
00009 <span class="comment">   notice, this list of conditions and the following disclaimer.</span>
00010 <span class="comment">2. Redistributions in binary form must reproduce the above copyright</span>
00011 <span class="comment">   notice, this list of conditions and the following disclaimer in the</span>
00012 <span class="comment">   documentation and/or other materials provided with the distribution.</span>
00013 <span class="comment">3. All advertising materials mentioning features or use of this software</span>
00014 <span class="comment">   must display the following acknowledgement:</span>
00015 <span class="comment">   This product includes software developed by the Pawel Niewiadomski,</span>
00016 <span class="comment">   and other contributors.</span>
00017 <span class="comment">4. Neither the name of Pawel Niewiadomski nor the names of other contributors</span>
00018 <span class="comment">   may be used to endorse or promote products derived from this software</span>
00019 <span class="comment">   without specific prior written permission.</span>
00020 <span class="comment"></span>
00021 <span class="comment">THIS SOFTWARE IS PROVIDED BY PAWEL NIEWIADOMSKI AND CONTRIBUTORS ``AS IS'' AND</span>
00022 <span class="comment">ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
00023 <span class="comment">IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
00024 <span class="comment">ARE DISCLAIMED.  IN NO EVENT SHALL PAWEL NIEWIADOMSKI OR CONTRIBUTORS BE LIABLE</span>
00025 <span class="comment">FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
00026 <span class="comment">DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</span>
00027 <span class="comment">OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
00028 <span class="comment">HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
00029 <span class="comment">LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
00030 <span class="comment">OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
00031 <span class="comment">SUCH DAMAGE.</span>
00032 <span class="comment">*/</span>
00033 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00034 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00035 <span class="preprocessor">#include &lt;sys/socket.h&gt;</span>
00036 <span class="preprocessor">#include &lt;ctime&gt;</span>
00037 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00038 <span class="preprocessor">#include &lt;cerrno&gt;</span>
00039 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
00040 <span class="preprocessor">#include &lt;stdexcept&gt;</span>
00041 <span class="preprocessor">#include &lt;iostream&gt;</span>
00042 <span class="preprocessor">#include &lt;sstream&gt;</span>
00043 <span class="preprocessor">#include &lt;algorithm&gt;</span>
00044 <span class="preprocessor">#include &lt;vector&gt;</span>
00045 
00046 <span class="preprocessor">#include "conf_home.h"</span>
00047 <span class="preprocessor">#include "vq_conf.h"</span>
00048 <span class="preprocessor">#include "sig.h"</span>
00049 <span class="preprocessor">#include "fd.h"</span>
00050 <span class="preprocessor">#include "fdstr.h"</span>
00051 <span class="preprocessor">#include "util.h"</span>
00052 <span class="preprocessor">#include "lock.h"</span>
00053 <span class="preprocessor">#include "pgsqlcommon.h"</span>
00054 <span class="preprocessor">#include "sys.h"</span>
00055 <span class="preprocessor">#include "daemon.h"</span>
00056 <span class="preprocessor">#include "cvq.h"</span>
00057 <span class="preprocessor">#include "cdaemonauth.h"</span>
00058 
00059 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00060 <span class="keyword">using</span> <span class="keyword">namespace </span>vq;
00061 
00062 <span class="comment">// socket</span>
00063 <span class="keywordtype">int</span> slock;
00064 <span class="comment">// pgsql</span>
00065 pqxx::Connection *pg = NULL;
00066 <span class="comment">// child</span>
00067 string dom, user, pass, ip, ext;
00068 <a class="code" href="classcvq.html#cvqw35">cvq::udot_type</a> type;
00069 
00073 <span class="keywordtype">void</span> setup()
00074 {
00075     umask(0);
00076     <span class="keywordflow">if</span>(!sig_pipeign() || !sig_chld_nocldwait() ) 
00077             <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"setup: can't set signals: "</span>+strerror(errno));
00078     <span class="keywordflow">if</span>(chdir((conf_home+<span class="stringliteral">"/sockets"</span>).c_str()))
00079             <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"setup: chdir: "</span>
00080                     +conf_home+<span class="stringliteral">"/sockets: "</span>+strerror(errno));
00081     slock = open(<span class="stringliteral">"daemonauth.lock"</span>, O_RDONLY | O_NONBLOCK | O_CREAT, 0666 );
00082     <span class="keywordflow">if</span>(slock==-1)
00083             <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"setup: open: daemonauth.lock: "</span>+strerror(errno));
00084     <span class="keywordflow">if</span>(lock_exnb(slock)) {
00085             <span class="keywordflow">if</span>( errno == EWOULDBLOCK )
00086                     <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"setup: daemonauth.lock is already locked"</span>);
00087             <span class="keywordflow">else</span> <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"setup: daemonauth.lock: lock: "</span>+strerror(errno));
00088     }
00089     <span class="keywordflow">if</span>(unlink(<span class="stringliteral">"daemonauth"</span>)==-1 &amp;&amp; errno != ENOENT )
00090             <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"setup: unlink: daemonauth: "</span>+strerror(errno));
00091     <span class="keywordflow">if</span>( (sso=socket(AF_UNIX,SOCK_STREAM,0)) == -1 )
00092             <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"setup: socket: "</span>+strerror(errno));
00093 
00094     <span class="keyword">struct </span>sockaddr_un sun;
00095     sun.sun_family = AF_UNIX;
00096     strcpy(sun.sun_path, <span class="stringliteral">"daemonauth"</span>);
00097     <span class="keywordflow">if</span>(bind(sso, (<span class="keyword">struct</span> sockaddr*) &amp;sun, SUN_LEN(&amp;sun)))
00098             <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"setup: bind: daemonauth: "</span>+strerror(errno));
00099     <span class="keywordflow">if</span>( !(pg = <span class="keyword">new</span> pqxx::Connection(ac_pgsql.<a class="code" href="classclnconf.html#clnconfa1">val_str</a>().c_str())) ) 
00100             <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"setup: no memory"</span>); 
00101     <span class="keywordflow">if</span>( listen(sso, 5) == -1 )
00102             <span class="keywordflow">throw</span> runtime_error((string)<span class="stringliteral">"setup: listen: "</span>+strerror(errno));
00103 }
00104 
00107 <span class="keywordtype">void</span> cmd_dom_add()
00108 {
00109     <span class="keywordflow">if</span>( fdrdstr(cso, dom) != -1 ) {
00110             str2tb(dom);
00111             pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00112                     <span class="stringliteral">"SELECT DOM_ADD("</span>+pqxx::Quote(dom, <span class="keyword">false</span>)+<span class="stringliteral">","</span>
00113                     +pqxx::Quote(pg-&gt;UserName(), <span class="keyword">false</span>)+<span class="stringliteral">")"</span>));
00114             
00115             <span class="keywordflow">if</span>(res.empty() || res[0][0].is_null() 
00116                 || strcmp(res[0][0].c_str(), <span class="stringliteral">"t"</span>) ) {
00117                     <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"E"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00118                     <span class="keywordflow">return</span>;
00119             }
00120 
00121             <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"K"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00122     } <span class="keywordflow">else</span> 
00123             <span class="keywordflow">throw</span> <a class="code" href="classrd__error.html">rd_error</a>();
00124 }
00125 
00128 <span class="keywordtype">void</span> cmd_dom_rm()
00129 {
00130     <span class="keywordflow">if</span>( fdrdstr(cso, dom) != -1 ) {
00131             str2tb(dom);
00132             pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00133                     <span class="stringliteral">"SELECT DOM_RM("</span>+pqxx::Quote(dom, <span class="keyword">false</span>)+<span class="stringliteral">")"</span>));
00134 
00135             <span class="keywordflow">if</span>(res.empty() || res[0][0].is_null() 
00136                 || strcmp(res[0][0].c_str(), <span class="stringliteral">"t"</span>) ) {
00137                     <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"E"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00138                     <span class="keywordflow">return</span>;
00139             }
00140 
00141             <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"K"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00142     } <span class="keywordflow">else</span> 
00143             <span class="keywordflow">throw</span> <a class="code" href="classrd__error.html">rd_error</a>();
00144 }
00145 
00148 <span class="keywordtype">void</span> cmd_user_add()
00149 {
00150     uint8_t flags;
00151     <span class="keywordflow">if</span>( fdrdstr(cso, user) != -1
00152         &amp;&amp; fdrdstr(cso, dom) != -1
00153         &amp;&amp; fdrdstr(cso, pass) != -1 
00154         &amp;&amp; fdread(cso, &amp;flags, <span class="keyword">sizeof</span>(flags)) == <span class="keyword">sizeof</span>(flags) ) {
00155             str2tb(dom);
00156             ostringstream sflags;
00157             sflags&lt;&lt;(<span class="keywordtype">int</span>)flags;
00158 
00159             pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00160                     <span class="stringliteral">"SELECT USER_ADD("</span>+pqxx::Quote(user, <span class="keyword">false</span>)+<span class="stringliteral">","</span>
00161                     +pqxx::Quote(dom, <span class="keyword">false</span>)+<span class="stringliteral">","</span>
00162                     +pqxx::Quote(pass, <span class="keyword">false</span>)+<span class="stringliteral">","</span>
00163                     +pqxx::Quote(sflags.str(), <span class="keyword">false</span>)+<span class="stringliteral">")"</span>));
00164 
00165             <span class="keywordflow">if</span>(res.empty() || res[0][0].is_null() ) {
00166                     <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"E"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00167                     <span class="keywordflow">return</span>;
00168             }
00169             <span class="keyword">const</span> <span class="keywordtype">char</span> *val = res[0][0].c_str();
00170             <span class="keywordflow">if</span>( *(val+1) == <span class="charliteral">'\0'</span> ) {
00171                     <span class="keywordflow">if</span>( *val == <span class="charliteral">'1'</span> ) {
00172                             <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"D"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00173                             <span class="keywordflow">return</span>;
00174                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( *val == <span class="charliteral">'0'</span> ) {
00175                             <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"K"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00176                             <span class="keywordflow">return</span>;
00177                     }
00178             }
00179             <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"E"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00180     } <span class="keywordflow">else</span> 
00181             <span class="keywordflow">throw</span> <a class="code" href="classrd__error.html">rd_error</a>();
00182 }
00183 
00187 <span class="keywordtype">void</span> cmd_user_pass()
00188 {
00189     <span class="keywordflow">if</span>( fdrdstr(cso, user) != -1
00190         &amp;&amp; fdrdstr(cso, dom) != -1
00191         &amp;&amp; fdrdstr(cso, pass) != -1 ) {
00192             str2tb(dom);
00193 
00194             pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00195                     <span class="stringliteral">"SELECT USER_PASS("</span>+pqxx::Quote(user, <span class="keyword">false</span>)+<span class="stringliteral">","</span>
00196                     +pqxx::Quote(dom, <span class="keyword">false</span>)+<span class="stringliteral">","</span>+pqxx::Quote(pass, <span class="keyword">false</span>)+<span class="stringliteral">")"</span>));
00197 
00198             <span class="keywordflow">if</span>(res.empty() || res[0][0].is_null() 
00199                 || strcmp(res[0][0].c_str(), <span class="stringliteral">"t"</span>) ) {
00200                     <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"E"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00201                     <span class="keywordflow">return</span>;
00202             }
00203 
00204             <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"K"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00205     } <span class="keywordflow">else</span> 
00206             <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00207 }
00208 
00211 <span class="keywordtype">void</span> cmd_user_rm()
00212 {
00213     <span class="keywordflow">if</span>( fdrdstr(cso, user) != -1
00214         &amp;&amp; fdrdstr(cso, dom) != -1 ) {
00215             str2tb(dom);
00216             pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00217                     <span class="stringliteral">"SELECT USER_RM("</span>+pqxx::Quote(user, <span class="keyword">false</span>)+<span class="stringliteral">","</span>
00218                     +pqxx::Quote(dom, <span class="keyword">false</span>)+<span class="stringliteral">")"</span>));
00219 
00220             <span class="keywordflow">if</span>(res.empty() || res[0][0].is_null() 
00221                 || strcmp(res[0][0].c_str(), <span class="stringliteral">"t"</span>) ) {
00222                     <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"E"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00223                     <span class="keywordflow">return</span>;
00224             }
00225 
00226             <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"K"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00227     } <span class="keywordflow">else</span> 
00228             <span class="keywordflow">throw</span> <a class="code" href="classrd__error.html">rd_error</a>();
00229 }
00230 
00233 <span class="keywordtype">void</span> cmd_user_auth()
00234 {
00235     <span class="keywordflow">if</span>( fdrdstr(cso, user) != -1
00236        &amp;&amp; fdrdstr(cso, dom) != -1 ) {
00237             alias2dom(*pg, dom);
00238             string tb(dom);
00239             str2tb(tb);
00240 
00241             pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00242                 <span class="stringliteral">"SELECT pass,flags FROM \""</span>+tb
00243                 +<span class="stringliteral">"\" WHERE login="</span>+pqxx::Quote(user, <span class="keyword">false</span>)));
00244 
00245             <span class="keywordflow">if</span>( res.size() == 1 ) {
00246                     <span class="keywordflow">if</span>( res[0][0].is_null() || res[0][1].is_null() ) {
00247                             <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"E"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00248                             <span class="keywordflow">return</span>;
00249                     }
00250 
00251                     <span class="keyword">const</span> <span class="keywordtype">char</span> *pass = res[0][0].c_str();
00252                     <span class="keywordflow">if</span>(!pass) pass = <span class="stringliteral">""</span>;
00253                     <span class="keyword">const</span> <span class="keywordtype">char</span> *flags = res[0][1].c_str();
00254                     <span class="keywordflow">if</span>(!flags) flags= <span class="stringliteral">"0"</span>;
00255                     istringstream is;
00256                     is.str(flags);
00257                     <span class="keywordtype">int</span> iflags;
00258                     is&gt;&gt;iflags;
00259                     <span class="keywordflow">if</span>( ! is ) {
00260                             <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"E"</span>, 1) != 1 ) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00261                             <span class="keywordflow">return</span>;
00262                     }
00263                     <span class="keywordflow">if</span>( fdwrite(cso,&amp;<span class="stringliteral">"F"</span>,1) != 1
00264                         || fdwrstr(cso, user) == -1
00265                         || fdwrstr(cso, dom) == -1
00266                         || fdwrstr(cso, pass) == -1
00267                         || fdwrite(cso, &amp;iflags, <span class="keyword">sizeof</span>(iflags)) == -1 ) 
00268                             <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00269             } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(fdwrite(cso,&amp;<span class="stringliteral">"Z"</span>,1)!=1) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00270     } <span class="keywordflow">else</span> <span class="keywordflow">throw</span> <a class="code" href="classrd__error.html">rd_error</a>();
00271 }
00272 
00275 <span class="keywordtype">void</span> cmd_user_ex() {
00276     <span class="keywordflow">if</span>( -1 != fdrdstr(cso, dom)
00277         &amp;&amp; -1 != fdrdstr(cso, user) ) {
00278             uint8_t ret=0xff;
00279             alias2dom(*pg, dom);
00280             str2tb(dom);
00281 
00282             pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00283                 <span class="stringliteral">"SELECT user_exists("</span>+pqxx::Quote(dom, <span class="keyword">false</span>)+<span class="stringliteral">","</span>
00284                 +pqxx::Quote(user, <span class="keyword">false</span>)+<span class="charliteral">')'</span>));
00285 
00286             <span class="keywordflow">if</span>( res.size() == 1 ) {
00287                     istringstream is;
00288                     <span class="keywordtype">unsigned</span> ret1;
00289                     <span class="keyword">const</span> <span class="keywordtype">char</span> *tmp = res[0][0].c_str();
00290                     <span class="keywordflow">if</span>(!tmp) tmp = <span class="stringliteral">""</span>;
00291                     is.str(tmp);
00292                     is&gt;&gt;ret1;
00293                     <span class="keywordflow">if</span>(is) ret = ret1 &amp; 0xff;
00294             }
00295             <span class="keywordflow">if</span>( 1 != fdwrite(cso, &amp;<span class="stringliteral">"F"</span>, 1) ) {
00296                     <span class="keywordflow">switch</span>(ret) {
00297                     <span class="keywordflow">case</span> 1:
00298                             ret = <a class="code" href="group__err.html#a16cvqw6">cvq::err_user_nf</a>;
00299                             <span class="keywordflow">break</span>;
00300                     <span class="keywordflow">case</span> 0:
00301                             ret = <a class="code" href="group__err.html#a16cvqw2">cvq::err_no</a>;
00302                             <span class="keywordflow">break</span>;
00303                     <span class="keywordflow">case</span> 2:
00304                             ret = <a class="code" href="group__err.html#a16cvqw4">cvq::err_dom_inv</a>;
00305                             <span class="keywordflow">break</span>;
00306                     <span class="keywordflow">default</span>:
00307                             ret = <a class="code" href="group__err.html#a16cvqw3">cvq::err_temp</a>;
00308                     }
00309                 
00310                     <span class="keywordflow">if</span>( <span class="keyword">sizeof</span>(ret) == fdwrite(cso, &amp;ret, <span class="keyword">sizeof</span>(ret)) )
00311                             <span class="keywordflow">return</span>;
00312             }
00313             <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00314     } <span class="keywordflow">else</span> <span class="keywordflow">throw</span> <a class="code" href="classrd__error.html">rd_error</a>();
00315 }
00318 <span class="keywordtype">void</span> cmd_dom_ip_add()
00319 {
00320     <span class="keywordflow">if</span>( fdrdstr(cso,dom) != -1
00321         &amp;&amp; fdrdstr(cso,ip) != -1 ) {
00322             pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00323                 <span class="stringliteral">"INSERT INTO ip2domain (DOMAIN,IP) VALUES("</span>
00324                 +pqxx::Quote(dom, <span class="keyword">false</span>)+<span class="stringliteral">","</span>+pqxx::Quote(ip, <span class="keyword">false</span>)+<span class="charliteral">')'</span>));
00325 
00326             <span class="keywordflow">if</span>(fdwrite(cso,&amp;<span class="stringliteral">"K"</span>,1) != 1) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00327     } <span class="keywordflow">else</span> <span class="keywordflow">throw</span> <a class="code" href="classrd__error.html">rd_error</a>();
00328 }
00329 
00332 <span class="keywordtype">void</span> cmd_dom_ip_rm()
00333 {
00334     <span class="keywordflow">if</span>( fdrdstr(cso,dom) != -1
00335         &amp;&amp; fdrdstr(cso,ip) != -1 ) {
00336             pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00337                 <span class="stringliteral">"DELETE FROM ip2domain WHERE DOMAIN="</span>
00338                 +pqxx::Quote(dom, <span class="keyword">false</span>)+<span class="stringliteral">" AND IP="</span>+pqxx::Quote(ip, <span class="keyword">false</span>)));
00339 
00340             <span class="keywordflow">if</span>(fdwrite(cso,&amp;<span class="stringliteral">"K"</span>,1) != 1) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00341     } <span class="keywordflow">else</span> <span class="keywordflow">throw</span> <a class="code" href="classrd__error.html">rd_error</a>();
00342 }
00345 <span class="keywordtype">void</span> cmd_dom_ip_rm_all()
00346 {
00347     <span class="keywordflow">if</span>( fdrdstr(cso,dom) != -1 ) {
00348             pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00349                 <span class="stringliteral">"DELETE FROM ip2domain WHERE DOMAIN="</span>
00350                 +pqxx::Quote(dom, <span class="keyword">false</span>)));
00351 
00352             <span class="keywordflow">if</span>(fdwrite(cso,&amp;<span class="stringliteral">"K"</span>,1) != 1) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00353     } <span class="keywordflow">else</span> <span class="keywordflow">throw</span> <a class="code" href="classrd__error.html">rd_error</a>();
00354 }
00358 <span class="keywordtype">void</span> cmd_dom_ip_ls()
00359 {
00360     <span class="keywordflow">if</span>( fdrdstr(cso,dom) == -1 )
00361             <span class="keywordflow">throw</span> <a class="code" href="classrd__error.html">rd_error</a>();
00362     
00363     pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00364         <span class="stringliteral">"SELECT IP FROM ip2domain WHERE DOMAIN="</span>
00365         +pqxx::Quote(dom, <span class="keyword">false</span>)+<span class="stringliteral">" ORDER BY IP"</span>));
00366 
00367     vector&lt;string&gt;::size_type i, cnt = res.size();
00368     <span class="keywordflow">if</span>( fdwrite(cso,&amp;<span class="stringliteral">"F"</span>,1) == -1
00369         || fdwrite(cso,&amp;cnt,<span class="keyword">sizeof</span>(cnt)) == -1 )
00370             <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00371 
00372     string::size_type ipl;
00373     <span class="keyword">const</span> <span class="keywordtype">char</span> *ip;
00374     <span class="keywordflow">for</span>(i=0; i&lt;cnt; ++i) {
00375             ip = res[i][0].c_str();
00376             ipl = ! ip ? 0 : strlen(ip);
00377             <span class="keywordflow">if</span>( fdwrite(cso,&amp;ipl,<span class="keyword">sizeof</span>(ipl)) == -1
00378                 || (ip &amp;&amp; fdwrite(cso, ip, ipl) == -1) )
00379                     <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00380     }
00381 }
00384 <span class="keywordtype">void</span> cmd_dom_ip_ls_dom()
00385 {
00386     pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00387         <span class="stringliteral">"SELECT DISTINCT DOMAIN FROM ip2domain ORDER BY DOMAIN"</span>));
00388 
00389     vector&lt;string&gt;::size_type i, cnt = res.size();
00390     <span class="keywordflow">if</span>(fdwrite(cso,&amp;<span class="stringliteral">"F"</span>,1) == -1
00391        || fdwrite(cso,&amp;cnt,<span class="keyword">sizeof</span>(cnt)) == -1 )
00392             <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00393 
00394     string::size_type doml;
00395     <span class="keyword">const</span> <span class="keywordtype">char</span> *dom;
00396     <span class="keywordflow">for</span>(i=0; i&lt;cnt; ++i) {
00397             dom = res[i][0].c_str();
00398             doml= !dom ? 0 : strlen(dom);
00399             <span class="keywordflow">if</span>( fdwrite(cso,&amp;doml,<span class="keyword">sizeof</span>(doml)) == -1
00400                 || (dom &amp;&amp; fdwrite(cso, dom, doml) == -1) )
00401                     <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00402     }
00403 }
00404 
00408 <span class="keywordtype">void</span> cmd_udot_add() <span class="keywordflow">throw</span> (out_of_range) {
00409     string val;
00410     <span class="keywordflow">if</span>( fdrdstr(cso, dom) == -1
00411        || fdrdstr(cso, user) == -1
00412        || fdrdstr(cso, ext) == -1
00413        || fdread(cso, &amp;type, <span class="keyword">sizeof</span>(type)) == -1 
00414        || fdrdstr(cso, val) == -1 )
00415             <span class="keywordflow">throw</span> <a class="code" href="classrd__error.html">rd_error</a>();
00416 
00417     str2tb(dom);
00418     pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00419         <span class="stringliteral">"SELECT UDOT_ADD("</span>+pqxx::Quote(dom, <span class="keyword">false</span>)+<span class="stringliteral">","</span>+pqxx::Quote(user, <span class="keyword">false</span>)
00420         +<span class="stringliteral">","</span>+pqxx::Quote(ext, <span class="keyword">false</span>)+<span class="stringliteral">",'\\"</span>+(<span class="keywordtype">char</span>)type+<span class="stringliteral">"',"</span>
00421         +pqxx::Quote(val, <span class="keyword">false</span>)+<span class="stringliteral">")"</span>));
00422 
00423     <span class="keywordflow">if</span>(res.size() &amp;&amp; !res[0][0].is_null()) {
00424             string id(res[0][0].c_str());
00425             <span class="keywordflow">if</span>(fdwrite(cso,&amp;<span class="stringliteral">"F"</span>,1) == -1 || fdwrstr(cso, id) == -1 )
00426                     <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00427             <span class="keywordflow">return</span>;
00428     }
00429     <span class="keywordflow">if</span>(fdwrite(cso,&amp;<span class="stringliteral">"E"</span>,1)!=1) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00430 }
00434 <span class="keywordtype">void</span> cmd_udot_ls() {
00435     string ext;
00436     <span class="keywordflow">if</span>( fdrdstr(cso, dom) == -1
00437        || fdrdstr(cso, user) == -1
00438        || fdrdstr(cso, ext) == -1 )
00439             <span class="keywordflow">throw</span> <a class="code" href="classrd__error.html">rd_error</a>();
00440     
00441     str2tb(dom);
00442     pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00443         <span class="stringliteral">"SELECT ID,TYPE,VALUE FROM \""</span>+dom+<span class="stringliteral">"_dot\" WHERE EXT="</span>
00444         +pqxx::Quote(user+ac_qmail_hyp.<a class="code" href="classclnconf.html#clnconfa1">val_str</a>().at(0)+ext, <span class="keyword">false</span>)
00445         +<span class="stringliteral">" ORDER BY ID"</span>));
00446 
00447     vector&lt;string&gt;::size_type i, cnt = res.size();
00448     <span class="keywordflow">if</span>(fdwrite(cso,&amp;<span class="stringliteral">"F"</span>,1) == -1
00449        || fdwrite(cso,&amp;cnt,<span class="keyword">sizeof</span>(cnt)) == -1 )
00450             <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00451 
00452     <span class="keyword">const</span> <span class="keywordtype">char</span> *tmp;
00453     <a class="code" href="structcvq_1_1udot__info.html">cvq::udot_info</a> ui;
00454     <span class="keywordflow">for</span>(i=0; i&lt;cnt; ++i) {
00455             tmp = res[i][0].c_str();
00456             ui.<a class="code" href="structcvq_1_1udot__info.html#cvq_1_1udot__infoo0">id</a> = !tmp ? <span class="stringliteral">""</span> : tmp;
00457             tmp = res[i][1].c_str();
00458             (<span class="keywordtype">char</span>)ui.<a class="code" href="structcvq_1_1udot__info.html#cvq_1_1udot__infoo2">type</a> = !tmp ? 0 : *tmp;
00459             tmp = res[i][2].c_str();
00460             ui.<a class="code" href="structcvq_1_1udot__info.html#cvq_1_1udot__infoo1">val</a> = !tmp ? <span class="stringliteral">""</span> : tmp;
00461 
00462             <span class="keywordflow">if</span>( fdwrstr(cso,ui.<a class="code" href="structcvq_1_1udot__info.html#cvq_1_1udot__infoo0">id</a>) == -1 
00463                 || fdwrite(cso, &amp;ui.<a class="code" href="structcvq_1_1udot__info.html#cvq_1_1udot__infoo2">type</a>, <span class="keyword">sizeof</span>(ui.<a class="code" href="structcvq_1_1udot__info.html#cvq_1_1udot__infoo2">type</a>)) != <span class="keyword">sizeof</span>(ui.<a class="code" href="structcvq_1_1udot__info.html#cvq_1_1udot__infoo2">type</a>)
00464                 || fdwrstr(cso, ui.<a class="code" href="structcvq_1_1udot__info.html#cvq_1_1udot__infoo1">val</a>) == -1 )
00465                     <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00466     }
00467 }
00471 <span class="keywordtype">void</span> cmd_udot_ls_type() {
00472     <span class="keywordflow">if</span>( fdrdstr(cso, dom) == -1
00473        || fdrdstr(cso, user) == -1
00474        || fdrdstr(cso, ext) == -1
00475        || fdread(cso, &amp;type, <span class="keyword">sizeof</span>(type)) == -1 )
00476             <span class="keywordflow">throw</span> <a class="code" href="classrd__error.html">rd_error</a>();
00477 
00478     str2tb(dom);
00479     pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00480         <span class="stringliteral">"SELECT ID,TYPE,VALUE FROM \""</span>+dom+<span class="stringliteral">"_dot\" WHERE EXT="</span>
00481         +pqxx::Quote(user+ac_qmail_hyp.<a class="code" href="classclnconf.html#clnconfa1">val_str</a>().at(0)+ext, <span class="keyword">false</span>)
00482         +<span class="stringliteral">" AND TYPE='\\"</span>+(<span class="keywordtype">char</span>)type+<span class="stringliteral">"' ORDER BY ID"</span>));
00483 
00484     vector&lt;string&gt;::size_type i, cnt = res.size();
00485     <span class="keywordflow">if</span>(fdwrite(cso,&amp;<span class="stringliteral">"F"</span>,1) == -1
00486        || fdwrite(cso,&amp;cnt,<span class="keyword">sizeof</span>(cnt)) == -1 )
00487             <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00488 
00489     <span class="keyword">const</span> <span class="keywordtype">char</span> *tmp;
00490     <a class="code" href="structcvq_1_1udot__info.html">cvq::udot_info</a> ui;
00491     <span class="keywordflow">for</span>(i=0; i&lt;cnt; ++i) {
00492             tmp = res[i][0].c_str();
00493             ui.<a class="code" href="structcvq_1_1udot__info.html#cvq_1_1udot__infoo0">id</a> = !tmp ? <span class="stringliteral">""</span> : tmp;
00494             tmp = res[i][1].c_str();
00495             (<span class="keywordtype">char</span>)ui.<a class="code" href="structcvq_1_1udot__info.html#cvq_1_1udot__infoo2">type</a> = !tmp ? 0 : *tmp;
00496             tmp = res[i][2].c_str();
00497             ui.<a class="code" href="structcvq_1_1udot__info.html#cvq_1_1udot__infoo1">val</a> = !tmp ? <span class="stringliteral">""</span> : tmp;
00498             <span class="keywordflow">if</span>( fdwrstr(cso,ui.<a class="code" href="structcvq_1_1udot__info.html#cvq_1_1udot__infoo0">id</a>) == -1 
00499                 || fdwrite(cso, &amp;ui.<a class="code" href="structcvq_1_1udot__info.html#cvq_1_1udot__infoo2">type</a>, <span class="keyword">sizeof</span>(ui.<a class="code" href="structcvq_1_1udot__info.html#cvq_1_1udot__infoo2">type</a>)) != <span class="keyword">sizeof</span>(ui.<a class="code" href="structcvq_1_1udot__info.html#cvq_1_1udot__infoo2">type</a>)
00500                 || fdwrstr(cso, ui.<a class="code" href="structcvq_1_1udot__info.html#cvq_1_1udot__infoo1">val</a>) == -1 )
00501                     <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00502     }
00503 }
00507 <span class="keywordtype">void</span> cmd_udot_rm() {
00508     string id;
00509     <span class="keywordflow">if</span>( fdrdstr(cso, dom) == -1
00510        || fdrdstr(cso, id) == -1 )
00511             <span class="keywordflow">throw</span> <a class="code" href="classrd__error.html">rd_error</a>();
00512 
00513     str2tb(dom);
00514     pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00515         <span class="stringliteral">"DELETE FROM \""</span>+dom+<span class="stringliteral">"_dot\" WHERE ID="</span>+pqxx::Quote(id, <span class="keyword">false</span>)));
00516 
00517     <span class="keywordflow">if</span>(fdwrite(cso, &amp;<span class="stringliteral">"K"</span>, 1)!=1) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00518 }
00522 <span class="keywordtype">void</span> cmd_udot_rm_type() {
00523     <span class="keywordflow">if</span>( fdrdstr(cso, dom) == -1 
00524         || fdrdstr(cso, user) == -1 
00525         || fdrdstr(cso, ext) == -1
00526         || fdread(cso, &amp;type, <span class="keyword">sizeof</span>(type)) != <span class="keyword">sizeof</span>(type) )
00527             <span class="keywordflow">throw</span> <a class="code" href="classrd__error.html">rd_error</a>();
00528 
00529     str2tb(dom);
00530     pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00531         <span class="stringliteral">"DELETE FROM \""</span>+dom+<span class="stringliteral">"_dot\" WHERE EXT="</span>
00532         +pqxx::Quote(user+ac_qmail_hyp.<a class="code" href="classclnconf.html#clnconfa1">val_str</a>().at(0)+ext, <span class="keyword">false</span>)
00533         +<span class="stringliteral">" AND TYPE='\\"</span>+(<span class="keywordtype">char</span>)type+<span class="stringliteral">"'"</span>));
00534 
00535     <span class="keywordflow">if</span>(fdwrite(cso, &amp;<span class="stringliteral">"K"</span>,1) != 1) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00536 }
00540 <span class="keywordtype">void</span> cmd_udot_get() {
00541     string id;
00542     <span class="keywordflow">if</span>( fdrdstr(cso, dom) == -1
00543        || fdrdstr(cso, id) == -1 )
00544             <span class="keywordflow">throw</span> <a class="code" href="classrd__error.html">rd_error</a>();
00545     
00546     str2tb(dom);
00547     pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00548         <span class="stringliteral">"SELECT TYPE,VALUE FROM \""</span>+dom+<span class="stringliteral">"_dot\" WHERE ID="</span>+pqxx::Quote(id, <span class="keyword">false</span>)));
00549 
00550     <span class="keywordflow">if</span>(res.empty()) {
00551             <span class="keywordflow">if</span>(fdwrite(cso, &amp;<span class="stringliteral">"Z"</span>, 1)!=1) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00552             <span class="keywordflow">return</span>;
00553     }
00554     
00555     string val;
00556     <span class="keyword">const</span> <span class="keywordtype">char</span> *ptr;
00557     ptr = res[0][0].c_str();
00558     (<span class="keywordtype">char</span>)type = ! ptr ? <span class="charliteral">'\0'</span> : *ptr;
00559     ptr = res[0][1].c_str();
00560     val = ! ptr ? <span class="stringliteral">""</span> : ptr;
00561     
00562     <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"F"</span>, 1) != 1 
00563        || fdwrite(cso, &amp;type, <span class="keyword">sizeof</span>(type)) != <span class="keyword">sizeof</span>(type)
00564        || fdwrstr(cso, val) == -1 )
00565             <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00566 }
00567 
00571 <span class="keywordtype">void</span> cmd_udot_rep() {
00572     <a class="code" href="structcvq_1_1udot__info.html">cvq::udot_info</a> ui;
00573 
00574     <span class="keywordflow">if</span>( fdrdstr(cso, dom) == -1
00575        || fdrdstr(cso, ui.<a class="code" href="structcvq_1_1udot__info.html#cvq_1_1udot__infoo0">id</a>) == -1
00576        || fdread(cso, &amp;ui.<a class="code" href="structcvq_1_1udot__info.html#cvq_1_1udot__infoo2">type</a>, <span class="keyword">sizeof</span>(ui.<a class="code" href="structcvq_1_1udot__info.html#cvq_1_1udot__infoo2">type</a>)) != <span class="keyword">sizeof</span>(ui.<a class="code" href="structcvq_1_1udot__info.html#cvq_1_1udot__infoo2">type</a>)
00577        || fdrdstr(cso, ui.<a class="code" href="structcvq_1_1udot__info.html#cvq_1_1udot__infoo1">val</a>) == -1 )
00578             <span class="keywordflow">throw</span> <a class="code" href="classrd__error.html">rd_error</a>();
00579 
00580     str2tb(dom);
00581     pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00582         <span class="stringliteral">"UPDATE \""</span>+dom+<span class="stringliteral">"_dot\" SET TYPE='\\"</span>+(<span class="keywordtype">char</span>)ui.<a class="code" href="structcvq_1_1udot__info.html#cvq_1_1udot__infoo2">type</a>
00583         +<span class="stringliteral">"',VALUE="</span>+pqxx::Quote(ui.<a class="code" href="structcvq_1_1udot__info.html#cvq_1_1udot__infoo1">val</a>, <span class="keyword">false</span>)+<span class="stringliteral">" WHERE ID="</span>
00584         +pqxx::Quote(ui.<a class="code" href="structcvq_1_1udot__info.html#cvq_1_1udot__infoo0">id</a>, <span class="keyword">false</span>)));
00585 
00586     <span class="keywordflow">if</span>( ! res.AffectedRows() ) {
00587             <span class="keywordflow">if</span>(fdwrite(cso, &amp;<span class="stringliteral">"Z"</span>, 1) != 1) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00588     } <span class="keywordflow">else</span> 
00589             <span class="keywordflow">if</span>(fdwrite(cso, &amp;<span class="stringliteral">"K"</span>, 1) != 1) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00590 }
00594 <span class="keywordtype">void</span> cmd_udot_has() {
00595     <span class="keywordflow">if</span>( fdrdstr(cso, dom) == -1
00596        || fdrdstr(cso, user) == -1
00597        || fdrdstr(cso, ext) == -1
00598        || fdread(cso, &amp;type, <span class="keyword">sizeof</span>(type)) == -1 )
00599             <span class="keywordflow">throw</span> <a class="code" href="classrd__error.html">rd_error</a>();
00600 
00601     str2tb(dom);
00602     pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00603         <span class="stringliteral">"SELECT 1 FROM \""</span>+dom+<span class="stringliteral">"_dot\" WHERE ext="</span>
00604         +pqxx::Quote(user+ac_qmail_hyp.<a class="code" href="classclnconf.html#clnconfa1">val_str</a>().at(0)+ext, <span class="keyword">false</span>)
00605         +<span class="stringliteral">" AND TYPE='\\"</span>+(<span class="keywordtype">char</span>)type+<span class="stringliteral">"' LIMIT 1"</span>));
00606 
00607     <span class="keywordflow">if</span>( ! res.empty() ) {
00608             <span class="keywordflow">if</span>(fdwrite(cso, &amp;<span class="stringliteral">"T"</span>, 1) != 1) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00609     } <span class="keywordflow">else</span> 
00610             <span class="keywordflow">if</span>(fdwrite(cso, &amp;<span class="stringliteral">"F"</span>,1) != 1) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00611 }
00615 <span class="keywordtype">void</span> cmd_udot_type_cnt() {
00616     <span class="keywordflow">if</span>( fdrdstr(cso, dom) == -1 
00617         || fdrdstr(cso, user) == -1 
00618         || fdrdstr(cso, ext) == -1
00619         || fdread(cso, &amp;type, <span class="keyword">sizeof</span>(type)) != <span class="keyword">sizeof</span>(type) )
00620             <span class="keywordflow">throw</span> <a class="code" href="classrd__error.html">rd_error</a>();
00621     
00622     str2tb(dom);
00623     pqxx::Result res(pqxx::NonTransaction(*pg).Exec(
00624         <span class="stringliteral">"SELECT COUNT(*) FROM \""</span>+dom+<span class="stringliteral">"_dot\" WHERE ext="</span>
00625         +pqxx::Quote(user+ac_qmail_hyp.<a class="code" href="classclnconf.html#clnconfa1">val_str</a>().at(0)+ext, <span class="keyword">false</span>)
00626         +<span class="stringliteral">" AND TYPE='\\"</span>+(<span class="keywordtype">char</span>)type+<span class="stringliteral">"'"</span>));
00627 
00628     <span class="keywordflow">if</span>( res.empty() || res[0][0].is_null() ) {
00629             <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"E"</span>, 1)) <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00630     }
00631 
00632     <span class="keyword">const</span> <span class="keywordtype">char</span> *ptr = res[0][0].c_str();
00633 
00634     <a class="code" href="classcauth.html#cdaemonauthw22">cdaemonauth::size_type</a> cnt;
00635     istringstream is(ptr);
00636     is&gt;&gt;cnt;
00637     <span class="keywordflow">if</span>( ! is ) cnt = 0;
00638     
00639     <span class="keywordflow">if</span>(fdwrite(cso, &amp;<span class="stringliteral">"F"</span>,1) != 1
00640        || fdwrite(cso, &amp;cnt, <span class="keyword">sizeof</span>(cnt)) != <span class="keyword">sizeof</span>(cnt))
00641             <span class="keywordflow">throw</span> <a class="code" href="classwr__error.html">wr_error</a>();
00642 }
00645 void (*cmd_proc( <span class="keywordtype">char</span> cmd )) () {
00646     <span class="keywordflow">switch</span>(cmd) {
00647     <span class="keywordflow">case</span> cdaemonauth::cmd_dom_add: 
00648         <span class="keywordflow">return</span> &amp;cmd_dom_add;
00649     <span class="keywordflow">case</span> cdaemonauth::cmd_dom_rm:
00650         <span class="keywordflow">return</span> &amp;cmd_dom_rm;
00651     <span class="keywordflow">case</span> cdaemonauth::cmd_user_add:
00652         <span class="keywordflow">return</span> &amp;cmd_user_add;
00653     <span class="keywordflow">case</span> cdaemonauth::cmd_user_rm:
00654         <span class="keywordflow">return</span> &amp;cmd_user_rm;
00655     <span class="keywordflow">case</span> cdaemonauth::cmd_user_pass:
00656         <span class="keywordflow">return</span> &amp;cmd_user_pass;
00657     <span class="keywordflow">case</span> cdaemonauth::cmd_user_auth:
00658         <span class="keywordflow">return</span> &amp;cmd_user_auth;
00659     <span class="keywordflow">case</span> cdaemonauth::cmd_dom_ip_add:
00660         <span class="keywordflow">return</span> &amp;cmd_dom_ip_add;
00661     <span class="keywordflow">case</span> cdaemonauth::cmd_dom_ip_rm:
00662         <span class="keywordflow">return</span> &amp;cmd_dom_ip_rm;
00663     <span class="keywordflow">case</span> cdaemonauth::cmd_dom_ip_rm_all:
00664         <span class="keywordflow">return</span> &amp;cmd_dom_ip_rm_all;
00665     <span class="keywordflow">case</span> cdaemonauth::cmd_dom_ip_ls:
00666         <span class="keywordflow">return</span> &amp;cmd_dom_ip_ls;
00667     <span class="keywordflow">case</span> cdaemonauth::cmd_dom_ip_ls_dom:
00668         <span class="keywordflow">return</span> &amp;cmd_dom_ip_ls_dom;
00669     <span class="keywordflow">case</span> cdaemonauth::cmd_udot_add:
00670         <span class="keywordflow">return</span> &amp;cmd_udot_add;
00671     <span class="keywordflow">case</span> cdaemonauth::cmd_udot_rm:
00672         <span class="keywordflow">return</span> &amp;cmd_udot_rm;
00673     <span class="keywordflow">case</span> cdaemonauth::cmd_udot_rm_type:
00674         <span class="keywordflow">return</span> &amp;cmd_udot_rm_type;
00675     <span class="keywordflow">case</span> cdaemonauth::cmd_udot_ls:
00676         <span class="keywordflow">return</span> &amp;cmd_udot_ls;
00677     <span class="keywordflow">case</span> cdaemonauth::cmd_udot_ls_type:
00678         <span class="keywordflow">return</span> &amp;cmd_udot_ls_type;
00679     <span class="keywordflow">case</span> cdaemonauth::cmd_udot_get:
00680         <span class="keywordflow">return</span> &amp;cmd_udot_get;
00681     <span class="keywordflow">case</span> cdaemonauth::cmd_udot_rep:
00682         <span class="keywordflow">return</span> &amp;cmd_udot_rep;
00683     <span class="keywordflow">case</span> cdaemonauth::cmd_udot_has:
00684         <span class="keywordflow">return</span> &amp;cmd_udot_has;
00685     <span class="keywordflow">case</span> cdaemonauth::cmd_udot_type_cnt:
00686         <span class="keywordflow">return</span> &amp;cmd_udot_type_cnt;
00687     <span class="keywordflow">case</span> cdaemonauth::cmd_user_ex:
00688         <span class="keywordflow">return</span> &amp;cmd_user_ex;
00689     <span class="keywordflow">default</span>:
00690         <span class="keywordflow">return</span> NULL;
00691     }
00692 }
00696 <span class="keywordtype">char</span> child(<span class="keywordtype">int</span> fd)
00697 {
00698     <span class="keywordtype">char</span> cmd;
00699     void (*run)();
00700 
00701     cso = fd;
00702     
00703     <span class="keywordflow">switch</span>( fdread(cso, &amp;cmd, 1) ) {
00704     <span class="keywordflow">case</span> 0: <span class="keywordflow">return</span> 1;
00705     <span class="keywordflow">case</span> -1: 
00706             cerr&lt;&lt;<span class="stringliteral">"child: read error: "</span>&lt;&lt;strerror(errno)&lt;&lt;endl;
00707             <span class="keywordflow">return</span> 2;
00708     }
00709     <span class="comment">// process cmd</span>
00710     <span class="keywordflow">if</span>( ! (run = cmd_proc(cmd)) ) {
00711             cerr &lt;&lt; <span class="stringliteral">"child: unknown command: "</span> &lt;&lt; (<span class="keywordtype">int</span>) cmd &lt;&lt; endl;
00712             <span class="keywordflow">return</span> 2;
00713     }
00714 
00715     <span class="keywordflow">try</span> {
00716             (*run)();
00717             <span class="keywordflow">return</span> 0;
00718     } <span class="keywordflow">catch</span>( <span class="keyword">const</span> <a class="code" href="classrd__error.html">rd_error</a> &amp; e ) {
00719             cerr&lt;&lt;<span class="stringliteral">"child: exception: "</span>&lt;&lt;e.what()&lt;&lt;endl;
00720     } <span class="keywordflow">catch</span>( <span class="keyword">const</span> <a class="code" href="classwr__error.html">wr_error</a> &amp; e ) {
00721             cerr&lt;&lt;<span class="stringliteral">"child: exception: "</span>&lt;&lt;e.what()&lt;&lt;endl;
00722     } <span class="keywordflow">catch</span>( <span class="keyword">const</span> exception &amp; e ) {
00723             cerr&lt;&lt;<span class="stringliteral">"child: exception: "</span>&lt;&lt;e.what()&lt;&lt;endl;
00724             <span class="keywordflow">if</span>( fdwrite(cso, &amp;<span class="stringliteral">"E"</span>, 1) != 1 ) cerr&lt;&lt;<span class="stringliteral">"child: write error: "</span>&lt;&lt;strerror(errno)&lt;&lt;endl;
00725     }
00726     
00727     <span class="keywordflow">return</span> 2;
00728 }
00729 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Dec 25 13:37:10 2003 for Virtual Qmail by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.3 </small></address>
</body>
</html>
